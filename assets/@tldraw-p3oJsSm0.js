var Ca=Object.defineProperty;var Ea=(n,t,e)=>t in n?Ca(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var u=(n,t,e)=>Ea(n,typeof t!="symbol"?t+"":t,e);import{t as _a}from"./lodash.throttle-yuuEgjvB.js";import{_ as ka}from"./lodash.uniq-u0GOvbqz.js";import{i as Ta}from"./lodash.isequal-CX3c-88x.js";import{R as dt,r as k,j as y}from"./react-xe4jsmfW.js";import{c as be}from"./classnames-Dty2DWCt.js";import"./core-js-C7DbFKwg.js";import{n as bs}from"./nanoid-vcSNLBTf.js";import{c as Ma,w as Aa,p as Da}from"./@use-gesture-DOFCekvX.js";import{E as Ra}from"./eventemitter3-Dqjbdtcb.js";import{c as La,r as Oa}from"./react-dom-CDP_2C_w.js";import{o as zr,d as Br}from"./idb-Bn1DMRyg.js";function Ur(n){return n&&typeof n=="object"&&"parents"in n}function Nr(n){for(let t=0,e=n.parents.length;t<e;t++)if(n.parents[t].__unsafe__getWithoutCapture(!0),n.parents[t].lastChangedEpoch!==n.parentEpochs[t])return!0;return!1}const qs=(n,t)=>{if(n.children.remove(t)&&n.children.isEmpty&&Ur(n))for(let e=0,s=n.parents.length;e<s;e++)qs(n.parents[e],n)},ti=(n,t)=>{if(n.children.add(t)&&Ur(n))for(let e=0,s=n.parents.length;e<s;e++)ti(n.parents[e],n)};function $r(n,t){return n===t||Object.is(n,t)||!!(n&&t&&typeof n.equals=="function"&&n.equals(t))}function bt(n,t){const e=Symbol.for(`com.tldraw.state/${n}`),s=globalThis;return s[e]??(s[e]=t()),s[e]}const ht=bt("empty_array",()=>Object.freeze([])),Fi=8;class Ws{constructor(){u(this,"arraySize",0);u(this,"array",Array(Fi));u(this,"set",null)}get isEmpty(){if(this.array)return this.arraySize===0;if(this.set)return this.set.size===0;throw new Error("no set or array")}add(t){if(this.array)return this.array.indexOf(t)!==-1?!1:this.arraySize<Fi?(this.array[this.arraySize]=t,this.arraySize++,!0):(this.set=new Set(this.array),this.array=null,this.set.add(t),!0);if(this.set)return this.set.has(t)?!1:(this.set.add(t),!0);throw new Error("no set or array")}remove(t){if(this.array){const e=this.array.indexOf(t);return e===-1?!1:(this.array[e]=void 0,this.arraySize--,e!==this.arraySize&&(this.array[e]=this.array[this.arraySize],this.array[this.arraySize]=void 0),!0)}if(this.set)return this.set.has(t)?(this.set.delete(t),!0):!1;throw new Error("no set or array")}visit(t){if(this.array){for(let e=0;e<this.arraySize;e++){const s=this.array[e];typeof s<"u"&&t(s)}return}if(this.set){this.set.forEach(t);return}throw new Error("no set or array")}has(t){return this.array?this.array.indexOf(t)!==-1:this.set.has(t)}clear(){this.set?this.set.clear():(this.arraySize=0,this.array=[])}size(){return this.set?this.set.size:this.arraySize}}const Re=Symbol.for("com.tldraw.state/RESET_VALUE");class Kr{constructor(t){u(this,"index",0);u(this,"buffer");this.capacity=t,this.buffer=new Array(t)}pushEntry(t,e,s){if(s!==void 0){if(s===Re){this.clear();return}this.buffer[this.index]=[t,e,s],this.index=(this.index+1)%this.capacity}}clear(){this.index=0,this.buffer.fill(void 0)}getChangesSince(t){const{index:e,capacity:s,buffer:i}=this;for(let r=0;r<s;r++){const o=(e-1+s-r)%s,a=i[o];if(!a)return Re;const[c,l]=a;if(r===0&&t>=l)return[];if(c<=t&&t<l){const d=r+1,h=new Array(d);for(let p=0;p<d;p++)h[p]=i[(o+p)%s][2];return h}}return Re}}class Fa{constructor(t,e){u(this,"offset",0);u(this,"maybeRemoved");this.below=t,this.child=e}}const re=bt("capture",()=>({stack:null}));function Es(n){const t=re.stack;re.stack=null;try{return n()}finally{re.stack=t}}function Hr(n){re.stack=new Fa(re.stack,n),n.parentSet.clear()}function Yr(){const n=re.stack;if(re.stack=n.below,n.offset<n.child.parents.length){for(let t=n.offset;t<n.child.parents.length;t++){const e=n.child.parents[t];n.child.parentSet.has(e)||qs(e,n.child)}n.child.parents.length=n.offset,n.child.parentEpochs.length=n.offset}if(n.maybeRemoved)for(let t=0;t<n.maybeRemoved.length;t++){const e=n.maybeRemoved[t];n.child.parentSet.has(e)||qs(e,n.child)}}function Vs(n){if(re.stack){if(re.stack.child.parentSet.has(n))return;if(re.stack.child.parentSet.add(n),re.stack.child.isActivelyListening&&ti(n,re.stack.child),re.stack.offset<re.stack.child.parents.length){const e=re.stack.child.parents[re.stack.offset];e!==n&&(re.stack.maybeRemoved?re.stack.maybeRemoved.push(e):re.stack.maybeRemoved=[e])}re.stack.child.parents[re.stack.offset]=n,re.stack.child.parentEpochs[re.stack.offset]=n.lastChangedEpoch,re.stack.offset++}}const gt=-1;class ja{constructor(t,e,s){u(this,"_isActivelyListening",!1);u(this,"lastTraversedEpoch",gt);u(this,"lastReactedEpoch",gt);u(this,"_scheduleCount",0);u(this,"parentSet",new Ws);u(this,"parentEpochs",[]);u(this,"parents",[]);u(this,"_scheduleEffect");u(this,"maybeExecute",()=>{this._isActivelyListening&&this.execute()});this.name=t,this.runEffect=e,this._scheduleEffect=s==null?void 0:s.scheduleEffect}get isActivelyListening(){return this._isActivelyListening}get scheduleCount(){return this._scheduleCount}maybeScheduleEffect(){if(this._isActivelyListening&&this.lastReactedEpoch!==Pe()){if(this.parents.length&&!Nr(this)){this.lastReactedEpoch=Pe();return}this.scheduleEffect()}}scheduleEffect(){this._scheduleCount++,this._scheduleEffect?this._scheduleEffect(this.maybeExecute):this.execute()}attach(){this._isActivelyListening=!0;for(let t=0,e=this.parents.length;t<e;t++)ti(this.parents[t],this)}detach(){this._isActivelyListening=!1;for(let t=0,e=this.parents.length;t<e;t++)qs(this.parents[t],this)}execute(){try{Hr(this);const t=Pe(),e=this.runEffect(this.lastReactedEpoch);return this.lastReactedEpoch=t,e}finally{Yr()}}}const Xt=bt("EffectScheduler",()=>ja);function xs(n,t,e){const s=new Xt(n,t,e);return s.attach(),s.scheduleEffect(),()=>{s.detach()}}function za(n,t,e){const s=new Xt(n,t,e);return{scheduler:s,start:i=>{const r=(i==null?void 0:i.force)??!1;s.attach(),r?s.scheduleEffect():s.maybeScheduleEffect()},stop:()=>{s.detach()}}}class Ba{constructor(t){u(this,"initialAtomValues",new Map);this.parent=t}get isRoot(){return this.parent===null}commit(){this.isRoot?Gr(this.initialAtomValues.keys()):this.initialAtomValues.forEach((t,e)=>{this.parent.initialAtomValues.has(e)||this.parent.initialAtomValues.set(e,t)})}abort(){ee.globalEpoch++,this.initialAtomValues.forEach((t,e)=>{var s;e.set(t),(s=e.historyBuffer)==null||s.clear()}),this.commit()}}const ee=bt("transactions",()=>({globalEpoch:gt+1,globalIsReacting:!1,currentTransaction:null,cleanupReactors:null,reactionEpoch:gt+1}));function Ua(){return ee.reactionEpoch}function Pe(){return ee.globalEpoch}function Na(){return ee.globalIsReacting}function si(n,t){t.lastTraversedEpoch!==ee.globalEpoch&&(t.lastTraversedEpoch=ee.globalEpoch,t instanceof Xt?n.add(t):t.children.visit(e=>si(n,e)))}function Gr(n){var t;if(ee.globalIsReacting)throw new Error("cannot change atoms during reaction cycle");try{ee.globalIsReacting=!0,ee.reactionEpoch=ee.globalEpoch;const e=new Set;for(const i of n)i.children.visit(r=>si(e,r));for(const i of e)i.maybeScheduleEffect();let s=0;for(;(t=ee.cleanupReactors)!=null&&t.size;){if(s++>1e3)throw new Error("Reaction update depth limit exceeded");const i=ee.cleanupReactors;ee.cleanupReactors=null;for(const r of i)r.maybeScheduleEffect()}}finally{ee.cleanupReactors=null,ee.globalIsReacting=!1}}function $a(n,t){if(ee.globalIsReacting){const e=ee.cleanupReactors??(ee.cleanupReactors=new Set);n.children.visit(s=>si(e,s))}else ee.currentTransaction?ee.currentTransaction.initialAtomValues.has(n)||ee.currentTransaction.initialAtomValues.set(n,t):Gr([n])}function Ka(){ee.globalEpoch++}function Ha(n){const t=new Ba(ee.currentTransaction);ee.currentTransaction=t;try{let e,s=!1;try{e=n(()=>s=!0)}catch(i){throw t.abort(),i}return s?t.abort():t.commit(),e}finally{ee.currentTransaction=ee.currentTransaction.parent}}function ut(n){return ee.currentTransaction?n():Ha(n)}class Ya{constructor(t,e,s){u(this,"isEqual");u(this,"computeDiff");u(this,"lastChangedEpoch",Pe());u(this,"children",new Ws);u(this,"historyBuffer");this.name=t,this.current=e,this.isEqual=(s==null?void 0:s.isEqual)??null,s&&(s.historyLength&&(this.historyBuffer=new Kr(s.historyLength)),this.computeDiff=s.computeDiff)}__unsafe__getWithoutCapture(t){return this.current}get(){return Vs(this),this.current}set(t,e){var i,r;if(((i=this.isEqual)==null?void 0:i.call(this,this.current,t))??$r(this.current,t))return this.current;Ka(),this.historyBuffer&&this.historyBuffer.pushEntry(this.lastChangedEpoch,Pe(),e??((r=this.computeDiff)==null?void 0:r.call(this,this.current,t,this.lastChangedEpoch,Pe()))??Re),this.lastChangedEpoch=Pe();const s=this.current;return this.current=t,$a(this,s),t}update(t){return this.set(t(this.current))}getDiffSince(t){var e;return Vs(this),t>=this.lastChangedEpoch?ht:((e=this.historyBuffer)==null?void 0:e.getChangesSince(t))??Re}}const Ga=bt("Atom",()=>Ya);function fe(n,t,e){return new Ga(n,t,e)}let ji=!1;function Xa(){ji||(ji=!0,console.warn(`Using \`@computed\` as a decorator for getters is deprecated and will be removed in the near future. Please refactor to use \`@computed\` as a decorator for methods.

// Before
@computed
get foo() {
	return 'foo'
}

// After
@computed
getFoo() {
	return 'foo'
}
`))}const ns=Symbol.for("com.tldraw.state/UNINITIALIZED"),Ct=n=>n===ns,$n=bt("WithDiff",()=>class{constructor(t,e){this.value=t,this.diff=e}});function is(n,t){return new $n(n,t)}class qa{constructor(t,e,s){u(this,"lastChangedEpoch",gt);u(this,"lastTraversedEpoch",gt);u(this,"lastCheckedEpoch",gt);u(this,"parentSet",new Ws);u(this,"parents",[]);u(this,"parentEpochs",[]);u(this,"children",new Ws);u(this,"historyBuffer");u(this,"state",ns);u(this,"error",null);u(this,"computeDiff");u(this,"isEqual");this.name=t,this.derive=e,s!=null&&s.historyLength&&(this.historyBuffer=new Kr(s.historyLength)),this.computeDiff=s==null?void 0:s.computeDiff,this.isEqual=(s==null?void 0:s.isEqual)??$r}get isActivelyListening(){return!this.children.isEmpty}__unsafe__getWithoutCapture(t){var i;const e=this.lastChangedEpoch===gt,s=Pe();if(!e&&(this.lastCheckedEpoch===s||this.isActivelyListening&&Na()&&this.lastTraversedEpoch<Ua()||!Nr(this)))if(this.lastCheckedEpoch=s,this.error){if(t)return this.state;throw this.error.thrownValue}else return this.state;try{Hr(this);const r=this.derive(this.state,this.lastCheckedEpoch),o=r instanceof $n?r.value:r,a=this.state===ns;if(a||!this.isEqual(o,this.state)){if(this.historyBuffer&&!a){const c=r instanceof $n?r.diff:void 0;this.historyBuffer.pushEntry(this.lastChangedEpoch,Pe(),c??((i=this.computeDiff)==null?void 0:i.call(this,this.state,o,this.lastCheckedEpoch,Pe()))??Re)}this.lastChangedEpoch=Pe(),this.state=o}return this.error=null,this.lastCheckedEpoch=Pe(),this.state}catch(r){if(this.state!==ns&&(this.state=ns,this.lastChangedEpoch=Pe()),this.lastCheckedEpoch=Pe(),this.historyBuffer&&this.historyBuffer.clear(),this.error={thrownValue:r},!t)throw r;return this.state}finally{Yr()}}get(){try{return this.__unsafe__getWithoutCapture()}finally{Vs(this)}}getDiffSince(t){var e;return this.__unsafe__getWithoutCapture(!0),Vs(this),t>=this.lastChangedEpoch?ht:((e=this.historyBuffer)==null?void 0:e.getChangesSince(t))??Re}}const ni=bt("Computed",()=>qa);function Wa(n={},t,e,s){const i=s.value,r=Symbol.for("__@tldraw/state__computed__"+e);return s.value=function(){let o=this[r];return o||(o=new ni(e,i.bind(this),n),Object.defineProperty(this,r,{enumerable:!1,configurable:!1,writable:!1,value:o})),o.get()},s.value[Za]=!0,s}function zi(n={},t,e,s){return s.get?(Xa(),Va(n,t,e,s)):Wa(n,t,e,s)}function Va(n={},t,e,s){const i=s.get,r=Symbol.for("__@tldraw/state__computed__"+e);return s.get=function(){let o=this[r];return o||(o=new ni(e,i.bind(this),n),Object.defineProperty(this,r,{enumerable:!1,configurable:!1,writable:!1,value:o})),o.get()},s}const Za="@@__isComputedMethod__@@";function C(){if(arguments.length===1){const n=arguments[0];return(t,e,s)=>zi(n,t,e,s)}else return typeof arguments[0]=="string"?new ni(arguments[0],arguments[1],arguments[2]):zi(void 0,arguments[0],arguments[1],arguments[2])}const Xr=1,Qa=bt("apiVersion",()=>Xr);if(Qa!==Xr)throw new Error("You have multiple incompatible versions of @tldraw/state in your app. Please deduplicate the package.");const rs={Good:"#40C057",Mid:"#FFC078",Poor:"#E03131"},Ja=rs.Good;class qr{constructor(){u(this,"startTime",0);u(this,"name","");u(this,"frames",0);u(this,"started",!1);u(this,"frame",null);u(this,"recordFrame",()=>{this.frames++,this.started&&(this.frame=requestAnimationFrame(this.recordFrame))})}start(t){this.name=t,this.frames=0,this.started=!0,this.frame!==null&&cancelAnimationFrame(this.frame),this.frame=requestAnimationFrame(this.recordFrame),this.startTime=performance.now()}stop(){this.started=!1,this.frame!==null&&cancelAnimationFrame(this.frame);const t=(performance.now()-this.startTime)/1e3,e=t===0?0:Math.floor(this.frames/t),s=e>55?rs.Good:e>30?rs.Mid:rs.Poor,i=s===rs.Mid?"black":"white",r=this.name[0].toUpperCase()+this.name.slice(1);console.debug(`%cPerf%c ${r} %c${e}%c fps`,`color: white; background: ${Ja};padding: 2px;border-radius: 3px;`,"font-weight: normal",`font-weight: bold; padding: 2px; background: ${s};color: ${i};`,"font-weight: normal")}isStarted(){return this.started}}function ii(n,t){const e=[];e:for(const s of n){for(const i of e)if(t?t(s,i):s===i)continue e;e.push(s)}return e}function te(n){return n.filter(t=>t!=null)}function Cn(n){return n[n.length-1]}function vf(n,t){let e,s=1/0;for(const i of n){const r=t(i);r<s&&(e=i,s=r)}return e}function ec(n,t){if(n===t)return!0;if(n.length!==t.length)return!1;for(let e=0;e<n.length;e++)if(!Object.is(n[e],t[e]))return!1;return!0}class gs{constructor(){u(this,"items",new WeakMap)}get(t,e){return this.items.has(t)||this.items.set(t,e(t)),this.items.get(t)}}function Wr(n){const t=(...e)=>{try{return n(...e)}catch(s){throw s instanceof Error&&Error.captureStackTrace&&Error.captureStackTrace(s,t),s}};return t}const ri=()=>{},yt={ok(n){return{ok:!0,value:n}},err(n){return{ok:!1,error:n}}};function Ve(n,t){const e=t&&n&&typeof n=="object"&&t in n?n[t]:n;throw new Error(`Unknown switch case ${e}`)}const de=Wr((n,t)=>{if(!n)throw new Error(t||"Assertion Error")}),Be=Wr((n,t)=>{if(n==null)throw new Error(t??"value must be defined");return n});function tc(n,t){let e;const s=(...i)=>(e||(e={},e.promise=new Promise((r,o)=>{e.resolve=r,e.reject=o})),clearTimeout(e.timeout),e.latestArgs=i,e.timeout=setTimeout(()=>{const r=e;e=void 0;try{r.resolve(n(...r.latestArgs))}catch(o){r.reject(o)}},t),e.promise);return s.cancel=()=>{e&&clearTimeout(e.timeout)},s}const Bi=new WeakMap;function oi(n,t){if(typeof n!="object"||n===null)return;let e=Bi.get(n);e||(e={tags:{},extras:{}},Bi.set(n,e)),t.tags&&(e.tags={...e.tags,...t.tags}),t.extras&&(e.extras={...e.extras,...t.extras})}async function ln(n,t){return window.fetch(n,{referrerPolicy:"strict-origin-when-cross-origin",...t})}const sc=(n,t)=>{const e=new window.Image(n,t);return e.referrerPolicy="strict-origin-when-cross-origin",e};class Vr{static async dataUrlToArrayBuffer(t){return ln(t).then(function(e){return e.arrayBuffer()})}static async blobToDataUrl(t){return await new Promise((e,s)=>{if(t){const i=new FileReader;i.onload=()=>e(i.result),i.onerror=r=>s(r),i.onabort=r=>s(r),i.readAsDataURL(t)}})}static async blobToText(t){return await new Promise((e,s)=>{if(t){const i=new FileReader;i.onload=()=>e(i.result),i.onerror=r=>s(r),i.onabort=r=>s(r),i.readAsText(t)}})}}function Pf(n){let t=0;for(let e=0;e<n.length;e++)t=(t<<5)-t+n.charCodeAt(e),t|=0;return t+""}function Cf(n){const t=new DataView(n);let e=0;for(let s=0;s<t.byteLength;s++)e=(e<<5)-e+t.getUint8(s),e|=0;return e+""}/*!
 * MIT License: https://github.com/vHeemstra/is-apng/blob/main/license
 * Copyright (c) Philip van Heemstra
 */function nc(n){const t=new Uint8Array(n);if(!t||!(typeof Buffer<"u"&&Buffer.isBuffer(t)||t instanceof Uint8Array)||t.length<16||!(t[0]===137&&t[1]===80&&t[2]===78&&t[3]===71&&t[4]===13&&t[5]===10&&t[6]===26&&t[7]===10))return!1;function s(r,o,a,c,l=1024){if(!o)return-1;o=new RegExp(o,"g");const d=o.source.length,h=new TextDecoder,p=r.length;if(typeof c>"u"&&(c=p),a>=p||c<=0||a>=c)return-1;r=r.subarray(a,c);let f=-1,S=0,g=0,w="";e:for(;S<r.length;){const b=S+l,x=r.subarray(S,b),I=h.decode(x,{stream:!0}),_=w+I;let T,A=-1;for(;(T=o.exec(_))!==null;){A=T.index-w.length,f=g+A;break e}S=b,g+=I.length;const M=A>-1?A+d:I.length-d;w=I.slice(M)}return f>=0&&(f+=a>=0?a:p+a),f}const i=s(t,"IDAT",12);return i>=12?s(t,"acTL",8,i)>=8:!1}const ic=n=>new Uint8Array(n)[3]===44;/*!
 * MIT License
 * Modified code originally from <https://github.com/qzb/is-animated>
 * Copyright (c) 2016 Józef Sokołowski <j.k.sokolowski@gmail.com>
 */function Ui(n,t){let e=0;for(;n[t+e];)e+=n[t+e]+1;return e+1}function rc(n){return new TextDecoder("ascii").decode(n.slice(0,3))==="GIF"}function oc(n){const t=new Uint8Array(n);let e,s,i=0,r=0;if(!rc(n))return!1;for(e=t[10]&128,s=t[10]&7,i+=6,i+=7,i+=e?3*Math.pow(2,s+1):0;r<2&&i<t.length;)switch(t[i]){case 44:r+=1,e=t[i+9]&128,s=t[i+9]&7,i+=10,i+=e?3*Math.pow(2,s+1):0,i+=Ui(t,i+1)+1;break;case 33:i+=2,i+=Ui(t,i);break;case 59:i=t.length;break;default:i=t.length;break}return r>1}let Kn=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];typeof Int32Array<"u"&&(Kn=new Int32Array(Kn));/*!
 * MIT License: https://github.com/alexgorbatchev/crc/blob/master/LICENSE
 * Copyright: 2014 Alex Gorbatchev
 * Code: crc32, https://github.com/alexgorbatchev/crc/blob/master/src/calculators/crc32.ts
 */const ac=(n,t)=>{let e=-1;for(let s=0;s<n.length;s++)e=Kn[(e^n[s])&255]^e>>>8;return e^-1},Ni=4,$i=4;class lt{static isPng(t,e){return t.getUint8(e+0)===137&&t.getUint8(e+1)===80&&t.getUint8(e+2)===78&&t.getUint8(e+3)===71&&t.getUint8(e+4)===13&&t.getUint8(e+5)===10&&t.getUint8(e+6)===26&&t.getUint8(e+7)===10}static getChunkType(t,e){return[String.fromCharCode(t.getUint8(e)),String.fromCharCode(t.getUint8(e+1)),String.fromCharCode(t.getUint8(e+2)),String.fromCharCode(t.getUint8(e+3))].join("")}static readChunks(t,e=0){const s={};if(!lt.isPng(t,e))throw new Error("Not a PNG");for(e+=8;e<=t.buffer.byteLength;){const i=e,r=t.getInt32(e);e+=4;const o=lt.getChunkType(t,e);if(o==="IDAT"&&s[o]){e+=r+Ni+$i;continue}if(o==="IEND")break;s[o]={start:i,dataOffset:e+4,size:r},e+=r+Ni+$i}return s}static parsePhys(t,e){return{ppux:t.getUint32(e),ppuy:t.getUint32(e+4),unit:t.getUint8(e+4)}}static findChunk(t,e){return lt.readChunks(t)[e]}static setPhysChunk(t,e=1,s){let i=46,r=0;const o=lt.findChunk(t,"pHYs");o&&(i=o.start,r=o.size);const a=lt.findChunk(t,"IDAT");a&&(i=a.start,r=0);const c=new ArrayBuffer(21),l=new DataView(c);l.setUint32(0,9),l.setUint8(4,112),l.setUint8(5,72),l.setUint8(6,89),l.setUint8(7,115);const d=2835.5;l.setInt32(8,d*e),l.setInt32(12,d*e),l.setInt8(16,1);const h=new Uint8Array(c.slice(4,17));l.setInt32(17,ac(h));const p=t.buffer.slice(0,i),f=t.buffer.slice(i+r);return new Blob([p,c,f],s)}}/*!
 * MIT License: https://github.com/sindresorhus/is-webp/blob/main/license
 * Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (https://sindresorhus.com)
 */function cc(n){return!n||n.length<12?!1:n[8]===87&&n[9]===69&&n[10]===66&&n[11]===80}function lc(n){const t=new Uint8Array(n);return!cc(t)||!t||t.length<21?!1:(t[20]>>1&1)===1}const Zr=Object.freeze(["image/svg+xml"]),Qr=Object.freeze(["image/jpeg","image/png","image/webp"]),Jr=Object.freeze(["image/gif","image/apng","image/avif"]),eo=Object.freeze([...Qr,...Zr,...Jr]),dc=Object.freeze(["video/mp4","video/webm","video/quicktime"]),Ef=[...eo,...dc].join(",");class os{static loadVideo(t){return new Promise((e,s)=>{const i=document.createElement("video");i.onloadeddata=()=>e(i),i.onerror=r=>{console.error(r),s(new Error("Could not load video"))},i.crossOrigin="anonymous",i.src=t})}static loadImage(t){return new Promise((e,s)=>{const i=sc();i.onload=()=>e(i),i.onerror=r=>{console.error(r),s(new Error("Could not load image"))},i.crossOrigin="anonymous",i.referrerPolicy="strict-origin-when-cross-origin",i.src=t})}static async getVideoSize(t){return os.usingObjectURL(t,async e=>{const s=await os.loadVideo(e);return{w:s.videoWidth,h:s.videoHeight}})}static async getImageSize(t){const e=await os.usingObjectURL(t,os.loadImage);try{if(t.type==="image/png"){const s=new DataView(await t.arrayBuffer());if(lt.isPng(s,0)){const i=lt.findChunk(s,"pHYs");if(i){const r=lt.parsePhys(s,i.dataOffset);if(r.unit===0&&r.ppux===r.ppuy){const o=Math.max(r.ppux/2834.5,1);return{w:Math.round(e.naturalWidth/o),h:Math.round(e.naturalHeight/o)}}}}}}catch(s){return console.error(s),{w:e.naturalWidth,h:e.naturalHeight}}return{w:e.naturalWidth,h:e.naturalHeight}}static async isAnimated(t){return t.type==="image/gif"?oc(await t.arrayBuffer()):t.type==="image/avif"?ic(await t.arrayBuffer()):t.type==="image/webp"?lc(await t.arrayBuffer()):t.type==="image/apng"?nc(await t.arrayBuffer()):!1}static isAnimatedImageType(t){return Jr.includes(t||"")}static isStaticImageType(t){return Qr.includes(t||"")}static isVectorImageType(t){return Zr.includes(t||"")}static isImageType(t){return eo.includes(t)}static async usingObjectURL(t,e){const s=URL.createObjectURL(t);try{return await e(s)}finally{URL.revokeObjectURL(s)}}}function zt(n,t,e){return n+(t-n)*e}function _f(n=""){let t=0,e=0,s=0,i=0;function r(){const o=t^t<<11;return t=e,e=s,s=i,i^=(i>>>19^o^o>>>8)>>>0,i/4294967296*2}for(let o=0;o<n.length+64;o++)t^=n.charCodeAt(o)|0,r();return r}function Zs(n,t,e,s=!1){const[i,r]=t,[o,a]=e,c=o+(n-i)/(r-i)*(a-o);return s?o<a?Math.max(Math.min(c,a),o):Math.max(Math.min(c,o),a):c}function Qe(n,t){return Object.prototype.hasOwnProperty.call(n,t)}function Ee(n,t){if(Qe(n,t))return n[t]}function Ki(n){return Object.keys(n)}function oe(n){return Object.values(n)}function Ne(n){return Object.entries(n)}function to(n){return Object.fromEntries(n)}function ls(n,t){const e={};let s=!1;for(const[i,r]of Ne(n))t(i,r)?e[i]=r:s=!0;return s?e:n}function ai(n,t){const e={};for(const[s,i]of Ne(n)){const r=t(s,i);e[s]=r}return e}function so(n,t){if(n===t)return!0;const e=new Set(Object.keys(n)),s=new Set(Object.keys(t));if(e.size!==s.size)return!1;for(const i of e)if(!s.has(i)||!Object.is(n[i],t[i]))return!1;return!0}const Ae="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",no="a0",io="A00000000000000000000000000";function ro(n){if(n>="a"&&n<="z")return n.charCodeAt(0)-97+2;if(n>="A"&&n<="Z")return 90-n.charCodeAt(0)+2;throw new Error("Invalid index key head: "+n)}function oo(n){if(n.length!==ro(n.charAt(0)))throw new Error("invalid integer part of index key: "+n)}function Hi(n){if(n===void 0)throw Error("n is undefined")}function Yi(n){oo(n);const[t,...e]=n.split("");let s=!0;for(let i=e.length-1;s&&i>=0;i--){const r=Ae.indexOf(e[i])+1;r===Ae.length?e[i]="0":(e[i]=Ae.charAt(r),s=!1)}if(s){if(t==="Z")return"a0";if(t==="z")return;const i=String.fromCharCode(t.charCodeAt(0)+1);return i>"a"?e.push("0"):e.pop(),i+e.join("")}else return t+e.join("")}function hc(n){oo(n);const[t,...e]=n.split("");let s=!0;for(let i=e.length-1;s&&i>=0;i--){const r=Ae.indexOf(e[i])-1;r===-1?e[i]=Ae.slice(-1):(e[i]=Ae.charAt(r),s=!1)}if(s){if(t==="a")return"Z"+Ae.slice(-1);if(t==="A")return;const i=String.fromCharCode(t.charCodeAt(0)-1);return i<"Z"?e.push(Ae.slice(-1)):e.pop(),i+e.join("")}else return t+e.join("")}function Bt(n,t){if(t!==void 0&&n>=t)throw new Error(n+" >= "+t);if(n.slice(-1)==="0"||t&&t.slice(-1)==="0")throw new Error("trailing zero");if(t){let i=0;for(;(n.charAt(i)||"0")===t.charAt(i);)i++;if(i>0)return t.slice(0,i)+Bt(n.slice(i),t.slice(i))}const e=n?Ae.indexOf(n.charAt(0)):0,s=t!==void 0?Ae.indexOf(t.charAt(0)):Ae.length;if(s-e>1){const i=Math.round(.5*(e+s));return Ae.charAt(i)}else return t&&t.length>1?t.slice(0,1):Ae.charAt(e)+Bt(n.slice(1),void 0)}function as(n){const t=ro(n.charAt(0));if(t>n.length)throw new Error("invalid index: "+n);return n.slice(0,t)}function Hn(n){if(n===io)throw new Error("invalid index: "+n);const t=as(n);if(n.slice(t.length).slice(-1)==="0")throw new Error("invalid index: "+n)}function Rt(n,t){if(n!==void 0&&Hn(n),t!==void 0&&Hn(t),n!==void 0&&t!==void 0&&n>=t)throw new Error(n+" >= "+t);if(n===void 0&&t===void 0)return no;if(n===void 0){if(t===void 0)throw Error("b is undefined");const a=as(t),c=t.slice(a.length);if(a===io)return a+Bt("",c);if(a<t)return a;const l=hc(a);return Hi(l),l}if(t===void 0){const a=as(n),c=n.slice(a.length),l=Yi(a);return l===void 0?a+Bt(c,void 0):l}const e=as(n),s=n.slice(e.length),i=as(t),r=t.slice(i.length);if(e===i)return e+Bt(s,r);const o=Yi(e);return Hi(o),o<t?o:e+Bt(s,void 0)}function St(n,t,e){if(e===0)return[];if(e===1)return[Rt(n,t)];if(t===void 0){let r=Rt(n,t);const o=[r];for(let a=0;a<e-1;a++)r=Rt(r,t),o.push(r);return o}if(n===void 0){let r=Rt(n,t);const o=[r];for(let a=0;a<e-1;a++)r=Rt(n,r),o.push(r);return o.reverse(),o}const s=Math.floor(e/2),i=Rt(n,t);return[...St(n,i,s),i,...St(i,t,e-s-1)]}const kf=no;function uc(n){Hn(n)}function Gt(n,t,e){return St(n,t,e)}function En(n,t){return St(n,void 0,t)}function Gi(n,t){return St(n,t,1)[0]}function qt(n){return St(n,void 0,1)[0]}function Tf(n){return St(void 0,n,1)[0]}function Yn(n,t="a1"){return[t,...St(t,void 0,n)]}function Ue(n,t){return n.index<t.index?-1:n.index>t.index?1:0}function pc(n,t){return n.id>t.id?1:-1}function ao(n){try{return localStorage.getItem(n)}catch{return null}}function co(n,t){try{localStorage.setItem(n,t)}catch{}}function fc(){try{localStorage.clear()}catch{}}function lo(n){try{return sessionStorage.getItem(n)}catch{return null}}function ci(n,t){try{sessionStorage.setItem(n,t)}catch{}}function ho(n){try{sessionStorage.removeItem(n)}catch{}}function gc(){try{sessionStorage.clear()}catch{}}const Ut=[],mc=60,$s=Math.ceil(1e3/mc);let Wt,_n=0,Gn=0;const yc=()=>{const n=Ut.splice(0,Ut.length);for(const t of n)t()};function uo(){if(Wt)return;const n=Date.now(),t=n-Gn;if(_n+t<$s){Wt=requestAnimationFrame(()=>{Wt=void 0,uo()});return}Wt=requestAnimationFrame(()=>{Wt=void 0,Gn=n,_n=Math.min(_n+t-$s,$s*10),yc()})}let Xi=!1;function po(n){return Ut.includes(n)||(Ut.push(n),Xi||(Xi=!0,Gn=Date.now()-$s-1),uo()),()=>{const t=Ut.indexOf(n);t>-1&&Ut.splice(t,1)}}class Sc{constructor(){u(this,"timeouts",[]);u(this,"intervals",[]);u(this,"rafs",[])}setTimeout(t,e,...s){const i=window.setTimeout(t,e,s);return this.timeouts.push(i),i}setInterval(t,e,...s){const i=window.setInterval(t,e,s);return this.intervals.push(i),i}requestAnimationFrame(t){const e=window.requestAnimationFrame(t);return this.rafs.push(e),e}dispose(){this.timeouts.forEach(t=>clearTimeout(t)),this.intervals.forEach(t=>clearInterval(t)),this.rafs.forEach(t=>cancelAnimationFrame(t)),this.timeouts.length=0,this.intervals.length=0,this.rafs.length=0}}function Mf(n){return n!==null}function wc(){return typeof globalThis<"u"&&globalThis.structuredClone?[globalThis.structuredClone,!0]:typeof global<"u"&&global.structuredClone?[global.structuredClone,!0]:typeof window<"u"&&window.structuredClone?[window.structuredClone,!0]:[n=>n&&JSON.parse(JSON.stringify(n)),!1]}const fo=wc(),ue=fo[0];fo[1];const bc=Object.getPrototypeOf(ue({}));var kn={};const go={enableLicensing:xc("enableLicensing",{defaults:{all:!0,production:!1}})},mo=Ie("pointerCaptureTrackingObject",{defaults:{all:new Map},shouldStoreForSession:!1}),Ce={logPreventDefaults:Ie("logPreventDefaults",{defaults:{all:!1}}),logPointerCaptures:Ie("logPointerCaptures",{defaults:{all:!1}}),logElementRemoves:Ie("logElementRemoves",{defaults:{all:!1}}),debugSvg:Ie("debugSvg",{defaults:{all:!1}}),showFps:Ie("showFps",{defaults:{all:!1}}),measurePerformance:Ie("measurePerformance",{defaults:{all:!1}}),throwToBlob:Ie("throwToBlob",{defaults:{all:!1}}),reconnectOnPing:Ie("reconnectOnPing",{defaults:{all:!1}}),debugCursors:Ie("debugCursors",{defaults:{all:!1}}),forceSrgb:Ie("forceSrgbColors",{defaults:{all:!1}}),debugGeometry:Ie("debugGeometry",{defaults:{all:!1}}),hideShapes:Ie("hideShapes",{defaults:{all:!1}}),editOnType:Ie("editOnType",{defaults:{all:!1}})};if(typeof Element<"u"){const n=Element.prototype.removeChild;xs("element removal logging",()=>{Ce.logElementRemoves.get()?Element.prototype.removeChild=function(t){return console.warn("[tldraw] removing child:",t),n.call(this,t)}:Element.prototype.removeChild=n})}function Ie(n,{defaults:t,shouldStoreForSession:e=!0}){return yo({name:n,defaults:t,shouldStoreForSession:e})}function xc(n,{defaults:t,shouldStoreForSession:e=!0}){return yo({name:n,defaults:t,shouldStoreForSession:e})}function yo(n){const t=vc(n),e=n.shouldStoreForSession?Ic(n.name):null,s=fe(`debug:${n.name}`,e??t);return typeof window<"u"&&(n.shouldStoreForSession&&xs(`debug:${n.name}`,()=>{const i=s.get();i===t?ho(`tldraw_debug:${n.name}`):ci(`tldraw_debug:${n.name}`,JSON.stringify(i))}),Object.defineProperty(window,`tldraw${n.name.replace(/^[a-z]/,i=>i.toUpperCase())}`,{get(){return s.get()},set(i){s.set(i)},configurable:!0})),Object.assign(s,n)}function Ic(n){try{return JSON.parse(lo(`tldraw_debug:${n}`)??"null")}catch{return null}}function Tn(n){try{return n()}catch{return null}}function vc(n){switch(Tn(()=>kn.TLDRAW_ENV)??Tn(()=>kn.VERCEL_PUBLIC_TLDRAW_ENV)??Tn(()=>kn.NEXT_PUBLIC_TLDRAW_ENV)??"production"){case"production":return n.defaults.production??n.defaults.all;case"preview":case"staging":return n.defaults.staging??n.defaults.all;default:return n.defaults.development??n.defaults.all}}class Ks{constructor(t){u(this,"nextValue");u(this,"diff");this.previousValue=t}get(){var s,i,r,o;const t=((i=(s=this.diff)==null?void 0:s.removed)==null?void 0:i.size)??0,e=((o=(r=this.diff)==null?void 0:r.added)==null?void 0:o.size)??0;if(!(t===0&&e===0))return{value:this.nextValue,diff:this.diff}}_add(t,e){var s,i;this.nextValue??(this.nextValue=new Set(this.previousValue)),this.nextValue.add(t),this.diff??(this.diff={}),e?(s=this.diff.removed)==null||s.delete(t):((i=this.diff).added??(i.added=new Set),this.diff.added.add(t))}add(t){var i,r,o;const e=this.previousValue.has(t);if(e)return((r=(i=this.diff)==null?void 0:i.removed)==null?void 0:r.has(t))?this._add(t,e):void 0;(o=this.nextValue)!=null&&o.has(t)||this._add(t,e)}_remove(t,e){var s,i;this.nextValue??(this.nextValue=new Set(this.previousValue)),this.nextValue.delete(t),this.diff??(this.diff={}),e?((s=this.diff).removed??(s.removed=new Set),this.diff.removed.add(t)):(i=this.diff.added)==null||i.delete(t)}remove(t){var i,r,o,a;const e=this.previousValue.has(t);if(!e)return((r=(i=this.diff)==null?void 0:i.added)==null?void 0:r.has(t))?this._remove(t,e):void 0;(a=(o=this.diff)==null?void 0:o.removed)!=null&&a.has(t)||this._remove(t,e)}}class dn{constructor(t,e){u(this,"createDefaultProperties");u(this,"validator");u(this,"ephemeralKeys");u(this,"ephemeralKeySet");u(this,"scope");u(this,"isInstance",t=>(t==null?void 0:t.typeName)===this.typeName);this.typeName=t,this.createDefaultProperties=e.createDefaultProperties,this.validator=e.validator??{validate:i=>i},this.scope=e.scope??"document",this.ephemeralKeys=e.ephemeralKeys;const s=new Set;if(e.ephemeralKeys)for(const[i,r]of Ne(e.ephemeralKeys))r&&s.add(i);this.ephemeralKeySet=s}create(t){const e={...this.createDefaultProperties(),id:this.createId()};for(const[s,i]of Object.entries(t))i!==void 0&&(e[s]=i);return e.typeName=this.typeName,e}clone(t){return{...ue(t),id:this.createId()}}createId(t){return this.typeName+":"+(t??bs())}createCustomId(t){return this.typeName+":"+t}parseId(t){if(!this.isId(t))throw new Error(`ID "${t}" is not a valid ID for type "${this.typeName}"`);return t.slice(this.typeName.length+1)}isId(t){if(!t)return!1;for(let e=0;e<this.typeName.length;e++)if(t[e]!==this.typeName[e])return!1;return t[this.typeName.length]===":"}withDefaultProperties(t){return new dn(this.typeName,{createDefaultProperties:t,validator:this.validator,scope:this.scope,ephemeralKeys:this.ephemeralKeys})}validate(t,e){return e&&this.validator.validateUsingKnownGoodVersion?this.validator.validateUsingKnownGoodVersion(e,t):this.validator.validate(t)}}function et(n,t){return new dn(n,{createDefaultProperties:()=>({}),validator:t.validator,scope:t.scope,ephemeralKeys:t.ephemeralKeys})}function Qs(){return{added:{},updated:{},removed:{}}}function Xn(n){const t={added:n.removed,removed:n.added,updated:{}};for(const[e,s]of Object.values(n.updated))t.updated[e.id]=[s,e];return t}function So(n){return Object.keys(n.added).length===0&&Object.keys(n.updated).length===0&&Object.keys(n.removed).length===0}function li(n){const t={added:{},removed:{},updated:{}};return ds(t,n),t}function ds(n,t){for(const e of t){for(const[s,i]of Ne(e.added))if(n.removed[s]){const r=n.removed[s];delete n.removed[s],r!==i&&(n.updated[s]=[r,i])}else n.added[s]=i;for(const[s,[i,r]]of Ne(e.updated)){if(n.added[s]){n.added[s]=r,delete n.updated[s],delete n.removed[s];continue}if(n.updated[s]){n.updated[s]=[n.updated[s][0],r],delete n.removed[s];continue}n.updated[s]=e.updated[s],delete n.removed[s]}for(const[s,i]of Ne(e.removed))n.added[s]?delete n.added[s]:n.updated[s]?(n.removed[s]=n.updated[s][0],delete n.updated[s]):n.removed[s]=i}}function Pc(n){if(n.length===0)return new Set;const t=n[0],e=n.slice(1),s=new Set;for(const i of t)e.every(r=>r.has(i))&&s.add(i);return s}function Cc(n,t){const e={};for(const s of t)n.has(s)||(e.added??(e.added=new Set),e.added.add(s));for(const s of n)t.has(s)||(e.removed??(e.removed=new Set),e.removed.add(s));return e.added||e.removed?e:void 0}function qi(n,t){for(const[e,s]of Object.entries(n)){const i=s,r=t[e];if("eq"in i&&r!==i.eq||"neq"in i&&r===i.neq||"gt"in i&&(typeof r!="number"||r<=i.gt))return!1}return!0}function Wi(n,t,e){const s=Object.fromEntries(Object.keys(e).map(i=>[i,new Set]));for(const[i,r]of Object.entries(e))if("eq"in r){const a=n.index(t,i).get().get(r.eq);if(a)for(const c of a)s[i].add(c)}else if("neq"in r){const o=n.index(t,i);for(const[a,c]of o.get())if(a!==r.neq)for(const l of c)s[i].add(l)}else if("gt"in r){const o=n.index(t,i);for(const[a,c]of o.get())if(a>r.gt)for(const l of c)s[i].add(l)}return Pc(Object.values(s))}class Ec{constructor(t,e){u(this,"indexCache",new Map);u(this,"historyCache",new Map);this.atoms=t,this.history=e}filterHistory(t){if(this.historyCache.has(t))return this.historyCache.get(t);const e=C("filterHistory:"+t,(s,i)=>{if(Ct(s))return this.history.get();const r=this.history.getDiffSince(i);if(r===Re)return this.history.get();const o={added:{},removed:{},updated:{}};let a=0,c=0,l=0;for(const d of r){for(const h of oe(d.added))if(h.typeName===t)if(o.removed[h.id]){const p=o.removed[h.id];delete o.removed[h.id],c--,p!==h&&(o.updated[h.id]=[p,h],l++)}else o.added[h.id]=h,a++;for(const[h,p]of oe(d.updated))p.typeName===t&&(o.added[p.id]?o.added[p.id]=p:o.updated[p.id]?o.updated[p.id]=[o.updated[p.id][0],p]:(o.updated[p.id]=[h,p],l++));for(const h of oe(d.removed))h.typeName===t&&(o.added[h.id]?(delete o.added[h.id],a--):o.updated[h.id]?(o.removed[h.id]=o.updated[h.id][0],delete o.updated[h.id],l--,c++):(o.removed[h.id]=h,c++))}return a||c||l?is(this.history.get(),o):s},{historyLength:100});return this.historyCache.set(t,e),e}index(t,e){const s=t+":"+e;if(this.indexCache.has(s))return this.indexCache.get(s);const i=this.__uncached_createIndex(t,e);return this.indexCache.set(s,i),i}__uncached_createIndex(t,e){const s=this.filterHistory(t),i=()=>{s.get();const r=new Map;for(const o of oe(this.atoms.get())){const a=o.get();if(a.typeName===t){const c=a[e];r.has(c)||r.set(c,new Set),r.get(c).add(a.id)}}return r};return C("index:"+t+":"+e,(r,o)=>{if(Ct(r))return i();const a=s.getDiffSince(o);if(a===Re)return i();const c=new Map,l=(f,S)=>{let g=c.get(f);g||(g=new Ks(r.get(f)??new Set)),g.add(S),c.set(f,g)},d=(f,S)=>{let g=c.get(f);g||(g=new Ks(r.get(f)??new Set)),g.remove(S),c.set(f,g)};for(const f of a){for(const S of oe(f.added))if(S.typeName===t){const g=S[e];l(g,S.id)}for(const[S,g]of oe(f.updated))if(g.typeName===t){const w=S[e],b=g[e];w!==b&&(d(w,g.id),l(b,g.id))}for(const S of oe(f.removed))if(S.typeName===t){const g=S[e];d(g,S.id)}}let h,p;for(const[f,S]of c){const g=S.get();g&&(h||(h=new Map(r)),p||(p=new Map),g.value.size===0?h.delete(f):h.set(f,g.value),p.set(f,g.diff))}return h&&p?is(h,p):r},{historyLength:100})}record(t,e=()=>({}),s="record:"+t+(e?":"+e.toString():"")){const i=this.ids(t,e,s);return C(s,()=>{var r;for(const o of i.get())return(r=this.atoms.get()[o])==null?void 0:r.get()})}records(t,e=()=>({}),s="records:"+t+(e?":"+e.toString():"")){const i=this.ids(t,e,"ids:"+s);return C(s,()=>[...i.get()].map(r=>{const o=this.atoms.get()[r];if(!o)throw new Error("no atom found for record id: "+r);return o.get()}))}ids(t,e=()=>({}),s="ids:"+t+(e?":"+e.toString():"")){const i=this.filterHistory(t),r=()=>{i.get();const c=e();return Object.keys(c).length===0?new Set(oe(this.atoms.get()).flatMap(l=>{const d=l.get();return d.typeName===t?d.id:[]})):Wi(this,t,c)},o=c=>{const l=r(),d=Cc(c,l);return d?is(l,d):c},a=C("ids_query:"+s,e,{isEqual:Ta});return C("query:"+s,(c,l)=>{const d=a.get();if(Ct(c))return r();if(l<a.lastChangedEpoch)return o(c);const h=i.getDiffSince(l);if(h===Re)return o(c);const p=new Ks(c);for(const S of h){for(const g of oe(S.added))g.typeName===t&&qi(d,g)&&p.add(g.id);for(const[g,w]of oe(S.updated))w.typeName===t&&(qi(d,w)?p.add(w.id):p.remove(w.id));for(const g of oe(S.removed))g.typeName===t&&p.remove(g.id)}const f=p.get();return f?is(f.value,f.diff):c},{historyLength:50})}exec(t,e){const s=Wi(this,t,e);if(s.size===0)return ht;const i=this.atoms.get();return[...s].map(r=>i[r].get())}}class _c{constructor(t){u(this,"_beforeCreateHandlers",{});u(this,"_afterCreateHandlers",{});u(this,"_beforeChangeHandlers",{});u(this,"_afterChangeHandlers",{});u(this,"_beforeDeleteHandlers",{});u(this,"_afterDeleteHandlers",{});u(this,"_operationCompleteHandlers",[]);u(this,"_isEnabled",!0);this.store=t}isEnabled(){return this._isEnabled}setIsEnabled(t){this._isEnabled=t}handleBeforeCreate(t,e){if(!this._isEnabled)return t;const s=this._beforeCreateHandlers[t.typeName];if(s){let i=t;for(const r of s)i=r(i,e);return i}return t}handleAfterCreate(t,e){if(!this._isEnabled)return;const s=this._afterCreateHandlers[t.typeName];if(s)for(const i of s)i(t,e)}handleBeforeChange(t,e,s){if(!this._isEnabled)return e;const i=this._beforeChangeHandlers[e.typeName];if(i){let r=e;for(const o of i)r=o(t,r,s);return r}return e}handleAfterChange(t,e,s){if(!this._isEnabled)return;const i=this._afterChangeHandlers[e.typeName];if(i)for(const r of i)r(t,e,s)}handleBeforeDelete(t,e){if(!this._isEnabled)return!0;const s=this._beforeDeleteHandlers[t.typeName];if(s){for(const i of s)if(i(t,e)===!1)return!1}return!0}handleAfterDelete(t,e){if(!this._isEnabled)return;const s=this._afterDeleteHandlers[t.typeName];if(s)for(const i of s)i(t,e)}handleOperationComplete(t){if(this._isEnabled)for(const e of this._operationCompleteHandlers)e(t)}register(t){const e=[];for(const[s,i]of Object.entries(t))i!=null&&i.beforeCreate&&e.push(this.registerBeforeCreateHandler(s,i.beforeCreate)),i!=null&&i.afterCreate&&e.push(this.registerAfterCreateHandler(s,i.afterCreate)),i!=null&&i.beforeChange&&e.push(this.registerBeforeChangeHandler(s,i.beforeChange)),i!=null&&i.afterChange&&e.push(this.registerAfterChangeHandler(s,i.afterChange)),i!=null&&i.beforeDelete&&e.push(this.registerBeforeDeleteHandler(s,i.beforeDelete)),i!=null&&i.afterDelete&&e.push(this.registerAfterDeleteHandler(s,i.afterDelete));return()=>{for(const s of e)s()}}registerBeforeCreateHandler(t,e){return this._beforeCreateHandlers[t]||(this._beforeCreateHandlers[t]=[]),this._beforeCreateHandlers[t].push(e),()=>It(this._beforeCreateHandlers[t],e)}registerAfterCreateHandler(t,e){return this._afterCreateHandlers[t]||(this._afterCreateHandlers[t]=[]),this._afterCreateHandlers[t].push(e),()=>It(this._afterCreateHandlers[t],e)}registerBeforeChangeHandler(t,e){return this._beforeChangeHandlers[t]||(this._beforeChangeHandlers[t]=[]),this._beforeChangeHandlers[t].push(e),()=>It(this._beforeChangeHandlers[t],e)}registerAfterChangeHandler(t,e){return this._afterChangeHandlers[t]||(this._afterChangeHandlers[t]=[]),this._afterChangeHandlers[t].push(e),()=>It(this._afterChangeHandlers[t],e)}registerBeforeDeleteHandler(t,e){return this._beforeDeleteHandlers[t]||(this._beforeDeleteHandlers[t]=[]),this._beforeDeleteHandlers[t].push(e),()=>It(this._beforeDeleteHandlers[t],e)}registerAfterDeleteHandler(t,e){return this._afterDeleteHandlers[t]||(this._afterDeleteHandlers[t]=[]),this._afterDeleteHandlers[t].push(e),()=>It(this._afterDeleteHandlers[t],e)}registerOperationCompleteHandler(t){return this._operationCompleteHandlers.push(t),()=>It(this._operationCompleteHandlers,t)}}function It(n,t){const e=n.indexOf(t);e>=0&&n.splice(e,1)}class di{constructor(t){u(this,"id");u(this,"atoms",fe("store_atoms",{}));u(this,"history",fe("history",0,{historyLength:1e3}));u(this,"query",new Ec(this.atoms,this.history));u(this,"listeners",new Set);u(this,"historyAccumulator",new Tc);u(this,"historyReactor");u(this,"cancelHistoryReactor",()=>{});u(this,"schema");u(this,"props");u(this,"scopedTypes");u(this,"sideEffects",new _c(this));u(this,"put",(t,e)=>{this.atomic(()=>{const s={},i={},r=this.atoms.__unsafe__getWithoutCapture();let o=null,a,c=!1;const l=this.isMergingRemoteChanges?"remote":"user";for(let d=0,h=t.length;d<h;d++){a=t[d];const p=(o??r)[a.id];if(p){const f=p.__unsafe__getWithoutCapture();if(a=this.sideEffects.handleBeforeChange(f,a,l),this.schema.validateRecord(this,a,e??"updateRecord",f)===f)continue;p.set(a),c=!0;const g=p.__unsafe__getWithoutCapture();s[a.id]=[f,g],this.addDiffForAfterEvent(f,g)}else a=this.sideEffects.handleBeforeCreate(a,l),c=!0,a=this.schema.validateRecord(this,a,e??"createRecord",null),i[a.id]=a,this.addDiffForAfterEvent(null,a),o||(o={...r}),o[a.id]=fe("atom:"+a.id,a)}o&&this.atoms.set(o),c&&this.updateHistory({added:i,updated:s,removed:{}})})});u(this,"remove",t=>{this.atomic(()=>{const e=new Set,s=this.isMergingRemoteChanges?"remote":"user";if(this.sideEffects.isEnabled())for(const r of t){const o=this.atoms.__unsafe__getWithoutCapture()[r];o&&this.sideEffects.handleBeforeDelete(o.get(),s)===!1&&e.add(r)}let i;this.atoms.update(r=>{let o;for(const a of t){if(e.has(a)||!(a in r))continue;o||(o={...r}),i||(i={}),delete o[a];const c=r[a].get();i[a]=c,this.addDiffForAfterEvent(c,null)}return o??r}),i&&this.updateHistory({added:{},updated:{},removed:i})})});u(this,"get",t=>{var e;return(e=this.atoms.get()[t])==null?void 0:e.get()});u(this,"unsafeGetWithoutCapture",t=>{var e;return(e=this.atoms.__unsafe__getWithoutCapture()[t])==null?void 0:e.__unsafe__getWithoutCapture()});u(this,"serialize",(t="document")=>{const e={};for(const[s,i]of Ne(this.atoms.get())){const r=i.get();(t==="all"||this.scopedTypes[t].has(r.typeName))&&(e[s]=r)}return e});u(this,"allRecords",()=>oe(this.atoms.get()).map(t=>t.get()));u(this,"clear",()=>{this.remove(Ki(this.atoms.get()))});u(this,"update",(t,e)=>{const s=this.atoms.get()[t];if(!s){console.error(`Record ${t} not found. This is probably an error`);return}this.put([e(s.__unsafe__getWithoutCapture())])});u(this,"has",t=>!!this.atoms.get()[t]);u(this,"listen",(t,e)=>{this._flushHistory();const s={onHistory:t,filters:{source:(e==null?void 0:e.source)??"all",scope:(e==null?void 0:e.scope)??"all"}};return this.listeners.add(s),this.historyReactor.scheduler.isActivelyListening||this.historyReactor.start(),()=>{this.listeners.delete(s),this.listeners.size===0&&this.historyReactor.stop()}});u(this,"isMergingRemoteChanges",!1);u(this,"mergeRemoteChanges",t=>{if(this.isMergingRemoteChanges)return t();if(this._isInAtomicOp)throw new Error("Cannot merge remote changes while in atomic operation");try{this.isMergingRemoteChanges=!0,ut(t)}finally{this.isMergingRemoteChanges=!1}});u(this,"createComputedCache",(t,e,s)=>{const i=new gs;return{get:r=>{const o=this.atoms.get()[r];if(o)return i.get(o,()=>{const a=s?C(o.name+":equals",()=>o.get(),{isEqual:s}):o;return C(t+":"+r,()=>e(a.get()))}).get()}}});u(this,"createSelectedComputedCache",(t,e,s)=>{const i=new gs;return{get:r=>{const o=this.atoms.get()[r];if(o)return i.get(o,()=>{const a=C(t+":"+r+":selector",()=>e(o.get()));return C(t+":"+r,()=>s(a.get()))}).get()}}});u(this,"_integrityChecker");u(this,"_isPossiblyCorrupted",!1);u(this,"pendingAfterEvents",null);u(this,"_isInAtomicOp",!1);const{initialData:e,schema:s,id:i}=t;this.id=i??bs(),this.schema=s,this.props=t.props,e&&this.atoms.set(to(Ne(e).map(([r,o])=>[r,fe("atom:"+r,this.schema.validateRecord(this,o,"initialize",null))]))),this.historyReactor=za("Store.historyReactor",()=>{this.history.get(),this._flushHistory()},{scheduleEffect:r=>this.cancelHistoryReactor=po(r)}),this.scopedTypes={document:new Set(oe(this.schema.types).filter(r=>r.scope==="document").map(r=>r.typeName)),session:new Set(oe(this.schema.types).filter(r=>r.scope==="session").map(r=>r.typeName)),presence:new Set(oe(this.schema.types).filter(r=>r.scope==="presence").map(r=>r.typeName))}}_flushHistory(){if(this.historyAccumulator.hasChanges()){const t=this.historyAccumulator.flush();for(const{changes:e,source:s}of t){let i=null,r=null,o=null;for(const{onHistory:a,filters:c}of this.listeners)if(!(c.source!=="all"&&c.source!==s))if(c.scope!=="all")if(c.scope==="document"){if(r??(r=this.filterChangesByScope(e,"document")),!r)continue;a({changes:r,source:s})}else if(c.scope==="session"){if(i??(i=this.filterChangesByScope(e,"session")),!i)continue;a({changes:i,source:s})}else{if(o??(o=this.filterChangesByScope(e,"presence")),!o)continue;a({changes:o,source:s})}else a({changes:e,source:s})}}}dispose(){this.cancelHistoryReactor()}filterChangesByScope(t,e){const s={added:ls(t.added,(i,r)=>this.scopedTypes[e].has(r.typeName)),updated:ls(t.updated,(i,r)=>this.scopedTypes[e].has(r[1].typeName)),removed:ls(t.removed,(i,r)=>this.scopedTypes[e].has(r.typeName))};return Object.keys(s.added).length===0&&Object.keys(s.updated).length===0&&Object.keys(s.removed).length===0?null:s}updateHistory(t){this.historyAccumulator.add({changes:t,source:this.isMergingRemoteChanges?"remote":"user"}),this.listeners.size===0&&this.historyAccumulator.clear(),this.history.set(this.history.get()+1,t)}validate(t){this.allRecords().forEach(e=>this.schema.validateRecord(this,e,t,null))}getStoreSnapshot(t="document"){return{store:this.serialize(t),schema:this.schema.serialize()}}getSnapshot(t="document"){return console.warn("[tldraw] `Store.getSnapshot` is deprecated and will be removed in a future release. Use `getSnapshot` from the `tldraw` package instead."),this.getStoreSnapshot(t)}migrateSnapshot(t){const e=this.schema.migrateStoreSnapshot(t);if(e.type==="error")throw new Error(`Failed to migrate snapshot: ${e.reason}`);return{store:e.value,schema:this.schema.serialize()}}loadStoreSnapshot(t){const e=this.schema.migrateStoreSnapshot(t);if(e.type==="error")throw new Error(`Failed to migrate snapshot: ${e.reason}`);const s=this.sideEffects.isEnabled();try{this.sideEffects.setIsEnabled(!1),this.atomic(()=>{this.clear(),this.put(Object.values(e.value)),this.ensureStoreIsUsable()})}finally{this.sideEffects.setIsEnabled(s)}}loadSnapshot(t){console.warn("[tldraw] `Store.loadSnapshot` is deprecated and will be removed in a future release. Use `loadSnapshot` from the 'tldraw' package instead."),this.loadStoreSnapshot(t)}extractingChanges(t){const e=[],s=this.historyAccumulator.addInterceptor(i=>e.push(i.changes));try{return ut(t),li(e)}finally{s()}}applyDiff(t,{runCallbacks:e=!0,ignoreEphemeralKeys:s=!1}={}){this.atomic(()=>{const i=oe(t.added);for(const[o,a]of oe(t.updated)){const c=this.schema.getType(a.typeName);if(s&&c.ephemeralKeySet.size){const l=this.get(a.id);if(!l){i.push(a);continue}let d=null;for(const[h,p]of Object.entries(a))c.ephemeralKeySet.has(h)||Object.is(p,Ee(l,h))||(d||(d={...l}),d[h]=p);d&&i.push(d)}else i.push(a)}const r=Ki(t.removed);i.length&&this.put(i),r.length&&this.remove(r)},e)}ensureStoreIsUsable(){this.atomic(()=>{var t;this._integrityChecker??(this._integrityChecker=this.schema.createIntegrityChecker(this)),(t=this._integrityChecker)==null||t.call(this)})}markAsPossiblyCorrupted(){this._isPossiblyCorrupted=!0}isPossiblyCorrupted(){return this._isPossiblyCorrupted}addDiffForAfterEvent(t,e){if(de(this.pendingAfterEvents,"must be in event operation"),t===e||(t&&e&&de(t.id===e.id),!t&&!e))return;const s=(t||e).id,i=this.pendingAfterEvents.get(s);i?i.after=e:this.pendingAfterEvents.set(s,{before:t,after:e})}flushAtomicCallbacks(){let t=0;const e=this.isMergingRemoteChanges?"remote":"user";for(;this.pendingAfterEvents;){const s=this.pendingAfterEvents;if(this.pendingAfterEvents=null,!!this.sideEffects.isEnabled()){if(t++,t>100)throw new Error("Maximum store update depth exceeded, bailing out");for(const{before:i,after:r}of s.values())i&&r?this.sideEffects.handleAfterChange(i,r,e):i&&!r?this.sideEffects.handleAfterDelete(i,e):!i&&r&&this.sideEffects.handleAfterCreate(r,e);this.pendingAfterEvents||this.sideEffects.handleOperationComplete(e)}}}atomic(t,e=!0){return ut(()=>{if(this._isInAtomicOp)return this.pendingAfterEvents||(this.pendingAfterEvents=new Map),t();this.pendingAfterEvents=new Map;const s=this.sideEffects.isEnabled();this.sideEffects.setIsEnabled(e??s),this._isInAtomicOp=!0;try{const i=t();return this.flushAtomicCallbacks(),i}finally{this.pendingAfterEvents=null,this.sideEffects.setIsEnabled(s),this._isInAtomicOp=!1}})}addHistoryInterceptor(t){return this.historyAccumulator.addInterceptor(e=>t(e,this.isMergingRemoteChanges?"remote":"user"))}}function kc(n){if(n.length===0)return[];const t=[];let e=[n[0]],s;for(let i=1,r=n.length;i<r;i++)s=n[i],e[0].source!==s.source&&(t.push(e),e=[]),e.push(s);return t.push(e),t.map(i=>({source:i[0].source,changes:li(i.map(r=>r.changes))}))}class Tc{constructor(){u(this,"_history",[]);u(this,"_interceptors",new Set)}addInterceptor(t){return this._interceptors.add(t),()=>{this._interceptors.delete(t)}}add(t){this._history.push(t);for(const e of this._interceptors)e(t)}flush(){const t=kc(this._history);return this._history=[],t}clear(){this._history=[]}hasChanges(){return this._history.length>0}}function Af(n,t,e){const s=new gs;return{get(i,r){return s.get(i,()=>(i instanceof di?i:i.store).createComputedCache(n,c=>t(i,c),e)).get(r)}}}function Mc(n){const t=[];for(let e=n.length-1;e>=0;e--){const s=n[e];if("id"in s)t.unshift(s);else{const i=s.dependsOn,r=t[0];r&&(t[0]={...r,dependsOn:i.concat(r.dependsOn??[])})}}return t}function Kt({sequence:n,sequenceId:t,retroactive:e=!0}){const s={sequenceId:t,retroactive:e,sequence:Mc(n)};return wo(s),s}function Te(n,t){return Object.fromEntries(Ne(t).map(([e,s])=>[e,`${n}/${s}`]))}function Oe(n){const t=n.sequenceId;return Kt({sequenceId:t,retroactive:n.retroactive??!0,sequence:n.sequence.map(e=>"id"in e?{...e,scope:"record",filter:s=>{var i,r;return s.typeName===n.recordType&&(((i=e.filter)==null?void 0:i.call(e,s))??!0)&&(((r=n.filter)==null?void 0:r.call(n,s))??!0)}}:e)})}function Ac(n){const t=new Map(n.map(r=>[r.id,r])),e=new Set,s=[];function i(r){de(!e.has(r.id),`Circular dependency in migrations: ${r.id}`),e.add(r.id);const{version:o,sequenceId:a}=Js(r.id),c=t.get(`${a}/${o-1}`);if(c&&i(c),r.dependsOn)for(const l of r.dependsOn){const d=t.get(l);d&&i(d)}t.delete(r.id),s.push(r)}for(const r of t.values())i(r);return s}function Js(n){const[t,e]=n.split("/");return{sequenceId:t,version:parseInt(e)}}function Vi(n,t){t&&de(n.startsWith(t+"/"),`Every migration in sequence '${t}' must have an id starting with '${t}/'. Got invalid id: '${n}'`),de(n.match(/^(.*?)\/(0|[1-9]\d*)$/),`Invalid migration id: '${n}'`)}function wo(n){if(de(!n.sequenceId.includes("/"),`sequenceId cannot contain a '/', got ${n.sequenceId}`),de(n.sequenceId.length,"sequenceId must be a non-empty string"),n.sequence.length===0)return;Vi(n.sequence[0].id,n.sequenceId);let t=Js(n.sequence[0].id).version;de(t===1,`Expected the first migrationId to be '${n.sequenceId}/1' but got '${n.sequence[0].id}'`);for(let e=1;e<n.sequence.length;e++){const s=n.sequence[e].id;Vi(s,n.sequenceId);const i=Js(s).version;de(i===t+1,`Migration id numbers must increase in increments of 1, expected ${n.sequenceId}/${t+1} but got '${n.sequence[e].id}'`),t=i}}var ft=(n=>(n.IncompatibleSubtype="incompatible-subtype",n.UnknownType="unknown-type",n.TargetVersionTooNew="target-version-too-new",n.TargetVersionTooOld="target-version-too-old",n.MigrationError="migration-error",n.UnrecognizedSubtype="unrecognized-subtype",n))(ft||{});function Dc(n){if(n.schemaVersion>2||n.schemaVersion<1)return yt.err("Bad schema version");if(n.schemaVersion===2)return yt.ok(n);const t={schemaVersion:2,sequences:{}};for(const[e,s]of Object.entries(n.recordVersions))if(t.sequences[`com.tldraw.${e}`]=s.version,"subTypeKey"in s)for(const[i,r]of Object.entries(s.subTypeVersions))t.sequences[`com.tldraw.${e}.${i}`]=r;return yt.ok(t)}class hi{constructor(t,e){u(this,"migrations",{});u(this,"sortedMigrations");var i;this.types=t,this.options=e;for(const r of e.migrations??[])de(!this.migrations[r.sequenceId],`Duplicate migration sequenceId ${r.sequenceId}`),wo(r),this.migrations[r.sequenceId]=r;const s=Object.values(this.migrations).flatMap(r=>r.sequence);this.sortedMigrations=Ac(s);for(const r of this.sortedMigrations)if((i=r.dependsOn)!=null&&i.length)for(const o of r.dependsOn){const a=s.find(c=>c.id===o);de(a,`Migration '${r.id}' depends on missing migration '${o}'`)}}static create(t,e){return new hi(t,e??{})}validateRecord(t,e,s,i){try{const r=Ee(this.types,e.typeName);if(!r)throw new Error(`Missing definition for record type ${e.typeName}`);return r.validate(e,i??void 0)}catch(r){if(this.options.onValidationFailure)return this.options.onValidationFailure({store:t,record:e,phase:s,recordBefore:i,error:r});throw r}}getMigrationsSince(t){const e=Dc(t);if(!e.ok)return e;const s=e.value,i=new Set(Object.keys(s.sequences).filter(o=>this.migrations[o]));for(const o in this.migrations)s.sequences[o]===void 0&&this.migrations[o].retroactive&&i.add(o);if(i.size===0)return yt.ok([]);const r=new Set;for(const o of i){const a=s.sequences[o];if(typeof a!="number"&&this.migrations[o].retroactive||a===0){for(const d of this.migrations[o].sequence)r.add(d.id);continue}const c=`${o}/${a}`,l=this.migrations[o].sequence.findIndex(d=>d.id===c);if(l===-1)return yt.err("Incompatible schema?");for(const d of this.migrations[o].sequence.slice(l+1))r.add(d.id)}return yt.ok(this.sortedMigrations.filter(({id:o})=>r.has(o)))}migratePersistedRecord(t,e,s="up"){const i=this.getMigrationsSince(e);if(!i.ok)return console.error("Error migrating record",i.error),{type:"error",reason:ft.MigrationError};let r=i.value;if(r.length===0)return{type:"success",value:t};if(r.some(o=>o.scope==="store"))return{type:"error",reason:s==="down"?ft.TargetVersionTooOld:ft.TargetVersionTooNew};if(s==="down"){if(!r.every(o=>o.down))return{type:"error",reason:ft.TargetVersionTooOld};r=r.slice().reverse()}t=ue(t);try{for(const o of r){if(o.scope==="store")throw new Error;if(!(o.filter?o.filter(t):!0))continue;const c=o[s](t);c&&(t=ue(c))}}catch(o){return console.error("Error migrating record",o),{type:"error",reason:ft.MigrationError}}return{type:"success",value:t}}migrateStoreSnapshot(t){let{store:e}=t;const s=this.getMigrationsSince(t.schema);if(!s.ok)return console.error("Error migrating store",s.error),{type:"error",reason:ft.MigrationError};const i=s.value;if(i.length===0)return{type:"success",value:e};e=ue(e);try{for(const r of i)if(r.scope==="record")for(const[o,a]of Object.entries(e)){if(!(r.filter?r.filter(a):!0))continue;const l=r.up(a);l&&(e[o]=ue(l))}else if(r.scope==="store"){const o=r.up(e);o&&(e=ue(o))}else Ve(r)}catch(r){return console.error("Error migrating store",r),{type:"error",reason:ft.MigrationError}}return{type:"success",value:e}}createIntegrityChecker(t){var e,s;return((s=(e=this.options).createIntegrityChecker)==null?void 0:s.call(e,t))??void 0}serialize(){return{schemaVersion:2,sequences:Object.fromEntries(Object.values(this.migrations).map(({sequenceId:t,sequence:e})=>[t,e.length?Js(e.at(-1).id).version:0]))}}serializeEarliestVersion(){return{schemaVersion:2,sequences:Object.fromEntries(Object.values(this.migrations).map(({sequenceId:t})=>[t,0]))}}getType(t){const e=Ee(this.types,t);return de(e,"record type does not exists"),e}}function Rc(n){if(!n.length)return null;let t="";for(const e of n)typeof e=="number"?t+=`.${e}`:e.startsWith("(")?t.endsWith(")")?t=`${t.slice(0,-1)}, ${e.slice(1)}`:t+=e:t+=`.${e}`;return t=t.replace(/id = [^,]+, /,"").replace(/id = [^)]+/,""),t.startsWith(".")?t.slice(1):t}class q extends Error{constructor(e,s=[]){const i=Rc(s),r=e.split(`
`).map((o,a)=>a===0?o:`  ${o}`).join(`
`);super(s?`At ${i}: ${r}`:r);u(this,"name","ValidationError");this.rawMessage=e,this.path=s}}function _e(n,t){try{return t()}catch(e){throw e instanceof q?new q(e.rawMessage,[n,...e.path]):new q(e.toString(),[n])}}function wt(n){if(n===null)return"null";if(Array.isArray(n))return"an array";const t=typeof n;switch(t){case"bigint":case"boolean":case"function":case"number":case"string":case"symbol":return`a ${t}`;case"object":return`an ${t}`;case"undefined":return"undefined";default:Ve(t)}}class xe{constructor(t,e){this.validationFn=t,this.validateUsingKnownGoodVersionFn=e}validate(t){return this.validationFn(t)}validateUsingKnownGoodVersion(t,e){return Object.is(t,e)?t:this.validateUsingKnownGoodVersionFn?this.validateUsingKnownGoodVersionFn(t,e):this.validate(e)}isValid(t){try{return this.validate(t),!0}catch{return!1}}nullable(){return zc(this)}optional(){return xo(this)}refine(t){return new xe(e=>t(this.validate(e)),(e,s)=>{const i=this.validateUsingKnownGoodVersion(e,s);return Object.is(e,i)?e:t(i)})}check(t,e){return typeof t=="string"?this.refine(s=>(_e(`(check ${t})`,()=>e(s)),s)):this.refine(s=>(t(s),s))}}class Lc extends xe{constructor(t){super(e=>{const s=Zi.validate(e);for(let i=0;i<s.length;i++)_e(i,()=>t.validate(s[i]));return s},(e,s)=>{if(!t.validateUsingKnownGoodVersion)return this.validate(s);const i=Zi.validate(s);let r=e.length!==i.length;for(let o=0;o<i.length;o++){const a=i[o];if(o>=e.length){r=!0,_e(o,()=>t.validate(a));continue}if(Object.is(e[o],a))continue;const c=_e(o,()=>t.validateUsingKnownGoodVersion(e[o],a));Object.is(c,e[o])||(r=!0)}return r?s:e}),this.itemValidator=t}nonEmpty(){return this.check(t=>{if(t.length===0)throw new q("Expected a non-empty array")})}lengthGreaterThan1(){return this.check(t=>{if(t.length<=1)throw new q("Expected an array with length greater than 1")})}}class en extends xe{constructor(t,e=!1){super(s=>{if(typeof s!="object"||s===null)throw new q(`Expected object, got ${wt(s)}`);for(const[i,r]of Object.entries(t))_e(i,()=>{r.validate(Ee(s,i))});if(!e){for(const i of Object.keys(s))if(!Qe(t,i))throw new q("Unexpected property",[i])}return s},(s,i)=>{if(typeof i!="object"||i===null)throw new q(`Expected object, got ${wt(i)}`);let r=!1;for(const[o,a]of Object.entries(t)){const c=Ee(s,o),l=Ee(i,o);if(Object.is(c,l))continue;const d=_e(o,()=>{const h=a;return h.validateUsingKnownGoodVersion?h.validateUsingKnownGoodVersion(c,l):h.validate(l)});Object.is(d,c)||(r=!0)}if(!e){for(const o of Object.keys(i))if(!Qe(t,o))throw new q("Unexpected property",[o])}for(const o of Object.keys(s))if(!Qe(i,o)){r=!0;break}return r?i:s}),this.config=t,this.shouldAllowUnknownProperties=e}allowUnknownProperties(){return new en(this.config,!0)}extend(t){return new en({...this.config,...t})}}class hn extends xe{constructor(t,e,s,i){super(r=>{this.expectObject(r);const{matchingSchema:o,variant:a}=this.getMatchingSchemaAndVariant(r);return o===void 0?this.unknownValueValidation(r,a):_e(`(${t} = ${a})`,()=>o.validate(r))},(r,o)=>{this.expectObject(o),this.expectObject(r);const{matchingSchema:a,variant:c}=this.getMatchingSchemaAndVariant(o);return a===void 0?this.unknownValueValidation(o,c):Ee(r,t)!==Ee(o,t)?_e(`(${t} = ${c})`,()=>a.validate(o)):_e(`(${t} = ${c})`,()=>a.validateUsingKnownGoodVersion?a.validateUsingKnownGoodVersion(r,o):a.validate(o))}),this.key=t,this.config=e,this.unknownValueValidation=s,this.useNumberKeys=i}expectObject(t){if(typeof t!="object"||t===null)throw new q(`Expected an object, got ${wt(t)}`,[])}getMatchingSchemaAndVariant(t){const e=Ee(t,this.key);if(!this.useNumberKeys&&typeof e!="string")throw new q(`Expected a string for key "${this.key}", got ${wt(e)}`);if(this.useNumberKeys&&!Number.isFinite(Number(e)))throw new q(`Expected a number for key "${this.key}", got "${e}"`);return{matchingSchema:Qe(this.config,e)?this.config[e]:void 0,variant:e}}validateUnknownVariants(t){return new hn(this.key,this.config,t,this.useNumberKeys)}}class Oc extends xe{constructor(t,e){super(s=>{if(typeof s!="object"||s===null)throw new q(`Expected object, got ${wt(s)}`);for(const[i,r]of Object.entries(s))_e(i,()=>{t.validate(i),e.validate(r)});return s},(s,i)=>{if(typeof i!="object"||i===null)throw new q(`Expected object, got ${wt(i)}`);let r=!1;for(const[o,a]of Object.entries(i)){if(!Qe(s,o)){r=!0,_e(o,()=>{t.validate(o),e.validate(a)});continue}const c=Ee(s,o),l=a;if(Object.is(c,l))continue;const d=_e(o,()=>e.validateUsingKnownGoodVersion?e.validateUsingKnownGoodVersion(c,l):e.validate(l));Object.is(d,c)||(r=!0)}for(const o of Object.keys(s))if(!Qe(i,o)){r=!0;break}return r?i:s}),this.keyValidator=t,this.valueValidator=e}}function ui(n){return new xe(t=>{if(typeof t!==n)throw new q(`Expected ${n}, got ${wt(t)}`);return t})}const Fc=new xe(n=>n),G=ui("string"),N=ui("number").check(n=>{if(Number.isNaN(n))throw new q("Expected a number, got NaN");if(!Number.isFinite(n))throw new q(`Expected a finite number, got ${n}`)}),tn=N.check(n=>{if(n<0)throw new q(`Expected a positive number, got ${n}`)}),le=N.check(n=>{if(n<=0)throw new q(`Expected a non-zero positive number, got ${n}`)}),bo=N.check(n=>{if(!Number.isInteger(n))throw new q(`Expected an integer, got ${n}`)}),Df=bo.check(n=>{if(n<0)throw new q(`Expected a positive integer, got ${n}`)}),Rf=bo.check(n=>{if(n<=0)throw new q(`Expected a non-zero positive integer, got ${n}`)}),Y=ui("boolean");function ke(n){return new xe(t=>{if(t!==n)throw new q(`Expected ${n}, got ${JSON.stringify(t)}`);return n})}const Zi=new xe(n=>{if(!Array.isArray(n))throw new q(`Expected an array, got ${wt(n)}`);return n});function Se(n){return new Lc(n)}function W(n){return new en(n)}function qn(n){return typeof n=="object"&&n!==null&&(Object.getPrototypeOf(n)===Object.prototype||Object.getPrototypeOf(n)===null||Object.getPrototypeOf(n)===bc)}function Wn(n){return n===null||typeof n=="number"||typeof n=="string"||typeof n=="boolean"?!0:Array.isArray(n)?n.every(Wn):qn(n)?Object.values(n).every(Wn):!1}const pe=new xe(n=>{if(Wn(n))return n;throw new q(`Expected json serializable value, got ${typeof n}`)},(n,t)=>{if(Array.isArray(n)&&Array.isArray(t)){let e=n.length!==t.length;for(let s=0;s<t.length;s++){if(s>=n.length){e=!0,pe.validate(t[s]);continue}const i=n[s],r=t[s];if(Object.is(i,r))continue;const o=pe.validateUsingKnownGoodVersion(i,r);Object.is(o,i)||(e=!0)}return e?t:n}else if(qn(n)&&qn(t)){let e=!1;for(const s of Object.keys(t)){if(!Qe(n,s)){e=!0,pe.validate(t[s]);continue}const i=n[s],r=t[s];if(Object.is(i,r))continue;const o=pe.validateUsingKnownGoodVersion(i,r);Object.is(o,i)||(e=!0)}for(const s of Object.keys(n))if(!Qe(t,s)){e=!0;break}return e?t:n}else return pe.validate(t)});function jc(n,t){return new Oc(n,t)}function pi(n,t){return new hn(n,t,(e,s)=>{throw new q(`Expected one of ${Object.keys(t).map(i=>JSON.stringify(i)).join(" or ")}, got ${JSON.stringify(s)}`,[n])},!1)}function Lf(n,t){return new hn(n,t,(e,s)=>{throw new q(`Expected one of ${Object.keys(t).map(i=>JSON.stringify(i)).join(" or ")}, got ${JSON.stringify(s)}`,[n])},!0)}function tt(n,t){return new xe(e=>_e(n,()=>t.validate(e)),(e,s)=>_e(n,()=>t.validateUsingKnownGoodVersion?t.validateUsingKnownGoodVersion(e,s):t.validate(s)))}function un(n){return new xe(t=>{if(!n.has(t)){const e=Array.from(n,s=>JSON.stringify(s)).join(" or ");throw new q(`Expected ${e}, got ${t}`)}return t})}function xo(n){return new xe(t=>{if(t!==void 0)return n.validate(t)},(t,e)=>{if(!(t===void 0&&e===void 0)&&e!==void 0)return n.validateUsingKnownGoodVersion&&t!==void 0?n.validateUsingKnownGoodVersion(t,e):n.validate(e)})}function zc(n){return new xe(t=>t===null?null:n.validate(t),(t,e)=>e===null?null:n.validateUsingKnownGoodVersion&&t!==null?n.validateUsingKnownGoodVersion(t,e):n.validate(e))}function pn(...n){return un(new Set(n))}function fi(n){try{return new URL(n)}catch{if(n.startsWith("/")||n.startsWith("./"))try{return new URL(n,"http://example.com")}catch{throw new q(`Expected a valid url, got ${JSON.stringify(n)}`)}throw new q(`Expected a valid url, got ${JSON.stringify(n)}`)}}const Bc=new Set(["http:","https:","mailto:"]),st=G.check(n=>{if(n==="")return;const t=fi(n);if(!Bc.has(t.protocol.toLowerCase()))throw new q(`Expected a valid url, got ${JSON.stringify(n)} (invalid protocol)`)}),Uc=new Set(["http:","https:","data:","asset:"]),kt=G.check(n=>{if(n==="")return;const t=fi(n);if(!Uc.has(t.protocol.toLowerCase()))throw new q(`Expected a valid url, got ${JSON.stringify(n)} (invalid protocol)`)});G.check(n=>{if(n==="")return;if(!fi(n).protocol.toLowerCase().match(/^https?:$/))throw new q(`Expected a valid url, got ${JSON.stringify(n)} (invalid protocol)`)});const gi=G.refine(n=>{try{return uc(n),n}catch{throw new q(`Expected an index key, got ${JSON.stringify(n)}`)}});function Le(n){return G.refine(t=>{if(!t.startsWith(`${n}:`))throw new Error(`${n} ID must start with "${n}:"`);return t})}const fn=Le("asset");function mi(n,t){return W({id:fn,typeName:ke("asset"),type:ke(n),props:t,meta:pe})}const Tt=W({x:N,y:N,z:N.optional()}),hs=W({x:N,y:N,w:N,h:N}),Io=N.check(n=>{if(n<0||n>1)throw new q("Opacity must be between 0 and 1")}),Nc=G.refine(n=>{if(!n.startsWith("page:")&&!n.startsWith("shape:"))throw new Error('Parent ID must start with "page:" or "shape:"');return n}),ze=Le("shape");function $c(n,t,e){return W({id:ze,typeName:ke("shape"),x:N,y:N,rotation:N,index:gi,parentId:Nc,type:ke(n),isLocked:Y,opacity:Io,props:t?W(t):pe,meta:e?W(e):pe})}const Kc=Le("binding");function Hc(n,t,e){return W({id:Kc,typeName:ke("binding"),type:ke(n),fromId:ze,toId:ze,props:t?W(t):pe,meta:e?W(e):pe})}Te("com.tldraw.binding",{});Oe({sequenceId:"com.tldraw.binding",recordType:"binding",sequence:[]});function us(n){return`binding:${bs()}`}function Yc(n){return et("binding",{scope:"document",validator:tt("binding",pi("type",ai(n,(t,{props:e,meta:s})=>Hc(t,e,s))))}).withDefaultProperties(()=>({meta:{}}))}class ge{constructor(t,e,s){this.id=t,this.defaultValue=e,this.type=s}static define(t,e){const{defaultValue:s,type:i=Fc}=e;return new ge(t,s,i)}static defineEnum(t,e){const{defaultValue:s,values:i}=e;return new Gc(t,s,i)}setDefaultValue(t){this.defaultValue=t}validate(t){return this.type.validate(t)}validateUsingKnownGoodVersion(t,e){return this.type.validateUsingKnownGoodVersion?this.type.validateUsingKnownGoodVersion(t,e):this.validate(e)}}class Gc extends ge{constructor(t,e,s){super(t,e,pn(...s)),this.values=s}}const _s=Te("com.tldraw.shape",{AddIsLocked:1,HoistOpacity:2,AddMeta:3,AddWhite:4}),Xc=Oe({sequenceId:"com.tldraw.shape",recordType:"shape",sequence:[{id:_s.AddIsLocked,up:n=>{n.isLocked=!1},down:n=>{delete n.isLocked}},{id:_s.HoistOpacity,up:n=>{n.opacity=Number(n.props.opacity??"1"),delete n.props.opacity},down:n=>{const t=n.opacity;delete n.opacity,n.props.opacity=t<.175?"0.1":t<.375?"0.25":t<.625?"0.5":t<.875?"0.75":"1"}},{id:_s.AddMeta,up:n=>{n.meta={}}},{id:_s.AddWhite,up:n=>{},down:n=>{n.props.color==="white"&&(n.props.color="black")}}]});function Nt(n){return n?n.typeName==="shape":!1}function We(n){return n?n.startsWith("shape:"):!1}function $t(n){return`shape:${n??bs()}`}function vo(n){const t=new Map;for(const[e,s]of Object.entries(n))if(s instanceof ge){if(t.has(s))throw new Error(`Duplicate style prop ${s.id}. Each style prop can only be used once within a shape.`);t.set(s,e)}return t}function Xe(n,t){return ai(t,(e,s)=>`com.tldraw.shape.${n}/${s}`)}function qc(n){return et("shape",{scope:"document",validator:tt("shape",pi("type",ai(n,(t,{props:e,meta:s})=>$c(t,e,s))))}).withDefaultProperties(()=>({x:0,y:0,rotation:0,isLocked:!1,opacity:1,meta:{}}))}function Qi(n,t){const e=[];for(const[s,{migrations:i}]of Object.entries(t)){const r=`com.tldraw.${n}.${s}`;i?"sequenceId"in i?(de(r===i.sequenceId,`sequenceId mismatch for ${s} ${dn} migrations. Expected '${r}', got '${i.sequenceId}'`),e.push(i)):"sequence"in i?e.push(Kt({sequenceId:r,retroactive:!1,sequence:i.sequence.map(o=>"id"in o?Po(n,s,o):o)})):e.push(Kt({sequenceId:r,retroactive:!1,sequence:Object.keys(i.migrators).map(o=>Number(o)).sort((o,a)=>o-a).map(o=>({id:`${r}/${o}`,scope:"record",filter:a=>a.typeName===n&&a.type===s,up:a=>{const c=i.migrators[o].up(a);if(c)return c},down:a=>{const c=i.migrators[o].down(a);if(c)return c}}))})):e.push(Kt({sequenceId:r,retroactive:!1,sequence:[]}))}return e}function Po(n,t,e){return{id:e.id,dependsOn:e.dependsOn,scope:"record",filter:s=>s.typeName===n&&s.type===t,up:s=>{const i=e.up(s.props);i&&(s.props=i)},down:typeof e.down=="function"?s=>{const i=e.down(s.props);i&&(s.props=i)}:void 0}}const Co=["black","grey","light-violet","violet","blue","light-blue","yellow","orange","green","light-green","light-red","red","white"],Ji={lightMode:{id:"light",text:"#000000",background:"rgb(249, 250, 251)",solid:"#fcfffe",black:{solid:"#1d1d1d",fill:"#1d1d1d",note:{fill:"#FCE19C",text:"#000000"},semi:"#e8e8e8",pattern:"#494949",highlight:{srgb:"#fddd00",p3:"color(display-p3 0.972 0.8705 0.05)"}},blue:{solid:"#4465e9",fill:"#4465e9",note:{fill:"#8AA3FF",text:"#000000"},semi:"#dce1f8",pattern:"#6681ee",highlight:{srgb:"#10acff",p3:"color(display-p3 0.308 0.6632 0.9996)"}},green:{solid:"#099268",fill:"#099268",note:{fill:"#6FC896",text:"#000000"},semi:"#d3e9e3",pattern:"#39a785",highlight:{srgb:"#00ffc8",p3:"color(display-p3 0.2536 0.984 0.7981)"}},grey:{solid:"#9fa8b2",fill:"#9fa8b2",note:{fill:"#C0CAD3",text:"#000000"},semi:"#eceef0",pattern:"#bcc3c9",highlight:{srgb:"#cbe7f1",p3:"color(display-p3 0.8163 0.9023 0.9416)"}},"light-blue":{solid:"#4ba1f1",fill:"#4ba1f1",note:{fill:"#9BC4FD",text:"#000000"},semi:"#ddedfa",pattern:"#6fbbf8",highlight:{srgb:"#00f4ff",p3:"color(display-p3 0.1512 0.9414 0.9996)"}},"light-green":{solid:"#4cb05e",fill:"#4cb05e",note:{fill:"#98D08A",text:"#000000"},semi:"#dbf0e0",pattern:"#65cb78",highlight:{srgb:"#65f641",p3:"color(display-p3 0.563 0.9495 0.3857)"}},"light-red":{solid:"#f87777",fill:"#f87777",note:{fill:"#F7A5A1",text:"#000000"},semi:"#f4dadb",pattern:"#fe9e9e",highlight:{srgb:"#ff7fa3",p3:"color(display-p3 0.9988 0.5301 0.6397)"}},"light-violet":{solid:"#e085f4",fill:"#e085f4",note:{fill:"#DFB0F9",text:"#000000"},semi:"#f5eafa",pattern:"#e9acf8",highlight:{srgb:"#ff88ff",p3:"color(display-p3 0.9676 0.5652 0.9999)"}},orange:{solid:"#e16919",fill:"#e16919",note:{fill:"#FAA475",text:"#000000"},semi:"#f8e2d4",pattern:"#f78438",highlight:{srgb:"#ffa500",p3:"color(display-p3 0.9988 0.6905 0.266)"}},red:{solid:"#e03131",fill:"#e03131",note:{fill:"#FC8282",text:"#000000"},semi:"#f4dadb",pattern:"#e55959",highlight:{srgb:"#ff636e",p3:"color(display-p3 0.9992 0.4376 0.45)"}},violet:{solid:"#ae3ec9",fill:"#ae3ec9",note:{fill:"#DB91FD",text:"#000000"},semi:"#ecdcf2",pattern:"#bd63d3",highlight:{srgb:"#c77cff",p3:"color(display-p3 0.7469 0.5089 0.9995)"}},yellow:{solid:"#f1ac4b",fill:"#f1ac4b",note:{fill:"#FED49A",text:"#000000"},semi:"#f9f0e6",pattern:"#fecb92",highlight:{srgb:"#fddd00",p3:"color(display-p3 0.972 0.8705 0.05)"}},white:{solid:"#FFFFFF",fill:"#FFFFFF",semi:"#f5f5f5",pattern:"#f9f9f9",note:{fill:"#FFFFFF",text:"#000000"},highlight:{srgb:"#ffffff",p3:"color(display-p3 1 1 1)"}}},darkMode:{id:"dark",text:"hsl(210, 17%, 98%)",background:"hsl(240, 5%, 6.5%)",solid:"#010403",black:{solid:"#f2f2f2",fill:"#f2f2f2",note:{fill:"#2c2c2c",text:"#f2f2f2"},semi:"#2c3036",pattern:"#989898",highlight:{srgb:"#d2b700",p3:"color(display-p3 0.8078 0.7225 0.0312)"}},blue:{solid:"#4f72fc",fill:"#4f72fc",note:{fill:"#2A3F98",text:"#f2f2f2"},semi:"#262d40",pattern:"#3a4b9e",highlight:{srgb:"#0079d2",p3:"color(display-p3 0.0032 0.4655 0.7991)"}},green:{solid:"#099268",fill:"#099268",note:{fill:"#014429",text:"#f2f2f2"},semi:"#253231",pattern:"#366a53",highlight:{srgb:"#009774",p3:"color(display-p3 0.0085 0.582 0.4604)"}},grey:{solid:"#9398b0",fill:"#9398b0",note:{fill:"#56595F",text:"#f2f2f2"},semi:"#33373c",pattern:"#7c8187",highlight:{srgb:"#9cb4cb",p3:"color(display-p3 0.6299 0.7012 0.7856)"}},"light-blue":{solid:"#4dabf7",fill:"#4dabf7",note:{fill:"#1F5495",text:"#f2f2f2"},semi:"#2a3642",pattern:"#4d7aa9",highlight:{srgb:"#00bdc8",p3:"color(display-p3 0.0023 0.7259 0.7735)"}},"light-green":{solid:"#40c057",fill:"#40c057",note:{fill:"#21581D",text:"#f2f2f2"},semi:"#2a3830",pattern:"#4e874e",highlight:{srgb:"#00a000",p3:"color(display-p3 0.2711 0.6172 0.0195)"}},"light-red":{solid:"#ff8787",fill:"#ff8787",note:{fill:"#923632",text:"#f2f2f2"},semi:"#3b3235",pattern:"#a56767",highlight:{srgb:"#db005b",p3:"color(display-p3 0.7849 0.0585 0.3589)"}},"light-violet":{solid:"#e599f7",fill:"#e599f7",note:{fill:"#762F8E",text:"#f2f2f2"},semi:"#383442",pattern:"#9770a9",highlight:{srgb:"#c400c7",p3:"color(display-p3 0.7024 0.0403 0.753)"}},orange:{solid:"#f76707",fill:"#f76707",note:{fill:"#843906",text:"#f2f2f2"},semi:"#3a2e2a",pattern:"#9f552d",highlight:{srgb:"#d07a00",p3:"color(display-p3 0.7699 0.4937 0.0085)"}},red:{solid:"#e03131",fill:"#e03131",note:{fill:"#89231A",text:"#f2f2f2"},semi:"#36292b",pattern:"#8f3734",highlight:{srgb:"#de002c",p3:"color(display-p3 0.7978 0.0509 0.2035)"}},violet:{solid:"#ae3ec9",fill:"#ae3ec9",note:{fill:"#681683",text:"#f2f2f2"},semi:"#31293c",pattern:"#763a8b",highlight:{srgb:"#9e00ee",p3:"color(display-p3 0.5651 0.0079 0.8986)"}},yellow:{solid:"#ffc034",fill:"#ffc034",note:{fill:"#98571B",text:"#f2f2f2"},semi:"#3c3934",pattern:"#fecb92",highlight:{srgb:"#d2b700",p3:"color(display-p3 0.8078 0.7225 0.0312)"}},white:{solid:"#f3f3f3",fill:"#f3f3f3",semi:"#f5f5f5",pattern:"#f9f9f9",note:{fill:"#eaeaea",text:"#1d1d1d"},highlight:{srgb:"#ffffff",p3:"color(display-p3 1 1 1)"}}}};function Wc(n){return n.isDarkMode?Ji.darkMode:Ji.lightMode}const Mt=ge.defineEnum("tldraw:color",{defaultValue:"black",values:Co}),Eo=ge.defineEnum("tldraw:labelColor",{defaultValue:"black",values:Co}),gn=ge.defineEnum("tldraw:dash",{defaultValue:"draw",values:["draw","solid","dashed","dotted"]}),yi=ge.defineEnum("tldraw:fill",{defaultValue:"none",values:["none","semi","solid","pattern","fill"]}),mn=ge.defineEnum("tldraw:font",{defaultValue:"draw",values:["draw","sans","serif","mono"]}),Of={draw:"'tldraw_draw', sans-serif",sans:"'tldraw_sans', sans-serif",serif:"'tldraw_serif', serif",mono:"'tldraw_mono', monospace"},At=ge.defineEnum("tldraw:size",{defaultValue:"m",values:["s","m","l","xl"]}),_o=["arrow","triangle","square","dot","pipe","diamond","inverted","bar","none"],Vc=ge.defineEnum("tldraw:arrowheadStart",{defaultValue:"none",values:_o}),Zc=ge.defineEnum("tldraw:arrowheadEnd",{defaultValue:"arrow",values:_o}),Qc={labelColor:Eo,color:Mt,fill:yi,dash:gn,size:At,arrowheadStart:Vc,arrowheadEnd:Zc,font:mn,start:Tt,end:Tt,bend:N,text:G,labelPosition:N,scale:le},jt=Xe("arrow",{AddLabelColor:1,AddIsPrecise:2,AddLabelPosition:3,ExtractBindings:4,AddScale:5});function ks(n){return Po("shape","arrow",n)}const Jc=Kt({sequenceId:"com.tldraw.shape.arrow",retroactive:!1,sequence:[ks({id:jt.AddLabelColor,up:n=>{n.labelColor="black"},down:"retired"}),ks({id:jt.AddIsPrecise,up:({start:n,end:t})=>{n.type==="binding"&&(n.isPrecise=!(n.normalizedAnchor.x===.5&&n.normalizedAnchor.y===.5)),t.type==="binding"&&(t.isPrecise=!(t.normalizedAnchor.x===.5&&t.normalizedAnchor.y===.5))},down:({start:n,end:t})=>{n.type==="binding"&&(n.isPrecise||(n.normalizedAnchor={x:.5,y:.5}),delete n.isPrecise),t.type==="binding"&&(t.isPrecise||(t.normalizedAnchor={x:.5,y:.5}),delete t.isPrecise)}}),ks({id:jt.AddLabelPosition,up:n=>{n.labelPosition=.5},down:n=>{delete n.labelPosition}}),{id:jt.ExtractBindings,scope:"store",up:n=>{const t=Object.values(n).filter(e=>e.typeName==="shape"&&e.type==="arrow");for(const e of t){const{start:s,end:i}=e.props;if(s.type==="binding"){const r=us(),o={typeName:"binding",id:r,type:"arrow",fromId:e.id,toId:s.boundShapeId,meta:{},props:{terminal:"start",normalizedAnchor:s.normalizedAnchor,isExact:s.isExact,isPrecise:s.isPrecise}};n[r]=o,e.props.start={x:0,y:0}}else delete e.props.start.type;if(i.type==="binding"){const r=us(),o={typeName:"binding",id:r,type:"arrow",fromId:e.id,toId:i.boundShapeId,meta:{},props:{terminal:"end",normalizedAnchor:i.normalizedAnchor,isExact:i.isExact,isPrecise:i.isPrecise}};n[r]=o,e.props.end={x:0,y:0}}else delete e.props.end.type}}},ks({id:jt.AddScale,up:n=>{n.scale=1},down:n=>{delete n.scale}})]}),el={terminal:pn("start","end"),normalizedAnchor:Tt,isExact:Y,isPrecise:Y},tl={sequence:[{dependsOn:[jt.ExtractBindings]}]},sl=tt("camera",W({typeName:ke("camera"),id:Le("camera"),x:N,y:N,z:N,meta:pe})),nl=Te("com.tldraw.camera",{AddMeta:1}),il=Oe({sequenceId:"com.tldraw.camera",recordType:"camera",sequence:[{id:nl.AddMeta,up:n=>{n.meta={}}}]}),Ze=et("camera",{validator:sl,scope:"session"}).withDefaultProperties(()=>({x:0,y:0,z:1,meta:{}})),rl=new Set(["none","default","pointer","cross","grab","rotate","grabbing","resize-edge","resize-corner","text","move","ew-resize","ns-resize","nesw-resize","nwse-resize","nesw-rotate","nwse-rotate","swne-rotate","senw-rotate","zoom-in","zoom-out"]),ko=un(rl),ol=W({type:ko,rotation:N}),al=new Set(["accent","white","black","selection-stroke","selection-fill","laser","muted-1"]),cl=un(al),ll=new Set(["starting","paused","active","stopping"]),To=W({id:G,points:Se(Tt),size:tn,color:cl,opacity:N,state:un(ll),delay:N,shrink:N,taper:Y}),ms=Le("page"),dl=tt("page",W({typeName:ke("page"),id:ms,name:G,index:gi,meta:pe})),hl=Te("com.tldraw.page",{AddMeta:1}),ul=Oe({sequenceId:"com.tldraw.page",recordType:"page",sequence:[{id:hl.AddMeta,up:n=>{n.meta={}}}]}),ys=et("page",{validator:dl,scope:"document"}).withDefaultProperties(()=>({meta:{}}));function Me(n){return ys.isId(n)}const pl={id:!1,typeName:!1,currentPageId:!1,opacityForNextShape:!1,stylesForNextShape:!1,followingUserId:!1,highlightedUserIds:!1,brush:!1,cursor:!1,scribbles:!1,isFocusMode:!0,isDebugMode:!0,isToolLocked:!0,exportBackground:!0,screenBounds:!0,insets:!0,zoomBrush:!1,chatMessage:!1,isChatting:!1,isPenMode:!1,isGridMode:!0,isFocused:!0,devicePixelRatio:!0,isCoarsePointer:!0,isHoveringCanvas:!1,openMenus:!1,isChangingStyle:!1,isReadonly:!0,meta:!1,duplicateProps:!1},Mo=n=>n?ls(n,t=>pl[t]):null;Le("instance");function fl(n){const t={};for(const[s,i]of n)t[s]=xo(i);const e=tt("instance",W({typeName:ke("instance"),id:Le("instance"),currentPageId:ms,followingUserId:G.nullable(),brush:hs.nullable(),opacityForNextShape:Io,stylesForNextShape:W(t),cursor:ol,scribbles:Se(To),isFocusMode:Y,isDebugMode:Y,isToolLocked:Y,exportBackground:Y,screenBounds:hs,insets:Se(Y),zoomBrush:hs.nullable(),isPenMode:Y,isGridMode:Y,chatMessage:G,isChatting:Y,highlightedUserIds:Se(G),isFocused:Y,devicePixelRatio:N,isCoarsePointer:Y,isHoveringCanvas:Y.nullable(),openMenus:Se(G),isChangingStyle:Y,isReadonly:Y,meta:pe,duplicateProps:W({shapeIds:Se(Le("shape")),offset:W({x:N,y:N})}).nullable()}));return et("instance",{validator:e,scope:"session",ephemeralKeys:{currentPageId:!1,meta:!1,followingUserId:!0,opacityForNextShape:!0,stylesForNextShape:!0,brush:!0,cursor:!0,scribbles:!0,isFocusMode:!0,isDebugMode:!0,isToolLocked:!0,exportBackground:!0,screenBounds:!0,insets:!0,zoomBrush:!0,isPenMode:!0,isGridMode:!0,chatMessage:!0,isChatting:!0,highlightedUserIds:!0,isFocused:!0,devicePixelRatio:!0,isCoarsePointer:!0,isHoveringCanvas:!0,openMenus:!0,isChangingStyle:!0,isReadonly:!0,duplicateProps:!0}}).withDefaultProperties(()=>({followingUserId:null,opacityForNextShape:1,stylesForNextShape:{},brush:null,scribbles:[],cursor:{type:"default",rotation:0},isFocusMode:!1,exportBackground:!1,isDebugMode:!1,isToolLocked:!1,screenBounds:{x:0,y:0,w:1080,h:720},insets:[!1,!1,!1,!1],zoomBrush:null,isGridMode:!1,isPenMode:!1,chatMessage:"",isChatting:!1,highlightedUserIds:[],isFocused:!1,devicePixelRatio:typeof window>"u"?1:window.devicePixelRatio,isCoarsePointer:!1,isHoveringCanvas:null,openMenus:[],isChangingStyle:!1,isReadonly:!1,meta:{},duplicateProps:null}))}const se=Te("com.tldraw.instance",{AddTransparentExportBgs:1,RemoveDialog:2,AddToolLockMode:3,RemoveExtraPropsForNextShape:4,AddLabelColor:5,AddFollowingUserId:6,RemoveAlignJustify:7,AddZoom:8,AddVerticalAlign:9,AddScribbleDelay:10,RemoveUserId:11,AddIsPenModeAndIsGridMode:12,HoistOpacity:13,AddChat:14,AddHighlightedUserIds:15,ReplacePropsForNextShapeWithStylesForNextShape:16,AddMeta:17,RemoveCursorColor:18,AddLonelyProperties:19,ReadOnlyReadonly:20,AddHoveringCanvas:21,AddScribbles:22,AddInset:23,AddDuplicateProps:24,RemoveCanMoveCamera:25}),gl=Oe({sequenceId:"com.tldraw.instance",recordType:"instance",sequence:[{id:se.AddTransparentExportBgs,up:n=>({...n,exportBackground:!0})},{id:se.RemoveDialog,up:({dialog:n,...t})=>t},{id:se.AddToolLockMode,up:n=>({...n,isToolLocked:!1})},{id:se.RemoveExtraPropsForNextShape,up:({propsForNextShape:n,...t})=>({...t,propsForNextShape:Object.fromEntries(Object.entries(n).filter(([e])=>["color","labelColor","dash","fill","size","font","align","verticalAlign","icon","geo","arrowheadStart","arrowheadEnd","spline"].includes(e)))})},{id:se.AddLabelColor,up:({propsForNextShape:n,...t})=>({...t,propsForNextShape:{...n,labelColor:"black"}})},{id:se.AddFollowingUserId,up:n=>({...n,followingUserId:null})},{id:se.RemoveAlignJustify,up:n=>{let t=n.propsForNextShape.align;return t==="justify"&&(t="start"),{...n,propsForNextShape:{...n.propsForNextShape,align:t}}}},{id:se.AddZoom,up:n=>({...n,zoomBrush:null})},{id:se.AddVerticalAlign,up:n=>({...n,propsForNextShape:{...n.propsForNextShape,verticalAlign:"middle"}})},{id:se.AddScribbleDelay,up:n=>n.scribble!==null?{...n,scribble:{...n.scribble,delay:0}}:{...n}},{id:se.RemoveUserId,up:({userId:n,...t})=>t},{id:se.AddIsPenModeAndIsGridMode,up:n=>({...n,isPenMode:!1,isGridMode:!1})},{id:se.HoistOpacity,up:({propsForNextShape:{opacity:n,...t},...e})=>({...e,opacityForNextShape:Number(n??"1"),propsForNextShape:t})},{id:se.AddChat,up:n=>({...n,chatMessage:"",isChatting:!1})},{id:se.AddHighlightedUserIds,up:n=>({...n,highlightedUserIds:[]})},{id:se.ReplacePropsForNextShapeWithStylesForNextShape,up:({propsForNextShape:n,...t})=>({...t,stylesForNextShape:{}})},{id:se.AddMeta,up:n=>({...n,meta:{}})},{id:se.RemoveCursorColor,up:n=>{const{color:t,...e}=n.cursor;return{...n,cursor:e}}},{id:se.AddLonelyProperties,up:n=>({...n,canMoveCamera:!0,isFocused:!1,devicePixelRatio:1,isCoarsePointer:!1,openMenus:[],isChangingStyle:!1,isReadOnly:!1})},{id:se.ReadOnlyReadonly,up:({isReadOnly:n,...t})=>({...t,isReadonly:n})},{id:se.AddHoveringCanvas,up:n=>({...n,isHoveringCanvas:null})},{id:se.AddScribbles,up:({scribble:n,...t})=>({...t,scribbles:[]})},{id:se.AddInset,up:n=>({...n,insets:[!1,!1,!1,!1]}),down:({insets:n,...t})=>({...t})},{id:se.AddDuplicateProps,up:n=>({...n,duplicateProps:null}),down:({duplicateProps:n,...t})=>({...t})},{id:se.RemoveCanMoveCamera,up:({canMoveCamera:n,...t})=>({...t}),down:n=>({...n,canMoveCamera:!0})}]}),we="instance:instance",ml=tt("instance_page_state",W({typeName:ke("instance_page_state"),id:Le("instance_page_state"),pageId:ms,selectedShapeIds:Se(ze),hintingShapeIds:Se(ze),erasingShapeIds:Se(ze),hoveredShapeId:ze.nullable(),editingShapeId:ze.nullable(),croppingShapeId:ze.nullable(),focusedGroupId:ze.nullable(),meta:pe})),Vt=Te("com.tldraw.instance_page_state",{AddCroppingId:1,RemoveInstanceIdAndCameraId:2,AddMeta:3,RenameProperties:4,RenamePropertiesAgain:5}),yl=Oe({sequenceId:"com.tldraw.instance_page_state",recordType:"instance_page_state",sequence:[{id:Vt.AddCroppingId,up(n){n.croppingShapeId=null}},{id:Vt.RemoveInstanceIdAndCameraId,up(n){delete n.instanceId,delete n.cameraId}},{id:Vt.AddMeta,up:n=>{n.meta={}}},{id:Vt.RenameProperties,up:n=>{},down:n=>{}},{id:Vt.RenamePropertiesAgain,up:n=>{n.selectedShapeIds=n.selectedIds,delete n.selectedIds,n.hintingShapeIds=n.hintingIds,delete n.hintingIds,n.erasingShapeIds=n.erasingIds,delete n.erasingIds,n.hoveredShapeId=n.hoveredId,delete n.hoveredId,n.editingShapeId=n.editingId,delete n.editingId,n.croppingShapeId=n.croppingShapeId??n.croppingId??null,delete n.croppingId,n.focusedGroupId=n.focusLayerId,delete n.focusLayerId},down:n=>{n.selectedIds=n.selectedShapeIds,delete n.selectedShapeIds,n.hintingIds=n.hintingShapeIds,delete n.hintingShapeIds,n.erasingIds=n.erasingShapeIds,delete n.erasingShapeIds,n.hoveredId=n.hoveredShapeId,delete n.hoveredShapeId,n.editingId=n.editingShapeId,delete n.editingShapeId,n.croppingId=n.croppingShapeId,delete n.croppingShapeId,n.focusLayerId=n.focusedGroupId,delete n.focusedGroupId}}]}),Ye=et("instance_page_state",{validator:ml,scope:"session",ephemeralKeys:{pageId:!1,selectedShapeIds:!1,editingShapeId:!1,croppingShapeId:!1,meta:!1,hintingShapeIds:!0,erasingShapeIds:!0,hoveredShapeId:!0,focusedGroupId:!0}}).withDefaultProperties(()=>({editingShapeId:null,croppingShapeId:null,selectedShapeIds:[],hoveredShapeId:null,erasingShapeIds:[],hintingShapeIds:[],focusedGroupId:null,meta:{}})),Sl=tt("pointer",W({typeName:ke("pointer"),id:Le("pointer"),x:N,y:N,lastActivityTimestamp:N,meta:pe})),wl=Te("com.tldraw.pointer",{AddMeta:1}),bl=Oe({sequenceId:"com.tldraw.pointer",recordType:"pointer",sequence:[{id:wl.AddMeta,up:n=>{n.meta={}}}]}),Si=et("pointer",{validator:Sl,scope:"session"}).withDefaultProperties(()=>({x:0,y:0,lastActivityTimestamp:0,meta:{}})),sn=Si.createId("pointer"),xl=tt("instance_presence",W({typeName:ke("instance_presence"),id:Le("instance_presence"),userId:G,userName:G,lastActivityTimestamp:N,followingUserId:G.nullable(),cursor:W({x:N,y:N,type:ko,rotation:N}),color:G,camera:W({x:N,y:N,z:N}),screenBounds:hs,selectedShapeIds:Se(Le("shape")),currentPageId:Le("page"),brush:hs.nullable(),scribbles:Se(To),chatMessage:G,meta:pe})),Zt=Te("com.tldraw.instance_presence",{AddScribbleDelay:1,RemoveInstanceId:2,AddChatMessage:3,AddMeta:4,RenameSelectedShapeIds:5}),Il=Oe({sequenceId:"com.tldraw.instance_presence",recordType:"instance_presence",sequence:[{id:Zt.AddScribbleDelay,up:n=>{n.scribble!==null&&(n.scribble.delay=0)}},{id:Zt.RemoveInstanceId,up:n=>{delete n.instanceId}},{id:Zt.AddChatMessage,up:n=>{n.chatMessage=""}},{id:Zt.AddMeta,up:n=>{n.meta={}}},{id:Zt.RenameSelectedShapeIds,up:n=>{}}]}),vl=et("instance_presence",{validator:xl,scope:"presence"}).withDefaultProperties(()=>({lastActivityTimestamp:0,followingUserId:null,color:"#FF0000",camera:{x:0,y:0,z:1},cursor:{x:0,y:0,type:"default",rotation:0},screenBounds:{x:0,y:0,w:1,h:1},selectedShapeIds:[],brush:null,scribbles:[],chatMessage:"",meta:{}})),Pl=tt("document",W({typeName:ke("document"),id:ke("document:document"),gridSize:N,name:G,meta:pe})),er=Te("com.tldraw.document",{AddName:1,AddMeta:2}),Cl=Oe({sequenceId:"com.tldraw.document",recordType:"document",sequence:[{id:er.AddName,up:n=>{n.name=""},down:n=>{delete n.name}},{id:er.AddMeta,up:n=>{n.meta={}}}]}),wi=et("document",{validator:Pl,scope:"document"}).withDefaultProperties(()=>({gridSize:10,name:"",meta:{}})),Vn=wi.createId("document");function El(n,t){return n.index<t.index?-1:n.index>t.index?1:0}function tr(n){n.typeName==="asset"&&("src"in n&&(n.src="<redacted>"),"src"in n.props&&(n.props.src="<redacted>"))}const _l=({error:n,phase:t,record:e,recordBefore:s})=>{throw oi(n,{tags:{origin:"store.validateRecord",storePhase:t,isExistingValidationIssue:t==="initialize"},extras:{recordBefore:s?tr(ue(s)):void 0,recordAfter:tr(ue(e))}}),n};function kl(){return[ys.create({id:"page:page",name:"Page 1",index:"a1",meta:{}})]}function Tl(n){const t=n.query.ids("page"),e=()=>{if(!n.has(Vn))return n.put([wi.create({id:Vn,name:n.props.defaultName})]),e();if(!n.has(sn))return n.put([Si.create({id:sn})]),e();const s=t.get();if(s.size===0)return n.put(kl()),e();const i=()=>[...s].map(c=>n.get(c)).sort(El)[0].id,r=n.get(we);if(r){if(!s.has(r.currentPageId))return n.put([{...r,currentPageId:i()}]),e()}else return n.put([n.schema.types.instance.create({id:we,currentPageId:i(),exportBackground:!0})]),e();const o=new Set,a=new Set;for(const c of s){const l=Ye.createId(c);n.has(l)||o.add(l);const d=Ze.createId(c);n.has(d)||a.add(d)}o.size>0&&n.put([...o].map(c=>Ye.create({id:c,pageId:Ye.parseId(c)}))),a.size>0&&n.put([...a].map(c=>Ze.create({id:c})))};return e}const Ml=mi("bookmark",W({title:G,description:G,image:G,favicon:G,src:kt.nullable()})),sr=Te("com.tldraw.asset.bookmark",{MakeUrlsValid:1,AddFavicon:2}),Al=Oe({sequenceId:"com.tldraw.asset.bookmark",recordType:"asset",filter:n=>n.type==="bookmark",sequence:[{id:sr.MakeUrlsValid,up:n=>{kt.isValid(n.props.src)||(n.props.src="")},down:n=>{}},{id:sr.AddFavicon,up:n=>{kt.isValid(n.props.favicon)||(n.props.favicon="")},down:n=>{delete n.props.favicon}}]}),Dl=mi("image",W({w:N,h:N,name:G,isAnimated:Y,mimeType:G.nullable(),src:kt.nullable(),fileSize:le.optional()})),Qt=Te("com.tldraw.asset.image",{AddIsAnimated:1,RenameWidthHeight:2,MakeUrlsValid:3,AddFileSize:4,MakeFileSizeOptional:5}),Rl=Oe({sequenceId:"com.tldraw.asset.image",recordType:"asset",filter:n=>n.type==="image",sequence:[{id:Qt.AddIsAnimated,up:n=>{n.props.isAnimated=!1},down:n=>{delete n.props.isAnimated}},{id:Qt.RenameWidthHeight,up:n=>{n.props.w=n.props.width,n.props.h=n.props.height,delete n.props.width,delete n.props.height},down:n=>{n.props.width=n.props.w,n.props.height=n.props.h,delete n.props.w,delete n.props.h}},{id:Qt.MakeUrlsValid,up:n=>{kt.isValid(n.props.src)||(n.props.src="")},down:n=>{}},{id:Qt.AddFileSize,up:n=>{n.props.fileSize=-1},down:n=>{delete n.props.fileSize}},{id:Qt.MakeFileSizeOptional,up:n=>{n.props.fileSize===-1&&(n.props.fileSize=void 0)},down:n=>{n.props.fileSize===void 0&&(n.props.fileSize=-1)}}]}),Ll=mi("video",W({w:N,h:N,name:G,isAnimated:Y,mimeType:G.nullable(),src:kt.nullable(),fileSize:N.optional()})),Jt=Te("com.tldraw.asset.video",{AddIsAnimated:1,RenameWidthHeight:2,MakeUrlsValid:3,AddFileSize:4,MakeFileSizeOptional:5}),Ol=Oe({sequenceId:"com.tldraw.asset.video",recordType:"asset",filter:n=>n.type==="video",sequence:[{id:Jt.AddIsAnimated,up:n=>{n.props.isAnimated=!1},down:n=>{delete n.props.isAnimated}},{id:Jt.RenameWidthHeight,up:n=>{n.props.w=n.props.width,n.props.h=n.props.height,delete n.props.width,delete n.props.height},down:n=>{n.props.width=n.props.w,n.props.height=n.props.h,delete n.props.w,delete n.props.h}},{id:Jt.MakeUrlsValid,up:n=>{kt.isValid(n.props.src)||(n.props.src="")},down:n=>{}},{id:Jt.AddFileSize,up:n=>{n.props.fileSize=-1},down:n=>{delete n.props.fileSize}},{id:Jt.MakeFileSizeOptional,up:n=>{n.props.fileSize===-1&&(n.props.fileSize=void 0)},down:n=>{n.props.fileSize===void 0&&(n.props.fileSize=-1)}}]}),Fl=tt("asset",pi("type",{image:Dl,video:Ll,bookmark:Ml})),jl=Te("com.tldraw.asset",{AddMeta:1}),zl=Oe({sequenceId:"com.tldraw.asset",recordType:"asset",sequence:[{id:jl.AddMeta,up:n=>{n.meta={}}}]}),Bl=et("asset",{validator:Fl,scope:"document"}).withDefaultProperties(()=>({meta:{}})),Ul={w:le,h:le,assetId:fn.nullable(),url:st},nr=Xe("bookmark",{NullAssetId:1,MakeUrlsValid:2}),Nl={sequence:[{id:nr.NullAssetId,up:n=>{n.assetId===void 0&&(n.assetId=null)},down:"retired"},{id:nr.MakeUrlsValid,up:n=>{st.isValid(n.url)||(n.url="")},down:n=>{}}]},Ao=W({type:pn("free","straight"),points:Se(Tt)}),$l={color:Mt,fill:yi,dash:gn,size:At,segments:Se(Ao),isComplete:Y,isClosed:Y,isPen:Y,scale:le},ir=Xe("draw",{AddInPen:1,AddScale:2}),Kl={sequence:[{id:ir.AddInPen,up:n=>{const{points:t}=n.segments[0];if(t.length===0){n.isPen=!1;return}let e=!(t[0].z===0||t[0].z===.5);t[1]&&(e=e&&!(t[1].z===0||t[1].z===.5)),n.isPen=e},down:"retired"},{id:ir.AddScale,up:n=>{n.scale=1},down:n=>{delete n.scale}}]};var Hl={};const rr=/(^\/r\/[^/]+\/?$)/,Z=n=>{try{return new URL(n)}catch{return}},Yl=[{type:"tldraw",title:"tldraw",hostnames:["beta.tldraw.com","tldraw.com","localhost:3000"],minWidth:300,minHeight:300,width:720,height:500,doesResize:!0,overridePermissions:{"allow-top-navigation":!0},toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(rr))return n},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(rr))return n}},{type:"figma",title:"Figma",hostnames:["figma.com"],width:720,height:500,doesResize:!0,toEmbedUrl:n=>{if(n.match(/https:\/\/([\w\.-]+\.)?figma.com\/(file|proto)\/([0-9a-zA-Z]{22,128})(?:\/.*)?$/)&&!n.includes("figma.com/embed"))return`https://www.figma.com/embed?embed_host=share&url=${n}`},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/embed\/?$/)){const e=t.searchParams.get("url");if(e)return e}}},{type:"google_maps",title:"Google Maps",hostnames:["google.*"],width:720,height:500,doesResize:!0,overridePermissions:{"allow-presentation":!0},toEmbedUrl:n=>{if(n.includes("/maps/")){const t=n.match(/@(.*),(.*),(.*)z/);let e;if(t){const[,s,i,r]=t;e=`https://${new URL(n).host.replace("www.","")}/maps/embed/v1/view?key=${Hl.NEXT_PUBLIC_GC_API_KEY}&center=${s},${i}&zoom=${r}`}else e="";return e}},fromEmbedUrl:n=>{const t=Z(n);if(!t)return;if(t.pathname.match(/^\/maps\/embed\/v1\/view\/?$/)&&t.searchParams.has("center")&&t.searchParams.get("zoom")){const s=t.searchParams.get("zoom"),[i,r]=t.searchParams.get("center").split(",");return`https://www.google.com/maps/@${i},${r},${s}z`}}},{type:"val_town",title:"Val Town",hostnames:["val.town"],minWidth:260,minHeight:100,width:720,height:500,doesResize:!0,toEmbedUrl:n=>{const t=Z(n),e=t&&t.pathname.match(/\/v\/(.+)\/?/);if(e)return`https://www.val.town/embed/${e[1]}`},fromEmbedUrl:n=>{const t=Z(n),e=t&&t.pathname.match(/\/embed\/(.+)\/?/);if(e)return`https://www.val.town/v/${e[1]}`}},{type:"codesandbox",title:"CodeSandbox",hostnames:["codesandbox.io"],minWidth:300,minHeight:300,width:720,height:500,doesResize:!0,toEmbedUrl:n=>{const t=Z(n),e=t&&t.pathname.match(/\/s\/([^/]+)\/?/);if(e)return`https://codesandbox.io/embed/${e[1]}`},fromEmbedUrl:n=>{const t=Z(n),e=t&&t.pathname.match(/\/embed\/([^/]+)\/?/);if(e)return`https://codesandbox.io/s/${e[1]}`}},{type:"codepen",title:"Codepen",hostnames:["codepen.io"],minWidth:300,minHeight:300,width:520,height:400,doesResize:!0,toEmbedUrl:n=>{const t=/https:\/\/codepen.io\/([^/]+)\/pen\/([^/]+)/,e=n.match(t);if(e){const[s,i,r]=e;return`https://codepen.io/${i}/embed/${r}`}},fromEmbedUrl:n=>{const t=/https:\/\/codepen.io\/([^/]+)\/embed\/([^/]+)/,e=n.match(t);if(e){const[s,i,r]=e;return`https://codepen.io/${i}/pen/${r}`}}},{type:"scratch",title:"Scratch",hostnames:["scratch.mit.edu"],width:520,height:400,doesResize:!1,toEmbedUrl:n=>{const t=/https?:\/\/scratch.mit.edu\/projects\/([^/]+)/,e=n.match(t);if(e){const[s,i]=e;return`https://scratch.mit.edu/projects/embed/${i}`}},fromEmbedUrl:n=>{const t=/https:\/\/scratch.mit.edu\/projects\/embed\/([^/]+)/,e=n.match(t);if(e){const[s,i]=e;return`https://scratch.mit.edu/projects/${i}`}}},{type:"youtube",title:"YouTube",hostnames:["*.youtube.com","youtube.com","youtu.be"],width:800,height:450,doesResize:!0,overridePermissions:{"allow-presentation":!0,"allow-popups-to-escape-sandbox":!0},isAspectRatioLocked:!0,toEmbedUrl:n=>{const t=Z(n);if(!t)return;const e=t.hostname.replace(/^www./,"");if(e==="youtu.be")return`https://www.youtube.com/embed/${t.pathname.split("/").filter(Boolean)[0]}`;if((e==="youtube.com"||e==="m.youtube.com")&&t.pathname.match(/^\/watch/))return`https://www.youtube.com/embed/${t.searchParams.get("v")}`},fromEmbedUrl:n=>{const t=Z(n);if(!t)return;if(t.hostname.replace(/^www./,"")==="youtube.com"){const s=t.pathname.match(/^\/embed\/([^/]+)\/?/);if(s)return`https://www.youtube.com/watch?v=${s[1]}`}}},{type:"google_calendar",title:"Google Calendar",hostnames:["calendar.google.*"],width:720,height:500,minWidth:460,minHeight:360,doesResize:!0,instructionLink:"https://support.google.com/calendar/answer/41207?hl=en",overridePermissions:{"allow-popups-to-escape-sandbox":!0},toEmbedUrl:n=>{const t=Z(n),e=t==null?void 0:t.searchParams.get("cid");if(t!=null&&t.pathname.match(/\/calendar\/u\/0/)&&e){t.pathname="/calendar/embed";const s=Array.from(t.searchParams.keys());for(const i of s)t.searchParams.delete(i);return t.searchParams.set("src",e),t.href}},fromEmbedUrl:n=>{const t=Z(n),e=t==null?void 0:t.searchParams.get("src");if(t!=null&&t.pathname.match(/\/calendar\/embed/)&&e){t.pathname="/calendar/u/0";const s=Array.from(t.searchParams.keys());for(const i of s)t.searchParams.delete(i);return t.searchParams.set("cid",e),t.href}}},{type:"google_slides",title:"Google Slides",hostnames:["docs.google.*"],width:720,height:500,minWidth:460,minHeight:360,doesResize:!0,overridePermissions:{"allow-popups-to-escape-sandbox":!0},toEmbedUrl:n=>{const t=Z(n);if(t!=null&&t.pathname.match(/^\/presentation/)&&(t!=null&&t.pathname.match(/\/pub\/?$/))){t.pathname=t.pathname.replace(/\/pub$/,"/embed");const e=Array.from(t.searchParams.keys());for(const s of e)t.searchParams.delete(s);return t.href}},fromEmbedUrl:n=>{const t=Z(n);if(t!=null&&t.pathname.match(/^\/presentation/)&&(t!=null&&t.pathname.match(/\/embed\/?$/))){t.pathname=t.pathname.replace(/\/embed$/,"/pub");const e=Array.from(t.searchParams.keys());for(const s of e)t.searchParams.delete(s);return t.href}}},{type:"github_gist",title:"GitHub Gist",hostnames:["gist.github.com"],width:720,height:500,doesResize:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/\/([^/]+)\/([^/]+)/))return n.split("/").pop()?n:void 0},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/\/([^/]+)\/([^/]+)/))return n.split("/").pop()?n:void 0}},{type:"replit",title:"Replit",hostnames:["replit.com"],width:720,height:500,doesResize:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/\/@([^/]+)\/([^/]+)/))return`${n}?embed=true`},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/\/@([^/]+)\/([^/]+)/)&&t.searchParams.has("embed"))return t.searchParams.delete("embed"),t.href}},{type:"felt",title:"Felt",hostnames:["felt.com"],width:720,height:500,doesResize:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/map\//))return t.origin+"/embed"+t.pathname},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/embed\/map\//))return t.pathname=t.pathname.replace(/^\/embed/,""),t.href}},{type:"spotify",title:"Spotify",hostnames:["open.spotify.com"],width:720,height:500,minHeight:500,overrideOutlineRadius:12,doesResize:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/(artist|album)\//))return t.origin+"/embed"+t.pathname},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/embed\/(artist|album)\//))return t.origin+t.pathname.replace(/^\/embed/,"")}},{type:"vimeo",title:"Vimeo",hostnames:["vimeo.com","player.vimeo.com"],width:640,height:360,doesResize:!0,isAspectRatioLocked:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.hostname==="vimeo.com"&&t.pathname.match(/^\/[0-9]+/))return"https://player.vimeo.com/video/"+t.pathname.split("/")[1]+"?title=0&byline=0"},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.hostname==="player.vimeo.com"){const e=t.pathname.match(/^\/video\/([^/]+)\/?$/);if(e)return"https://vimeo.com/"+e[1]}}},{type:"excalidraw",title:"Excalidraw",hostnames:["excalidraw.com"],width:720,height:500,doesResize:!0,isAspectRatioLocked:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.hash.match(/#room=/))return n},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.hash.match(/#room=/))return n}},{type:"observable",title:"Observable",hostnames:["observablehq.com"],width:720,height:500,doesResize:!0,isAspectRatioLocked:!1,backgroundColor:"#fff",toEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/@([^/]+)\/([^/]+)\/?$/))return`${t.origin}/embed${t.pathname}?cell=*`;if(t&&t.pathname.match(/^\/d\/([^/]+)\/?$/)){const e=t.pathname.replace(/^\/d/,"");return`${t.origin}/embed${e}?cell=*`}},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.pathname.match(/^\/embed\/@([^/]+)\/([^/]+)\/?$/))return`${t.origin}${t.pathname.replace("/embed","")}#cell-*`;if(t&&t.pathname.match(/^\/embed\/([^/]+)\/?$/))return`${t.origin}${t.pathname.replace("/embed","/d")}#cell-*`}},{type:"desmos",title:"Desmos",hostnames:["desmos.com"],width:700,height:450,doesResize:!0,toEmbedUrl:n=>{const t=Z(n);if(t&&t.hostname==="www.desmos.com"&&t.pathname.match(/^\/calculator\/([^/]+)\/?$/)&&t.search===""&&t.hash==="")return`${n}?embed`},fromEmbedUrl:n=>{const t=Z(n);if(t&&t.hostname==="www.desmos.com"&&t.pathname.match(/^\/calculator\/([^/]+)\/?$/)&&t.search==="?embed"&&t.hash==="")return n.replace("?embed","")}}],Ff={"allow-downloads-without-user-activation":!1,"allow-downloads":!1,"allow-modals":!1,"allow-orientation-lock":!1,"allow-pointer-lock":!1,"allow-popups":!0,"allow-popups-to-escape-sandbox":!1,"allow-presentation":!1,"allow-storage-access-by-user-activation":!1,"allow-top-navigation":!1,"allow-top-navigation-by-user-activation":!1,"allow-scripts":!0,"allow-same-origin":!0,"allow-forms":!0},Gl={w:le,h:le,url:G},Ts=Xe("embed",{GenOriginalUrlInEmbed:1,RemoveDoesResize:2,RemoveTmpOldUrl:3,RemovePermissionOverrides:4}),Xl={sequence:[{id:Ts.GenOriginalUrlInEmbed,up:n=>{try{const t=n.url,e=new URL(t).host.replace("www.","");let s;for(const i of Yl)if(i.hostnames.includes(e))try{s=i.fromEmbedUrl(t)}catch(r){console.warn(r)}n.tmpOldUrl=n.url,n.url=s??""}catch{n.url="",n.tmpOldUrl=n.url}},down:"retired"},{id:Ts.RemoveDoesResize,up:n=>{delete n.doesResize},down:"retired"},{id:Ts.RemoveTmpOldUrl,up:n=>{delete n.tmpOldUrl},down:"retired"},{id:Ts.RemovePermissionOverrides,up:n=>{delete n.overridePermissions},down:"retired"}]},ql={w:le,h:le,name:G},Wl={sequence:[]},Do=ge.defineEnum("tldraw:horizontalAlign",{defaultValue:"middle",values:["start","middle","end","start-legacy","end-legacy","middle-legacy"]}),Ro=ge.defineEnum("tldraw:verticalAlign",{defaultValue:"middle",values:["start","middle","end"]}),Vl=ge.defineEnum("tldraw:geo",{defaultValue:"rectangle",values:["cloud","rectangle","ellipse","triangle","diamond","pentagon","hexagon","octagon","star","rhombus","rhombus-2","oval","trapezoid","arrow-right","arrow-left","arrow-up","arrow-down","x-box","check-box","heart"]}),Zl={geo:Vl,labelColor:Eo,color:Mt,fill:yi,dash:gn,size:At,font:mn,align:Do,verticalAlign:Ro,url:st,w:le,h:le,growY:tn,text:G,scale:le},rt=Xe("geo",{AddUrlProp:1,AddLabelColor:2,RemoveJustify:3,AddCheckBox:4,AddVerticalAlign:5,MigrateLegacyAlign:6,AddCloud:7,MakeUrlsValid:8,AddScale:9}),Ql={sequence:[{id:rt.AddUrlProp,up:n=>{n.url=""},down:"retired"},{id:rt.AddLabelColor,up:n=>{n.labelColor="black"},down:"retired"},{id:rt.RemoveJustify,up:n=>{n.align==="justify"&&(n.align="start")},down:"retired"},{id:rt.AddCheckBox,up:n=>{},down:"retired"},{id:rt.AddVerticalAlign,up:n=>{n.verticalAlign="middle"},down:"retired"},{id:rt.MigrateLegacyAlign,up:n=>{let t;switch(n.align){case"start":t="start-legacy";break;case"end":t="end-legacy";break;default:t="middle-legacy";break}n.align=t},down:"retired"},{id:rt.AddCloud,up:n=>{},down:"retired"},{id:rt.MakeUrlsValid,up:n=>{st.isValid(n.url)||(n.url="")},down:n=>{}},{id:rt.AddScale,up:n=>{n.scale=1},down:n=>{delete n.scale}}]},Lo={},Oo={sequence:[]},Jl={color:Mt,size:At,segments:Se(Ao),isComplete:Y,isPen:Y,scale:le},ed=Xe("highlight",{AddScale:1}),td={sequence:[{id:ed.AddScale,up:n=>{n.scale=1},down:n=>{delete n.scale}}]},sd=W({topLeft:Tt,bottomRight:Tt}),nd={w:le,h:le,playing:Y,url:st,assetId:fn.nullable(),crop:sd.nullable(),flipX:Y,flipY:Y},Ms=Xe("image",{AddUrlProp:1,AddCropProp:2,MakeUrlsValid:3,AddFlipProps:4}),id={sequence:[{id:Ms.AddUrlProp,up:n=>{n.url=""},down:"retired"},{id:Ms.AddCropProp,up:n=>{n.crop=null},down:n=>{delete n.crop}},{id:Ms.MakeUrlsValid,up:n=>{st.isValid(n.url)||(n.url="")},down:n=>{}},{id:Ms.AddFlipProps,up:n=>{n.flipX=!1,n.flipY=!1},down:n=>{delete n.flipX,delete n.flipY}}]},rd=ge.defineEnum("tldraw:spline",{defaultValue:"line",values:["cubic","line"]}),od=W({id:G,index:gi,x:N,y:N}),ad={color:Mt,dash:gn,size:At,spline:rd,points:jc(G,od),scale:le},es=Xe("line",{AddSnapHandles:1,RemoveExtraHandleProps:2,HandlesToPoints:3,PointIndexIds:4,AddScale:5}),cd={sequence:[{id:es.AddSnapHandles,up:n=>{for(const t of Object.values(n.handles))t.canSnap=!0},down:"retired"},{id:es.RemoveExtraHandleProps,up:n=>{n.handles=to(Object.values(n.handles).map(t=>[t.index,{x:t.x,y:t.y}]))},down:n=>{const t=Object.entries(n.handles).map(([e,s])=>({index:e,...s})).sort(Ue);n.handles=Object.fromEntries(t.map((e,s)=>{const i=s===0?"start":s===t.length-1?"end":`handle:${e.index}`;return[i,{id:i,type:"vertex",canBind:!1,canSnap:!0,index:e.index,x:e.x,y:e.y}]}))}},{id:es.HandlesToPoints,up:n=>{const t=Object.entries(n.handles).map(([e,{x:s,y:i}])=>({x:s,y:i,index:e})).sort(Ue);n.points=t.map(({x:e,y:s})=>({x:e,y:s})),delete n.handles},down:n=>{const t=Yn(n.points.length);n.handles=Object.fromEntries(n.points.map((e,s)=>[t[s],{x:e.x,y:e.y}])),delete n.points}},{id:es.PointIndexIds,up:n=>{const t=Yn(n.points.length);n.points=Object.fromEntries(n.points.map((e,s)=>{const i=t[s];return[i,{id:i,index:i,x:e.x,y:e.y}]}))},down:n=>{const t=Object.values(n.points).sort(Ue);n.points=t.map(({x:e,y:s})=>({x:e,y:s}))}},{id:es.AddScale,up:n=>{n.scale=1},down:n=>{delete n.scale}}]},ld={color:Mt,size:At,font:mn,fontSizeAdjustment:tn,align:Do,verticalAlign:Ro,growY:tn,url:st,text:G,scale:le},vt=Xe("note",{AddUrlProp:1,RemoveJustify:2,MigrateLegacyAlign:3,AddVerticalAlign:4,MakeUrlsValid:5,AddFontSizeAdjustment:6,AddScale:7}),dd={sequence:[{id:vt.AddUrlProp,up:n=>{n.url=""},down:"retired"},{id:vt.RemoveJustify,up:n=>{n.align==="justify"&&(n.align="start")},down:"retired"},{id:vt.MigrateLegacyAlign,up:n=>{switch(n.align){case"start":n.align="start-legacy";return;case"end":n.align="end-legacy";return;default:n.align="middle-legacy";return}},down:"retired"},{id:vt.AddVerticalAlign,up:n=>{n.verticalAlign="middle"},down:"retired"},{id:vt.MakeUrlsValid,up:n=>{st.isValid(n.url)||(n.url="")},down:n=>{}},{id:vt.AddFontSizeAdjustment,up:n=>{n.fontSizeAdjustment=0},down:n=>{delete n.fontSizeAdjustment}},{id:vt.AddScale,up:n=>{n.scale=1},down:n=>{delete n.scale}}]},hd=ge.defineEnum("tldraw:textAlign",{defaultValue:"start",values:["start","middle","end"]}),ud={color:Mt,size:At,font:mn,textAlign:hd,w:le,text:G,scale:le,autoSize:Y},or=Xe("text",{RemoveJustify:1,AddTextAlign:2}),pd={sequence:[{id:or.RemoveJustify,up:n=>{n.align==="justify"&&(n.align="start")},down:"retired"},{id:or.AddTextAlign,up:n=>{n.textAlign=n.align,delete n.align},down:n=>{n.align=n.textAlign,delete n.textAlign}}]},fd={w:le,h:le,time:N,playing:Y,url:st,assetId:fn.nullable()},ar=Xe("video",{AddUrlProp:1,MakeUrlsValid:2}),gd={sequence:[{id:ar.AddUrlProp,up:n=>{n.url=""},down:"retired"},{id:ar.MakeUrlsValid,up:n=>{st.isValid(n.url)||(n.url="")},down:n=>{}}]},As=Te("com.tldraw.store",{RemoveCodeAndIconShapeTypes:1,AddInstancePresenceType:2,RemoveTLUserAndPresenceAndAddPointer:3,RemoveUserDocument:4}),md=Kt({sequenceId:"com.tldraw.store",retroactive:!1,sequence:[{id:As.RemoveCodeAndIconShapeTypes,scope:"store",up:n=>{for(const[t,e]of Ne(n))e.typeName==="shape"&&(e.type==="icon"||e.type==="code")&&delete n[t]}},{id:As.AddInstancePresenceType,scope:"store",up(n){}},{id:As.RemoveTLUserAndPresenceAndAddPointer,scope:"store",up:n=>{for(const[t,e]of Ne(n))e.typeName.match(/^(user|user_presence)$/)&&delete n[t]}},{id:As.RemoveUserDocument,scope:"store",up:n=>{for(const[t,e]of Ne(n))e.typeName.match("user_document")&&delete n[t]}}]}),yd={arrow:{migrations:Jc,props:Qc},bookmark:{migrations:Nl,props:Ul},draw:{migrations:Kl,props:$l},embed:{migrations:Xl,props:Gl},frame:{migrations:Wl,props:ql},geo:{migrations:Ql,props:Zl},group:{migrations:Oo,props:Lo},highlight:{migrations:td,props:Jl},image:{migrations:id,props:nd},line:{migrations:cd,props:ad},note:{migrations:dd,props:ld},text:{migrations:pd,props:ud},video:{migrations:gd,props:fd}},Sd={arrow:{migrations:tl,props:el}};function wd({shapes:n=yd,bindings:t=Sd,migrations:e}={}){const s=new Map;for(const a of oe(n))for(const c of vo(a.props??{}).keys()){if(s.has(c.id)&&s.get(c.id)!==c)throw new Error(`Multiple StyleProp instances with the same id: ${c.id}`);s.set(c.id,c)}const i=qc(n),r=Yc(t),o=fl(s);return hi.create({asset:Bl,binding:r,camera:Ze,document:wi,instance:o,instance_page_state:Ye,page:ys,instance_presence:vl,pointer:Si,shape:i},{migrations:[md,zl,il,Cl,gl,yl,ul,Il,bl,Xc,Al,Rl,Ol,...Qi("shape",n),...Qi("binding",t),...e??[]],onValidationFailure:_l,createIntegrityChecker:Tl})}const cr=[{locale:"id",label:"Bahasa Indonesia"},{locale:"ca",label:"Català"},{locale:"cs",label:"Čeština"},{locale:"da",label:"Danish"},{locale:"de",label:"Deutsch"},{locale:"en",label:"English"},{locale:"es",label:"Español"},{locale:"fr",label:"Français"},{locale:"gl",label:"Galego"},{locale:"hr",label:"Hrvatski"},{locale:"it",label:"Italiano"},{locale:"hu",label:"Magyar"},{locale:"no",label:"Norwegian"},{locale:"pl",label:"Polski"},{locale:"pt-br",label:"Português - Brasil"},{locale:"pt-pt",label:"Português - Europeu"},{locale:"ro",label:"Română"},{locale:"ru",label:"Russian"},{locale:"sl",label:"Slovenščina"},{locale:"fi",label:"Suomi"},{locale:"sv",label:"Svenska"},{locale:"vi",label:"Tiếng Việt"},{locale:"tr",label:"Türkçe"},{locale:"uk",label:"Ukrainian"},{locale:"he",label:"עברית"},{locale:"ar",label:"عربي"},{locale:"fa",label:"فارسی"},{locale:"ku",label:"کوردی"},{locale:"ne",label:"नेपाली"},{locale:"hi-in",label:"हिन्दी"},{locale:"te",label:"తెలుగు"},{locale:"th",label:"ภาษาไทย"},{locale:"my",label:"မြန်မာစာ"},{locale:"ko-kr",label:"한국어"},{locale:"ja",label:"日本語"},{locale:"zh-cn",label:"简体中文"},{locale:"zh-tw",label:"繁體中文 (台灣)"}];function bd(){const n=typeof window<"u"?window.navigator.languages??["en"]:["en"];return xd(n)}function xd(n){for(const t of n){const e=Id(t);if(e)return e}return"en"}const lr={zh:"zh-cn",pt:"pt-br",ko:"ko-kr",hi:"hi-in"};function Id(n){const t=cr.find(i=>i.locale===n.toLowerCase());if(t)return t.locale;const[e,s]=n.split(/[-_]/).map(i=>i.toLowerCase());if(s){const i=cr.find(r=>r.locale===e);if(i)return i.locale}return e in lr?lr[e]:null}function yn(n,t){const e=dt.useRef(t);e.current=t;const[s,i,r]=dt.useMemo(()=>{let o=null;const a=d=>(o=d,()=>{o=null}),c=new Xt(`useStateTracking(${n})`,()=>{var d;return(d=e.current)==null?void 0:d.call(e)},{scheduleEffect(){o==null||o()}});return[c,a,()=>c.scheduleCount]},[n]);return dt.useSyncExternalStore(i,r,r),dt.useEffect(()=>(s.attach(),s.maybeScheduleEffect(),()=>{s.detach()}),[s]),s.execute()}const dr={apply(n,t,e){return yn(n.displayName??n.name??"tracked(???)",()=>n.apply(t,e))}},vd=Symbol.for("react.memo"),Pd=Symbol.for("react.forward_ref");function Sn(n){let t=null;const e=n.$$typeof;return e===vd&&(n=n.type,t=n.compare),e===Pd?k.memo(k.forwardRef(new Proxy(n.render,dr))):k.memo(new Proxy(n,dr),t)}function Cd(){const n=arguments[0],t=arguments[1],e=arguments.length===3?void 0:arguments[2],s=arguments.length===3?arguments[2]:arguments[3];return k.useMemo(()=>C(`useComputed(${n})`,t,e),s)}function Et(n,t,e=ht){k.useEffect(()=>{const s=new Xt(n,t);return s.attach(),s.execute(),()=>{s.detach()}},e)}function $(){const n=arguments,t=n.length===3?n[2]:[n[0]],e=n.length===3?n[0]:`useValue(${n[0].name})`,s=k.useRef(!0);s.current=!0;const i=k.useMemo(()=>n.length===1?n[0]:C(e,()=>{if(s.current)return n[1]();try{return n[1]()}catch{return{}}}),t);try{const{subscribe:r,getSnapshot:o}=k.useMemo(()=>({subscribe:a=>xs(`useValue(${e})`,()=>{i.get(),a()}),getSnapshot:()=>i.get()}),[i]);return k.useSyncExternalStore(r,o,o)}finally{s.current=!1}}const Fo="2.4.6",hr={major:"2024-06-28T10:56:07.893Z",minor:"2024-07-22T16:42:50.301Z"},Ed={error:null};class jo extends k.Component{constructor(){super(...arguments);u(this,"state",Ed)}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e){var s,i;(i=(s=this.props).onError)==null||i.call(s,e)}render(){const{error:e}=this.state;if(e!==null){const{fallback:s}=this.props;return y.jsx(s,{error:e})}return this.props.children}}function Ss({children:n,fallback:t,...e}){return t===null?n:y.jsx(jo,{fallback:t,...e,children:n})}const wn=k.createContext(null);function K(){const n=dt.useContext(wn);if(!n)throw new Error("useEditor must be used inside of the <Tldraw /> or <TldrawEditor /> components");return n}function _d(){return y.jsx("div",{className:"tl-background"})}function Is(n,t,e,s,i,r){k.useLayoutEffect(()=>{const o=n.current;if(!o||t===void 0)return;let a=`translate(${t}px, ${e}px)`;s!==void 0&&(a+=` scale(${s})`),i!==void 0&&(a+=` rotate(${i}rad)`),r&&(a+=` translate(${r.x}px, ${r.y}px)`),o.style.transform=a})}const ws={linear:n=>n,easeInQuad:n=>n*n,easeOutQuad:n=>n*(2-n),easeInOutQuad:n=>n<.5?2*n*n:-1+(4-2*n)*n,easeInCubic:n=>n*n*n,easeOutCubic:n=>--n*n*n+1,easeInOutCubic:n=>n<.5?4*n*n*n:(n-1)*(2*n-2)*(2*n-2)+1,easeInQuart:n=>n*n*n*n,easeOutQuart:n=>1- --n*n*n*n,easeInOutQuart:n=>n<.5?8*n*n*n*n:1-8*--n*n*n*n,easeInQuint:n=>n*n*n*n*n,easeOutQuint:n=>1+--n*n*n*n*n,easeInOutQuint:n=>n<.5?16*n*n*n*n*n:1+16*--n*n*n*n*n,easeInSine:n=>1-Math.cos(n*Math.PI/2),easeOutSine:n=>Math.sin(n*Math.PI/2),easeInOutSine:n=>-(Math.cos(Math.PI*n)-1)/2,easeInExpo:n=>n<=0?0:Math.pow(2,10*n-10),easeOutExpo:n=>n>=1?1:1-Math.pow(2,-10*n),easeInOutExpo:n=>n<=0?0:n>=1?1:n<.5?Math.pow(2,20*n-10)/2:(2-Math.pow(2,-20*n+10))/2};class m{constructor(t=0,e=0,s=1){this.x=t,this.y=e,this.z=s}get pressure(){return this.z}set(t=this.x,e=this.y,s=this.z){return this.x=t,this.y=e,this.z=s,this}setTo({x:t=0,y:e=0,z:s=1}){return this.x=t,this.y=e,this.z=s,this}rot(t){if(t===0)return this;const{x:e,y:s}=this,i=Math.sin(t),r=Math.cos(t);return this.x=e*r-s*i,this.y=e*i+s*r,this}rotWith(t,e){if(e===0)return this;const s=this.x-t.x,i=this.y-t.y,r=Math.sin(e),o=Math.cos(e);return this.x=t.x+(s*o-i*r),this.y=t.y+(s*r+i*o),this}clone(){const{x:t,y:e,z:s}=this;return new m(t,e,s)}sub(t){return this.x-=t.x,this.y-=t.y,this}subXY(t,e){return this.x-=t,this.y-=e,this}subScalar(t){return this.x-=t,this.y-=t,this}add(t){return this.x+=t.x,this.y+=t.y,this}addXY(t,e){return this.x+=t,this.y+=e,this}addScalar(t){return this.x+=t,this.y+=t,this}clamp(t,e){return this.x=Math.max(this.x,t),this.y=Math.max(this.y,t),e!==void 0&&(this.x=Math.min(this.x,e),this.y=Math.min(this.y,e)),this}div(t){return this.x/=t,this.y/=t,this}divV(t){return this.x/=t.x,this.y/=t.y,this}mul(t){return this.x*=t,this.y*=t,this}mulV(t){return this.x*=t.x,this.y*=t.y,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}nudge(t,e){const s=m.Tan(t,this);return this.add(s.mul(e))}neg(){return this.x*=-1,this.y*=-1,this}cross(t){return this.x=this.y*t.z-this.z*t.y,this.y=this.z*t.x-this.x*t.z,this}dpr(t){return m.Dpr(this,t)}cpr(t){return m.Cpr(this,t)}len2(){return m.Len2(this)}len(){return m.Len(this)}pry(t){return m.Pry(this,t)}per(){const{x:t,y:e}=this;return this.x=e,this.y=-t,this}uni(){return m.Uni(this)}tan(t){return m.Tan(this,t)}dist(t){return m.Dist(this,t)}distanceToLineSegment(t,e){return m.DistanceToLineSegment(t,e,this)}slope(t){return m.Slope(this,t)}snapToGrid(t){return this.x=Math.round(this.x/t)*t,this.y=Math.round(this.y/t)*t,this}angle(t){return m.Angle(this,t)}toAngle(){return m.ToAngle(this)}lrp(t,e){return this.x=this.x+(t.x-this.x)*e,this.y=this.y+(t.y-this.y)*e,this}equals(t){return m.Equals(this,t)}equalsXY(t,e){return m.EqualsXY(this,t,e)}norm(){const t=this.len();return this.x=t===0?0:this.x/t,this.y=t===0?0:this.y/t,this}toFixed(){return m.ToFixed(this)}toString(){return m.ToString(m.ToFixed(this))}toJson(){return m.ToJson(this)}toArray(){return m.ToArray(this)}static Add(t,e){return new m(t.x+e.x,t.y+e.y)}static AddXY(t,e,s){return new m(t.x+e,t.y+s)}static Sub(t,e){return new m(t.x-e.x,t.y-e.y)}static SubXY(t,e,s){return new m(t.x-e,t.y-s)}static AddScalar(t,e){return new m(t.x+e,t.y+e)}static SubScalar(t,e){return new m(t.x-e,t.y-e)}static Div(t,e){return new m(t.x/e,t.y/e)}static Mul(t,e){return new m(t.x*e,t.y*e)}static DivV(t,e){return new m(t.x/e.x,t.y/e.y)}static MulV(t,e){return new m(t.x*e.x,t.y*e.y)}static Neg(t){return new m(-t.x,-t.y)}static Per(t){return new m(t.y,-t.x)}static Abs(t){return new m(Math.abs(t.x),Math.abs(t.y))}static Dist(t,e){return((t.y-e.y)**2+(t.x-e.x)**2)**.5}static DistMin(t,e,s){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)<s**2}static Dist2(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)}static Dpr(t,e){return t.x*e.x+t.y*e.y}static Cross(t,e){return new m(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z)}static Cpr(t,e){return t.x*e.y-e.x*t.y}static Len2(t){return t.x*t.x+t.y*t.y}static Len(t){return(t.x*t.x+t.y*t.y)**.5}static Pry(t,e){return m.Dpr(t,e)/m.Len(e)}static Uni(t){return m.Div(t,m.Len(t))}static Tan(t,e){return m.Uni(m.Sub(t,e))}static Min(t,e){return new m(Math.min(t.x,e.x),Math.min(t.y,e.y))}static Max(t,e){return new m(Math.max(t.x,e.x),Math.max(t.y,e.y))}static From({x:t,y:e,z:s=1}){return new m(t,e,s)}static FromArray(t){return new m(t[0],t[1])}static Rot(t,e=0){const s=Math.sin(e),i=Math.cos(e);return new m(t.x*i-t.y*s,t.x*s+t.y*i)}static RotWith(t,e,s){const i=t.x-e.x,r=t.y-e.y,o=Math.sin(s),a=Math.cos(s);return new m(e.x+(i*a-r*o),e.y+(i*o+r*a))}static NearestPointOnLineThroughPoint(t,e,s){return m.Mul(e,m.Sub(s,t).pry(e)).add(t)}static NearestPointOnLineSegment(t,e,s,i=!0){if(m.Equals(t,s)||m.Equals(e,s))return m.From(s);const r=m.Tan(e,t),o=m.Add(t,m.Mul(r,m.Sub(s,t).pry(r)));if(i){if(o.x<Math.min(t.x,e.x))return m.Cast(t.x<e.x?t:e);if(o.x>Math.max(t.x,e.x))return m.Cast(t.x>e.x?t:e);if(o.y<Math.min(t.y,e.y))return m.Cast(t.y<e.y?t:e);if(o.y>Math.max(t.y,e.y))return m.Cast(t.y>e.y?t:e)}return o}static DistanceToLineThroughPoint(t,e,s){return m.Dist(s,m.NearestPointOnLineThroughPoint(t,e,s))}static DistanceToLineSegment(t,e,s,i=!0){return m.Dist(s,m.NearestPointOnLineSegment(t,e,s,i))}static Snap(t,e=1){return new m(Math.round(t.x/e)*e,Math.round(t.y/e)*e)}static Cast(t){return t instanceof m?t:m.From(t)}static Slope(t,e){return t.x===e.y?NaN:(t.y-e.y)/(t.x-e.x)}static IsNaN(t){return isNaN(t.x)||isNaN(t.y)}static Angle(t,e){return Math.atan2(e.y-t.y,e.x-t.x)}static Lrp(t,e,s){return m.Sub(e,t).mul(s).add(t)}static Med(t,e){return new m((t.x+e.x)/2,(t.y+e.y)/2)}static Equals(t,e){return Math.abs(t.x-e.x)<1e-4&&Math.abs(t.y-e.y)<1e-4}static EqualsXY(t,e,s){return t.x===e&&t.y===s}static Clockwise(t,e,s){return(s.x-t.x)*(e.y-t.y)-(e.x-t.x)*(s.y-t.y)<0}static Rescale(t,e){const s=m.Len(t);return new m(e*t.x/s,e*t.y/s)}static ScaleWithOrigin(t,e,s){return m.Sub(t,s).mul(e).add(s)}static ToFixed(t){return new m(pr(t.x),pr(t.y))}static ToInt(t){return new m(parseInt(t.x.toFixed(0)),parseInt(t.y.toFixed(0)),parseInt((t.z??0).toFixed(0)))}static ToCss(t){return`${t.x},${t.y}`}static Nudge(t,e,s){return m.Add(t,m.Tan(e,t).mul(s))}static ToString(t){return`${t.x}, ${t.y}`}static ToAngle(t){let e=Math.atan2(t.y,t.x);return e<0&&(e+=Math.PI*2),e}static FromAngle(t,e=1){return new m(Math.cos(t)*e,Math.sin(t)*e)}static ToArray(t){return[t.x,t.y,t.z]}static ToJson(t){const{x:e,y:s,z:i}=t;return{x:e,y:s,z:i}}static Average(t){const e=t.length,s=new m(0,0);if(e===0)return s;for(let i=0;i<e;i++)s.add(t[i]);return s.div(e)}static Clamp(t,e,s){return s===void 0?new m(Math.min(Math.max(t.x,e)),Math.min(Math.max(t.y,e))):new m(Math.min(Math.max(t.x,e),s),Math.min(Math.max(t.y,e),s))}static PointsBetween(t,e,s=6){const i=[];for(let r=0;r<s;r++){const o=ws.easeInQuad(r/(s-1)),a=m.Lrp(t,e,o);a.z=Math.min(1,.5+Math.abs(.5-kd(o))*.65),i.push(a)}return i}static SnapToGrid(t,e=8){return new m(Math.round(t.x/e)*e,Math.round(t.y/e)*e)}}const kd=n=>n<.5?2*n*n:-1+(4-2*n)*n;function Lt(n){return`${he(n.x)},${he(n.y)} `}function Ot(n,t){return`${he((n.x+t.x)/2)},${he((n.y+t.y)/2)} `}const $e=Math.PI,Zn=$e/2,ae=$e*2,jf=Math.sin;function ve(n,t,e){return Math.max(t,typeof e<"u"?Math.min(n,e):n)}function Ds(n,t=1e10){return n?Math.round(n*t)/t:0}function Hs(n,t,e=1e-6){return Math.abs(n-t)<=e}function Td(n,t){const e=Math.pow(n-t,2)/Math.pow(n+t,2);return $e*(n+t)*(1+3*e/(10+Math.sqrt(4-3*e)))}function Qn(n){return n=n%ae,n<0?n=n+ae:n===0&&(n=0),n}function bi(n,t){return n=Qn(n),t=Qn(t),n>t&&(t+=ae),t-n}function Md(n,t){return ae-bi(n,t)}function Mn(n,t){const e=(t-n)%ae;return 2*e%ae-e}function Jn(n){return(ae+n)%ae}function zf(n,t){const e=ae/t;let s=Math.floor((Jn(n)+e/2)/e)*e%ae;return s<$e&&(s+=ae),s>$e&&(s-=ae),s}function Ad(n,t){return n===t||Hs(n%(Math.PI/2)-t%(Math.PI/2),0)}function Bf(n){return n*$e/180}function Dd(n){return n*180/$e}function xi(n,t,e){return new m(n.x,n.y).add(m.FromAngle(e,t))}function Uf(n,t,e){const s=n/2,i=t/2,r=[];let o=1/0,a=-1/0,c=1/0,l=-1/0;for(let S=0;S<e;S++){const g=ae/e,w=-Zn+S*g,b=s+s*Math.cos(w),x=i+i*Math.sin(w);b<o&&(o=b),x<c&&(c=x),b>a&&(a=b),x>l&&(l=x),r.push(new m(b,x))}const d=a-o,h=l-c,p=n-d,f=t-h;if(p!==0||f!==0)for(let S=0;S<r.length;S++){const g=r[S];g.x=(g.x-o)/d*n,g.y=(g.y-c)/h*t}return r}function ts(n,t,e,s){return n<s&&e<t}function He(n,t,e,s){const i=Math.max(n,e),r=Math.min(t,s);return i<=r?[i,r]:null}function ur(n,t,e){return(t.x-n.x)*(e.y-n.y)-(e.x-n.x)*(t.y-n.y)}function _t(n,t){let e=0,s,i;for(let r=0;r<t.length;r++){if(s=t[r],s.x===n.x&&s.y===n.y||(i=t[(r+1)%t.length],m.Dist(n,s)+m.Dist(n,i)===m.Dist(s,i)))return!0;s.y<=n.y?i.y>n.y&&ur(s,i,n)>0&&(e+=1):i.y<=n.y&&ur(s,i,n)<0&&(e-=1)}return e!==0}function he(n){return Math.round(n*1e4)/1e4}function pr(n){return Math.round(n*100)/100}const Nf=n=>Math.abs(n)<Number.MAX_SAFE_INTEGER;function $f(n,t,e){return e<0?bi(n,t):Md(n,t)}function fr(n,t,e,s){let i;if(Math.abs(n)>$e){i=Mn(t,s);const r=Mn(s,e);return Math.abs(i)<Math.abs(r)?i/n:(n-r)/n}else{i=Mn(t,s);const r=i/n;return Math.sign(i)!==Math.sign(n)?Math.abs(r)>.5?1:0:r}}function Rd(n,t,e,s){const i=2*((t-n)%ae)%ae-(t-n)%ae;return s?(ae-Math.abs(i))*(e?1:-1):i}function Kf(n,t,e){const s=-2*(n.x*(t.y-e.y)-n.y*(t.x-e.x)+t.x*e.y-e.x*t.y);return new m(((n.x*n.x+n.y*n.y)*(e.y-t.y)+(t.x*t.x+t.y*t.y)*(n.y-e.y)+(e.x*e.x+e.y*e.y)*(t.y-n.y))/s,((n.x*n.x+n.y*n.y)*(t.x-e.x)+(t.x*t.x+t.y*t.y)*(e.x-n.x)+(e.x*e.x+e.y*e.y)*(n.x-t.x))/s)}function Hf(n,t,e,s,i){if(e===null)return[m.From(n),m.From(t)];const r=[],o=m.Angle(e,n),a=m.Angle(e,t),c=bi(o,a);for(let l=0;l<i;l++){const d=l/(i-1),h=o+c*d,p=xi(e,s,h);r.push(p)}return r}const An=({brush:n,color:t,opacity:e,className:s})=>{const i=k.useRef(null);Is(i,n.x,n.y);const r=he(Math.max(1,n.w)),o=he(Math.max(1,n.h));return y.jsx("svg",{className:"tl-overlays__item",ref:i,children:t?y.jsxs("g",{className:"tl-brush",opacity:e,children:[y.jsx("rect",{width:r,height:o,fill:t,opacity:.75}),y.jsx("rect",{width:r,height:o,fill:"none",stroke:t,opacity:.1})]}):y.jsx("rect",{className:`tl-brush tl-brush__default ${s}`,width:r,height:o})})},gr={isLocked:!1,wheelBehavior:"pan",panSpeed:1,zoomSpeed:1,zoomSteps:[.1,.25,.5,1,2,4,8]},Dn={duration:0,easing:ws.easeInOutCubic},mr={CAMERA_MOVE:-10},Ld=["top","right","bottom","left"],yr=0,Ii=2,Rs=1,Sr=5,Od=128;function nn(n){if(n instanceof HTMLElement)return n;if(n.parentElement)return nn(n.parentElement);throw Error("Could not find a parent element of an HTML type!")}function ye(n){n.preventDefault(),Ce.logPreventDefaults.get()&&console.warn("preventDefault called on event:",n)}function vi(n,t){if(n.setPointerCapture(t.pointerId),Ce.logPointerCaptures.get()){const e=mo.get();e.set(n,(e.get(n)??0)+1),console.warn("setPointerCapture called on element:",n,t)}}function Pi(n,t){if(n.hasPointerCapture(t.pointerId)&&(n.releasePointerCapture(t.pointerId),Ce.logPointerCaptures.get())){const e=mo.get();e.get(n)===1?e.delete(n):e.has(n)?e.set(n,e.get(n)-1):console.warn("Release without capture"),console.warn("releasePointerCapture called on element:",n,t)}}const vs=n=>n.stopPropagation(),me=(n,t,e)=>{n&&n.style.setProperty(t,e)};function Ge(n){return n.isKilled=!0,{point:{x:n.clientX,y:n.clientY,z:n.pressure},shiftKey:n.shiftKey,altKey:n.altKey,ctrlKey:n.metaKey||n.ctrlKey,pointerId:n.pointerId,button:n.button,isPen:n.pointerType==="pen"}}function zo(){const n=K();return k.useMemo(function(){let s,i;function r(g){if(!g.isKilled){if(g.button===Ii){n.dispatch({type:"pointer",target:"canvas",name:"right_click",...Ge(g)});return}g.button!==0&&g.button!==1&&g.button!==5||(vi(g.currentTarget,g),n.dispatch({type:"pointer",target:"canvas",name:"pointer_down",...Ge(g)}))}}function o(g){g.isKilled||g.clientX===s&&g.clientY===i||(s=g.clientX,i=g.clientY,n.dispatch({type:"pointer",target:"canvas",name:"pointer_move",...Ge(g)}))}function a(g){g.isKilled||g.button!==0&&g.button!==1&&g.button!==2&&g.button!==5||(s=g.clientX,i=g.clientY,Pi(g.currentTarget,g),n.dispatch({type:"pointer",target:"canvas",name:"pointer_up",...Ge(g)}))}function c(g){if(g.isKilled||n.getInstanceState().isPenMode&&g.pointerType!=="pen")return;const w=g.pointerType==="mouse"||g.pointerType==="pen";n.updateInstanceState({isHoveringCanvas:w?!0:null})}function l(g){if(g.isKilled||n.getInstanceState().isPenMode&&g.pointerType!=="pen")return;const w=g.pointerType==="mouse"||g.pointerType==="pen";n.updateInstanceState({isHoveringCanvas:w?!1:null})}function d(g){g.isKilled=!0,ye(g)}function h(g){g.isKilled=!0,g.target instanceof HTMLElement&&g.target.tagName!=="A"&&g.target.tagName!=="TEXTAREA"&&!(n.getEditingShape()&&g.target.className.includes("tl-text-content"))&&ye(g)}function p(g){ye(g)}async function f(g){var b,x;if(ye(g),!((x=(b=g.dataTransfer)==null?void 0:b.files)!=null&&x.length))return;const w=Array.from(g.dataTransfer.files);await n.putExternalContent({type:"files",files:w,point:n.screenToPage({x:g.clientX,y:g.clientY}),ignoreParent:!1})}function S(g){vs(g)}return{onPointerDown:r,onPointerMove:o,onPointerUp:a,onPointerEnter:c,onPointerLeave:l,onDragOver:p,onDrop:f,onTouchStart:d,onTouchEnd:h,onClick:S}},[n])}function Fd(){const n=K();k.useEffect(()=>{let t=n.getInstanceState().isCoarsePointer;const e=o=>{const a=o.pointerType!=="mouse";t!==a&&(t=a,n.updateInstanceState({isCoarsePointer:a}))};window.addEventListener("pointerdown",e,{capture:!0});const s=window.matchMedia&&window.matchMedia("(any-pointer: coarse)"),i=n.environment.isFirefox&&!n.environment.isAndroid&&!n.environment.isIos,r=()=>{const o=i?!1:s.matches;t===o&&(t=o,n.updateInstanceState({isCoarsePointer:o}))};return s&&(s.addEventListener("change",r),r()),()=>{window.removeEventListener("pointerdown",e,{capture:!0}),s&&s.removeEventListener("change",r)}},[n])}const Bo=k.createContext(null);function jd({container:n,children:t}){return y.jsx(Bo.Provider,{value:n,children:t})}function Dt(){return Be(k.useContext(Bo),"useContainer used outside of <Tldraw />")}function zd(){const n=K(),t=Dt(),e=$("isFocused",()=>n.getIsFocused(),[n]);k.useEffect(()=>{if(typeof window>"u"||!("matchMedia"in window))return;let s=null;const i=()=>{s!=null&&s();const r=`(resolution: ${window.devicePixelRatio}dppx)`,o=matchMedia(r),a=c=>{c.type==="change"&&i()};o.addEventListener?o.addEventListener("change",i):o.addListener&&o.addListener(a),s=()=>{o.removeEventListener?o.removeEventListener("change",i):o.removeListener&&o.removeListener(a)},n.updateInstanceState({devicePixelRatio:window.devicePixelRatio})};return i(),()=>{s==null||s()}},[n]),k.useEffect(()=>{if(!e)return;const s=a=>{if(a.altKey&&(n.isIn("zoom")||!n.getPath().endsWith(".idle"))&&!Ls()&&ye(a),a.isKilled)return;switch(a.isKilled=!0,a.key){case"=":case"-":case"0":{if(a.metaKey||a.ctrlKey){ye(a);return}break}case"Tab":{if(Ls()||n.getIsMenuOpen())return;break}case",":return;case"Escape":{if((n.getEditingShape()||n.getSelectedShapeIds().length>0)&&a.preventDefault(),n.getOpenMenus().length>0)return;n.inputs.keys.has("Escape")||(n.inputs.keys.add("Escape"),n.cancel(),n.focus());return}default:if(Ls()||n.getIsMenuOpen())return}const c={type:"keyboard",name:a.repeat?"key_repeat":"key_down",key:a.key,code:a.code,shiftKey:a.shiftKey,altKey:a.altKey,ctrlKey:a.metaKey||a.ctrlKey};n.dispatch(c)},i=a=>{if(a.isKilled||(a.isKilled=!0,Ls()||n.getIsMenuOpen())||a.key===",")return;const c={type:"keyboard",name:"key_up",key:a.key,code:a.code,shiftKey:a.shiftKey,altKey:a.altKey,ctrlKey:a.metaKey||a.ctrlKey};n.dispatch(c)};function r(a){var c,l;if(t.contains(a.target)){const d=a.touches[0].pageX,h=a.touches[0].radiusX||0;(d-h<10||d+h>n.getViewportScreenBounds().width-10)&&(((c=a.target)==null?void 0:c.tagName)==="BUTTON"&&((l=a.target)==null||l.click()),ye(a))}}const o=a=>{t.contains(a.target)&&(a.ctrlKey||a.metaKey)&&ye(a)};return t.addEventListener("touchstart",r,{passive:!1}),t.addEventListener("wheel",o,{passive:!1}),document.addEventListener("gesturestart",ye),document.addEventListener("gesturechange",ye),document.addEventListener("gestureend",ye),t.addEventListener("keydown",s),t.addEventListener("keyup",i),()=>{t.removeEventListener("touchstart",r),t.removeEventListener("wheel",o),document.removeEventListener("gesturestart",ye),document.removeEventListener("gesturechange",ye),document.removeEventListener("gestureend",ye),t.removeEventListener("keydown",s),t.removeEventListener("keyup",i)}},[n,t,e])}const Bd=["input","select","button","textarea"];function Ls(){const{activeElement:n}=document;return!!(n&&(n.getAttribute("contenteditable")||Bd.indexOf(n.tagName.toLowerCase())>-1))}const Ud=["textarea","input"];function Nd(n){const t=K();k.useEffect(()=>{const e=n.current;if(!e)return;const s=i=>{var r;if(i instanceof PointerEvent&&i.pointerType==="pen"){i.isKilled=!0;const{target:o}=i;if(Ud.includes((r=o.tagName)==null?void 0:r.toLocaleLowerCase())||t.isIn("select.editing_shape"))return;ye(i)}};return e.addEventListener("touchstart",s),e.addEventListener("touchend",s),()=>{e.removeEventListener("touchstart",s),e.removeEventListener("touchend",s)}},[t,n])}const wr=10,$d=/Mac|iPod|iPhone|iPad/.test(typeof window>"u"?"node":window.navigator.platform);function Kd(n){let{deltaY:t,deltaX:e}=n,s=0;return n.ctrlKey||n.altKey||n.metaKey?s=(Math.abs(t)>wr?wr*Math.sign(t):t)/100:n.shiftKey&&!$d&&(e=t,t=0),{x:-e,y:-t,z:-s}}const Hd=Ma([Aa,Da]);let Ft;const Yd=n=>Ft===void 0?(Ft=n,!1):n-Ft>120&&n-Ft<160?(Ft=n,!0):(Ft=n,!1);function Gd(n){const t=K(),e=k.useMemo(()=>{let s="not sure";const i=({event:g})=>{if(!t.getInstanceState().isFocused||(s="not sure",Yd(Date.now())))return;const w=t.getEditingShapeId();if(w){const I=t.getShape(w);if(I&&t.getShapeUtil(I).canScroll(I)){const T=t.getShapePageBounds(w);if(T!=null&&T.containsPoint(t.inputs.currentPagePoint))return}}ye(g),vs(g);const b=Kd(g);if(b.x===0&&b.y===0)return;const x={type:"wheel",name:"wheel",delta:b,point:new m(g.clientX,g.clientY),shiftKey:g.shiftKey,altKey:g.altKey,ctrlKey:g.metaKey||g.ctrlKey};t.dispatch(x)};let r=1,o=1,a=1,c=0;const l=new m,d=new m,h=g=>{const w=n.current;s="not sure";const{event:b,origin:x,da:I}=g;b instanceof WheelEvent||(b.target===w||w!=null&&w.contains(b.target))&&(d.x=x[0],d.y=x[1],l.x=x[0],l.y=x[1],r=I[0],o=t.getZoomLevel(),t.dispatch({type:"pinch",name:"pinch_start",point:{x:x[0],y:x[1],z:t.getZoomLevel()},delta:{x:0,y:0},shiftKey:b.shiftKey,altKey:b.altKey,ctrlKey:b.metaKey||b.ctrlKey}))},p=g=>{if(g&&(s="zooming"),s==="zooming")return;const w=Math.abs(c-r),b=m.Dist(l,d);switch(s){case"not sure":{w>24?s="zooming":b>16&&(s="panning");break}case"panning":{w>64&&(s="zooming");break}}};return{onWheel:i,onPinchStart:h,onPinchEnd:g=>{const w=n.current,{event:b,origin:x,offset:I}=g;if(b instanceof WheelEvent||!(b.target===w||w!=null&&w.contains(b.target)))return;const _=I[0];s="not sure",t.timers.requestAnimationFrame(()=>{t.dispatch({type:"pinch",name:"pinch_end",point:{x:x[0],y:x[1],z:_},delta:{x:x[0],y:x[1]},shiftKey:b.shiftKey,altKey:b.altKey,ctrlKey:b.metaKey||b.ctrlKey})})},onPinch:g=>{const w=n.current,{event:b,origin:x,offset:I,da:_}=g;if(b instanceof WheelEvent||!(b.target===w||w!=null&&w.contains(b.target)))return;const T=g.type==="gesturechange"||g.type==="gestureend";c=_[0];const A=x[0]-d.x,M=x[1]-d.y;switch(d.x=x[0],d.y=x[1],p(T),s){case"zooming":{a=I[0],t.dispatch({type:"pinch",name:"pinch",point:{x:x[0],y:x[1],z:a},delta:{x:A,y:M},shiftKey:b.shiftKey,altKey:b.altKey,ctrlKey:b.metaKey||b.ctrlKey});break}case"panning":{t.dispatch({type:"pinch",name:"pinch",point:{x:x[0],y:x[1],z:o},delta:{x:A,y:M},shiftKey:b.shiftKey,altKey:b.altKey,ctrlKey:b.metaKey||b.ctrlKey});break}}}}},[t,n]);Hd(e,{target:n,eventOptions:{passive:!1},pinch:{from:()=>[t.getZoomLevel(),0],scaleBounds:()=>({from:t.getZoomLevel(),max:8,min:.05})}})}function Rn(n,t,e){const s=n.getShape(t),i=n.getShapeHandles(s);return{shape:s,handle:i.find(r=>r.id===e)}}function Xd(n,t){const e=K();return k.useMemo(()=>{const s=c=>{if(c.isKilled)return;const l=nn(c.currentTarget);vi(l,c);const{shape:d,handle:h}=Rn(e,n,t);h&&e.dispatch({type:"pointer",target:"handle",handle:h,shape:d,name:"pointer_down",...Ge(c)})};let i,r;return{onPointerDown:s,onPointerMove:c=>{if(c.isKilled||c.clientX===i&&c.clientY===r)return;i=c.clientX,r=c.clientY;const{shape:l,handle:d}=Rn(e,n,t);d&&e.dispatch({type:"pointer",target:"handle",handle:d,shape:l,name:"pointer_move",...Ge(c)})},onPointerUp:c=>{if(c.isKilled)return;const l=nn(c.currentTarget);Pi(l,c);const{shape:d,handle:h}=Rn(e,n,t);h&&e.dispatch({type:"pointer",target:"handle",handle:h,shape:d,name:"pointer_up",...Ge(c)})}}},[e,n,t])}const ne=class ne{constructor(t=0,e=0,s=0,i=0){u(this,"x",0);u(this,"y",0);u(this,"w",0);u(this,"h",0);this.x=t,this.y=e,this.w=s,this.h=i}get point(){return new m(this.x,this.y)}set point(t){this.x=t.x,this.y=t.y}get minX(){return this.x}set minX(t){this.x=t}get midX(){return this.x+this.w/2}get maxX(){return this.x+this.w}get minY(){return this.y}set minY(t){this.y=t}get midY(){return this.y+this.h/2}get maxY(){return this.y+this.h}get width(){return this.w}set width(t){this.w=t}get height(){return this.h}set height(t){this.h=t}get aspectRatio(){return this.width/this.height}get center(){return new m(this.midX,this.midY)}set center(t){this.minX=t.x-this.width/2,this.minY=t.y-this.height/2}get corners(){return[new m(this.minX,this.minY),new m(this.maxX,this.minY),new m(this.maxX,this.maxY),new m(this.minX,this.maxY)]}get cornersAndCenter(){return[new m(this.minX,this.minY),new m(this.maxX,this.minY),new m(this.maxX,this.maxY),new m(this.minX,this.maxY),this.center]}get sides(){const{corners:t}=this;return[[t[0],t[1]],[t[1],t[2]],[t[2],t[3]],[t[3],t[0]]]}get size(){return new m(this.w,this.h)}toFixed(){return this.x=Ds(this.x),this.y=Ds(this.y),this.w=Ds(this.w),this.h=Ds(this.h),this}setTo(t){return this.x=t.x,this.y=t.y,this.w=t.w,this.h=t.h,this}set(t=0,e=0,s=0,i=0){return this.x=t,this.y=e,this.w=s,this.h=i,this}expand(t){const e=Math.min(this.minX,t.minX),s=Math.min(this.minY,t.minY),i=Math.max(this.maxX,t.maxX),r=Math.max(this.maxY,t.maxY);return this.x=e,this.y=s,this.w=i-e,this.h=r-s,this}expandBy(t){return this.x-=t,this.y-=t,this.w+=t*2,this.h+=t*2,this}scale(t){return this.x/=t,this.y/=t,this.w/=t,this.h/=t,this}clone(){const{x:t,y:e,w:s,h:i}=this;return new ne(t,e,s,i)}translate(t){return this.x+=t.x,this.y+=t.y,this}snapToGrid(t){const e=Math.round(this.minX/t)*t,s=Math.round(this.minY/t)*t,i=Math.round(this.maxX/t)*t,r=Math.round(this.maxY/t)*t;this.minX=e,this.minY=s,this.width=Math.max(1,i-e),this.height=Math.max(1,r-s)}collides(t){return ne.Collides(this,t)}contains(t){return ne.Contains(this,t)}includes(t){return ne.Includes(this,t)}containsPoint(t,e=0){return ne.ContainsPoint(this,t,e)}getHandlePoint(t){switch(t){case"top_left":return new m(this.minX,this.minY);case"top_right":return new m(this.maxX,this.minY);case"bottom_left":return new m(this.minX,this.maxY);case"bottom_right":return new m(this.maxX,this.maxY);case"top":return new m(this.midX,this.minY);case"right":return new m(this.maxX,this.midY);case"bottom":return new m(this.midX,this.maxY);case"left":return new m(this.minX,this.midY)}}toJson(){return{x:this.minX,y:this.minY,w:this.w,h:this.h}}resize(t,e,s){const{minX:i,minY:r,maxX:o,maxY:a}=this;let{minX:c,minY:l,maxX:d,maxY:h}=this;switch(t){case"left":case"top_left":case"bottom_left":{c+=e;break}case"right":case"top_right":case"bottom_right":{d+=e;break}}switch(t){case"top":case"top_left":case"top_right":{l+=s;break}case"bottom":case"bottom_left":case"bottom_right":{h+=s;break}}const p=(d-c)/(o-i),f=(h-l)/(a-r),S=p<0,g=f<0;if(S){const w=d;d=c,c=w}if(g){const w=h;h=l,l=w}this.minX=c,this.minY=l,this.width=Math.abs(d-c),this.height=Math.abs(h-l)}union(t){const e=Math.min(this.minX,t.x),s=Math.min(this.minY,t.y),i=Math.max(this.maxX,t.w+t.x),r=Math.max(this.maxY,t.h+t.y);return this.x=e,this.y=s,this.width=i-e,this.height=r-s,this}static From(t){return new ne(t.x,t.y,t.w,t.h)}static FromCenter(t,e){return new ne(t.x-e.x/2,t.y-e.y/2,e.x,e.y)}static FromPoints(t){if(t.length===0)return new ne;let e=1/0,s=1/0,i=-1/0,r=-1/0,o;for(let a=0,c=t.length;a<c;a++)o=t[a],e=Math.min(o.x,e),s=Math.min(o.y,s),i=Math.max(o.x,i),r=Math.max(o.y,r);return new ne(e,s,i-e,r-s)}static Expand(t,e){const s=Math.min(e.minX,t.minX),i=Math.min(e.minY,t.minY),r=Math.max(e.maxX,t.maxX),o=Math.max(e.maxY,t.maxY);return new ne(s,i,r-s,o-i)}static ExpandBy(t,e){return new ne(t.minX-e,t.minY-e,t.width+e*2,t.height+e*2)}static Resize(t,e,s,i,r=!1){const{minX:o,minY:a,maxX:c,maxY:l}=t;let{minX:d,minY:h,maxX:p,maxY:f}=t;switch(e){case"left":case"top_left":case"bottom_left":{d+=s;break}case"right":case"top_right":case"bottom_right":{p+=s;break}}switch(e){case"top":case"top_left":case"top_right":{h+=i;break}case"bottom":case"bottom_left":case"bottom_right":{f+=i;break}}const S=(p-d)/(c-o),g=(f-h)/(l-a),w=S<0,b=g<0;if(r){const I=(c-o)/(l-a),_=Math.abs(p-d),T=Math.abs(f-h),A=_*(g<0?1:-1)*(1/I),M=T*(S<0?1:-1)*I,F=I<_/T;switch(e){case"top_left":{F?h=f+A:d=p+M;break}case"top_right":{F?h=f+A:p=d-M;break}case"bottom_right":{F?f=h-A:p=d-M;break}case"bottom_left":{F?f=h-A:d=p+M;break}case"bottom":case"top":{const v=(d+p)/2,E=T*I;d=v-E/2,p=v+E/2;break}case"left":case"right":{const v=(h+f)/2,E=_/I;h=v-E/2,f=v+E/2;break}}}if(w){const I=p;p=d,d=I}if(b){const I=f;f=h,h=I}const x=new ne(d,h,Math.abs(p-d),Math.abs(f-h));return{box:x,scaleX:+(x.width/t.width*(S>0?1:-1)).toFixed(5),scaleY:+(x.height/t.height*(g>0?1:-1)).toFixed(5)}}equals(t){return ne.Equals(this,t)}static Equals(t,e){return e.x===t.x&&e.y===t.y&&e.w===t.w&&e.h===t.h}zeroFix(){return this.w=Math.max(1,this.w),this.h=Math.max(1,this.h),this}static ZeroFix(t){return new ne(t.x,t.y,Math.max(1,t.w),Math.max(1,t.h))}};u(ne,"Collides",(t,e)=>!(t.maxX<e.minX||t.minX>e.maxX||t.maxY<e.minY||t.minY>e.maxY)),u(ne,"Contains",(t,e)=>t.minX<e.minX&&t.minY<e.minY&&t.maxY>e.maxY&&t.maxX>e.maxX),u(ne,"Includes",(t,e)=>ne.Collides(t,e)||ne.Contains(t,e)),u(ne,"ContainsPoint",(t,e,s=0)=>!(e.x<t.minX-s||e.y<t.minY-s||e.x>t.maxX+s||e.y>t.maxY+s)),u(ne,"Common",t=>{let e=1/0,s=1/0,i=-1/0,r=-1/0;for(let o=0;o<t.length;o++){const a=t[o];e=Math.min(e,a.minX),s=Math.min(s,a.minY),i=Math.max(i,a.maxX),r=Math.max(r,a.maxY)}return new ne(e,s,i-e,r-s)}),u(ne,"Sides",(t,e=0)=>{const{corners:s}=t;return[[s[0],s[1]],[s[1],s[2]],[s[2],s[3]],[s[3],s[0]]]});let H=ne;function qd(n){switch(n){case"top":return"bottom";case"bottom":return"top";case"top_left":return"bottom_left";case"top_right":return"bottom_right";case"bottom_left":return"top_left";case"bottom_right":return"top_right";default:return n}}function Wd(n){switch(n){case"left":return"right";case"right":return"left";case"top_left":return"top_right";case"top_right":return"top_left";case"bottom_left":return"bottom_right";case"bottom_right":return"bottom_left";default:return n}}function Vd(n){return n==="top_left"||n==="top_right"||n==="bottom_right"||n==="bottom_left"}function Zd(n){const t=K();k.useLayoutEffect(()=>{let e=new H;function s(){const l=n.current;if(!l)return null;const d=l.getBoundingClientRect(),h=new H(d.left||d.x,d.top||d.y,Math.max(d.width,1),Math.max(d.height,1));e.equals(h)||(t.updateViewportScreenBounds(h),e=h)}s();const i=_a(s,200,{trailing:!0}),r=t.timers.setInterval(i,1e3);window.addEventListener("resize",i);const o=new ResizeObserver(l=>{l[0].contentRect&&i()}),a=n.current;let c=null;return a&&(o.observe(a),c=Qd(a),c.addEventListener("scroll",i)),()=>{clearInterval(r),window.removeEventListener("resize",i),o.disconnect(),c==null||c.removeEventListener("scroll",i),i.cancel()}},[t,n])}/*!
 * Author: excalidraw
 * MIT License: https://github.com/excalidraw/excalidraw/blob/master/LICENSE
 * https://github.com/excalidraw/excalidraw/blob/48c3465b19f10ec755b3eb84e21a01a468e96e43/packages/excalidraw/utils.ts#L600
 */const Qd=n=>{let t=n.parentElement;for(;t;){if(t===document.body)return document;const{overflowY:e}=window.getComputedStyle(t);if(t.scrollHeight>t.clientHeight&&(e==="auto"||e==="scroll"||e==="overlay"))return t;t=t.parentElement}return document},Q=class Q{constructor(t,e,s,i,r,o){u(this,"a",1);u(this,"b",0);u(this,"c",0);u(this,"d",1);u(this,"e",0);u(this,"f",0);this.a=t,this.b=e,this.c=s,this.d=i,this.e=r,this.f=o}equals(t){return this===t||this.a===t.a&&this.b===t.b&&this.c===t.c&&this.d===t.d&&this.e===t.e&&this.f===t.f}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0,this}multiply(t){const e=t,{a:s,b:i,c:r,d:o,e:a,f:c}=this;return this.a=s*e.a+r*e.b,this.c=s*e.c+r*e.d,this.e=s*e.e+r*e.f+a,this.b=i*e.a+o*e.b,this.d=i*e.c+o*e.d,this.f=i*e.e+o*e.f+c,this}rotate(t,e,s){return t===0?this:e===void 0?this.multiply(Q.Rotate(t)):this.translate(e,s).multiply(Q.Rotate(t)).translate(-e,-s)}translate(t,e){return this.multiply(Q.Translate(t,e))}scale(t,e){return this.multiply(Q.Scale(t,e))}invert(){const{a:t,b:e,c:s,d:i,e:r,f:o}=this,a=t*i-e*s;return this.a=i/a,this.b=e/-a,this.c=s/-a,this.d=t/a,this.e=(i*r-s*o)/-a,this.f=(e*r-t*o)/a,this}applyToPoint(t){return Q.applyToPoint(this,t)}applyToPoints(t){return Q.applyToPoints(this,t)}rotation(){return Q.Rotation(this)}point(){return Q.Point(this)}decomposed(){return Q.Decompose(this)}toCssString(){return Q.toCssString(this)}setTo(t){return Object.assign(this,t),this}decompose(){return Q.Decompose(this)}clone(){return new Q(this.a,this.b,this.c,this.d,this.e,this.f)}static Identity(){return new Q(1,0,0,1,0,0)}static Translate(t,e){return new Q(1,0,0,1,t,e)}static Rotate(t,e,s){if(t===0)return Q.Identity();const i=Math.cos(t),r=Math.sin(t),o=new Q(i,r,-r,i,0,0);return e===void 0?o:Q.Compose(Q.Translate(e,s),o,Q.Translate(-e,-s))}static Multiply(t,e){return{a:t.a*e.a+t.c*e.b,c:t.a*e.c+t.c*e.d,e:t.a*e.e+t.c*e.f+t.e,b:t.b*e.a+t.d*e.b,d:t.b*e.c+t.d*e.d,f:t.b*e.e+t.d*e.f+t.f}}static Inverse(t){const e=t.a*t.d-t.b*t.c;return{a:t.d/e,b:t.b/-e,c:t.c/-e,d:t.a/e,e:(t.d*t.e-t.c*t.f)/-e,f:(t.b*t.e-t.a*t.f)/e}}static Absolute(t){const e=t.a*t.d-t.b*t.c;return{a:t.d/e,b:t.b/-e,c:t.c/-e,d:t.a/e,e:(t.d*t.e-t.c*t.f)/e,f:(t.b*t.e-t.a*t.f)/-e}}static Compose(...t){const e=Q.Identity();for(let s=0,i=t.length;s<i;s++)e.multiply(t[s]);return e}static Point(t){return new m(t.e,t.f)}static Rotation(t){let e;if(t.a!==0||t.c!==0){const s=(t.a*t.a+t.c*t.c)**.5;e=Math.acos(t.a/s)*(t.c>0?-1:1)}else if(t.b!==0||t.d!==0){const s=(t.b*t.b+t.d*t.d)**.5;e=Zn+Math.acos(t.b/s)*(t.d>0?-1:1)}else e=0;return Jn(e)}static Decompose(t){let e,s,i;if(t.a!==0||t.c!==0){const r=(t.a*t.a+t.c*t.c)**.5;e=r,s=(t.a*t.d-t.b*t.c)/r,i=Math.acos(t.a/r)*(t.c>0?-1:1)}else if(t.b!==0||t.d!==0){const r=(t.b*t.b+t.d*t.d)**.5;e=(t.a*t.d-t.b*t.c)/r,s=r,i=Zn+Math.acos(t.b/r)*(t.d>0?-1:1)}else e=0,s=0,i=0;return{x:t.e,y:t.f,scaleX:e,scaleY:s,rotation:Jn(i)}}static Smooth(t,e=1e10){return t.a=Math.round(t.a*e)/e,t.b=Math.round(t.b*e)/e,t.c=Math.round(t.c*e)/e,t.d=Math.round(t.d*e)/e,t.e=Math.round(t.e*e)/e,t.f=Math.round(t.f*e)/e,t}static toCssString(t){return`matrix(${he(t.a)}, ${he(t.b)}, ${he(t.c)}, ${he(t.d)}, ${he(t.e)}, ${he(t.f)})`}static applyToPoint(t,e){return new m(t.a*e.x+t.c*e.y+t.e,t.b*e.x+t.d*e.y+t.f,e.z)}static applyToXY(t,e,s){return[t.a*e+t.c*s+t.e,t.b*e+t.d*s+t.f]}static applyToPoints(t,e){return e.map(s=>new m(t.a*s.x+t.c*s.y+t.e,t.b*s.x+t.d*s.y+t.f,s.z))}static applyToBounds(t,e){return new H(t.e+e.minX,t.f+e.minY,e.width,e.height)}static From(t){return new Q(t.a,t.b,t.c,t.d,t.e,t.f)}static Cast(t){return t instanceof Q?t:Q.From(t)}};u(Q,"Scale",(t,e,s,i)=>{const r=new Q(t,0,0,e,0,0);return s===void 0?r:Q.Compose(Q.Translate(s,i),r,Q.Translate(-s,-i))});let ie=Q;function Uo(n,t){return t===0?n:Uo(t,n%t)}function No(n){const t=n.toString().split(".")[1];if(!t)return 1;const e=Math.pow(10,t.length),s=parseInt(t,10);return e/Uo(s,e)}class xt{constructor(t){u(this,"isFilled",!1);u(this,"isClosed",!0);u(this,"isLabel",!1);u(this,"debugColor");u(this,"ignore");u(this,"_vertices");u(this,"_bounds");u(this,"_area");u(this,"_length");this.isFilled=t.isFilled,this.isClosed=t.isClosed,this.isLabel=t.isLabel??!1,this.debugColor=t.debugColor,this.ignore=t.ignore}hitTestPoint(t,e=0,s=!1){return this.isClosed&&(this.isFilled||s)&&_t(t,this.vertices)?!0:m.Dist2(t,this.nearestPoint(t))<=e*e}distanceToPoint(t,e=!1){return t.dist(this.nearestPoint(t))*(this.isClosed&&(this.isFilled||e)&&_t(t,this.vertices)?-1:1)}distanceToLineSegment(t,e){if(t.equals(e))return this.distanceToPoint(t);const{vertices:s}=this;let i,r=1/0,o,a,c;for(let l=0;l<s.length;l++)a=s[l],c=m.NearestPointOnLineSegment(t,e,a,!0),o=m.Dist2(a,c),o<r&&(r=o,i=c);if(!i)throw Error("nearest point not found");return this.isClosed&&this.isFilled&&_t(i,this.vertices)?-r:r}hitTestLineSegment(t,e,s=0){return this.distanceToLineSegment(t,e)<=s}nearestPointOnLineSegment(t,e){const{vertices:s}=this;let i,r=1/0,o,a,c;for(let l=0;l<s.length;l++)a=s[l],c=m.NearestPointOnLineSegment(t,e,a,!0),o=m.Dist2(a,c),o<r&&(r=o,i=c);if(!i)throw Error("nearest point not found");return i}isPointInBounds(t,e=0){const{bounds:s}=this;return!(t.x<s.minX-e||t.y<s.minY-e||t.x>s.maxX+e||t.y>s.maxY+e)}get vertices(){return this._vertices||(this._vertices=this.getVertices()),this._vertices}getBounds(){return H.FromPoints(this.vertices)}get bounds(){return this._bounds||(this._bounds=this.getBounds()),this._bounds}get center(){return this.bounds.center}get area(){return this._area||(this._area=this.getArea()),this._area}getArea(){if(!this.isClosed)return 0;const{vertices:t}=this;let e=0;for(let s=0,i=t.length;s<i;s++){const r=t[s],o=t[(s+1)%i];e+=r.x*o.y-o.x*r.y}return e/2}toSimpleSvgPath(){let t="";const{vertices:e}=this,s=e.length;if(s===0)return t;t+=`M${e[0].x},${e[0].y}`;for(let i=1;i<s;i++)t+=`L${e[i].x},${e[i].y}`;return this.isClosed&&(t+="Z"),t}get length(){return this._length?this._length:(this._length=this.getLength(),this._length)}getLength(){const{vertices:t}=this;let e,s=t[0],i=0;for(let r=1;r<t.length;r++)e=t[r],i+=m.Dist2(s,e),s=e;return Math.sqrt(i)}}class Ci extends xt{constructor(e){super({...e,isClosed:!0,isFilled:!1});u(this,"children",[]);u(this,"ignoredChildren",[]);for(const s of e.children)s.ignore?this.ignoredChildren.push(s):this.children.push(s);if(this.children.length===0)throw Error("Group2d must have at least one child")}getVertices(){return this.children.filter(e=>!e.isLabel).flatMap(e=>e.vertices)}nearestPoint(e){let s=1/0,i;const{children:r}=this;if(r.length===0)throw Error("no children");let o,a;for(const c of r)o=c.nearestPoint(e),a=m.Dist2(o,e),a<s&&(s=a,i=o);if(!i)throw Error("nearest point not found");return i}distanceToPoint(e,s=!1){return Math.min(...this.children.map((i,r)=>i.distanceToPoint(e,s||r>0)))}hitTestPoint(e,s,i){return!!this.children.filter(r=>!r.isLabel).find(r=>r.hitTestPoint(e,s,i))}hitTestLineSegment(e,s,i){return!!this.children.filter(r=>!r.isLabel).find(r=>r.hitTestLineSegment(e,s,i))}getArea(){return this.children[0].area}toSimpleSvgPath(){let e="";for(const i of this.children)e+=i.toSimpleSvgPath();const s=H.FromPoints(this.vertices).corners;for(let i=0,r=s.length;i<r;i++){const o=s[i],a=s[(i-1+r)%r],c=o.dist(a),l=s[(i+1)%r],d=o.dist(l),h=o.clone().lrp(a,4/c),p=o,f=o.clone().lrp(l,4/d);e+=`M${h.x},${h.y} L${p.x},${p.y} L${f.x},${f.y} `}return e}getLength(){return this.children.reduce((e,s)=>s.isLabel?e:e+s.length,0)}getSvgPathData(){return this.children.map((e,s)=>e.isLabel?"":e.getSvgPathData(s===0)).join(" ")}}function Jd(n=!0){const[t,e]=k.useState(0),s=K();k.useEffect(()=>{if(!n)return;const i=()=>e(r=>r+1);return s.on("tick",i),()=>{s.off("tick",i)}},[s,n])}const eh=Sn(function({showStroke:t=!0,showVertices:e=!0,showClosestPointOnOutline:s=!0}){const i=K();Jd(s);const r=i.getZoomLevel(),o=i.getRenderingShapes(),{inputs:{currentPagePoint:a}}=i;return y.jsx("svg",{style:{position:"absolute",pointerEvents:"none",zIndex:999999999,top:0,left:0,overflow:"visible"},children:o.map(c=>{const l=i.getShape(c.id);if(l.type==="group")return null;const d=i.getShapeGeometry(l),h=i.getShapePageTransform(l),p=i.getPointInShapeSpace(l,a),f=d.nearestPoint(p),S=d.distanceToPoint(p,!0),g=Math.abs(S)*r,w=S<0,{vertices:b}=d;return y.jsxs("g",{transform:h.toCssString(),strokeLinecap:"round",strokeLinejoin:"round",children:[t&&y.jsx("g",{stroke:d.debugColor??"red",opacity:"1",strokeWidth:2/r,fill:"none",children:y.jsx($o,{geometry:d})}),e&&b.map((x,I)=>y.jsx("circle",{cx:x.x,cy:x.y,r:2/r,fill:`hsl(${Zs(I,[0,b.length-1],[120,200])}, 100%, 50%)`,stroke:"black",strokeWidth:1/r},`v${I}`)),s&&g<150&&y.jsx("line",{x1:f.x,y1:f.y,x2:p.x,y2:p.y,opacity:1-g/150,stroke:w?"goldenrod":"dodgerblue",strokeWidth:2/r})]},c.id+"_outline")})})});function $o({geometry:n}){return n instanceof Ci?y.jsx(y.Fragment,{children:[...n.children,...n.ignoredChildren].map((t,e)=>y.jsx($o,{geometry:t},e))}):y.jsx("path",{d:n.toSimpleSvgPath()})}function th(n){return ka(n)}function sh(){const n=K(),t=Cd("userIds",()=>th(n.getCollaborators().map(e=>e.userId)).sort(),{isEqual:(e,s)=>{var i;return e.join(",")===((i=s.join)==null?void 0:i.call(s,","))}},[n]);return $(t)}function nh(n){const t=K();return $(`latestPresence:${n}`,()=>t.getCollaborators().find(s=>s.userId===n),[t,n])??null}const ih=Sn(function(){return sh().map(e=>y.jsx(rh,{collaboratorId:e},e))}),rh=Sn(function({collaboratorId:t}){const e=K(),s=nh(t),i=ah(e,s);if(!(s&&s.currentPageId===e.getCurrentPageId()))return null;switch(i){case"inactive":{const{followingUserId:r,highlightedUserIds:o}=e.getInstanceState();if(!(r===s.userId||o.includes(s.userId)))return null;break}case"idle":{const{highlightedUserIds:r}=e.getInstanceState();if(s.followingUserId===e.user.getId()&&!(s.chatMessage||r.includes(s.userId)))return null;break}}return y.jsx(oh,{latestPresence:s})}),oh=Sn(function({latestPresence:t}){const e=K(),{CollaboratorBrush:s,CollaboratorScribble:i,CollaboratorCursor:r,CollaboratorHint:o,CollaboratorShapeIndicator:a}=ce(),c=e.getZoomLevel(),l=e.getViewportPageBounds(),{userId:d,chatMessage:h,brush:p,scribbles:f,selectedShapeIds:S,userName:g,cursor:w,color:b}=t,x=!(w.x<l.minX-12/c||w.y<l.minY-16/c||w.x>l.maxX-12/c||w.y>l.maxY-16/c);return y.jsxs(y.Fragment,{children:[p&&s?y.jsx(s,{className:"tl-collaborator__brush",brush:p,color:b,opacity:.1},d+"_brush"):null,x&&r?y.jsx(r,{className:"tl-collaborator__cursor",point:w,color:b,zoom:c,name:g!=="New User"?g:null,chatMessage:h},d+"_cursor"):o?y.jsx(o,{className:"tl-collaborator__cursor-hint",point:w,color:b,zoom:c,viewport:l},d+"_cursor_hint"):null,i&&f.length?y.jsx(y.Fragment,{children:f.map(I=>y.jsx(i,{className:"tl-collaborator__scribble",scribble:I,color:b,zoom:c,opacity:I.color==="laser"?.5:.1},d+"_scribble_"+I.id))}):null,a&&S.map(I=>y.jsx(a,{className:"tl-collaborator__shape-indicator",shapeId:I,color:b,opacity:.5},d+"_"+I))]})});function br(n,t){return t>n.options.collaboratorInactiveTimeoutMs?"inactive":t>n.options.collaboratorIdleTimeoutMs?"idle":"active"}function ah(n,t){const e=k.useRef((t==null?void 0:t.lastActivityTimestamp)??-1),[s,i]=k.useState(()=>br(n,Date.now()-e.current));return k.useEffect(()=>{const r=n.timers.setInterval(()=>{i(br(n,Date.now()-e.current))},n.options.collaboratorCheckIntervalMs);return()=>clearInterval(r)},[n]),t&&(e.current=t.lastActivityTimestamp),s}const Ko=k.memo(function({id:t,shape:e,util:s,index:i,backgroundIndex:r,opacity:o,dprMultiple:a}){const c=K(),{ShapeErrorFallback:l}=ce(),d=k.useRef(null),h=k.useRef(null),p=k.useRef({transform:"",clipPath:"none",width:0,height:0,x:0,y:0,isCulled:!1});Et("set shape stuff",()=>{const g=c.getShape(t);if(!g)return;const w=p.current,b=c.getShapeClipPath(t)??"none";b!==w.clipPath&&(me(d.current,"clip-path",b),me(h.current,"clip-path",b),w.clipPath=b);const x=c.getShapePageTransform(t),I=ie.toCssString(x),_=c.getShapeGeometry(g).bounds;I!==w.transform&&(me(d.current,"transform",I),me(h.current,"transform",I),w.transform=I);const T=_.w%a,A=_.h%a,M=T===0?_.w:_.w+(a-T),F=A===0?_.h:_.h+(a-A);(M!==w.width||F!==w.height)&&(me(d.current,"width",Math.max(M,a)+"px"),me(d.current,"height",Math.max(F,a)+"px"),me(h.current,"width",Math.max(M,a)+"px"),me(h.current,"height",Math.max(F,a)+"px"),w.width=M,w.height=F)},[c]),Et("set opacity and z-index",()=>{const g=d.current,w=h.current;me(g,"opacity",o),me(w,"opacity",o),me(g,"z-index",i),me(w,"z-index",r)},[o,i,r]),Et("set display",()=>{if(!c.getShape(t))return;const b=c.getCulledShapes().has(t);b!==p.current.isCulled&&(me(d.current,"display",b?"none":"block"),me(h.current,"display",b?"none":"block"),p.current.isCulled=b)},[c]);const f=k.useCallback(g=>c.annotateError(g,{origin:"shape",willCrashApp:!1}),[c]);if(!e)return null;const S="fill"in e.props&&e.props.fill!=="none";return y.jsxs(y.Fragment,{children:[s.backgroundComponent&&y.jsx("div",{ref:h,className:"tl-shape tl-shape-background","data-shape-type":e.type,draggable:!1,children:y.jsx(Ss,{fallback:l,onError:f,children:y.jsx(lh,{shape:e,util:s})})}),y.jsx("div",{ref:d,className:"tl-shape","data-shape-type":e.type,"data-shape-is-filled":S,draggable:!1,children:y.jsx(Ss,{fallback:l,onError:f,children:y.jsx(ch,{shape:e,util:s})})})]})}),ch=k.memo(function({shape:t,util:e}){return yn("InnerShape:"+t.type,()=>e.component(e.editor.store.unsafeGetWithoutCapture(t.id)))},(n,t)=>n.shape.props===t.shape.props&&n.shape.meta===t.shape.meta),lh=k.memo(function({shape:t,util:e}){return yn("InnerShape:"+t.type,()=>{var s;return(s=e.backgroundComponent)==null?void 0:s.call(e,e.editor.store.unsafeGetWithoutCapture(t.id))})},(n,t)=>n.shape.props===t.shape.props&&n.shape.meta===t.shape.meta);function dh({className:n}){const t=K(),{Background:e,SvgDefs:s,ShapeIndicators:i}=ce(),r=k.useRef(null),o=k.useRef(null),a=k.useRef(null),c=Dt();Zd(r),zd(),Fd(),Gd(r),Nd(r);const l=k.useRef({lodDisableTextOutline:!1,allowTextOutline:!0});Et("position layers",function(){const{x,y:I,z:_}=t.getCamera();if(l.current.allowTextOutline&&t.environment.isSafari&&(c.style.setProperty("--tl-text-outline","none"),l.current.allowTextOutline=!1),l.current.allowTextOutline&&_<t.options.textShadowLod!==l.current.lodDisableTextOutline){const M=_<t.options.textShadowLod;c.style.setProperty("--tl-text-outline",M?"none":"var(--tl-text-outline-reference)"),l.current.lodDisableTextOutline=M}const T=_>=1?Zs(_,[1,8],[.125,.5],!0):Zs(_,[.1,1],[-2,.125],!0),A=`scale(${he(_)}) translate(${he(x+T)}px,${he(I+T)}px)`;me(o.current,"transform",A),me(a.current,"transform",A)},[t,c]);const d=zo(),h=$("shapeSvgDefs",()=>{const b=new Map;for(const x of oe(t.shapeUtils)){if(!x)return;const I=x.getCanvasSvgDefs();for(const{key:_,component:T}of I)b.has(_)||b.set(_,y.jsx(T,{},_))}return[...b.values()]},[t]),p=$("debug_shapes",()=>Ce.hideShapes.get(),[Ce]),f=$("debug_svg",()=>Ce.debugSvg.get(),[Ce]),S=$("debug_geometry",()=>Ce.debugGeometry.get(),[Ce]),g=$("isEditingAnything",()=>t.getEditingShapeId()!==null,[t]),w=$("isSelectingAnything",()=>!!t.getSelectedShapeIds().length,[t]);return y.jsxs(y.Fragment,{children:[y.jsxs("div",{ref:r,draggable:!1,"data-iseditinganything":g,"data-isselectinganything":w,className:be("tl-canvas",n),"data-testid":"canvas",...d,children:[y.jsx("svg",{className:"tl-svg-context",children:y.jsxs("defs",{children:[h,y.jsx(Ph,{}),y.jsx(Ch,{}),s&&y.jsx(s,{})]})}),e&&y.jsx("div",{className:"tl-background__wrapper",children:y.jsx(e,{})}),y.jsx(uh,{}),y.jsxs("div",{ref:o,className:"tl-html-layer tl-shapes",draggable:!1,children:[y.jsx(Th,{}),y.jsx(kh,{}),p?null:f?y.jsx(bh,{}):y.jsx(Ih,{})]}),y.jsx("div",{className:"tl-overlays",children:y.jsxs("div",{ref:a,className:"tl-html-layer",children:[S?y.jsx(eh,{}):null,y.jsx(yh,{}),y.jsx(fh,{}),y.jsx(ph,{}),y.jsx(gh,{}),i&&y.jsx(i,{}),y.jsx(vh,{}),y.jsx(mh,{}),y.jsx(_h,{}),y.jsx(ih,{})]})}),y.jsx(Mh,{})]}),y.jsx(hh,{})]})}function hh(){const{InFrontOfTheCanvas:n}=ce();return n?y.jsx(n,{}):null}function uh(){const n=K(),t=$("gridSize",()=>n.getDocumentSettings().gridSize,[n]),{x:e,y:s,z:i}=$("camera",()=>n.getCamera(),[n]),r=$("isGridMode",()=>n.getInstanceState().isGridMode,[n]),{Grid:o}=ce();return o&&r?y.jsx(o,{x:e,y:s,z:i,size:t}):null}function ph(){const n=K(),t=$("scribbles",()=>n.getInstanceState().scribbles,[n]),e=$("zoomLevel",()=>n.getZoomLevel(),[n]),{Scribble:s}=ce();return s&&t.length?t.map(i=>y.jsx(s,{className:"tl-user-scribble",scribble:i,zoom:e},i.id)):null}function fh(){const n=K(),t=$("brush",()=>n.getInstanceState().brush,[n]),{Brush:e}=ce();return e&&t?y.jsx(e,{className:"tl-user-brush",brush:t}):null}function gh(){const n=K(),t=$("zoomBrush",()=>n.getInstanceState().zoomBrush,[n]),{ZoomBrush:e}=ce();return e&&t?y.jsx(e,{className:"tl-user-brush tl-zoom-brush",brush:t}):null}function mh(){const n=K(),t=$("snapLines",()=>n.snaps.getIndicators(),[n]),e=$("zoomLevel",()=>n.getZoomLevel(),[n]),{SnapIndicator:s}=ce();return s&&t.length>0?t.map(i=>y.jsx(s,{className:"tl-user-snapline",line:i,zoom:e},i.id)):null}function yh(){const n=K(),t=$("handles shapeIdWithHandles",()=>{const{isReadonly:e,isChangingStyle:s}=n.getInstanceState();if(e||s)return!1;const i=n.getOnlySelectedShape();return!i||!n.getShapeHandles(i)?!1:i.id},[n]);return t?y.jsx(Sh,{shapeId:t}):null}function Sh({shapeId:n}){const t=K(),{Handles:e}=ce(),s=$("zoomLevel",()=>t.getZoomLevel(),[t]),i=$("coarse pointer",()=>t.getInstanceState().isCoarsePointer,[t]),r=$("handles transform",()=>t.getShapePageTransform(n),[t,n]),o=$("handles",()=>{const a=t.getShapeHandles(n);if(!a)return null;const c=(i?t.options.coarseHandleRadius:t.options.handleRadius)/s*2;return a.filter(l=>l.type!=="virtual"||!a.some(d=>d!==l&&d.type==="vertex"&&m.Dist(l,d)<c)).sort(l=>l.type==="vertex"?1:-1)},[t,s,i,n]);return!e||!o||!r?null:y.jsx(e,{children:y.jsx("g",{transform:ie.toCssString(r),children:o.map(a=>y.jsx(wh,{shapeId:n,handle:a,zoom:s,isCoarse:i},a.id))})})}function wh({shapeId:n,handle:t,zoom:e,isCoarse:s}){const i=Xd(n,t.id),{Handle:r}=ce();return r?y.jsx("g",{"aria-label":"handle",transform:`translate(${t.x}, ${t.y})`,...i,children:y.jsx(r,{shapeId:n,handle:t,zoom:e,isCoarse:s})}):null}function bh(){const n=K(),t=$("rendering shapes",()=>n.getRenderingShapes(),[n]),e=$("dpr multiple",()=>No(Math.floor(n.getInstanceState().devicePixelRatio*100)/100),[n]);return t.map(s=>y.jsxs(k.Fragment,{children:[y.jsx(Ko,{...s,dprMultiple:e}),y.jsx(Eh,{id:s.id})]},s.id+"_fragment"))}function xh(){const n=K(),t=k.useRef(new Set);return Et("reflow for culled shapes",()=>{const e=n.getCulledShapes();if(t.current.size===e.size&&[...e].every(i=>t.current.has(i)))return;t.current=e;const s=document.getElementsByClassName("tl-canvas");s.length!==0&&s[0].offsetHeight},[n]),null}function Ih(){const n=K(),t=$("rendering shapes",()=>n.getRenderingShapes(),[n]),e=$("dpr multiple",()=>No(Math.floor(n.getInstanceState().devicePixelRatio*100)/100),[n]);return y.jsxs(y.Fragment,{children:[t.map(s=>y.jsx(Ko,{...s,dprMultiple:e},s.id+"_shape")),n.environment.isSafari&&y.jsx(xh,{})]})}function vh(){const n=K(),{ShapeIndicator:t}=ce(),e=$("hinting shape ids",()=>ii(n.getHintingShapeIds()),[n]);return!e.length||!t?null:e.map(s=>y.jsx(t,{className:"tl-user-indicator__hint",shapeId:s},s+"_hinting"))}function Ph(){return y.jsxs("g",{id:"cursor",children:[y.jsxs("g",{fill:"rgba(0,0,0,.2)",transform:"translate(-11,-11)",children:[y.jsx("path",{d:"m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z"}),y.jsx("path",{d:"m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z"})]}),y.jsxs("g",{fill:"white",transform:"translate(-12,-12)",children:[y.jsx("path",{d:"m12 24.4219v-16.015l11.591 11.619h-6.781l-.411.124z"}),y.jsx("path",{d:"m21.0845 25.0962-3.605 1.535-4.682-11.089 3.686-1.553z"})]}),y.jsxs("g",{fill:"currentColor",transform:"translate(-12,-12)",children:[y.jsx("path",{d:"m19.751 24.4155-1.844.774-3.1-7.374 1.841-.775z"}),y.jsx("path",{d:"m13 10.814v11.188l2.969-2.866.428-.139h4.768z"})]})]})}function Ch(){return y.jsx("path",{id:"cursor_hint",fill:"currentColor",d:"M -2,-5 2,0 -2,5 Z"})}function Eh({id:n}){const t=K(),[e,s]=k.useState(null),i=$("is in root",()=>{const r=t.getShape(n);return(r==null?void 0:r.parentId)===t.getCurrentPageId()},[t,n]);return k.useEffect(()=>{if(!i)return;let r=null;const o=xs("shape to svg",async()=>{const a=Math.random();r=a;const l=t.isShapeOfType(n,"frame")?0:10;let d=t.getShapePageBounds(n);if(!d)return;d=d.clone().expandBy(l);const h=await t.getSvgString([n],{padding:l,background:t.getInstanceState().exportBackground});if(r!==a||!h)return;const p=`data:image/svg+xml;utf8,${encodeURIComponent(h.svg)}`;s({src:p,bounds:d})});return()=>{r=null,o()}},[t,n,i]),!i||!e?null:y.jsx("img",{src:e.src,width:e.bounds.width,height:e.bounds.height,referrerPolicy:"no-referrer",style:{position:"absolute",top:0,left:0,transform:`translate(${e.bounds.x}px, ${e.bounds.maxY+12}px)`,outline:"1px solid black",maxWidth:"none"}})}function _h(){const n=K(),t=$("selection rotation",()=>n.getSelectionRotation(),[n]),e=$("selection bounds",()=>n.getSelectionRotatedPageBounds(),[n]),{SelectionForeground:s}=ce();return!e||!s?null:y.jsx(s,{bounds:e,rotation:t})}function kh(){const n=K(),t=$("selection rotation",()=>n.getSelectionRotation(),[n]),e=$("selection bounds",()=>n.getSelectionRotatedPageBounds(),[n]),{SelectionBackground:s}=ce();return!e||!s?null:y.jsx(s,{bounds:e,rotation:t})}function Th(){const{OnTheCanvas:n}=ce();return n?y.jsx(n,{}):null}function Mh(){const n=K(),t=$("camera state",()=>n.getCameraState(),[n]);return y.jsx("div",{className:be("tl-hit-test-blocker",{"tl-hit-test-blocker__hidden":t==="idle"})})}function Ah({className:n,zoom:t,point:e,color:s,viewport:i,opacity:r=1}){const o=k.useRef(null);return Is(o,ve(e.x,i.minX+5/t,i.maxX-5/t),ve(e.y,i.minY+5/t,i.maxY-5/t),1/t,m.Angle(i.center,e)),y.jsxs("svg",{ref:o,className:be("tl-overlays__item",n),children:[y.jsx("use",{href:"#cursor_hint",color:s,strokeWidth:3,stroke:"var(--color-background)"}),y.jsx("use",{href:"#cursor_hint",color:s,opacity:r})]})}const xr=k.memo(function({className:t,zoom:e,point:s,color:i,name:r,chatMessage:o}){const a=k.useRef(null);return Is(a,s==null?void 0:s.x,s==null?void 0:s.y,1/e),s?y.jsxs("div",{ref:a,className:be("tl-overlays__item",t),children:[y.jsx("svg",{className:"tl-cursor",children:y.jsx("use",{href:"#cursor",color:i})}),o?y.jsxs(y.Fragment,{children:[r&&y.jsx("div",{className:"tl-nametag-title",style:{color:i},children:r}),y.jsx("div",{className:"tl-nametag-chat",style:{backgroundColor:i},children:o})]}):r&&y.jsx("div",{className:"tl-nametag",style:{backgroundColor:i},children:r})]}):null});function Dh(){return k.useId().replace(/:/g,"_")}function Rh({x:n,y:t,z:e,size:s}){const i=`grid_${Dh()}`,r=K(),{gridSteps:o}=r.options;return y.jsxs("svg",{className:"tl-grid",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:[y.jsx("defs",{children:o.map(({min:a,mid:c,step:l},d)=>{const h=l*s*e,p=.5+n*e,f=.5+t*e,S=p>0?p%h:h+p%h,g=f>0?f%h:h+f%h,w=e<c?Zs(e,[a,c],[0,1]):1;return y.jsx("pattern",{id:`${i}_${l}`,width:h,height:h,patternUnits:"userSpaceOnUse",children:y.jsx("circle",{className:"tl-grid-dot",cx:S,cy:g,r:1,opacity:w})},d)})}),o.map(({step:a},c)=>y.jsx("rect",{width:"100%",height:"100%",fill:`url(#${i}_${a})`},c))]})}function Lh({handle:n,isCoarse:t,className:e,zoom:s}){const i=K(),r=(t?i.options.coarseHandleRadius:i.options.handleRadius)/s;if(n.type==="clone"){const a=3/s,c=`M0,${-a} A${a},${a} 0 0,1 0,${a}`,l=Ld.indexOf(n.id);return y.jsxs("g",{className:be(`tl-handle tl-handle__${n.type}`,e),children:[y.jsx("circle",{className:"tl-handle__bg",r}),y.jsx("path",{className:"tl-handle__fg",d:c,transform:`rotate(${-90+90*l})`})]})}const o=(n.type==="create"&&t?3:4)/Math.max(s,.25);return y.jsxs("g",{className:be(`tl-handle tl-handle__${n.type}`,e),children:[y.jsx("circle",{className:"tl-handle__bg",r}),y.jsx("circle",{className:"tl-handle__fg",r:o})]})}const Oh=({children:n})=>y.jsx("svg",{className:"tl-user-handles tl-overlays__item",children:n}),Fh=()=>{const{Spinner:n}=ce();return y.jsx(nf,{children:n?y.jsx(n,{}):null})};function jh(n,t=!0){const e=n.length;if(e<2)return"";let s=n[0],i=n[1];if(e===2)return`M${Lt(s)}L${Lt(i)}`;let r="";for(let o=2,a=e-1;o<a;o++)s=n[o],i=n[o+1],r+=Ot(s,i);return t?`M${Ot(n[0],n[1])}Q${Lt(n[1])}${Ot(n[1],n[2])}T${r}${Ot(n[e-1],n[0])}${Ot(n[0],n[1])}Z`:`M${Lt(n[0])}Q${Lt(n[1])}${Ot(n[1],n[2])}${n.length>3?"T":""}${r}L${Lt(n[e-1])}`}function Ir({scribble:n,zoom:t,color:e,opacity:s,className:i}){return n.points.length?y.jsx("svg",{className:i&&be("tl-overlays__item",i),children:y.jsx("path",{className:"tl-scribble",d:jh(n.points,!1),stroke:e??`var(--color-${n.color})`,fill:"none",strokeWidth:8/t,opacity:s??n.opacity})}):null}function zh({bounds:n,rotation:t}){const e=k.useRef(null);return Is(e,n.x,n.y,1,t),k.useLayoutEffect(()=>{const s=e.current;s&&(s.style.width=he(Math.max(1,n.width))+"px",s.style.height=he(Math.max(1,n.height))+"px")},[n.width,n.height]),y.jsx("div",{ref:e,className:"tl-selection__bg",draggable:!1})}function Bh({bounds:n,rotation:t}){const e=K(),s=k.useRef(null),i=$("only selected shape",()=>e.getOnlySelectedShape(),[e]),r=i?e.getShapeUtil(i).expandSelectionOutlinePx(i):0;return Is(s,n==null?void 0:n.x,n==null?void 0:n.y,1,t,{x:-r,y:-r}),n=n.clone().expandBy(r).zeroFix(),y.jsx("svg",{ref:s,className:"tl-overlays__item tl-selection__fg","data-testid":"selection-foreground",children:y.jsx("rect",{className:be("tl-selection__fg__outline"),width:he(n.width),height:he(n.height)})})}const Uh=()=>y.jsx("div",{className:"tl-shape-error-boundary"}),Nh=({shape:n,util:t})=>yn("Indicator: "+n.type,()=>t.indicator(t.editor.store.unsafeGetWithoutCapture(n.id))),$h=({editor:n,id:t})=>{const e=$("shape for indicator",()=>n.store.get(t),[n,t]),{ShapeIndicatorErrorFallback:s}=ce();return!e||e.isLocked?null:y.jsx(Ss,{fallback:s,onError:i=>n.annotateError(i,{origin:"react.shapeIndicator",willCrashApp:!1}),children:y.jsx(Nh,{shape:e,util:n.getShapeUtil(e)},e.id)})},vr=k.memo(function({shapeId:t,className:e,color:s,hidden:i,opacity:r}){const o=K(),a=k.useRef(null);return Et("indicator transform",()=>{const c=a.current;if(!c)return;const l=o.getShapePageTransform(t);l&&c.style.setProperty("transform",l.toCssString())},[o,t]),k.useLayoutEffect(()=>{const c=a.current;c&&c.style.setProperty("display",i?"none":"block")},[i]),y.jsx("svg",{ref:a,className:be("tl-overlays__item",e),children:y.jsx("g",{className:"tl-shape-indicator",stroke:s??"var(--color-selected)",opacity:r,children:y.jsx($h,{editor:o,id:t})})})}),Kh=()=>y.jsx("circle",{cx:4,cy:4,r:8,strokeWidth:"1",stroke:"red"}),Hh=k.memo(function(){const t=K(),e=k.useRef(new Set),s=$("should display selected ids",()=>{const o=e.current,a=new Set;if(t.isInAny("select.idle","select.brushing","select.scribble_brushing","select.editing_shape","select.pointing_shape","select.pointing_selection","select.pointing_handle")&&!t.getInstanceState().isChangingStyle){const c=t.getSelectedShapeIds();for(const l of c)a.add(l);if(t.isInAny("select.idle","select.editing_shape")){const l=t.getInstanceState();if(l.isHoveringCanvas&&!l.isCoarsePointer){const d=t.getHoveredShapeId();d&&a.add(d)}}}if(o.size!==a.size)return e.current=a,a;for(const c of a)if(!o.has(c))return e.current=a,a;return o},[t]),i=$("rendering shapes",()=>t.getRenderingShapes(),[t]),{ShapeIndicator:r}=ce();return r?i.map(({id:o})=>y.jsx(r,{shapeId:o,hidden:!s.has(o)},o+"_indicator")):null});function Yh({points:n,zoom:t}){const e=2.5/t,s=n.reduce((p,f)=>Math.min(p,f.x),1/0),i=n.reduce((p,f)=>Math.max(p,f.x),-1/0),r=n.reduce((p,f)=>Math.min(p,f.y),1/0),o=n.reduce((p,f)=>Math.max(p,f.y),-1/0),a=n.some(p=>p.x===s&&p.y===r);let c,l,d,h;return a?(c=s,l=r,d=i,h=o):(c=s,l=o,d=i,h=r),y.jsxs("g",{className:"tl-snap-indicator",stroke:"lime",children:[y.jsx("line",{x1:c,y1:l,x2:d,y2:h}),n.map((p,f)=>y.jsx("g",{transform:`translate(${p.x},${p.y})`,children:y.jsx("path",{className:"tl-snap-point",d:`M ${-e},${-e} L ${e},${e} M ${-e},${e} L ${e},${-e}`})},f))]})}function Gh({gaps:n,direction:t,zoom:e}){const s=3.5/e;let i=[-1/0,1/0],r=null;const o=t==="horizontal";for(const c of n){if(r=He(i[0],i[1],o?c.startEdge[0].y:c.startEdge[0].x,o?c.startEdge[1].y:c.startEdge[1].x),r)i=r;else continue;if(r=He(i[0],i[1],o?c.endEdge[0].y:c.endEdge[0].x,o?c.endEdge[1].y:c.endEdge[1].x),r)i=r;else continue}if(i===null)return null;const a=(i[0]+i[1])/2;return y.jsx("g",{className:"tl-snap-indicator",stroke:"cyan",children:n.map(({startEdge:c,endEdge:l},d)=>y.jsx(k.Fragment,{children:o?y.jsxs(y.Fragment,{children:[y.jsx("line",{x1:c[0].x,y1:a-2*s,x2:c[1].x,y2:a+2*s}),y.jsx("line",{x1:l[0].x,y1:a-2*s,x2:l[1].x,y2:a+2*s}),y.jsx("line",{x1:c[0].x,y1:a,x2:l[0].x,y2:a}),y.jsx("line",{x1:(c[0].x+l[0].x)/2,y1:a-s,x2:(c[0].x+l[0].x)/2,y2:a+s})]}):y.jsxs(y.Fragment,{children:[y.jsx("line",{x1:a-2*s,y1:c[0].y,x2:a+2*s,y2:c[1].y}),y.jsx("line",{x1:a-2*s,y1:l[0].y,x2:a+2*s,y2:l[1].y}),y.jsx("line",{x1:a,y1:c[0].y,x2:a,y2:l[0].y}),y.jsx("line",{x1:a-s,y1:(c[0].y+l[0].y)/2,x2:a+s,y2:(c[0].y+l[0].y)/2})]})},d))})}function Xh({className:n,line:t,zoom:e}){return y.jsx("svg",{className:be("tl-overlays__item",n),children:t.type==="points"?y.jsx(Yh,{...t,zoom:e}):t.type==="gaps"?y.jsx(Gh,{...t,zoom:e}):null})}function qh(){return y.jsx("svg",{width:16,height:16,viewBox:"0 0 16 16",children:y.jsxs("g",{strokeWidth:2,fill:"none",fillRule:"evenodd",children:[y.jsx("circle",{strokeOpacity:.25,cx:8,cy:8,r:7,stroke:"currentColor"}),y.jsx("path",{strokeLinecap:"round",d:"M15 8c0-4.5-4.5-7-7-7",stroke:"currentColor",children:y.jsx("animateTransform",{attributeName:"transform",type:"rotate",from:"0 8 8",to:"360 8 8",dur:"1s",repeatCount:"indefinite"})})]})})}const Wh=()=>null;function Ho(n,t){const e=k.useRef(n);return t(n,e.current)?e.current:(e.current=n,n)}function Yf(n){return Ho(n,ec)}const Vh=(n,t)=>(n??(n=null),t??(t=null),n===t?!0:!n||!t?!1:so(n,t));function Yo(n){return Ho(n,Vh)}const Go=k.createContext(null);function Zh({overrides:n={},children:t}){const e=Yo(n),s=k.useMemo(()=>({Background:_d,SvgDefs:Wh,Brush:An,ZoomBrush:An,CollaboratorBrush:An,Cursor:xr,CollaboratorCursor:xr,CollaboratorHint:Ah,CollaboratorShapeIndicator:vr,Grid:Rh,Scribble:Ir,SnapIndicator:Xh,Handles:Oh,Handle:Lh,CollaboratorScribble:Ir,ErrorFallback:Xo,ShapeErrorFallback:Uh,ShapeIndicatorErrorFallback:Kh,Spinner:qh,SelectionBackground:zh,SelectionForeground:Bh,ShapeIndicators:Hh,ShapeIndicator:vr,OnTheCanvas:null,InFrontOfTheCanvas:null,Canvas:dh,LoadingScreen:Fh,...e}),[e]);return y.jsx(Go.Provider,{value:s,children:t})}function ce(){const n=k.useContext(Go);if(!n)throw new Error("useEditorComponents must be used inside of <EditorComponentsProvider />");return n}const Ei={openWindow:(n,t)=>window.open(n,t,"noopener noreferrer"),refreshPage:()=>window.location.reload(),hardReset:async()=>{var n;return await((n=window.__tldraw__hardReset)==null?void 0:n.call(window))}};function Qh(){Ei.hardReset()}function Jh(){Ei.refreshPage()}const eu="https://github.com/tldraw/tldraw/issues/new",Xo=({error:n,editor:t})=>{const e=k.useRef(null),[s,i]=k.useState(!1),[r,o]=k.useState(!1),[a,c]=k.useState(!1);let l=null;try{l=ce().Canvas??null}catch{}const d=n instanceof Error?n.message:String(n),h=n instanceof Error?n.stack:null,p=$("isDarkMode",()=>{try{if(t)return t.user.getIsDarkMode()}catch{}return null},[t]),[f,S]=k.useState(null);k.useLayoutEffect(()=>{var T;p!==null&&S(p);let I=(T=e.current)==null?void 0:T.parentElement,_=!1;for(;I;){if(I.classList.contains("tl-theme__dark")||I.classList.contains("tl-theme__light")){_=!0;break}I=I.parentElement}if(_){S(null);return}typeof window<"u"&&"matchMedia"in window&&S(window.matchMedia("(prefers-color-scheme: dark)").matches)},[p]),k.useEffect(()=>{if(r){const I=t==null?void 0:t.timers.setTimeout(()=>{o(!1)},2e3);return()=>clearTimeout(I)}},[r,t]);const g=()=>{const I=document.createElement("textarea");I.value=h??d,document.body.appendChild(I),I.select(),document.execCommand("copy"),I.remove(),o(!0)},w=()=>{Jh()},b=async()=>{Qh()},x=new URL(eu);return x.searchParams.set("title",d),x.searchParams.set("labels","bug"),x.searchParams.set("body",`Hey, I ran into an error while using tldraw:

\`\`\`js
${h??d}
\`\`\`

My browser: ${navigator.userAgent}`),y.jsxs("div",{ref:e,className:be("tl-container tl-error-boundary",f===null?"":f?"tl-theme__dark":"tl-theme__light"),children:[y.jsx("div",{className:"tl-error-boundary__overlay"}),t&&y.jsx(jo,{onError:ri,fallback:()=>null,children:y.jsx(wn.Provider,{value:t,children:y.jsx("div",{className:"tl-overlay tl-error-boundary__canvas",children:l?y.jsx(l,{}):null})})}),y.jsx("div",{className:be("tl-modal","tl-error-boundary__content",{"tl-error-boundary__content__expanded":s&&!a}),children:a?y.jsxs(y.Fragment,{children:[y.jsx("h2",{children:"Are you sure?"}),y.jsx("p",{children:"Resetting your data will delete your drawing and cannot be undone."}),y.jsxs("div",{className:"tl-error-boundary__content__actions",children:[y.jsx("button",{onClick:()=>c(!1),children:"Cancel"}),y.jsx("button",{className:"tl-error-boundary__reset",onClick:b,children:"Reset data"})]})]}):y.jsxs(y.Fragment,{children:[y.jsx("h2",{children:"Something's gone wrong."}),y.jsxs("p",{children:["Sorry, we encountered an error. Please refresh the page to continue. If you keep seeing this error, you can ",y.jsx("a",{href:x.toString(),children:"create a GitHub issue"})," or"," ",y.jsx("a",{href:"https://discord.gg/Cq6cPsTfNy",children:"ask for help on Discord"}),"."]}),s&&y.jsxs(y.Fragment,{children:["Message:",y.jsx("h4",{children:y.jsx("code",{children:d})}),"Stack trace:",y.jsxs("div",{className:"tl-error-boundary__content__error",children:[y.jsx("pre",{children:y.jsx("code",{children:h??d})}),y.jsx("button",{onClick:g,children:r?"Copied!":"Copy"})]})]}),y.jsxs("div",{className:"tl-error-boundary__content__actions",children:[y.jsx("button",{onClick:()=>i(!s),children:s?"Hide details":"Show details"}),y.jsxs("div",{className:"tl-error-boundary__content__actions__group",children:[y.jsx("button",{className:"tl-error-boundary__reset",onClick:()=>c(!0),children:"Reset data"}),y.jsx("button",{className:"tl-error-boundary__refresh",onClick:w,children:"Refresh Page"})]})]})]})})]})};function De(){return bs()}const qo="TLDRAW_USER_DATA_v3",Wo=W({id:G,name:G.nullable().optional(),locale:G.nullable().optional(),color:G.nullable().optional(),colorScheme:pn("light","dark","system").optional(),animationSpeed:N.nullable().optional(),edgeScrollSpeed:N.nullable().optional(),isSnapMode:Y.nullable().optional(),isWrapMode:Y.nullable().optional(),isDynamicSizeMode:Y.nullable().optional(),isPasteAtCursorMode:Y.nullable().optional()}),at={AddAnimationSpeed:1,AddIsSnapMode:2,MakeFieldsNullable:3,AddEdgeScrollSpeed:4,AddExcalidrawSelectMode:5,AddDynamicSizeMode:6,AllowSystemColorScheme:7,AddPasteAtCursor:8},_i=Math.max(...Object.values(at));function tu(n){n.version<at.AddAnimationSpeed&&(n.user.animationSpeed=1),n.version<at.AddIsSnapMode&&(n.user.isSnapMode=!1),n.version<at.MakeFieldsNullable,n.version<at.AddEdgeScrollSpeed&&(n.user.edgeScrollSpeed=1),n.version<at.AddExcalidrawSelectMode&&(n.user.isWrapMode=!1),n.version<at.AllowSystemColorScheme&&(n.user.isDarkMode===!0?n.user.colorScheme="dark":n.user.isDarkMode===!1&&(n.user.colorScheme="light"),delete n.user.isDarkMode),n.version<at.AddDynamicSizeMode&&(n.user.isDynamicSizeMode=!1),n.version<at.AddPasteAtCursor&&(n.user.isPasteAtCursorMode=!1),n.version=_i}const Pr=["#FF802B","#EC5E41","#F2555A","#F04F88","#E34BA9","#BD54C6","#9D5BD2","#7B66DC","#02B1CC","#11B3A3","#39B178","#55B467"];function Vo(){return Pr[Math.floor(Math.random()*Pr.length)]}function su(){var n,t;return typeof window<"u"&&"matchMedia"in window?((t=(n=window.matchMedia)==null?void 0:n.call(window,"(prefers-reduced-motion: reduce)"))==null?void 0:t.matches)??!1:!1}const ot=Object.freeze({name:"New User",locale:bd(),color:Vo(),edgeScrollSpeed:1,animationSpeed:su()?0:1,isSnapMode:!1,isWrapMode:!1,isDynamicSizeMode:!1,isPasteAtCursorMode:!1,colorScheme:"system"});function Ln(){return{id:De(),color:Vo()}}function Zo(n){if(n===null||typeof n!="object"||!("version"in n)||!("user"in n)||typeof n.version!="number")return Ln();const t=ue(n);tu(t);try{return Wo.validate(t.user)}catch{return Ln()}}function nu(){const n=JSON.parse(ao(qo)||"null")??null;return Zo(n)}const bn=fe("globalUserData",null);function iu(){co(qo,JSON.stringify({version:_i,user:bn.get()}))}function Qo(n){Wo.validate(n),bn.set(n),iu(),ru()}const Ht=typeof BroadcastChannel<"u"?new BroadcastChannel("tldraw-user-sync"):null;Ht==null||Ht.addEventListener("message",n=>{const t=n.data;(t==null?void 0:t.type)===ea&&(t==null?void 0:t.origin)!==Jo()&&bn.set(Zo(t.data))});let On=null;function Jo(){return On===null&&(On=De()),On}const ea="tldraw-user-preferences-change";function ru(){Ht==null||Ht.postMessage({type:ea,origin:Jo(),data:{user:ta(),version:_i}})}function ta(){let n=bn.get();return n||(n=nu(),Qo(n)),n}const ou=C("defaultLocalStorageUserPrefs",()=>ta());function sa(n={}){return{userPreferences:n.userPreferences??ou,setUserPreferences:n.setUserPreferences??Qo}}const Yt="TLDRAW_TAB_ID_v2",Je=globalThis.window;function au(){return Je?["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(Je.navigator.platform)||Je.navigator.userAgent.includes("Mac")&&"ontouchend"in document:!1}const rn=Je?Je[Yt]??lo(Yt)??"TLDRAW_INSTANCE_STATE_V1_"+De():"<error>";Je&&(Je[Yt]=rn,au()?ci(Yt,rn):ho(Yt));Je==null||Je.addEventListener("beforeunload",()=>{ci(Yt,rn)});const na={Initial:0},xn=Math.max(...Object.values(na));function cu(n){n.version<na.Initial,n.version=xn}const ia=W({version:N,currentPageId:ms,isFocusMode:Y,exportBackground:Y,isDebugMode:Y,isToolLocked:Y,isGridMode:Y,pageStates:Se(W({pageId:ms,camera:W({x:N,y:N,z:N}),selectedShapeIds:Se(ze),focusedGroupId:ze.nullable()}))});function lu(n){if(!n||typeof n!="object")return console.warn("Invalid instance state"),null;if(!("version"in n)||typeof n.version!="number")return console.warn("No version in instance state"),null;n.version!==xn&&(n=ue(n),cu(n));try{return ia.validate(n)}catch(t){return console.warn(t),null}}function ra(n){const t=n.query.ids("page");return C("sessionStateSnapshot",()=>{const e=n.get(we);if(!e)return null;const s=[...t.get()];return{version:xn,currentPageId:e.currentPageId,exportBackground:e.exportBackground,isFocusMode:e.isFocusMode,isDebugMode:e.isDebugMode,isToolLocked:e.isToolLocked,isGridMode:e.isGridMode,pageStates:s.map(i=>{const r=n.get(Ye.createId(i)),o=n.get(Ze.createId(i));return{pageId:i,camera:{x:(o==null?void 0:o.x)??0,y:(o==null?void 0:o.y)??0,z:(o==null?void 0:o.z)??1},selectedShapeIds:(r==null?void 0:r.selectedShapeIds)??[],focusedGroupId:(r==null?void 0:r.focusedGroupId)??null}})}})}function oa(n,t){const e=lu(t);if(!e)return;const s=n.schema.types.instance.create({id:we,...Mo(n.get(we)),currentPageId:e.currentPageId,isDebugMode:e.isDebugMode,isFocusMode:e.isFocusMode,isToolLocked:e.isToolLocked,isGridMode:e.isGridMode,exportBackground:e.exportBackground}),i=n.allRecords().filter(r=>r.typeName==="instance_page_state"||r.typeName==="camera");n.atomic(()=>{n.remove(i.map(r=>r.id));for(const r of e.pageStates)n.put([Ze.create({id:Ze.createId(r.pageId),x:r.camera.x,y:r.camera.y,z:r.camera.z}),Ye.create({id:Ye.createId(r.pageId),pageId:r.pageId,selectedShapeIds:r.selectedShapeIds,focusedGroupId:r.focusedGroupId})]);n.put([s]),n.ensureStoreIsUsable()})}function du(n){var i;const t=[];for(const r of Object.values(n))(i=r.typeName)!=null&&i.match(/^(instance.*|pointer|camera)$/)&&t.push(r);const e=t.filter(r=>r.typeName==="instance"&&r.id!==we)[0];if(!e)return null;const s={version:xn,currentPageId:e.currentPageId,exportBackground:!!e.exportBackground,isFocusMode:!!e.isFocusMode,isDebugMode:!!e.isDebugMode,isToolLocked:!!e.isToolLocked,isGridMode:!1,pageStates:t.filter(r=>r.typeName==="instance_page_state"&&r.instanceId===e.id).map(r=>{const o=n[r.cameraId]??{x:0,y:0,z:1};return{pageId:r.pageId,camera:{x:o.x,y:o.y,z:o.z},selectedShapeIds:r.selectedShapeIds,focusedGroupId:r.focusedGroupId}})};try{return ia.validate(s),s}catch{return null}}function aa(n,t){let e={};if("store"in t){const i=n.schema.migrateStoreSnapshot(t);if(i.type!=="success")throw new Error("Failed to migrate store snapshot: "+i.reason);e.document={schema:n.schema.serialize(),store:ls(i.value,(r,{typeName:o})=>n.scopedTypes.document.has(o))}}else e=t;const s=Mo(n.get(we));n.atomic(()=>{e.document&&n.loadStoreSnapshot(e.document),s&&n.update(we,i=>({...i,...s})),e.session&&oa(n,e.session)})}const hu=new gs;function uu(n){const e=hu.get(n,ra).get();if(!e)throw new Error("Session state is not ready yet");return{document:n.getStoreSnapshot(),session:e}}function ca(n){const t=[],e=new Set;for(const s of n){if(e.has(s.type))throw new Error(`Binding type "${s.type}" is defined more than once`);t.push(s),e.add(s.type)}return t}function pu({children:n,className:t="",...e}){return y.jsx("svg",{...e,className:be("tl-svg-container",t),children:n})}function ki(n,t,e,s){const i=n.x-e.x,r=n.y-e.y,o=s.x-e.x,a=s.y-e.y,c=t.x-n.x,l=t.y-n.y,d=o*r-a*i,h=c*r-l*i,p=a*c-o*l;if(d===0||h===0||p===0)return null;if(p!==0){const f=d/p,S=h/p;if(0<=f&&f<=1&&0<=S&&S<=1)return m.AddXY(n,f*c,f*l)}return null}function In(n,t,e,s){const i=(t.x-n.x)*(t.x-n.x)+(t.y-n.y)*(t.y-n.y),r=2*((t.x-n.x)*(n.x-e.x)+(t.y-n.y)*(n.y-e.y)),o=e.x*e.x+e.y*e.y+n.x*n.x+n.y*n.y-2*(e.x*n.x+e.y*n.y)-s*s,a=r*r-4*i*o;if(a<0||a===0)return null;const c=Math.sqrt(a),l=(-r+c)/(2*i),d=(-r-c)/(2*i);if((l<0||l>1)&&(d<0||d>1))return null;const h=[];return 0<=l&&l<=1&&h.push(m.Lrp(n,t,l)),0<=d&&d<=1&&h.push(m.Lrp(n,t,d)),h.length===0?null:h}function Gf(n,t,e){const s=[];let i;for(let r=0,o=e.length-1;r<o;r++)i=ki(n,t,e[r],e[r+1]),i&&s.push(i);return s.length===0?null:s}function Xf(n,t,e){const s=[];let i;for(let r=1,o=e.length;r<o+1;r++)i=ki(n,t,e[r-1],e[r%e.length]),i&&s.push(i);return s.length===0?null:s}function qf(n,t,e,s){let i=e.x-n.x,r=e.y-n.y;const o=Math.sqrt(i*i+r*r),a=(o*o-s*s+t*t)/(2*o),c=Math.sqrt(t*t-a*a);return i/=o,r/=o,[new m(n.x+i*a-r*c,n.y+r*a+i*c),new m(n.x+i*a+r*c,n.y+r*a-i*c)]}function Wf(n,t,e){const s=[];let i,r,o;for(let a=0,c=e.length;a<c;a++)i=e[a],r=e[(a+1)%e.length],o=In(i,r,n,t),o&&s.push(...o);return s.length===0?null:s}function Vf(n,t,e){const s=[];let i,r,o;for(let a=1,c=e.length;a<c;a++)i=e[a-1],r=e[a],o=In(i,r,n,t),o&&s.push(...o);return s.length===0?null:s}function Os(n,t,e){return(e.y-n.y)*(t.x-n.x)>(t.y-n.y)*(e.x-n.x)}function Ti(n,t,e,s){return Os(n,e,s)!==Os(t,e,s)&&Os(n,t,e)!==Os(n,t,s)}function Cr(n,t){const e=new Map;let s,i,r,o;for(let a=0,c=n.length;a<c;a++)if(s=n[a],_t(s,t)){const l=Fn(s);e.has(l)||e.set(l,s)}for(let a=0,c=t.length;a<c;a++)if(s=t[a],_t(s,n)){const l=Fn(s);e.has(l)||e.set(l,s)}for(let a=0,c=n.length;a<c;a++){s=n[a],i=n[(a+1)%n.length];for(let l=0,d=t.length;l<d;l++){r=t[l],o=t[(l+1)%t.length];const h=ki(s,i,r,o);if(h!==null){const p=Fn(h);e.has(p)||e.set(p,h)}}}return e.size===0?null:fu([...e.values()])}function Fn(n){return`${n.x},${n.y}`}function fu(n){const t=m.Average(n);return n.sort((e,s)=>m.Angle(t,e)-m.Angle(t,s))}function Zf(n,t){let e,s,i,r;for(let o=0,a=n.length;o<a;o++){e=n[o],s=n[(o+1)%a];for(let c=0,l=t.length;c<l;c++)if(i=t[c],r=t[(c+1)%l],Ti(e,s,i,r))return!0}return!1}function Qf(n,t){let e,s,i,r;for(let o=0,a=n.length;o<a;o++){e=n[o],s=n[(o+1)%a];for(let c=1,l=t.length;c<l;c++)if(i=t[c-1],r=t[c],Ti(e,s,i,r))return!0}return!1}class Pt extends xt{constructor(e){super({...e,isClosed:!1,isFilled:!1});u(this,"start");u(this,"end");u(this,"d");u(this,"u");u(this,"ul");const{start:s,end:i}=e;this.start=s,this.end=i,this.d=s.clone().sub(i),this.u=this.d.clone().uni(),this.ul=this.u.len()}getLength(){return this.d.len()}midPoint(){return this.start.lrp(this.end,.5)}getVertices(){return[this.start,this.end]}nearestPoint(e){const{start:s,end:i,u:r,ul:o}=this;if(o===0)return s;const a=m.Sub(e,s).dpr(r)/o,c=s.x+r.x*a;if(c<Math.min(s.x,i.x))return s.x<i.x?s:i;if(c>Math.max(s.x,i.x))return s.x>i.x?s:i;const l=s.y+r.y*a;return l<Math.min(s.y,i.y)?s.y<i.y?s:i:l>Math.max(s.y,i.y)?s.y>i.y?s:i:new m(c,l)}hitTestLineSegment(e,s,i=0){return Ti(e,s,this.start,this.end)||this.distanceToLineSegment(e,s)<=i}getSvgPathData(e=!0){const{start:s,end:i}=this;return`${e?`M${s.toFixed()}`:""} L${i.toFixed()}`}}class Mi extends xt{constructor(e){super({isClosed:!1,isFilled:!1,...e});u(this,"points");u(this,"_segments");const{points:s}=e;this.points=s}get segments(){if(!this._segments){this._segments=[];const{vertices:e}=this;for(let s=0,i=e.length-1;s<i;s++){const r=e[s],o=e[s+1];this._segments.push(new Pt({start:r,end:o}))}this.isClosed&&this._segments.push(new Pt({start:e[e.length-1],end:e[0]}))}return this._segments}getLength(){return this.segments.reduce((e,s)=>e+s.length,0)}getVertices(){return this.points}nearestPoint(e){const{segments:s}=this;let i=this.points[0],r=1/0,o,a;for(let c=0;c<s.length;c++)o=s[c].nearestPoint(e),a=m.Dist2(o,e),a<r&&(i=o,r=a);if(!i)throw Error("nearest point not found");return i}hitTestLineSegment(e,s,i=0){const{segments:r}=this;for(let o=0,a=r.length;o<a;o++)if(r[o].hitTestLineSegment(e,s,i))return!0;return!1}getSvgPathData(){const{vertices:e}=this;return e.length<2?"":e.reduce((s,i,r)=>r===0?`M ${i.x} ${i.y}`:`${s} L ${i.x} ${i.y}`,"")}}class la extends Mi{constructor(t){super({...t}),this.isClosed=!0}}class da extends la{constructor(e){const{x:s=0,y:i=0,width:r,height:o}=e;super({...e,points:[new m(s,i),new m(s+r,i),new m(s+r,i+o),new m(s,i+o)]});u(this,"x");u(this,"y");u(this,"w");u(this,"h");this.x=s,this.y=i,this.w=r,this.h=o}getBounds(){return new H(this.x,this.y,this.w,this.h)}getSvgPathData(){const{x:e,y:s,w:i,h:r}=this;return`M${e},${s} h${i} v${r} h-${i}z`}}class ps{constructor(t){u(this,"canSnap",()=>!0);u(this,"canScroll",()=>!1);u(this,"canEdit",()=>!1);u(this,"canResize",()=>!0);u(this,"canEditInReadOnly",()=>!1);u(this,"canCrop",()=>!1);u(this,"canBeLaidOut",()=>!0);u(this,"hideResizeHandles",()=>!1);u(this,"hideRotateHandle",()=>!1);u(this,"hideSelectionBoundsBg",()=>!1);u(this,"hideSelectionBoundsFg",()=>!1);u(this,"isAspectRatioLocked",()=>!1);u(this,"onBeforeCreate");u(this,"onBeforeUpdate");u(this,"onDragShapesOver");u(this,"onDragShapesOut");u(this,"onDropShapesOver");u(this,"onResizeStart");u(this,"onResize");u(this,"onResizeEnd");u(this,"onTranslateStart");u(this,"onTranslate");u(this,"onTranslateEnd");u(this,"onHandleDrag");u(this,"onRotateStart");u(this,"onRotate");u(this,"onRotateEnd");u(this,"onBindingChange");u(this,"onChildrenChange");u(this,"onDoubleClickHandle");u(this,"onDoubleClickEdge");u(this,"onDoubleClick");u(this,"onClick");u(this,"onEditEnd");this.editor=t}canBind(t){return!0}providesBackgroundForChildren(t){return!1}canReceiveNewChildrenOfType(t,e){return!1}canDropShapes(t,e){return!1}expandSelectionOutlinePx(t){return 0}getCanvasSvgDefs(){return[]}getBoundsSnapGeometry(t){return{}}getHandleSnapGeometry(t){return{}}}u(ps,"props"),u(ps,"migrations"),u(ps,"type");function gu(n,t,e={}){const{closed:s=!1,snap:i=1,start:r="outset",end:o="outset",lengthRatio:a=2,style:c="dashed"}=e;let l=0,d=0,h=1,p=0,f=0;switch(c){case"dashed":{h=1,l=Math.min(t*a,n/4);break}case"dotted":{h=100,l=t/h;break}default:return{strokeDasharray:"none",strokeDashoffset:"none"}}return s||(r==="outset"?(n+=l/2,f+=l/2):r==="skip"&&(n-=l,f-=l),o==="outset"?n+=l/2:o==="skip"&&(n-=l)),d=Math.floor(n/l/(2*h)),d-=d%i,d<3&&c==="dashed"?n/t<5?(l=n,d=1,p=0):(l=n*.333,p=n*.333):(d=Math.max(d,3),l=n/d/(2*h),s?(f=l/2,p=(n-d*l)/d):p=(n-d*l)/Math.max(1,d-1)),{strokeDasharray:[l,p].join(" "),strokeDashoffset:f.toString()}}function Er({bounds:n,className:t}){const e=K(),s=$("zoom level",()=>e.getZoomLevel(),[e]);return y.jsx("g",{className:t,pointerEvents:"none",strokeLinecap:"round",strokeLinejoin:"round",children:n.sides.map((i,r)=>{const{strokeDasharray:o,strokeDashoffset:a}=gu(i[0].dist(i[1]),1/s,{style:"dashed",lengthRatio:4});return y.jsx("line",{x1:i[0].x,y1:i[0].y,x2:i[1].x,y2:i[1].y,strokeDasharray:o,strokeDashoffset:a},r)})})}class Ys extends ps{constructor(){super(...arguments);u(this,"hideSelectionBoundsFg",()=>!0);u(this,"canBind",()=>!1);u(this,"onChildrenChange",e=>{const s=this.editor.getSortedChildIdsForParent(e.id);if(s.length===0){this.editor.getCurrentPageState().focusedGroupId===e.id&&this.editor.popFocusedGroupId(),this.editor.deleteShapes([e.id]);return}else if(s.length===1){this.editor.getCurrentPageState().focusedGroupId===e.id&&this.editor.popFocusedGroupId(),this.editor.reparentShapes(s,e.parentId),this.editor.deleteShapes([e.id]);return}})}getDefaultProps(){return{}}getGeometry(e){const s=this.editor.getSortedChildIdsForParent(e.id);return s.length===0?new da({width:1,height:1,isFilled:!1}):new Ci({children:s.map(i=>{const r=this.editor.getShape(i),o=this.editor.getShapeGeometry(i),a=this.editor.getShapeLocalTransform(r).applyToPoints(o.vertices);return o.isClosed?new la({points:a,isFilled:!0}):new Mi({points:a})})})}component(e){const s=this.editor.getErasingShapeIds().includes(e.id),{hintingShapeIds:i}=this.editor.getCurrentPageState(),r=i.length>0&&i.some(c=>c!==e.id&&this.editor.isShapeOfType(this.editor.getShape(c),"group")),o=this.editor.getCurrentPageState().focusedGroupId!==e.id;if(!s&&(o||r))return null;const a=this.editor.getShapeGeometry(e).bounds;return y.jsx(pu,{id:e.id,children:y.jsx(Er,{className:"tl-group",bounds:a})})}indicator(e){const s=this.editor.getShapeGeometry(e).bounds;return y.jsx(Er,{className:"",bounds:s})}}u(Ys,"type","group"),u(Ys,"props",Lo),u(Ys,"migrations",Oo);const ha=[Ys],mu=new Set(ha.map(n=>n.type));function ua(n){const t=[...ha],e=new Set;for(const s of n){if(mu.has(s.type))throw new Error(`Shape type "${s.type}" is a core shapes type and cannot be overridden`);if(e.has(s.type))throw new Error(`Shape type "${s.type}" is defined more than once`);t.push(s),e.add(s.type)}return t}const yu={maxShapesPerPage:4e3,maxPages:40,animationMediumMs:320,followChaseViewportSnap:2,doubleClickDurationMs:450,multiClickDurationMs:200,coarseDragDistanceSquared:36,dragDistanceSquared:16,defaultSvgPadding:32,cameraSlideFriction:.09,maxPointsPerDrawShape:500,gridSteps:[{min:-1,mid:.15,step:64},{min:.05,mid:.375,step:16},{min:.15,mid:1,step:4},{min:.7,mid:2.5,step:1}],collaboratorInactiveTimeoutMs:6e4,collaboratorIdleTimeoutMs:3e3,collaboratorCheckIntervalMs:1200,cameraMovingTimeoutMs:64,hitTestMargin:8,edgeScrollDelay:200,edgeScrollEaseDuration:200,edgeScrollSpeed:25,edgeScrollDistance:8,coarsePointerWidth:12,coarseHandleRadius:20,handleRadius:12,longPressDurationMs:500,textShadowLod:.35,adjacentShapeMargin:10,flattenImageBoundsExpand:64,flattenImageBoundsPadding:16};function _r(n,t){if(!t)return!1;switch(n.type){case"mixed":return t.type==="mixed";case"shared":return t.type==="shared"&&n.value===t.value;default:throw Ve(n)}}class Su{constructor(t){u(this,"map");this.map=new Map(t)}get(t){return this.map.get(t)}getAsKnownValue(t){const e=this.get(t);if(e&&e.type!=="mixed")return e.value}get size(){return this.map.size}equals(t){if(this.size!==t.size)return!1;const e=new Set;for(const[s,i]of this){if(!_r(i,t.get(s)))return!1;e.add(s)}for(const[s,i]of t)if(!e.has(s)&&!_r(i,this.get(s)))return!1;return!0}keys(){return this.map.keys()}values(){return this.map.values()}entries(){return this.map.entries()}[Symbol.iterator](){return this.map[Symbol.iterator]()}}class kr extends Su{set(t,e){this.map.set(t,e)}applyValue(t,e){const s=this.get(t);if(!s){this.set(t,{type:"shared",value:e});return}switch(s.type){case"mixed":return;case"shared":s.value!==e&&this.set(t,{type:"mixed"});return;default:Ve(s,"type")}}}function wu(n,t,e){return ln(n).then(function(s){return s.arrayBuffer()}).then(function(s){return new File([s],t,{type:e})})}const bu="https://cdn.tldraw.com";function xu(){return`${bu}/${Fo}`}function Iu(n,t){var i;let e=n;const s=new Set(t);for(;s.has(e);)e=(i=/^.*(\d+)$/.exec(e))!=null&&i[1]?e.replace(/(\d+)(?=\D?)$/,r=>(+r+1).toString()):`${e} 1`;return e}function Fs(n,t,e){if(e.length===0)return[];const s=new Map;for(const r of te(e.map(o=>n.getShape(o)))){const{parentId:o}=r;s.has(o)||s.set(o,{children:te(n.getSortedChildIdsForParent(o).map(a=>n.getShape(a))),moving:new Set}),s.get(o).moving.add(r)}const i=[];switch(t){case"toBack":{s.forEach(({moving:r,children:o})=>vu(r,o,i));break}case"toFront":{s.forEach(({moving:r,children:o})=>Pu(r,o,i));break}case"forward":{s.forEach(({moving:r,children:o})=>Cu(r,o,i));break}case"backward":{s.forEach(({moving:r,children:o})=>Eu(r,o,i));break}}return i}function vu(n,t,e){const s=t.length;if(n.size===s)return;let i,r;for(let o=0;o<s;o++){const a=t[o];if(n.has(a))i=a.index,n.delete(a);else{r=a.index;break}}if(n.size!==0){const o=Gt(i,r,n.size);e.push(...Array.from(n.values()).sort(Ue).map((a,c)=>({...a,index:o[c]})))}}function Pu(n,t,e){const s=t.length;if(n.size===s)return;let i,r;for(let o=s-1;o>-1;o--){const a=t[o];if(n.has(a))r=a.index,n.delete(a);else{i=a.index;break}}if(n.size!==0){const o=Gt(i,r,n.size);e.push(...Array.from(n.values()).sort(Ue).map((a,c)=>({...a,index:o[c]})))}}function Cu(n,t,e){var r;const s=t.length;if(n.size===s)return;let i={name:"skipping"};for(let o=0;o<s;o++){const a=n.has(t[o]);switch(i.name){case"skipping":{if(!a)continue;i={name:"selecting",selectIndex:o};break}case"selecting":{if(a)continue;const{selectIndex:c}=i;Gt(t[o].index,(r=t[o+1])==null?void 0:r.index,o-c).forEach((l,d)=>e.push({...t[c+d],index:l})),i={name:"skipping"};break}}}}function Eu(n,t,e){var r;const s=t.length;if(n.size===s)return;let i={name:"skipping"};for(let o=s-1;o>-1;o--){const a=n.has(t[o]);switch(i.name){case"skipping":{if(!a)continue;i={name:"selecting",selectIndex:o};break}case"selecting":{if(a)continue;Gt((r=t[o-1])==null?void 0:r.index,t[o].index,i.selectIndex-o).forEach((c,l)=>{e.push({...t[o+l+1],index:c})}),i={name:"skipping"};break}}}}function _u({editor:n}){const t=n.getSelectedShapes(),e=n.getSelectionRotation(),s=n.getSelectionRotatedPageBounds(),{inputs:{originPagePoint:i}}=n;if(!s)return null;const r=s.center.clone().rotWith(s.point,e);return{selectionPageCenter:r,initialCursorAngle:r.angle(i),initialSelectionRotation:e,shapeSnapshots:t.map(o=>({shape:ue(o),initialPagePoint:n.getShapePageTransform(o.id).point()}))}}function ku({delta:n,editor:t,snapshot:e,stage:s}){const{selectionPageCenter:i,shapeSnapshots:r}=e;t.updateShapes(r.map(({shape:a,initialPagePoint:c})=>{const l=We(a.parentId)?t.getShapePageTransform(a.parentId):ie.Identity(),d=m.RotWith(c,i,n),h=ie.applyToPoint(ie.Inverse(l),d),p=Qn(a.rotation+n);return{id:a.id,type:a.type,x:h.x,y:h.y,rotation:p}}));const o=[];r.forEach(({shape:a})=>{var h,p,f;const c=t.getShape(a.id);if(!c)return;const l=t.getShapeUtil(a);if(s==="start"||s==="one-off"){const S=(h=l.onRotateStart)==null?void 0:h.call(l,a);S&&o.push(S)}const d=(p=l.onRotate)==null?void 0:p.call(l,a,c);if(d&&o.push(d),s==="end"||s==="one-off"){const S=(f=l.onRotateEnd)==null?void 0:f.call(l,a,c);S&&o.push(S)}}),o.length>0&&t.updateShapes(o)}const Tu=n=>{const{store:t}=n,e=t.query.filterHistory("binding"),s=t.query.records("binding");function i(){const r=s.get(),o=new Map;for(const a of r){const{fromId:c,toId:l}=a,d=o.get(c);d?d.push(a):o.set(c,[a]);const h=o.get(l);h?h.push(a):o.set(l,[a])}return o}return C("arrowBindingsIndex",(r,o)=>{if(Ct(r))return i();const a=r,c=e.getDiffSince(o);if(c===Re)return i();let l;function d(f){l??(l=new Map(a));const S=l.get(f.fromId),g=S==null?void 0:S.filter(x=>x.id!==f.id);g!=null&&g.length?l.set(f.fromId,g):l.delete(f.fromId);const w=l.get(f.toId),b=w==null?void 0:w.filter(x=>x.id!==f.id);b!=null&&b.length?l.set(f.toId,b):l.delete(f.toId)}function h(f){l??(l=new Map(a));let S=l.get(f);return S?S===a.get(f)&&(S=S.slice(0),l.set(f,S)):(S=[],l.set(f,S)),S}function p(f){h(f.fromId).push(f),h(f.toId).push(f)}for(const f of c){for(const S of oe(f.added))p(S);for(const[S,g]of oe(f.updated))d(S),p(g);for(const S of oe(f.removed))d(S)}return l??a})};function Mu(n,t,e){const s=n.getShapeMaskedPageBounds(t);return s===void 0?!0:!e.includes(s)}const Au=n=>{function t(e){const s=e.getCurrentPageShapeIds(),i=e.getViewportPageBounds(),r=new Set;return s.forEach(o=>{Mu(e,o,i)&&r.add(o)}),r}return C("getCulledShapes",e=>{if(Ct(e))return t(n);const s=t(n);if(e.size!==s.size)return s;for(const i of e)if(!s.has(i))return s;return e})},Du=n=>{const t=n.query.ids("shape"),e=n.query.filterHistory("shape");function s(){const i={},r=t.get(),o=Array(r.size);return r.forEach(a=>o.push(n.get(a))),o.sort(Ue),o.forEach(a=>{i[a.parentId]||(i[a.parentId]=[]),i[a.parentId].push(a.id)}),i}return C("parentsToChildrenWithIndexes",(i,r)=>{if(Ct(i))return s();const o=e.getDiffSince(r);if(o===Re)return s();if(o.length===0)return i;let a=null;const c=h=>{a||(a={...i}),a[h]?a[h]===i[h]&&(a[h]=[...a[h]]):a[h]=[]},l=new Set;let d;for(let h=0,p=o.length;h<p;h++){d=o[h];for(const f of Object.values(d.added))Nt(f)&&(c(f.parentId),a[f.parentId].push(f.id),l.add(a[f.parentId]));for(const[f,S]of Object.values(d.updated))if(Nt(S)&&Nt(f)){if(f.parentId!==S.parentId)c(f.parentId),c(S.parentId),a[f.parentId].splice(a[f.parentId].indexOf(S.id),1),a[S.parentId].push(S.id),l.add(a[S.parentId]);else if(f.index!==S.index){c(S.parentId);const g=a[S.parentId].indexOf(S.id);a[S.parentId][g]=S.id,l.add(a[S.parentId])}}for(const f of Object.values(d.removed))Nt(f)&&(c(f.parentId),a[f.parentId].splice(a[f.parentId].indexOf(f.id),1))}for(const h of l){const p=te(h.map(f=>n.get(f)));p.sort(Ue),h.splice(0,h.length,...p.map(f=>f.id))}return a??i})},jn=(n,t,e)=>{for(;!Me(e.parentId);){const s=n.get(e.parentId);if(!s)return!1;e=s}return e.parentId===t},Ru=(n,t)=>{const e=n.query.ids("shape");let s=null;function i(){const r=t();return s=r,new Set([...e.get()].filter(o=>jn(n,r,n.get(o))))}return C("_shapeIdsInCurrentPage",(r,o)=>{if(Ct(r))return i();const a=t();if(a!==s)return i();const c=n.history.getDiffSince(o);if(c===Re)return i();const l=new Ks(r);for(const h of c){for(const p of Object.values(h.added))Nt(p)&&jn(n,a,p)&&l.add(p.id);for(const[p,f]of Object.values(h.updated))Nt(f)&&(jn(n,a,f)?l.add(f.id):l.remove(f.id));for(const p of Object.keys(h.removed))We(p)&&l.remove(p)}const d=l.get();return d?is(d.value,d.diff):r})},pa=k.createContext(null);function Lu({context:n,editor:t,children:e}){return y.jsx(wn.Provider,{value:t,children:y.jsx(pa.Provider,{value:n,children:e})})}function Ou(){const n=k.useContext(pa);return n?{isDarkMode:n.isDarkMode}:null}async function Fu(n,t,e={}){var T,A;const s=typeof t[0]=="string"?t:t.map(M=>M.id);if(s.length===0)return;if(!window.document)throw Error("No document");const{scale:i=1,background:r=!1,padding:o=n.options.defaultSvgPadding,preserveAspectRatio:a=!1}=e,c=e.darkMode??n.user.getIsDarkMode(),l=Wc({isDarkMode:c}),d=n.getShapeAndDescendantIds(s),h=n.getUnorderedRenderingShapes(!1).filter(({id:M})=>d.has(M));let p=null;if(e.bounds)p=e.bounds;else for(const{id:M}of h){const F=n.getShapeMaskedPageBounds(M);F&&(p?p.union(F):p=F.clone())}if(!p)return;const f=s.length===1&&n.isShapeOfType(n.getShape(s[0]),"frame")?s[0]:null;f||p.expandBy(o);const S=p.width*i,g=p.height*i;try{(A=(T=document.body).focus)==null||A.call(T)}catch{}const w=[],b=new Map,x={isDarkMode:c,addExportDef:M=>{if(b.has(M.key))return;const F=(async()=>{const v=await M.getElement();v&&w.push(y.jsx(k.Fragment,{children:v},w.length))})();b.set(M.key,F)}},I=(await Promise.all(h.map(async({id:M,opacity:F,index:v,backgroundIndex:E})=>{var J,nt;if(M===f)return[];const D=n.getShape(M);if(n.isShapeOfType(D,"group"))return[];const B=n.getShapeUtil(D);let P=await((J=B.toSvg)==null?void 0:J.call(B,D,x)),j=await((nt=B.toBackgroundSvg)==null?void 0:nt.call(B,D,x));if(!P&&!j){const je=n.getShapePageBounds(D);P=y.jsx("rect",{width:je.w,height:je.h,fill:l.solid,stroke:l.grey.pattern,strokeWidth:1})}let R=n.getShapePageTransform(D).toCssString();"scale"in D.props&&D.props.scale!==1&&(R=`${R} scale(${D.props.scale}, ${D.props.scale})`),P&&(P=y.jsx("g",{transform:R,opacity:F,children:P},D.id)),j&&(j=y.jsx("g",{transform:R,opacity:F,children:j},`bg_${D.id}`));const V=n.getShapeMask(D.id);if(V){const je=`mask_${D.id.replace(":","_")}`;w.push(y.jsx("clipPath",{id:je,children:y.jsx("path",{d:`M${V.map(({x:Cs,y:it})=>`${Cs},${it}`).join("L")}Z`})},w.length)),P&&(P=y.jsx("g",{clipPath:`url(#${je})`,children:P},D.id)),j&&(j=y.jsx("g",{clipPath:`url(#${je})`,children:j},`bg_${D.id}`))}const z=[];return P&&z.push({zIndex:v,element:P}),j&&z.push({zIndex:E,element:j}),z}))).flat();return await Promise.all(b.values()),{jsx:y.jsx(Lu,{editor:n,context:x,children:y.jsxs("svg",{preserveAspectRatio:a||void 0,direction:"ltr",width:S,height:g,viewBox:`${p.minX} ${p.minY} ${p.width} ${p.height}`,strokeLinecap:"round",strokeLinejoin:"round",style:{backgroundColor:r?f?l.solid:l.background:"transparent"},children:[y.jsx("defs",{children:w}),I.sort((M,F)=>M.zIndex-F.zIndex).map(({element:M})=>M)]})}),width:S,height:g}}const ju=40;class zu{constructor(t){u(this,"_clickId","");u(this,"_clickTimeout");u(this,"_clickScreenPoint");u(this,"_previousScreenPoint");u(this,"_getClickTimeout",(t,e=De())=>{this._clickId=e,clearTimeout(this._clickTimeout),this._clickTimeout=this.editor.timers.setTimeout(()=>{if(this._clickState===t&&this._clickId===e){switch(this._clickState){case"pendingTriple":{this.editor.dispatch({...this.lastPointerInfo,type:"click",name:"double_click",phase:"settle"});break}case"pendingQuadruple":{this.editor.dispatch({...this.lastPointerInfo,type:"click",name:"triple_click",phase:"settle"});break}case"pendingOverflow":{this.editor.dispatch({...this.lastPointerInfo,type:"click",name:"quadruple_click",phase:"settle"});break}}this._clickState="idle"}},t==="idle"||t==="pendingDouble"?this.editor.options.doubleClickDurationMs:this.editor.options.multiClickDurationMs)});u(this,"_clickState","idle");u(this,"lastPointerInfo",{});u(this,"handlePointerEvent",t=>{switch(t.name){case"pointer_down":{if(!this._clickState)return t;switch(this._clickScreenPoint=m.From(t.point),this._previousScreenPoint&&m.Dist2(this._previousScreenPoint,this._clickScreenPoint)>ju**2&&(this._clickState="idle"),this._previousScreenPoint=this._clickScreenPoint,this.lastPointerInfo=t,this._clickState){case"pendingDouble":return this._clickState="pendingTriple",this._clickTimeout=this._getClickTimeout(this._clickState),{...t,type:"click",name:"double_click",phase:"down"};case"pendingTriple":return this._clickState="pendingQuadruple",this._clickTimeout=this._getClickTimeout(this._clickState),{...t,type:"click",name:"triple_click",phase:"down"};case"pendingQuadruple":return this._clickState="pendingOverflow",this._clickTimeout=this._getClickTimeout(this._clickState),{...t,type:"click",name:"quadruple_click",phase:"down"};case"idle":{this._clickState="pendingDouble";break}case"pendingOverflow":{this._clickState="overflow";break}}return this._clickTimeout=this._getClickTimeout(this._clickState),t}case"pointer_up":{if(!this._clickState)return t;switch(this._clickScreenPoint=m.From(t.point),this._clickState){case"pendingTriple":return{...this.lastPointerInfo,type:"click",name:"double_click",phase:"up"};case"pendingQuadruple":return{...this.lastPointerInfo,type:"click",name:"triple_click",phase:"up"};case"pendingOverflow":return{...this.lastPointerInfo,type:"click",name:"quadruple_click",phase:"up"}}return t}case"pointer_move":return this._clickState!=="idle"&&this._clickScreenPoint&&m.Dist2(this._clickScreenPoint,this.editor.inputs.currentScreenPoint)>(this.editor.getInstanceState().isCoarsePointer?this.editor.options.coarseDragDistanceSquared:this.editor.options.dragDistanceSquared)&&this.cancelDoubleClickTimeout(),t}return t});u(this,"cancelDoubleClickTimeout",()=>{this._clickTimeout=clearTimeout(this._clickTimeout),this._clickState="idle"});this.editor=t}get clickState(){return this._clickState}}class Bu{constructor(t){u(this,"_isEdgeScrolling",!1);u(this,"_edgeScrollDuration",-1);this.editor=t}updateEdgeScrolling(t){const{editor:e}=this,s=this.getEdgeScroll();if(s.x===0&&s.y===0)this._isEdgeScrolling&&(this._isEdgeScrolling=!1,this._edgeScrollDuration=0);else if(this._isEdgeScrolling||(this._isEdgeScrolling=!0,this._edgeScrollDuration=0),this._edgeScrollDuration+=t,this._edgeScrollDuration>e.options.edgeScrollDelay){const i=e.options.edgeScrollEaseDuration>0?ws.easeInCubic(Math.min(1,this._edgeScrollDuration/(e.options.edgeScrollDelay+e.options.edgeScrollEaseDuration))):1;this.moveCameraWhenCloseToEdge({x:s.x*i,y:s.y*i})}}getEdgeProximityFactors(t,e,s,i,r){const{editor:o}=this,a=o.options.edgeScrollDistance,c=s?o.options.coarsePointerWidth:0,l=t-c,d=t+c,h=i?0:a,p=r?e:e-a;return l<h?Math.min(1,(h-l)/a):d>p?-Math.min(1,(d-p)/a):0}getEdgeScroll(){const{editor:t}=this,{inputs:{currentScreenPoint:{x:e,y:s}}}=t,i=t.getViewportScreenBounds(),{isCoarsePointer:r,insets:[o,a,c,l]}=t.getInstanceState(),d=this.getEdgeProximityFactors(e,i.w,r,l,a),h=this.getEdgeProximityFactors(s,i.h,r,o,c);return{x:d,y:h}}moveCameraWhenCloseToEdge(t){const{editor:e}=this;if(!e.inputs.isDragging||e.inputs.isPanning||e.getCameraOptions().isLocked||t.x===0&&t.y===0)return;const s=e.getViewportScreenBounds(),i=s.w<1e3?.612:1,r=s.h<1e3?.612:1,o=e.getZoomLevel(),a=e.user.getEdgeScrollSpeed()*e.options.edgeScrollSpeed,c=a*t.x*i/o,l=a*t.y*r/o,{x:d,y:h,z:p}=e.getCamera();e.setCamera(new m(d+c,h+l,p))}}class Uu{constructor(t){u(this,"isSafari");u(this,"isIos");u(this,"isChromeForIos");u(this,"isFirefox");u(this,"isAndroid");this.editor=t,typeof window<"u"&&"navigator"in window?(this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIos=!!navigator.userAgent.match(/iPad/i)||!!navigator.userAgent.match(/iPhone/i),this.isChromeForIos=/crios.*safari/i.test(navigator.userAgent),this.isFirefox=/firefox/i.test(navigator.userAgent),this.isAndroid=/android/i.test(navigator.userAgent)):(this.isSafari=!1,this.isIos=!1,this.isChromeForIos=!1,this.isFirefox=!1,this.isAndroid=!1)}}class Nu{constructor(t,e){u(this,"disposeSideEffectListener");this.editor=t,this.disposeSideEffectListener=t.sideEffects.registerAfterChangeHandler("instance",(i,r)=>{i.isFocused!==r.isFocused&&(r.isFocused?this.focus():this.blur(),this.updateContainerClass())});const s=t.getInstanceState().isFocused;e!==s&&t.updateInstanceState({isFocused:!!e}),this.updateContainerClass()}updateContainerClass(){const t=this.editor.getContainer();this.editor.getInstanceState().isFocused?t.classList.add("tl-container__focused"):t.classList.remove("tl-container__focused")}focus(){this.editor.getContainer().focus()}blur(){this.editor.complete(),this.editor.getContainer().blur()}dispose(){var t;(t=this.disposeSideEffectListener)==null||t.call(this)}}function ss(n){return Ku}class $u{constructor(){u(this,"length",0);u(this,"head",null);u(this,"tail",this)}push(t){return new Ai(t,this)}toArray(){return ht}[Symbol.iterator](){return{next(){return{value:void 0,done:!0}}}}}const Ku=new $u;class Ai{constructor(t,e){u(this,"length");this.head=t,this.tail=e,this.length=e.length+1}push(t){return new Ai(t,this)}toArray(){return Array.from(this)}[Symbol.iterator](){let t=this;return{next(){if(t.length){const e=t.head;return t=t.tail,{value:e,done:!1}}else return{value:void 0,done:!0}}}}}class Hu{constructor(t){u(this,"store");u(this,"dispose");u(this,"state","recording");u(this,"pendingDiff",new Gu);u(this,"stacks",fe("HistoryManager.stacks",{undos:ss(),redos:ss()},{isEqual:(t,e)=>t.undos===e.undos&&t.redos===e.redos}));u(this,"annotateError");u(this,"_isInBatch",!1);u(this,"batch",(t,e)=>{const s=this.state;s!=="paused"&&(e!=null&&e.history)&&(this.state=Yu[e.history]);try{if(this._isInBatch)return ut(t),this;this._isInBatch=!0;try{ut(t)}catch(i){throw this.annotateError(i),i}finally{this._isInBatch=!1}return this}finally{this.state=s}});u(this,"_undo",({pushToRedoStack:t,toMark:e=void 0})=>{var i;const s=this.state;this.state="paused";try{let{undos:r,redos:o}=this.stacks.get();const a=this.pendingDiff.clear(),c=So(a),l=Xn(a);t&&!c&&(o=o.push({type:"diff",diff:a}));let d=!1;if(c)for(;((i=r.head)==null?void 0:i.type)==="stop";){const h=r.head;if(r=r.tail,t&&(o=o.push(h)),h.id===e){d=!0;break}}if(!d)e:for(;r.head;){const h=r.head;switch(r=r.tail,t&&(o=o.push(h)),h.type){case"diff":ds(l,[Xn(h.diff)]);break;case"stop":if(!e||h.id===e)break e;break;default:Ve(h)}}this.store.applyDiff(l,{ignoreEphemeralKeys:!0}),this.store.ensureStoreIsUsable(),this.stacks.set({undos:r,redos:o})}finally{this.state=s}return this});u(this,"undo",()=>(this._undo({pushToRedoStack:!0}),this));u(this,"redo",()=>{var e;const t=this.state;this.state="paused";try{this.flushPendingDiff();let{undos:s,redos:i}=this.stacks.get();if(i.length===0)return this;for(;((e=i.head)==null?void 0:e.type)==="stop";)s=s.push(i.head),i=i.tail;const r=Qs();for(;i.head;){const o=i.head;if(s=s.push(o),i=i.tail,o.type==="diff")ds(r,[o.diff]);else break}this.store.applyDiff(r,{ignoreEphemeralKeys:!0}),this.store.ensureStoreIsUsable(),this.stacks.set({undos:s,redos:i})}finally{this.state=t}return this});u(this,"bail",()=>(this._undo({pushToRedoStack:!1}),this));u(this,"bailToMark",t=>(this._undo({pushToRedoStack:!1,toMark:t}),this));u(this,"squashToMark",t=>{var r;let e=this.stacks.get().undos;const s=[];for(;e.head&&!(e.head.type==="stop"&&e.head.id===t);)e.head.type==="diff"&&s.push(e.head.diff),e=e.tail;if(!e.head||((r=e.head)==null?void 0:r.id)!==t)return console.error("Could not find mark to squash to: ",t),this;if(s.length===0)return this;const i=Qs();return ds(i,s.reverse()),this.stacks.update(({redos:o})=>({undos:e.push({type:"diff",diff:i}),redos:o})),this});u(this,"mark",(t=De())=>(ut(()=>{this.flushPendingDiff(),this.stacks.update(({undos:e,redos:s})=>({undos:e.push({type:"stop",id:t}),redos:s}))}),t));this.store=t.store,this.annotateError=t.annotateError??ri,this.dispose=this.store.addHistoryInterceptor((e,s)=>{if(s==="user")switch(this.state){case"recording":this.pendingDiff.apply(e.changes),this.stacks.update(({undos:i})=>({undos:i,redos:ss()}));break;case"recordingPreserveRedoStack":this.pendingDiff.apply(e.changes);break;case"paused":break;default:Ve(this.state)}})}flushPendingDiff(){if(this.pendingDiff.isEmpty())return;const t=this.pendingDiff.clear();this.stacks.update(({undos:e,redos:s})=>({undos:e.push({type:"diff",diff:t}),redos:s}))}getNumUndos(){return this.stacks.get().undos.length+(this.pendingDiff.isEmpty()?0:1)}getNumRedos(){return this.stacks.get().redos.length}clear(){this.stacks.set({undos:ss(),redos:ss()}),this.pendingDiff.clear()}debug(){const{undos:t,redos:e}=this.stacks.get();return{undos:t.toArray(),redos:e.toArray(),pendingDiff:this.pendingDiff.debug(),state:this.state}}}const Yu={record:"recording","record-preserveRedoStack":"recordingPreserveRedoStack",ignore:"paused"};class Gu{constructor(){u(this,"diff",Qs());u(this,"isEmptyAtom",fe("PendingDiff.isEmpty",!0))}clear(){const t=this.diff;return this.diff=Qs(),this.isEmptyAtom.set(!0),t}isEmpty(){return this.isEmptyAtom.get()}apply(t){ds(this.diff,[t]),this.isEmptyAtom.set(So(this.diff))}debug(){return{diff:this.diff,isEmpty:this.isEmpty()}}}class Xu{constructor(t){u(this,"scribbleItems",new Map);u(this,"state","paused");u(this,"addScribble",(t,e=De())=>{const s={id:e,scribble:{id:e,size:20,color:"accent",opacity:.8,delay:0,points:[],shrink:.1,taper:!0,...t,state:"starting"},timeoutMs:0,delayRemaining:t.delay??0,prev:null,next:null};return this.scribbleItems.set(e,s),s});u(this,"stop",t=>{const e=this.scribbleItems.get(t);if(!e)throw Error(`Scribble with id ${t} not found`);return e.delayRemaining=Math.min(e.delayRemaining,200),e.scribble.state="stopping",e});u(this,"addPoint",(t,e,s)=>{const i=this.scribbleItems.get(t);if(!i)throw Error(`Scribble with id ${t} not found`);const{prev:r}=i,o={x:e,y:s,z:.5};return(!r||m.Dist(r,o)>=1)&&(i.next=o),i});u(this,"tick",t=>{this.scribbleItems.size!==0&&this.editor.run(()=>{this.scribbleItems.forEach(e=>{if(e.scribble.state==="starting"){const{next:c,prev:l}=e;c&&c!==l&&(e.prev=c,e.scribble.points.push(c)),e.scribble.points.length>8&&(e.scribble.state="active");return}e.delayRemaining>0&&(e.delayRemaining=Math.max(0,e.delayRemaining-t)),e.timeoutMs+=t,e.timeoutMs>=16&&(e.timeoutMs=0);const{delayRemaining:s,timeoutMs:i,prev:r,next:o,scribble:a}=e;switch(a.state){case"active":{o&&o!==r?(e.prev=o,a.points.push(o),s===0&&a.points.length>8&&a.points.shift()):i===0&&(a.points.length>1?a.points.shift():e.delayRemaining=a.delay);break}case"stopping":{if(e.delayRemaining===0&&i===0){if(a.points.length===1){this.scribbleItems.delete(e.id);return}a.shrink&&(a.size=Math.max(1,a.size*(1-a.shrink))),a.points.shift()}break}}}),this.editor.updateInstanceState({scribbles:Array.from(this.scribbleItems.values()).map(({scribble:e})=>({...e,points:[...e.points]})).slice(-5)})})});this.editor=t}reset(){this.editor.updateInstanceState({scribbles:[]}),this.scribbleItems.clear()}}var qu=Object.defineProperty,Wu=Object.getOwnPropertyDescriptor,vn=(n,t,e,s)=>{for(var i=Wu(t,e),r=n.length-1,o;r>=0;r--)(o=n[r])&&(i=o(t,e,i)||i);return i&&qu(t,e,i),i};const U=n=>Math.round(n*10**8)/10**8;function ct(n,t,e,s,i){const r=n.filter(a=>(s==="forward"?a.startNode.id===t:a.endNode.id===t)&&U(a.length)===U(e)&&He(a.breadthIntersection[0],a.breadthIntersection[1],i[0],i[1]));if(r.length===0)return[];const o=new Set;return r.forEach(a=>{const c=s==="forward"?a.endNode.id:a.startNode.id;if(!o.has(c)){o.add(c);const l=ct(n,c,e,s,He(a.breadthIntersection[0],a.breadthIntersection[1],i[0],i[1]));r.push(...l)}}),r}function Vu(n){n.sort((t,e)=>e.gaps.length-t.gaps.length);for(let t=n.length-1;t>0;t--){const e=n[t];for(let s=t-1;s>=0;s--){const i=n[s];if(i.direction===e.direction&&e.gaps.every(r=>i.gaps.some(o=>U(r.startEdge[0].x)===U(o.startEdge[0].x)&&U(r.startEdge[0].y)===U(o.startEdge[0].y)&&U(r.startEdge[1].x)===U(o.startEdge[1].x)&&U(r.startEdge[1].y)===U(o.startEdge[1].y))&&i.gaps.some(o=>U(r.endEdge[0].x)===U(o.endEdge[0].x)&&U(r.endEdge[0].y)===U(o.endEdge[0].y)&&U(r.endEdge[1].x)===U(o.endEdge[1].x)&&U(r.endEdge[1].y)===U(o.endEdge[1].y)))){n.splice(t,1);break}}}}class Ps{constructor(t){u(this,"editor");this.manager=t,this.editor=t.editor}getSnapPointsCache(){const{editor:t}=this;return t.store.createComputedCache("snapPoints",e=>{const s=t.getShapePageTransform(e.id);if(!s)return;const r=t.getShapeUtil(e).getBoundsSnapGeometry(e).points??t.getShapeGeometry(e).bounds.cornersAndCenter;if(!(!s||!r))return r.map((o,a)=>{const{x:c,y:l}=ie.applyToPoint(s,o);return{x:c,y:l,id:`${e.id}:${a}`}})})}getSnapPoints(t){return this.getSnapPointsCache().get(t)??[]}getSnappablePoints(){const t=this.getSnapPointsCache(),e=this.manager.getSnappableShapes(),s=[];for(const i of e){const r=t.get(i);r&&s.push(...r)}return s}getSnappableGapNodes(){return Array.from(this.manager.getSnappableShapes(),t=>({id:t,pageBounds:Be(this.editor.getShapePageBounds(t))}))}getVisibleGaps(){const t=[],e=[];let s,i;const r=this.getSnappableGapNodes().sort((a,c)=>a.pageBounds.minX-c.pageBounds.minX);for(let a=0;a<r.length;a++){s=r[a];for(let c=a+1;c<r.length;c++)i=r[c],s.pageBounds.maxX<i.pageBounds.minX&&ts(s.pageBounds.minY,s.pageBounds.maxY,i.pageBounds.minY,i.pageBounds.maxY)&&t.push({startNode:s,endNode:i,startEdge:[new m(s.pageBounds.maxX,s.pageBounds.minY),new m(s.pageBounds.maxX,s.pageBounds.maxY)],endEdge:[new m(i.pageBounds.minX,i.pageBounds.minY),new m(i.pageBounds.minX,i.pageBounds.maxY)],length:i.pageBounds.minX-s.pageBounds.maxX,breadthIntersection:He(s.pageBounds.minY,s.pageBounds.maxY,i.pageBounds.minY,i.pageBounds.maxY)})}const o=r.sort((a,c)=>a.pageBounds.minY-c.pageBounds.minY);for(let a=0;a<o.length;a++){s=o[a];for(let c=a+1;c<o.length;c++)i=o[c],s.pageBounds.maxY<i.pageBounds.minY&&ts(s.pageBounds.minX,s.pageBounds.maxX,i.pageBounds.minX,i.pageBounds.maxX)&&e.push({startNode:s,endNode:i,startEdge:[new m(s.pageBounds.minX,s.pageBounds.maxY),new m(s.pageBounds.maxX,s.pageBounds.maxY)],endEdge:[new m(i.pageBounds.minX,i.pageBounds.minY),new m(i.pageBounds.maxX,i.pageBounds.minY)],length:i.pageBounds.minY-s.pageBounds.maxY,breadthIntersection:He(s.pageBounds.minX,s.pageBounds.maxX,i.pageBounds.minX,i.pageBounds.maxX)})}return{horizontal:t,vertical:e}}snapTranslateShapes({lockedAxis:t,initialSelectionPageBounds:e,initialSelectionSnapPoints:s,dragDelta:i}){var w,b;const r=this.manager.getSnapThreshold(),o=this.getSnappablePoints(),a=e.clone().translate(i),c=s.map(({x,y:I},_)=>({id:"selection:"+_,x:x+i.x,y:I+i.y})),l=o,d=[],h=[],p=new m(r,r);this.collectPointSnaps({minOffset:p,nearestSnapsX:d,nearestSnapsY:h,otherNodeSnapPoints:l,selectionSnapPoints:c}),this.collectGapSnaps({selectionPageBounds:a,nearestSnapsX:d,nearestSnapsY:h,minOffset:p});const f=new m(t==="x"?0:((w=d[0])==null?void 0:w.nudge)??0,t==="y"?0:((b=h[0])==null?void 0:b.nudge)??0);p.x=0,p.y=0,d.length=0,h.length=0,c.forEach(x=>{x.x+=f.x,x.y+=f.y}),a.translate(f),this.collectPointSnaps({minOffset:p,nearestSnapsX:d,nearestSnapsY:h,otherNodeSnapPoints:l,selectionSnapPoints:c}),this.collectGapSnaps({selectionPageBounds:a,nearestSnapsX:d,nearestSnapsY:h,minOffset:p});const S=this.getPointSnapLines({nearestSnapsX:d,nearestSnapsY:h}),g=this.getGapSnapLines({selectionPageBounds:a,nearestSnapsX:d,nearestSnapsY:h});return this.manager.setIndicators([...g,...S]),{nudge:f}}snapResizeShapes({initialSelectionPageBounds:t,dragDelta:e,handle:s,isAspectRatioLocked:i,isResizingFromCenter:r}){var M,F;const o=this.manager.getSnapThreshold(),{box:a,scaleX:c,scaleY:l}=H.Resize(t,s,r?e.x*2:e.x,r?e.y*2:e.y,i);let d=s;c<0&&(d=Wd(d)),l<0&&(d=qd(d)),r&&(a.center=t.center);const h=d==="top"||d==="bottom",p=d==="left"||d==="right",f=Tr(d,a),S=this.getSnappablePoints(),g=[],w=[],b=new m(o,o);this.collectPointSnaps({minOffset:b,nearestSnapsX:g,nearestSnapsY:w,otherNodeSnapPoints:S,selectionSnapPoints:f});const x=new m(h?0:((M=g[0])==null?void 0:M.nudge)??0,p?0:((F=w[0])==null?void 0:F.nudge)??0);if(i&&Vd(d)&&x.len()!==0){const v=g.length&&w.length?Math.abs(x.x)<Math.abs(x.y)?"x":"y":g.length?"x":"y",E=t.aspectRatio;v==="x"?(w.length=0,x.y=x.x/E,(d==="bottom_left"||d==="top_right")&&(x.y=-x.y)):(g.length=0,x.x=x.y*E,(d==="bottom_left"||d==="top_right")&&(x.x=-x.x))}const I=m.Add(e,x),{box:_}=H.Resize(t,s,r?I.x*2:I.x,r?I.y*2:I.y,i);r&&(_.center=t.center);const T=Tr("any",_);g.length=0,w.length=0,b.x=0,b.y=0,this.collectPointSnaps({minOffset:b,nearestSnapsX:g,nearestSnapsY:w,otherNodeSnapPoints:S,selectionSnapPoints:T});const A=this.getPointSnapLines({nearestSnapsX:g,nearestSnapsY:w});return this.manager.setIndicators([...A]),{nudge:x}}collectPointSnaps({selectionSnapPoints:t,otherNodeSnapPoints:e,minOffset:s,nearestSnapsX:i,nearestSnapsY:r}){for(const o of t)for(const a of e){const c=m.Sub(o,a),l=Math.abs(c.x),d=Math.abs(c.y);U(l)<=U(s.x)&&(U(l)<U(s.x)&&(i.length=0),i.push({type:"points",points:{thisPoint:o,otherPoint:a},nudge:a.x-o.x}),s.x=l),U(d)<=U(s.y)&&(U(d)<U(s.y)&&(r.length=0),r.push({type:"points",points:{thisPoint:o,otherPoint:a},nudge:a.y-o.y}),s.y=d)}}collectGapSnaps({selectionPageBounds:t,minOffset:e,nearestSnapsX:s,nearestSnapsY:i}){const{horizontal:r,vertical:o}=this.getVisibleGaps();for(const a of r){if(!ts(a.breadthIntersection[0],a.breadthIntersection[1],t.minY,t.maxY))continue;const l=a.startEdge[0].x+a.length/2-t.center.x;if(a.length>t.width&&U(Math.abs(l))<=U(e.x)){U(Math.abs(l))<U(e.x)&&(s.length=0),e.x=Math.abs(l);const b={type:"gap_center",gap:a,nudge:l},x=s.find(({type:_})=>_==="gap_center"),I=x&&He(a.breadthIntersection[0],a.breadthIntersection[1],x.gap.breadthIntersection[0],x.gap.breadthIntersection[1]);x&&x.gap.length>a.length&&I?s[s.indexOf(x)]=b:(!x||!I)&&s.push(b)}const h=a.startNode.pageBounds.minX-a.length,p=t.maxX,f=h-p;U(Math.abs(f))<=U(e.x)&&(U(Math.abs(f))<U(e.x)&&(s.length=0),e.x=Math.abs(f),s.push({type:"gap_duplicate",gap:a,protrusionDirection:"left",nudge:f}));const S=a.endNode.pageBounds.maxX+a.length,g=t.minX,w=S-g;U(Math.abs(w))<=U(e.x)&&(U(Math.abs(w))<U(e.x)&&(s.length=0),e.x=Math.abs(w),s.push({type:"gap_duplicate",gap:a,protrusionDirection:"right",nudge:w}))}for(const a of o){if(!ts(a.breadthIntersection[0],a.breadthIntersection[1],t.minX,t.maxX))continue;const l=a.startEdge[0].y+a.length/2-t.center.y;if(a.length>t.height&&U(Math.abs(l))<=U(e.y)){U(Math.abs(l))<U(e.y)&&(i.length=0),e.y=Math.abs(l);const b={type:"gap_center",gap:a,nudge:l},x=i.find(({type:_})=>_==="gap_center"),I=x&&ts(x.gap.breadthIntersection[0],x.gap.breadthIntersection[1],a.breadthIntersection[0],a.breadthIntersection[1]);x&&x.gap.length>a.length&&I?i[i.indexOf(x)]=b:(!x||!I)&&i.push(b);continue}const h=a.startNode.pageBounds.minY-a.length,p=t.maxY,f=h-p;U(Math.abs(f))<=U(e.y)&&(U(Math.abs(f))<U(e.y)&&(i.length=0),e.y=Math.abs(f),i.push({type:"gap_duplicate",gap:a,protrusionDirection:"top",nudge:f}));const S=a.endNode.pageBounds.maxY+a.length,g=t.minY,w=S-g;U(Math.abs(w))<=U(e.y)&&(U(Math.abs(w))<U(e.y)&&(i.length=0),e.y=Math.abs(w),i.push({type:"gap_duplicate",gap:a,protrusionDirection:"bottom",nudge:w}))}}getPointSnapLines({nearestSnapsX:t,nearestSnapsY:e}){const s={},i={};if(t.length>0){for(const r of t)if(r.type==="points"){const o=U(r.points.otherPoint.x);s[o]||(s[o]=[]),s[o].push(r.points)}}if(e.length>0){for(const r of e)if(r.type==="points"){const o=U(r.points.otherPoint.y);i[o]||(i[o]=[]),i[o].push(r.points)}}return Object.values(s).concat(Object.values(i)).map(r=>({id:De(),type:"points",points:ii(r.map(o=>m.From(o.otherPoint)).concat(r.map(o=>m.From(o.thisPoint))),(o,a)=>o.equals(a))}))}getGapSnapLines({selectionPageBounds:t,nearestSnapsX:e,nearestSnapsY:s}){const{vertical:i,horizontal:r}=this.getVisibleGaps(),o={top:t.sides[0],right:t.sides[1],bottom:[t.corners[3],t.corners[2]],left:[t.corners[0],t.corners[3]]},a=[];if(e.length>0)for(const c of e){if(c.type==="points")continue;const{gap:{breadthIntersection:l,startEdge:d,startNode:h,endNode:p,length:f,endEdge:S}}=c;switch(c.type){case"gap_center":{const g=(f-t.width)/2,w=He(l[0],l[1],t.minY,t.maxY);a.push({type:"gaps",direction:"horizontal",id:De(),gaps:[...ct(r,h.id,g,"backward",w),{startEdge:d,endEdge:o.left},{startEdge:o.right,endEdge:S},...ct(r,p.id,g,"forward",w)]});break}case"gap_duplicate":{const g=He(l[0],l[1],t.minY,t.maxY);a.push({type:"gaps",direction:"horizontal",id:De(),gaps:c.protrusionDirection==="left"?[{startEdge:o.right,endEdge:d.map(w=>w.clone().addXY(-h.pageBounds.width,0))},{startEdge:d,endEdge:S},...ct(r,p.id,f,"forward",g)]:[...ct(r,h.id,f,"backward",g),{startEdge:d,endEdge:S},{startEdge:S.map(w=>w.clone().addXY(c.gap.endNode.pageBounds.width,0)),endEdge:o.left}]});break}}}if(s.length>0)for(const c of s){if(c.type==="points")continue;const{gap:{breadthIntersection:l,startEdge:d,startNode:h,endNode:p,length:f,endEdge:S}}=c;switch(c.type){case"gap_center":{const g=(f-t.height)/2,w=He(l[0],l[1],t.minX,t.maxX);a.push({type:"gaps",direction:"vertical",id:De(),gaps:[...ct(i,h.id,g,"backward",w),{startEdge:d,endEdge:o.top},{startEdge:o.bottom,endEdge:S},...ct(i,c.gap.endNode.id,g,"forward",w)]});break}case"gap_duplicate":{const g=He(l[0],l[1],t.minX,t.maxX);a.push({type:"gaps",direction:"vertical",id:De(),gaps:c.protrusionDirection==="top"?[{startEdge:o.bottom,endEdge:d.map(w=>w.clone().addXY(0,-h.pageBounds.height))},{startEdge:d,endEdge:S},...ct(i,p.id,f,"forward",g)]:[...ct(i,h.id,f,"backward",g),{startEdge:d,endEdge:S},{startEdge:S.map(w=>w.clone().addXY(0,p.pageBounds.height)),endEdge:o.top}]})}break}}return Vu(a),a}}vn([C],Ps.prototype,"getSnapPointsCache");vn([C],Ps.prototype,"getSnappablePoints");vn([C],Ps.prototype,"getSnappableGapNodes");vn([C],Ps.prototype,"getVisibleGaps");function Tr(n,t){const{minX:e,maxX:s,minY:i,maxY:r}=t,o=[];switch(n){case"top":case"left":case"top_left":case"any":o.push({id:"top_left",handle:"top_left",x:e,y:i})}switch(n){case"top":case"right":case"top_right":case"any":o.push({id:"top_right",handle:"top_right",x:s,y:i})}switch(n){case"bottom":case"right":case"bottom_right":case"any":o.push({id:"bottom_right",handle:"bottom_right",x:s,y:r})}switch(n){case"bottom":case"left":case"bottom_left":case"any":o.push({id:"bottom_left",handle:"bottom_left",x:e,y:r})}return o}var Zu=Object.defineProperty,Qu=Object.getOwnPropertyDescriptor,Ju=(n,t,e,s)=>{for(var i=Qu(t,e),r=n.length-1,o;r>=0;r--)(o=n[r])&&(i=o(t,e,i)||i);return i&&Zu(t,e,i),i};const ep=()=>null,tp=()=>[];class fa{constructor(t){u(this,"editor");this.manager=t,this.editor=t.editor}getSnapGeometryCache(){const{editor:t}=this;return t.store.createComputedCache("handle snap geometry",e=>{const s=t.getShapeUtil(e).getHandleSnapGeometry(e);return{outline:s.outline===void 0?t.getShapeGeometry(e):s.outline,points:s.points??[],getSelfSnapOutline:s.getSelfSnapOutline??ep,getSelfSnapPoints:s.getSelfSnapPoints??tp}})}*iterateSnapPointsInPageSpace(t,e){var i,r;const s=(i=this.getSnapGeometryCache().get(t))==null?void 0:i.getSelfSnapPoints(e);if(s&&s.length){const o=Be(this.editor.getShapePageTransform(t));for(const a of s)yield o.applyToPoint(a)}for(const o of this.manager.getSnappableShapes()){if(o===t)continue;const a=(r=this.getSnapGeometryCache().get(o))==null?void 0:r.points;if(!a||!a.length)continue;const c=Be(this.editor.getShapePageTransform(o));for(const l of a)yield c.applyToPoint(l)}}*iterateSnapOutlines(t,e){var i,r;const s=(i=this.getSnapGeometryCache().get(t))==null?void 0:i.getSelfSnapOutline(e);s&&(yield{shapeId:t,outline:s});for(const o of this.manager.getSnappableShapes()){if(o===t)continue;const a=(r=this.getSnapGeometryCache().get(o))==null?void 0:r.outline;a&&(yield{shapeId:o,outline:a})}}getHandleSnapPosition({currentShapeId:t,handle:e,handleInPageSpace:s}){const i=this.manager.getSnapThreshold();let r=i,o=null;for(const l of this.iterateSnapPointsInPageSpace(t,e))m.DistMin(s,l,r)&&(r=m.Dist(s,l),o=l);if(o)return o;let a=i,c=null;for(const{shapeId:l,outline:d}of this.iterateSnapOutlines(t,e)){const h=Be(this.editor.getShapePageTransform(l)),p=this.editor.getPointInShapeSpace(l,s),f=d.nearestPoint(p),S=h.applyToPoint(f);m.DistMin(s,S,a)&&(a=m.Dist(s,S),c=S)}return c||null}snapHandle({currentShapeId:t,handle:e}){const i=Be(this.editor.getShapePageTransform(t)).applyToPoint(e),r=this.getHandleSnapPosition({currentShapeId:t,handle:e,handleInPageSpace:i});return r?(this.manager.setIndicators([{id:De(),type:"points",points:[r]}]),{nudge:m.Sub(r,i)}):null}}Ju([C],fa.prototype,"getSnapGeometryCache");var sp=Object.defineProperty,np=Object.getOwnPropertyDescriptor,Di=(n,t,e,s)=>{for(var i=np(t,e),r=n.length-1,o;r>=0;r--)(o=n[r])&&(i=o(t,e,i)||i);return i&&sp(t,e,i),i};class Pn{constructor(t){u(this,"shapeBounds");u(this,"handles");u(this,"_snapIndicators",fe("snapLines",void 0));this.editor=t,this.shapeBounds=new Ps(this),this.handles=new fa(this)}getIndicators(){return this._snapIndicators.get()??ht}clearIndicators(){this.getIndicators().length&&this._snapIndicators.set(void 0)}setIndicators(t){this._snapIndicators.set(t)}getSnapThreshold(){return 8/this.editor.getZoomLevel()}getSnappableShapes(){const{editor:t}=this,e=t.getViewportPageBounds(),s=t.getSelectedShapeIds(),i=new Set,r=o=>{if(We(o)){const c=t.getShape(o);c&&t.isShapeOfType(c,"frame")&&i.add(o)}const a=t.getSortedChildIdsForParent(o);for(const c of a){if(s.includes(c))continue;const l=t.getShape(c);if(!l||!t.getShapeUtil(l).canSnap(l))continue;const h=t.getShapePageBounds(c);if(h&&e.includes(h)){if(t.isShapeOfType(l,"group")){r(c);continue}i.add(c)}}};return r(this.getCurrentCommonAncestor()??t.getCurrentPageId()),i}getCurrentCommonAncestor(){return this.editor.findCommonAncestor(this.editor.getSelectedShapes())}}Di([C],Pn.prototype,"getSnapThreshold");Di([C],Pn.prototype,"getSnappableShapes");Di([C],Pn.prototype,"getCurrentCommonAncestor");const ip=/\r?\n|\r/g;function Mr(n){return n.replace(ip,`
`).split(`
`).map(t=>t||" ").join(`
`)}const rp={start:"left","start-legacy":"left",middle:"center","middle-legacy":"center",end:"right","end-legacy":"right"},op=/\s/;class ap{constructor(t){u(this,"baseElm");u(this,"measureText",(t,e)=>{var o;const s=(o=this.baseElm)==null?void 0:o.cloneNode();this.baseElm.insertAdjacentElement("afterend",s),s.setAttribute("dir","auto"),s.style.setProperty("unicode-bidi","plaintext"),s.style.setProperty("font-family",e.fontFamily),s.style.setProperty("font-style",e.fontStyle),s.style.setProperty("font-weight",e.fontWeight),s.style.setProperty("font-size",e.fontSize+"px"),s.style.setProperty("line-height",e.lineHeight*e.fontSize+"px"),s.style.setProperty("max-width",e.maxWidth===null?null:e.maxWidth+"px"),s.style.setProperty("min-width",e.minWidth===null?null:e.minWidth+"px"),s.style.setProperty("padding",e.padding),s.style.setProperty("overflow-wrap",e.disableOverflowWrapBreaking?"normal":"break-word"),s.textContent=Mr(t);const i=s.scrollWidth,r=s.getBoundingClientRect();return s.remove(),{x:0,y:0,w:r.width,h:r.height,scrollWidth:i}});this.editor=t;const e=this.editor.getContainer(),s=document.createElement("div");s.classList.add("tl-text"),s.classList.add("tl-text-measure"),s.tabIndex=-1,e.appendChild(s),this.baseElm=s,t.disposables.add(()=>{s.remove()})}measureElementTextNodeSpans(t,{shouldTruncateToFirstLine:e=!1}={}){const s=[],i=t.getBoundingClientRect(),r=-i.left,o=-i.top,a=new Range,c=t.childNodes[0];let l=0,d=null,h=null,p=0,f=0,S=!1;for(const g of t.childNodes)if(g.nodeType===Node.TEXT_NODE)for(const w of g.textContent??""){a.setStart(c,l),a.setEnd(c,l+w.length);const b=a.getClientRects(),x=b[b.length-1],I=x.top+o,_=x.left+r,T=x.right+r,A=_<f,M=op.test(w);if(M!==h||I!==p||!d){if(d){if(e&&I!==p){S=!0;break}s.push(d)}d={box:{x:_,y:I,w:x.width,h:x.height},text:w},f=_}else A&&(d.box.x=_),d.box.w=A?d.box.w+x.width:T-d.box.x,d.text+=w;w===`
`&&(f=0),h=M,p=I,l+=w.length}return d&&s.push(d),{spans:s,didTruncate:S}}measureTextSpans(t,e){var l;if(t==="")return[];const s=(l=this.baseElm)==null?void 0:l.cloneNode();this.baseElm.insertAdjacentElement("afterend",s);const i=Math.ceil(e.width-e.padding*2);s.setAttribute("dir","auto"),s.style.setProperty("unicode-bidi","plaintext"),s.style.setProperty("width",`${i}px`),s.style.setProperty("height","min-content"),s.style.setProperty("font-size",`${e.fontSize}px`),s.style.setProperty("font-family",e.fontFamily),s.style.setProperty("font-weight",e.fontWeight),s.style.setProperty("line-height",`${e.lineHeight*e.fontSize}px`),s.style.setProperty("text-align",rp[e.textAlign]);const r=e.overflow==="truncate-ellipsis"||e.overflow==="truncate-clip";r&&(s.style.setProperty("overflow-wrap","anywhere"),s.style.setProperty("word-break","break-all"));const o=Mr(t);s.textContent=o;const{spans:a,didTruncate:c}=this.measureElementTextNodeSpans(s,{shouldTruncateToFirstLine:r});if(e.overflow==="truncate-ellipsis"&&c){s.textContent="…";const d=Math.ceil(this.measureElementTextNodeSpans(s).spans[0].box.w);s.style.setProperty("width",`${i-d}px`),s.textContent=o;const h=this.measureElementTextNodeSpans(s,{shouldTruncateToFirstLine:!0}).spans,p=h[h.length-1];return h.push({text:"…",box:{x:Math.min(p.box.x+p.box.w,e.width-e.padding-d),y:p.box.y,w:d,h:p.box.h}}),h}return s.remove(),a}}const Ar=po;class cp{constructor(t){u(this,"cancelRaf");u(this,"isPaused",!0);u(this,"now",0);u(this,"start",()=>{var t;this.isPaused=!1,(t=this.cancelRaf)==null||t.call(this),this.cancelRaf=Ar(this.tick),this.now=Date.now()});u(this,"tick",()=>{if(this.isPaused)return;const t=Date.now(),e=t-this.now;this.now=t,this.updatePointerVelocity(e),this.editor.emit("frame",e),this.editor.emit("tick",e),this.cancelRaf=Ar(this.tick)});u(this,"dispose",()=>{var t;this.isPaused=!0,(t=this.cancelRaf)==null||t.call(this)});u(this,"prevPoint",new m);u(this,"updatePointerVelocity",t=>{const{prevPoint:e,editor:{inputs:{currentScreenPoint:s,pointerVelocity:i}}}=this;if(t===0)return;const r=m.Sub(s,e);this.prevPoint=s.clone();const o=r.len(),a=o?r.div(o):new m(0,0),c=i.clone().lrp(a.mul(o/t),.5);Math.abs(c.x)<.01&&(c.x=0),Math.abs(c.y)<.01&&(c.y=0),i.equals(c)||(this.editor.inputs.pointerVelocity=c)});this.editor=t,this.editor.disposables.add(this.dispose),this.start()}}var lp=Object.defineProperty,dp=Object.getOwnPropertyDescriptor,Ke=(n,t,e,s)=>{for(var i=dp(t,e),r=n.length-1,o;r>=0;r--)(o=n[r])&&(i=o(t,e,i)||i);return i&&lp(t,e,i),i};class Fe{constructor(t,e){u(this,"systemColorScheme",fe("systemColorScheme","light"));u(this,"updateUserPreferences",t=>{this.user.setUserPreferences({...this.user.userPreferences.get(),...t})});if(this.user=t,this.inferDarkMode=e,typeof window>"u"||!("matchMedia"in window))return;const s=window.matchMedia("(prefers-color-scheme: dark)");s!=null&&s.matches&&this.systemColorScheme.set("dark"),s==null||s.addEventListener("change",i=>{i.matches?this.systemColorScheme.set("dark"):this.systemColorScheme.set("light")})}getUserPreferences(){return{id:this.getId(),name:this.getName(),locale:this.getLocale(),color:this.getColor(),animationSpeed:this.getAnimationSpeed(),isSnapMode:this.getIsSnapMode(),colorScheme:this.user.userPreferences.get().colorScheme,isDarkMode:this.getIsDarkMode(),isWrapMode:this.getIsWrapMode(),isDynamicResizeMode:this.getIsDynamicResizeMode()}}getIsDarkMode(){switch(this.user.userPreferences.get().colorScheme){case"dark":return!0;case"light":return!1;case"system":return this.systemColorScheme.get()==="dark";default:return this.inferDarkMode?this.systemColorScheme.get()==="dark":!1}}getEdgeScrollSpeed(){return this.user.userPreferences.get().edgeScrollSpeed??ot.edgeScrollSpeed}getAnimationSpeed(){return this.user.userPreferences.get().animationSpeed??ot.animationSpeed}getId(){return this.user.userPreferences.get().id}getName(){return this.user.userPreferences.get().name??ot.name}getLocale(){return this.user.userPreferences.get().locale??ot.locale}getColor(){return this.user.userPreferences.get().color??ot.color}getIsSnapMode(){return this.user.userPreferences.get().isSnapMode??ot.isSnapMode}getIsWrapMode(){return this.user.userPreferences.get().isWrapMode??ot.isWrapMode}getIsDynamicResizeMode(){return this.user.userPreferences.get().isDynamicSizeMode??ot.isDynamicSizeMode}getIsPasteAtCursorMode(){return this.user.userPreferences.get().isPasteAtCursorMode??ot.isPasteAtCursorMode}}Ke([C],Fe.prototype,"getUserPreferences");Ke([C],Fe.prototype,"getIsDarkMode");Ke([C],Fe.prototype,"getEdgeScrollSpeed");Ke([C],Fe.prototype,"getAnimationSpeed");Ke([C],Fe.prototype,"getId");Ke([C],Fe.prototype,"getName");Ke([C],Fe.prototype,"getLocale");Ke([C],Fe.prototype,"getColor");Ke([C],Fe.prototype,"getIsSnapMode");Ke([C],Fe.prototype,"getIsWrapMode");Ke([C],Fe.prototype,"getIsDynamicResizeMode");Ke([C],Fe.prototype,"getIsPasteAtCursorMode");const hp={wheel:"onWheel",pointer_down:"onPointerDown",pointer_move:"onPointerMove",long_press:"onLongPress",pointer_up:"onPointerUp",right_click:"onRightClick",middle_click:"onMiddleClick",key_down:"onKeyDown",key_up:"onKeyUp",key_repeat:"onKeyRepeat",cancel:"onCancel",complete:"onComplete",interrupt:"onInterrupt",double_click:"onDoubleClick",triple_click:"onTripleClick",quadruple_click:"onQuadrupleClick",tick:"onTick"},up=["brushing","cropping","dragging","dragging_handle","drawing","erasing","lasering","resizing","rotating","scribble_brushing","translating"];class mt{constructor(t,e){u(this,"performanceTracker");u(this,"id");u(this,"type");u(this,"shapeType");u(this,"initial");u(this,"children");u(this,"isLockable");u(this,"parent");u(this,"_path");u(this,"_current");u(this,"_isActive");u(this,"transition",(t,e={})=>{var r;const s=t.split(".");let i=this;for(let o=0;o<s.length;o++){const a=s[o],c=i.getCurrent(),l=(r=i.children)==null?void 0:r[a];if(!l)throw Error(`${i.id} - no child state exists with the id ${a}.`);if((c==null?void 0:c.id)!==l.id&&(c==null||c.exit(e,a),i._current.set(l),l.enter(e,(c==null?void 0:c.id)||"initial"),!l.getIsActive()))break;i=l}return this});u(this,"handleEvent",t=>{var i;const e=hp[t.name],s=this._current.__unsafe__getWithoutCapture();(i=this[e])==null||i.call(this,t),this._isActive.__unsafe__getWithoutCapture()&&s&&s===this._current.__unsafe__getWithoutCapture()&&s.handleEvent(t)});u(this,"enter",(t,e)=>{var s;if(Ce.measurePerformance.get()&&up.includes(this.id)&&this.performanceTracker.start(this.id),this._isActive.set(!0),(s=this.onEnter)==null||s.call(this,t,e),this.children&&this.initial&&this.getIsActive()){const i=this.children[this.initial];this._current.set(i),i.enter(t,e)}});u(this,"exit",(t,e)=>{var s,i;Ce.measurePerformance.get()&&this.performanceTracker.isStarted()&&this.performanceTracker.stop(),this._isActive.set(!1),(s=this.onExit)==null||s.call(this,t,e),this.getIsActive()||(i=this.getCurrent())==null||i.exit(t,e)});u(this,"_currentToolIdMask",fe("curent tool id mask",void 0));u(this,"onWheel");u(this,"onPointerDown");u(this,"onPointerMove");u(this,"onLongPress");u(this,"onPointerUp");u(this,"onDoubleClick");u(this,"onTripleClick");u(this,"onQuadrupleClick");u(this,"onRightClick");u(this,"onMiddleClick");u(this,"onKeyDown");u(this,"onKeyUp");u(this,"onKeyRepeat");u(this,"onCancel");u(this,"onComplete");u(this,"onInterrupt");u(this,"onTick");u(this,"onEnter");u(this,"onExit");this.editor=t;const{id:s,children:i,initial:r,isLockable:o}=this.constructor;this.id=s,this._isActive=fe("toolIsActive"+this.id,!1),this._current=fe("toolState"+this.id,void 0),this._path=C("toolPath"+this.id,()=>{const a=this.getCurrent();return this.id+(a?`.${a.getPath()}`:"")}),this.parent=e??{},this.parent?i&&r?(this.type="branch",this.initial=r,this.children=Object.fromEntries(i().map(a=>[a.id,new a(this.editor,this)])),this._current.set(this.children[this.initial])):this.type="leaf":(this.type="root",i&&r&&(this.initial=r,this.children=Object.fromEntries(i().map(a=>[a.id,new a(this.editor,this)])),this._current.set(this.children[this.initial]))),this.isLockable=o,this.performanceTracker=new qr}getPath(){return this._path.get()}getCurrent(){return this._current.get()}getIsActive(){return this._isActive.get()}getCurrentToolIdMask(){return this._currentToolIdMask.get()}setCurrentToolIdMask(t){this._currentToolIdMask.set(t)}}u(mt,"id"),u(mt,"initial"),u(mt,"children"),u(mt,"isLockable",!0);class Gs extends mt{constructor(){super(...arguments);u(this,"onKeyDown",e=>{var s;switch(e.code){case"KeyZ":{if(!(e.shiftKey||e.ctrlKey)){const i=this.getCurrent();i&&((s=i.getCurrent())==null?void 0:s.id)==="idle"&&this.children.zoom&&this.editor.setCurrentTool("zoom",{...e,onInteractionEnd:i.id})}break}}})}}u(Gs,"id","root"),u(Gs,"initial",""),u(Gs,"children",()=>[]);var pp=Object.defineProperty,fp=Object.getOwnPropertyDescriptor,O=(n,t,e,s)=>{for(var i=fp(t,e),r=n.length-1,o;r>=0;r--)(o=n[r])&&(i=o(t,e,i)||i);return i&&pp(t,e,i),i};class L extends Ra{constructor({store:e,user:s,shapeUtils:i,bindingUtils:r,tools:o,getContainer:a,cameraOptions:c,initialState:l,autoFocus:d,inferDarkMode:h,options:p}){super();u(this,"options");u(this,"store");u(this,"root");u(this,"disposables",new Set);u(this,"isDisposed",!1);u(this,"_tickManager");u(this,"snaps");u(this,"timers");u(this,"user");u(this,"textMeasure");u(this,"environment");u(this,"scribbles");u(this,"sideEffects");u(this,"edgeScrollManager");u(this,"focusManager");u(this,"getContainer");u(this,"shapeUtils");u(this,"styleProps");u(this,"bindingUtils");u(this,"history");u(this,"_shouldIgnoreShapeLock",!1);u(this,"_crashingError",null);u(this,"_updateInstanceState",(e,s)=>{this.run(()=>{this.store.put([{...this.getInstanceState(),...e}])},s)});u(this,"_isChangingStyleTimeout",-1);u(this,"setCursor",e=>(this.updateInstanceState({cursor:{...this.getInstanceState().cursor,...e}}),this));u(this,"_updateCurrentPageState",e=>{this.store.update(e.id??this.getCurrentPageState().id,s=>({...s,...e}))});u(this,"_cameraOptions",fe("camera options",gr));u(this,"_viewportAnimation",null);u(this,"_willSetInitialBounds",!0);u(this,"_isLockedOnFollowingUser",fe("isLockedOnFollowingUser",!1));u(this,"_cameraState",fe("camera state","idle"));u(this,"_cameraStateTimeoutRemaining",0);u(this,"_decayCameraStateTimeout",e=>{this._cameraStateTimeoutRemaining-=e,!(this._cameraStateTimeoutRemaining>0)&&(this.off("tick",this._decayCameraStateTimeout),this._cameraState.set("idle"))});u(this,"_tickCameraState",()=>{this._cameraStateTimeoutRemaining=this.options.cameraMovingTimeoutMs,this._cameraState.__unsafe__getWithoutCapture()==="idle"&&(this._cameraState.set("moving"),this.on("tick",this._decayCameraStateTimeout))});u(this,"_currentPageShapeIds");u(this,"_parentIdsToChildIds");u(this,"animatingShapes",new Map);u(this,"_updateShapes",e=>{this.getInstanceState().isReadonly||this.run(()=>{var o,a;const s=[];let i,r;for(let c=0,l=e.length;c<l;c++){const d=e[c];d&&(i=this.getShape(d.id),i&&(r=qe(i,d),r!==i&&(r=((a=(o=this.getShapeUtil(i)).onBeforeUpdate)==null?void 0:a.call(o,i,r))??r,s.push(r))))}this.store.put(s)})});u(this,"externalAssetContentHandlers",{file:null,url:null});u(this,"externalContentHandlers",{text:null,files:null,embed:null,"svg-text":null,url:null});u(this,"inputs",{originPagePoint:new m,originScreenPoint:new m,previousPagePoint:new m,previousScreenPoint:new m,currentPagePoint:new m,currentScreenPoint:new m,keys:new Set,buttons:new Set,isPen:!1,shiftKey:!1,ctrlKey:!1,altKey:!1,isDragging:!1,isPointing:!1,isPinching:!1,isEditing:!1,isPanning:!1,pointerVelocity:new m});u(this,"_clickManager",new zu(this));u(this,"_prevCursor","default");u(this,"_shiftKeyTimeout",-1);u(this,"_setShiftKeyTimeout",()=>{this.inputs.shiftKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Shift",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"ShiftLeft"})});u(this,"_altKeyTimeout",-1);u(this,"_setAltKeyTimeout",()=>{this.inputs.altKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Alt",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"AltLeft"})});u(this,"_ctrlKeyTimeout",-1);u(this,"_setCtrlKeyTimeout",()=>{this.inputs.ctrlKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Ctrl",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"ControlLeft"})});u(this,"_restoreToolId","select");u(this,"_pinchStart",1);u(this,"_didPinch",!1);u(this,"_selectedShapeIdsAtPointerDown",[]);u(this,"_longPressTimeout",-1);u(this,"capturedPointerId",null);u(this,"performanceTracker");u(this,"performanceTrackerTimeout",-1);u(this,"dispatch",e=>(this._pendingEventsForNextTick.push(e),e.type==="pointer"&&e.name==="pointer_move"||e.type==="wheel"||e.type==="pinch"||this._flushEventsForTick(0),this));u(this,"_pendingEventsForNextTick",[]);u(this,"_flushEventForTick",e=>{if(this.getCrashingError())return this;const{inputs:s}=this,{type:i}=e;if(e.type==="misc"){(e.name==="cancel"||e.name==="complete")&&(this.inputs.isDragging=!1,this.inputs.isPanning&&(this.inputs.isPanning=!1,this.setCursor({type:this._prevCursor,rotation:0}))),this.root.handleEvent(e);return}e.shiftKey?(clearTimeout(this._shiftKeyTimeout),this._shiftKeyTimeout=-1,s.shiftKey=!0):!e.shiftKey&&s.shiftKey&&this._shiftKeyTimeout===-1&&(this._shiftKeyTimeout=this.timers.setTimeout(this._setShiftKeyTimeout,150)),e.altKey?(clearTimeout(this._altKeyTimeout),this._altKeyTimeout=-1,s.altKey=!0):!e.altKey&&s.altKey&&this._altKeyTimeout===-1&&(this._altKeyTimeout=this.timers.setTimeout(this._setAltKeyTimeout,150)),e.ctrlKey?(clearTimeout(this._ctrlKeyTimeout),this._ctrlKeyTimeout=-1,s.ctrlKey=!0):!e.ctrlKey&&s.ctrlKey&&this._ctrlKeyTimeout===-1&&(this._ctrlKeyTimeout=this.timers.setTimeout(this._setCtrlKeyTimeout,150));const{originPagePoint:r,currentPagePoint:o}=s;s.isPointing||(s.isDragging=!1);const a=this.store.unsafeGetWithoutCapture(we),c=this.store.get(this._getCurrentPageStateId()),l=this._cameraOptions.__unsafe__getWithoutCapture();switch(i){case"pinch":{if(l.isLocked)return;switch(clearTimeout(this._longPressTimeout),this._updateInputsFromEvent(e),e.name){case"pinch_start":{if(s.isPinching)return;s.isEditing||(this._pinchStart=this.getCamera().z,this._selectedShapeIdsAtPointerDown.length||(this._selectedShapeIdsAtPointerDown=[...c.selectedShapeIds]),this._didPinch=!0,s.isPinching=!0,this.interrupt());return}case"pinch":{if(!s.isPinching)return;const{point:{z:d=1},delta:{x:h,y:p}}=e,{x:f,y:S}=m.SubXY(e.point,a.screenBounds.x,a.screenBounds.y);this.stopCameraAnimation(),a.followingUserId&&this.stopFollowingUser();const{x:g,y:w,z:b}=Es(()=>this.getCamera()),{panSpeed:x,zoomSpeed:I}=l;this._setCamera(new m(g+h*x/b-f/b+f/(d*I),w+p*x/b-S/b+S/(d*I),d*I),{immediate:!0});return}case"pinch_end":{if(!s.isPinching)return this;s.isPinching=!1;const{_selectedShapeIdsAtPointerDown:d}=this;this.setSelectedShapes(this._selectedShapeIdsAtPointerDown),this._selectedShapeIdsAtPointerDown=[],this._didPinch&&(this._didPinch=!1,d.length>0&&this.once("tick",()=>{this._didPinch||this.setSelectedShapes(d)}));return}}}case"wheel":{if(l.isLocked)return;if(this._updateInputsFromEvent(e),!this.getIsMenuOpen()){const{panSpeed:d,zoomSpeed:h,wheelBehavior:p}=l;if(p!=="none"){this.stopCameraAnimation(),a.followingUserId&&this.stopFollowingUser();const{x:f,y:S,z:g}=Es(()=>this.getCamera()),{x:w,y:b,z:x=0}=e.delta;let I=p;switch(s.ctrlKey&&(I=p==="pan"?"zoom":"pan"),I){case"zoom":{const{x:_,y:T}=this.inputs.currentScreenPoint;let A=x;p==="zoom"&&(Math.abs(b)>10?A=10*Math.sign(b)/100:A=b/100);const M=g+(A??0)*h*g;this._setCamera(new m(f+(_/M-_)-(_/g-_),S+(T/M-T)-(T/g-T),M),{immediate:!0}),this.maybeTrackPerformance("Zooming");return}case"pan":{this._setCamera(new m(f+w*d/g,S+b*d/g,g),{immediate:!0}),this.maybeTrackPerformance("Panning");return}}}}break}case"pointer":{if(s.isPinching)return;this._updateInputsFromEvent(e);const{isPen:d}=e,{isPenMode:h}=a;switch(e.name){case"pointer_down":{if(h&&!d)return;if(this.clearOpenMenus(),this.inputs.isPanning||(this._longPressTimeout=this.timers.setTimeout(()=>{this.dispatch({...e,point:this.inputs.currentScreenPoint,name:"long_press"})},this.options.longPressDurationMs)),this._selectedShapeIdsAtPointerDown=this.getSelectedShapeIds(),e.button===yr&&(this.capturedPointerId=e.pointerId),s.buttons.add(e.button),s.isPointing=!0,s.isDragging=!1,!h&&d&&this.updateInstanceState({isPenMode:!0}),e.button===Sr?(this._restoreToolId=this.getCurrentToolId(),this.complete(),this.setCurrentTool("eraser")):e.button===Rs&&(this.inputs.isPanning||(this._prevCursor=this.getInstanceState().cursor.type),this.inputs.isPanning=!0,clearTimeout(this._longPressTimeout)),this.inputs.isPanning)return this.stopCameraAnimation(),this.setCursor({type:"grabbing",rotation:0}),this;break}case"pointer_move":{if(!d&&h)return;const{x:p,y:f,z:S}=Es(()=>this.getCamera());if(this.inputs.isPanning&&this.inputs.isPointing){const{currentScreenPoint:g,previousScreenPoint:w}=this.inputs,{panSpeed:b}=l,x=m.Sub(g,w);this.setCamera(new m(p+x.x*b/S,f+x.y*b/S,S),{immediate:!0}),this.maybeTrackPerformance("Panning");return}s.isPointing&&!s.isDragging&&m.Dist2(r,o)*this.getZoomLevel()>(a.isCoarsePointer?this.options.coarseDragDistanceSquared:this.options.dragDistanceSquared)/S&&(s.isDragging=!0,clearTimeout(this._longPressTimeout));break}case"pointer_up":{if(s.isDragging=!1,s.isPointing=!1,clearTimeout(this._longPressTimeout),s.buttons.delete(e.button),this.getIsMenuOpen()||a.isPenMode&&!d)return;if(this.capturedPointerId===e.pointerId&&(this.capturedPointerId=null,e.button=0),s.isPanning){s.keys.has("Space")||(s.isPanning=!1);const p=this.inputs.pointerVelocity,f=Math.min(2,p.len());switch(e.button){case yr:{this.setCursor({type:"grab",rotation:0});break}case Rs:this.inputs.keys.has(" ")?this.setCursor({type:"grab",rotation:0}):this.setCursor({type:this._prevCursor,rotation:0})}f>0&&this.slideCamera({speed:f,direction:p})}else e.button===Sr&&(this.complete(),this.setCurrentTool(this._restoreToolId));break}}break}case"keyboard":{switch(e.key==="ShiftRight"&&(e.key="ShiftLeft"),e.key==="AltRight"&&(e.key="AltLeft"),e.code==="ControlRight"&&(e.code="ControlLeft"),e.name){case"key_down":{s.keys.add(e.code),e.code==="Space"&&!e.ctrlKey&&(this.inputs.isPanning||(this._prevCursor=a.cursor.type),this.inputs.isPanning=!0,clearTimeout(this._longPressTimeout),this.setCursor({type:this.inputs.isPointing?"grabbing":"grab",rotation:0}));break}case"key_up":{s.keys.delete(e.code),e.code==="Space"&&(this.inputs.buttons.has(Rs)||(this.inputs.isPanning=!1,this.setCursor({type:this._prevCursor,rotation:0})));break}}break}}if(e.type==="pointer"){e.button===Rs?e.name="middle_click":e.button===Ii&&(e.name="right_click");const{isPenMode:d}=this.store.unsafeGetWithoutCapture(we);if(e.isPen===d){const h=this._clickManager.handlePointerEvent(e);if(e.name!==h.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(h),this.emit("event",h);return}}}return this.root.handleEvent(e),this.emit("event",e),this});this.options={...yu,...p},this.store=e,this.disposables.add(this.store.dispose.bind(this.store)),this.history=new Hu({store:e,annotateError:v=>{this.annotateError(v,{origin:"history.batch",willCrashApp:!0}),this.crash(v)}}),this.snaps=new Pn(this),this.timers=new Sc,this.disposables.add(this.timers.dispose.bind(this.timers)),this._cameraOptions.set({...gr,...c}),this.user=new Fe(s??sa(),h??!1),this.getContainer=a??(()=>document.body),this.textMeasure=new ap(this),this._tickManager=new cp(this);class f extends Gs{}u(f,"initial",l??""),this.root=new f(this),this.root.children={};const S=ua(i),g={},w={},b=new Map;for(const v of S){const E=new v(this);g[v.type]=E;const D=vo(v.props??{});w[v.type]=D;for(const B of D.keys())if(!b.has(B.id))b.set(B.id,B);else if(b.get(B.id)!==B)throw Error(`Multiple style props with id "${B.id}" in use. Style prop IDs must be unique.`)}this.shapeUtils=g,this.styleProps=w;const x=ca(r),I={};for(const v of x){const E=new v(this);I[v.type]=E}this.bindingUtils=I;for(const v of[...o]){if(Qe(this.root.children,v.id))throw Error(`Can't override tool with id "${v.id}"`);this.root.children[v.id]=new v(this,this.root)}this.environment=new Uu(this),this.scribbles=new Xu(this);const _=(v,E)=>{let D=null;const B=v.selectedShapeIds.filter(R=>!E.has(R));B.length!==v.selectedShapeIds.length&&(D||(D={...v}),D.selectedShapeIds=B);const P=v.erasingShapeIds.filter(R=>!E.has(R));P.length!==v.erasingShapeIds.length&&(D||(D={...v}),D.erasingShapeIds=P),v.hoveredShapeId&&E.has(v.hoveredShapeId)&&(D||(D={...v}),D.hoveredShapeId=null),v.editingShapeId&&E.has(v.editingShapeId)&&(D||(D={...v}),D.editingShapeId=null);const j=v.hintingShapeIds.filter(R=>!E.has(R));return j.length!==v.hintingShapeIds.length&&(D||(D={...v}),D.hintingShapeIds=j),v.focusedGroupId&&E.has(v.focusedGroupId)&&(D||(D={...v}),D.focusedGroupId=null),D};this.sideEffects=this.store.sideEffects;let T=new Map;const A=new Set,M=new Set;let F=new Set;if(this.disposables.add(this.sideEffects.registerOperationCompleteHandler(()=>{var v,E,D,B;A.clear();for(const P of M){M.delete(P);const j=this.getShape(P);if(!j)continue;const R=this.getShapeUtil(j),V=(v=R.onChildrenChange)==null?void 0:v.call(R,j);V!=null&&V.length&&this.updateShapes(V)}if(F.size){const P=F;F=new Set;for(const j of P){const R=this.getBindingUtil(j);(E=R.onOperationComplete)==null||E.call(R)}}if(T.size){const P=T;T=new Map;for(const j of P.values())(B=(D=this.getBindingUtil(j.binding)).onAfterDelete)==null||B.call(D,j)}this.emit("update")})),this.disposables.add(this.sideEffects.register({shape:{afterChange:(v,E)=>{var D,B,P,j;for(const R of this.getBindingsInvolvingShape(E))F.add(R.type),R.fromId===E.id&&((B=(D=this.getBindingUtil(R)).onAfterChangeFromShape)==null||B.call(D,{binding:R,shapeBefore:v,shapeAfter:E})),R.toId===E.id&&((j=(P=this.getBindingUtil(R)).onAfterChangeToShape)==null||j.call(P,{binding:R,shapeBefore:v,shapeAfter:E}));if(v.parentId!==E.parentId){const R=V=>{var J,nt,je,Cs;const z=this.getShape(V);if(z)for(const it of this.getBindingsInvolvingShape(z))F.add(it.type),it.fromId===z.id&&((nt=(J=this.getBindingUtil(it)).onAfterChangeFromShape)==null||nt.call(J,{binding:it,shapeBefore:z,shapeAfter:z})),it.toId===z.id&&((Cs=(je=this.getBindingUtil(it)).onAfterChangeToShape)==null||Cs.call(je,{binding:it,shapeBefore:z,shapeAfter:z}))};R(E.id),this.visitDescendants(E.id,R)}if(v.parentId!==E.parentId&&Me(E.parentId)){const R=new Set([v.id]);this.visitDescendants(v.id,V=>{R.add(V)});for(const V of this.getPageStates()){if(V.pageId===E.parentId)continue;const z=_(V,R);z&&this.store.put([z])}}v.parentId&&We(v.parentId)&&M.add(v.parentId),E.parentId!==v.parentId&&We(E.parentId)&&M.add(E.parentId)},beforeDelete:v=>{var P,j,R,V;if(A.has(v.id))return;v.parentId&&We(v.parentId)&&M.add(v.parentId),A.add(v.id);const E=[];for(const z of this.getBindingsInvolvingShape(v)){F.add(z.type),E.push(z.id);const J=this.getBindingUtil(z);z.fromId===v.id?((P=J.onBeforeIsolateToShape)==null||P.call(J,{binding:z,removedShape:v}),(j=J.onBeforeDeleteFromShape)==null||j.call(J,{binding:z,shape:v})):((R=J.onBeforeIsolateFromShape)==null||R.call(J,{binding:z,removedShape:v}),(V=J.onBeforeDeleteToShape)==null||V.call(J,{binding:z,shape:v}))}E.length&&this.deleteBindings(E);const D=new Set([v.id]),B=te(this.getPageStates().map(z=>_(z,D)));B.length&&this.store.put(B)}},binding:{beforeCreate:v=>{var D,B;const E=(B=(D=this.getBindingUtil(v)).onBeforeCreate)==null?void 0:B.call(D,{binding:v});return E||v},afterCreate:v=>{var E,D;F.add(v.type),(D=(E=this.getBindingUtil(v)).onAfterCreate)==null||D.call(E,{binding:v})},beforeChange:(v,E)=>{var B,P;const D=(P=(B=this.getBindingUtil(E)).onBeforeChange)==null?void 0:P.call(B,{bindingBefore:v,bindingAfter:E});return D||E},afterChange:(v,E)=>{var D,B;F.add(E.type),(B=(D=this.getBindingUtil(E)).onAfterChange)==null||B.call(D,{bindingBefore:v,bindingAfter:E})},beforeDelete:v=>{var E,D;(D=(E=this.getBindingUtil(v)).onBeforeDelete)==null||D.call(E,{binding:v})},afterDelete:v=>{var E,D;(D=(E=this.getBindingUtil(v)).onAfterDelete)==null||D.call(E,{binding:v}),F.add(v.type)}},page:{afterCreate:v=>{const E=Ze.createId(v.id),D=Ye.createId(v.id);this.store.has(E)||this.store.put([Ze.create({id:E})]),this.store.has(D)||this.store.put([Ye.create({id:D,pageId:v.id})])},afterDelete:(v,E)=>{var P,j;if(((P=this.getInstanceState())==null?void 0:P.currentPageId)===v.id){const R=(j=this.getPages().find(V=>V.id!==v.id))==null?void 0:j.id;R?this.store.put([{...this.getInstanceState(),currentPageId:R}]):E==="user"&&this.store.ensureStoreIsUsable()}const D=Ze.createId(v.id),B=Ye.createId(v.id);this.store.remove([D,B])}},instance:{afterChange:(v,E,D)=>{var B;if(!this.store.has(E.currentPageId)){const P=this.store.has(v.currentPageId)?v.currentPageId:(B=this.getPages()[0])==null?void 0:B.id;P?this.store.update(E.id,j=>({...j,currentPageId:P})):D==="user"&&this.store.ensureStoreIsUsable()}}},instance_page_state:{afterChange:(v,E)=>{if((v==null?void 0:v.selectedShapeIds)!==(E==null?void 0:E.selectedShapeIds)){const D=E.selectedShapeIds.filter(P=>{var R,V;let j=(R=this.getShape(P))==null?void 0:R.parentId;for(;We(j);){if(E.selectedShapeIds.includes(j))return!1;j=(V=this.getShape(j))==null?void 0:V.parentId}return!0});let B=null;if(D.length>0){const P=this.findCommonAncestor(te(D.map(j=>this.getShape(j))),j=>this.isShapeOfType(j,"group"));P&&(B=P)}else E!=null&&E.focusedGroupId&&(B=E.focusedGroupId);(D.length!==E.selectedShapeIds.length||B!==E.focusedGroupId)&&this.store.put([{...E,selectedShapeIds:D,focusedGroupId:B??null}])}}}})),this._currentPageShapeIds=Ru(this.store,()=>this.getCurrentPageId()),this._parentIdsToChildIds=Du(this.store),this.disposables.add(this.store.listen(v=>{this.emit("change",v)})),this.disposables.add(this.history.dispose),this.run(()=>{this.store.ensureStoreIsUsable(),this._updateCurrentPageState({editingShapeId:null,hoveredShapeId:null,erasingShapeIds:[]})},{history:"ignore"}),l&&this.root.children[l]===void 0)throw Error(`No state found for initialState "${l}".`);this.root.enter(void 0,"initial"),this.edgeScrollManager=new Bu(this),this.focusManager=new Nu(this,d),this.disposables.add(this.focusManager.dispose.bind(this.focusManager)),this.getInstanceState().followingUserId&&this.stopFollowingUser(),this.on("tick",this._flushEventsForTick),this.timers.requestAnimationFrame(()=>{this._tickManager.start()}),this.performanceTracker=new qr}dispose(){this.disposables.forEach(e=>e()),this.disposables.clear(),this.isDisposed=!0}getShapeUtil(e){const s=typeof e=="string"?e:e.type,i=Ee(this.shapeUtils,s);return de(i,`No shape util found for type "${s}"`),i}getBindingUtil(e){const s=typeof e=="string"?e:e.type,i=Ee(this.bindingUtils,s);return de(i,`No binding util found for type "${s}"`),i}undo(){return this._flushEventsForTick(0),this.complete(),this.history.undo(),this}getCanUndo(){return this.history.getNumUndos()>0}redo(){return this._flushEventsForTick(0),this.complete(),this.history.redo(),this}clearHistory(){return this.history.clear(),this}getCanRedo(){return this.history.getNumRedos()>0}mark(e){return this.history.mark(e),this}squashToMark(e){return this.history.squashToMark(e),this}bail(){return this.history.bail(),this}bailToMark(e){return this.history.bailToMark(e),this}run(e,s){const i=this._shouldIgnoreShapeLock;this._shouldIgnoreShapeLock=(s==null?void 0:s.ignoreShapeLock)??i;try{this.history.batch(e,s)}finally{this._shouldIgnoreShapeLock=i}return this}batch(e,s){return this.run(e,s)}annotateError(e,{origin:s,willCrashApp:i,tags:r,extras:o}){const a=this.createErrorAnnotations(s,i);return oi(e,{tags:{...a.tags,...r},extras:{...a.extras,...o}}),i&&this.store.markAsPossiblyCorrupted(),this}createErrorAnnotations(e,s){try{const i=this.getEditingShapeId();return{tags:{origin:e,willCrashApp:s},extras:{activeStateNode:this.root.getPath(),selectedShapes:this.getSelectedShapes(),editingShape:i?this.getShape(i):void 0,inputs:this.inputs}}}catch{return{tags:{origin:e,willCrashApp:s},extras:{}}}}getCrashingError(){return this._crashingError}crash(e){return this._crashingError=e,this.store.markAsPossiblyCorrupted(),this.emit("crash",{error:e}),this}getPath(){return this.root.getPath().split("root.")[1]}isIn(e){const s=e.split(".").reverse();let i=this.root;for(;s.length>0;){const r=s.pop();if(!r)return!0;const o=i.getCurrent();if((o==null?void 0:o.id)===r){if(s.length===0)return!0;i=o;continue}else return!1}return!1}isInAny(...e){return e.some(s=>this.isIn(s))}setCurrentTool(e,s={}){return this.root.transition(e,s),this}getCurrentTool(){return this.root.getCurrent()}getCurrentToolId(){const e=this.getCurrentTool();return e?e.getCurrentToolIdMask()??e.id:""}getStateDescendant(e){var r;const s=e.split(".").reverse();let i=this.root;for(;s.length>0;){const o=s.pop();if(!o)return i;const a=(r=i.children)==null?void 0:r[o];if(!a)return;i=a}return i}getDocumentSettings(){return this.store.get(Vn)}updateDocumentSettings(e){return this.run(()=>{this.store.put([{...this.getDocumentSettings(),...e}])},{history:"ignore"}),this}getInstanceState(){return this.store.get(we)}updateInstanceState(e,s){return this._updateInstanceState(e,{history:"ignore",...s}),e.isChangingStyle!==void 0&&(clearTimeout(this._isChangingStyleTimeout),e.isChangingStyle===!0&&(this._isChangingStyleTimeout=this.timers.setTimeout(()=>{this._updateInstanceState({isChangingStyle:!1},{history:"ignore"})},2e3))),this}getOpenMenus(){return this.getInstanceState().openMenus}addOpenMenu(e){const s=new Set(this.getOpenMenus());return s.has(e)||(s.add(e),this.updateInstanceState({openMenus:[...s]})),this}deleteOpenMenu(e){const s=new Set(this.getOpenMenus());return s.has(e)&&(s.delete(e),this.updateInstanceState({openMenus:[...s]})),this}clearOpenMenus(){return this.getOpenMenus().length&&this.updateInstanceState({openMenus:[]}),this}getIsMenuOpen(){return this.getOpenMenus().length>0}getPageStates(){return this._getPageStatesQuery().get()}_getPageStatesQuery(){return this.store.query.records("instance_page_state")}getCurrentPageState(){return this.store.get(this._getCurrentPageStateId())}_getCurrentPageStateId(){return Ye.createId(this.getCurrentPageId())}updateCurrentPageState(e){return this._updateCurrentPageState(e),this}getSelectedShapeIds(){return this.getCurrentPageState().selectedShapeIds}getSelectedShapes(){const{selectedShapeIds:e}=this.getCurrentPageState();return te(e.map(s=>this.store.get(s)))}setSelectedShapes(e){return this.run(()=>{const s=e.map(o=>typeof o=="string"?o:o.id),{selectedShapeIds:i}=this.getCurrentPageState(),r=new Set(i);if(s.length===r.size&&s.every(o=>r.has(o)))return null;this.store.put([{...this.getCurrentPageState(),selectedShapeIds:s}])},{history:"record-preserveRedoStack"})}isAncestorSelected(e){const s=typeof e=="string"?e:(e==null?void 0:e.id)??null,i=this.getShape(s);if(!i)return!1;const r=this.getSelectedShapeIds();return!!this.findShapeAncestor(i,o=>r.includes(o.id))}select(...e){const s=typeof e[0]=="string"?e:e.map(i=>i.id);return this.setSelectedShapes(s),this}deselect(...e){const s=typeof e[0]=="string"?e:e.map(r=>r.id),i=this.getSelectedShapeIds();return i.length>0&&s.length>0&&this.setSelectedShapes(i.filter(r=>!s.includes(r))),this}selectAll(){const e=this.getSortedChildIdsForParent(this.getCurrentPageId());return e.length<=0?this:(this.setSelectedShapes(this._getUnlockedShapeIds(e)),this)}selectNone(){return this.getSelectedShapeIds().length>0&&this.setSelectedShapes([]),this}getOnlySelectedShapeId(){var e;return((e=this.getOnlySelectedShape())==null?void 0:e.id)??null}getOnlySelectedShape(){const e=this.getSelectedShapes();return e.length===1?e[0]:null}getSelectionPageBounds(){const e=this.getCurrentPageState().selectedShapeIds;return e.length===0?null:H.Common(te(e.map(s=>this.getShapePageBounds(s))))}getSelectionRotation(){const e=this.getSelectedShapeIds();let s=!1,i=0;for(let r=0,o=e.length;r<o;r++){const a=this.getShapePageTransform(e[r]);if(a)if(s){if(a.rotation()!==i)return 0}else s=!0,i=a.rotation()}return i}getSelectionRotatedPageBounds(){const e=this.getSelectedShapeIds();if(e.length===0)return;const s=this.getSelectionRotation();if(s===0)return this.getSelectionPageBounds();if(e.length===1){const r=this.getShapeGeometry(e[0]).bounds.clone(),o=this.getShapePageTransform(e[0]);return r.point=o.applyToPoint(r.point),r}const i=H.FromPoints(this.getSelectedShapeIds().flatMap(r=>{const o=this.getShapePageTransform(r);return o?o.applyToPoints(this.getShapeGeometry(r).bounds.corners):[]}).map(r=>r.rot(-s)));return i.point=i.point.rot(s),i}getSelectionRotatedScreenBounds(){const e=this.getSelectionRotatedPageBounds();if(!e)return;const{x:s,y:i}=this.pageToScreen(e.point),r=this.getZoomLevel();return new H(s,i,e.width*r,e.height*r)}getFocusedGroupId(){return this.getCurrentPageState().focusedGroupId??this.getCurrentPageId()}getFocusedGroup(){const e=this.getFocusedGroupId();return e?this.getShape(e):void 0}setFocusedGroup(e){const s=typeof e=="string"?e:(e==null?void 0:e.id)??null;if(s!==null){const i=this.getShape(s);if(!i)throw Error(`Editor.setFocusedGroup: Shape with id ${s} does not exist`);if(!this.isShapeOfType(i,"group"))throw Error(`Editor.setFocusedGroup: Cannot set focused group to shape of type ${i.type}`)}return s===this.getFocusedGroupId()?this:this.run(()=>{this.store.update(this.getCurrentPageState().id,i=>({...i,focusedGroupId:s}))},{history:"record-preserveRedoStack"})}popFocusedGroupId(){const e=this.getFocusedGroup();if(e){const s=this.findShapeAncestor(e,i=>this.isShapeOfType(i,"group"));this.setFocusedGroup((s==null?void 0:s.id)??null),this.select(e.id)}else this.setFocusedGroup(null),this.selectNone();return this}getEditingShapeId(){return this.getCurrentPageState().editingShapeId}getEditingShape(){const e=this.getEditingShapeId();return e?this.getShape(e):void 0}setEditingShape(e){const s=typeof e=="string"?e:(e==null?void 0:e.id)??null;if(s!==this.getEditingShapeId()){if(s){const i=this.getShape(s);if(i&&this.getShapeUtil(i).canEdit(i))return this.run(()=>{this._updateCurrentPageState({editingShapeId:s})},{history:"ignore"}),this}this.run(()=>{this._updateCurrentPageState({editingShapeId:null})},{history:"ignore"})}return this}getHoveredShapeId(){return this.getCurrentPageState().hoveredShapeId}getHoveredShape(){const e=this.getHoveredShapeId();return e?this.getShape(e):void 0}setHoveredShape(e){const s=typeof e=="string"?e:(e==null?void 0:e.id)??null;return s===this.getHoveredShapeId()?this:(this.run(()=>{this.updateCurrentPageState({hoveredShapeId:s})},{history:"ignore"}),this)}getHintingShapeIds(){return this.getCurrentPageState().hintingShapeIds}getHintingShape(){const e=this.getHintingShapeIds();return te(e.map(s=>this.getShape(s)))}setHintingShapes(e){const s=typeof e[0]=="string"?e:e.map(i=>i.id);return this.run(()=>{this._updateCurrentPageState({hintingShapeIds:ii(s)})},{history:"ignore"}),this}getErasingShapeIds(){return this.getCurrentPageState().erasingShapeIds}getErasingShapes(){const e=this.getErasingShapeIds();return te(e.map(s=>this.getShape(s)))}setErasingShapes(e){const s=typeof e[0]=="string"?e:e.map(r=>r.id);s.sort();const i=this.getErasingShapeIds();return this.run(()=>{if(s.length===i.length){for(let r=0;r<s.length;r++)if(s[r]!==i[r]){this._updateCurrentPageState({erasingShapeIds:s});break}}else this._updateCurrentPageState({erasingShapeIds:s})},{history:"ignore"}),this}getCroppingShapeId(){return this.getCurrentPageState().croppingShapeId}setCroppingShape(e){const s=typeof e=="string"?e:(e==null?void 0:e.id)??null;return s!==this.getCroppingShapeId()&&this.run(()=>{if(!s)this.updateCurrentPageState({croppingShapeId:null});else{const i=this.getShape(s),r=this.getShapeUtil(i);i&&r.canCrop(i)&&this.updateCurrentPageState({croppingShapeId:s})}},{history:"ignore"}),this}_unsafe_getCameraId(){return Ze.createId(this.getCurrentPageId())}getCamera(){const e=this.store.get(this._unsafe_getCameraId());if(this._isLockedOnFollowingUser.get()){const s=this.getCameraForFollowing();if(s)return{...e,...s}}return e}getViewportPageBoundsForFollowing(){const e=this.getInstanceState().followingUserId;if(!e)return null;const s=this.getCollaborators().find(p=>p.userId===e);if(!s)return null;const{w:i,h:r}=s.screenBounds,{x:o,y:a,z:c}=s.camera,l=new H(-o,-a,i/c,r/c),d=this.getViewportScreenBounds().clone(),h=d.width/d.height;return d.width=l.width,d.height=d.width/h,d.height<l.height&&(d.height=l.height,d.width=d.height*h),d.center=l.center,d}getCameraForFollowing(){const e=this.getViewportPageBoundsForFollowing();return e?{x:-e.x,y:-e.y,z:this.getViewportScreenBounds().w/e.width}:null}getZoomLevel(){return this.getCamera().z}getInitialZoom(){const e=this.getCameraOptions();if(!e.constraints||e.constraints.initialZoom==="default")return 1;const{zx:s,zy:i}=Rr(this,e);switch(e.constraints.initialZoom){case"fit-min":return Math.max(s,i);case"fit-max":return Math.min(s,i);case"fit-x":return s;case"fit-y":return i;case"fit-min-100":return Math.min(1,Math.max(s,i));case"fit-max-100":return Math.min(1,Math.min(s,i));case"fit-x-100":return Math.min(1,s);case"fit-y-100":return Math.min(1,i);default:throw Ve(e.constraints.initialZoom)}}getBaseZoom(){const e=this.getCameraOptions();if(!e.constraints||e.constraints.baseZoom==="default")return 1;const{zx:s,zy:i}=Rr(this,e);switch(e.constraints.baseZoom){case"fit-min":return Math.max(s,i);case"fit-max":return Math.min(s,i);case"fit-x":return s;case"fit-y":return i;case"fit-min-100":return Math.min(1,Math.max(s,i));case"fit-max-100":return Math.min(1,Math.min(s,i));case"fit-x-100":return Math.min(1,s);case"fit-y-100":return Math.min(1,i);default:throw Ve(e.constraints.baseZoom)}}getCameraOptions(){return this._cameraOptions.get()}setCameraOptions(e){var i;const s=ue({...this._cameraOptions.__unsafe__getWithoutCapture(),...e});return((i=s.zoomSteps)==null?void 0:i.length)<1&&(s.zoomSteps=[1]),this._cameraOptions.set(s),this}getConstrainedCamera(e,s){const i=this.getCamera();let{x:r,y:o,z:a=i.z}=e;if(!(s!=null&&s.force)){const c=this.getCameraOptions(),l=c.zoomSteps[0],d=Cn(c.zoomSteps),h=this.getViewportScreenBounds();if(c.constraints){const{constraints:p}=c,f=Math.min(p.padding.y,h.w/2),S=Math.min(p.padding.x,h.h/2),g=H.From(c.constraints.bounds),w=(h.w-S*2)/g.w,b=(h.h-f*2)/g.h,x=this.getBaseZoom(),I=d*x,_=l*x;if(s!=null&&s.reset&&(a=this.getInitialZoom()),a<_||a>I){const{x:P,y:j,z:R}=i,V=-P+h.w/R/2,z=-j+h.h/R/2;a=ve(a,_,I);const J=-P+h.w/a/2,nt=-j+h.h/a/2;r=P+J-V,o=j+nt-z}const T=S/a-g.x,A=f/a-g.y,M=(h.w-S*2)/a-g.w,F=(h.h-f*2)/a-g.h,v=T+M*p.origin.x,E=A+F*p.origin.y,D=typeof p.behavior=="string"?p.behavior:p.behavior.x,B=typeof p.behavior=="string"?p.behavior:p.behavior.y;if(s!=null&&s.reset)r=v,o=E;else{switch(D){case"fixed":{r=v;break}case"contain":{a<w?r=v:r=ve(r,T+M,T);break}case"inside":{a<w?r=ve(r,T,(h.w-S)/a-g.w):r=ve(r,T+M,T);break}case"outside":{r=ve(r,S/a-g.w,(h.w-S)/a);break}case"free":break;default:throw Ve(D)}switch(B){case"fixed":{o=E;break}case"contain":{a<b?o=E:o=ve(o,A+F,A);break}case"inside":{a<b?o=ve(o,A,(h.h-f)/a-g.h):o=ve(o,A+F,A);break}case"outside":{o=ve(o,f/a-g.h,(h.h-f)/a);break}case"free":break;default:throw Ve(B)}}}else if(a>d||a<l){const{x:p,y:f,z:S}=i;a=ve(a,l,d),r=p+(-p+h.w/a/2)-(-p+h.w/S/2),o=f+(-f+h.h/a/2)-(-f+h.h/S/2)}}return{x:r,y:o,z:a}}_setCamera(e,s){const i=this.getCamera(),{x:r,y:o,z:a}=this.getConstrainedCamera(e,s);return i.x===r&&i.y===o&&i.z===a?this:(ut(()=>{const c={...i,x:r,y:o,z:a};this.run(()=>{this.store.put([c])},{history:"ignore"});const{currentScreenPoint:l,currentPagePoint:d}=this.inputs,{screenBounds:h}=this.store.unsafeGetWithoutCapture(we);if(l.x/a-r!==d.x||l.y/a-o!==d.y){const p={type:"pointer",target:"canvas",name:"pointer_move",point:m.AddXY(l,h.x,h.y),pointerId:mr.CAMERA_MOVE,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,shiftKey:this.inputs.shiftKey,button:0,isPen:this.getInstanceState().isPenMode??!1};s!=null&&s.immediate?this._flushEventForTick(p):this.dispatch(p)}this._tickCameraState()}),this)}setCamera(e,s){const{isLocked:i}=this._cameraOptions.__unsafe__getWithoutCapture();if(i&&!(s!=null&&s.force))return this;this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser();const r=m.Cast(e);Number.isFinite(r.x)||(r.x=0),Number.isFinite(r.y)||(r.y=0),(r.z===void 0||!Number.isFinite(r.z))&&(e.z=this.getZoomLevel());const o=this.getConstrainedCamera(r,s);if(s!=null&&s.animation){const{width:a,height:c}=this.getViewportScreenBounds();this._animateToViewport(new H(-o.x,-o.y,a/o.z,c/o.z),s)}else this._setCamera(o,{...s,force:!0});return this}centerOnPoint(e,s){const{isLocked:i}=this.getCameraOptions();if(i&&!(s!=null&&s.force))return this;const{width:r,height:o}=this.getViewportPageBounds();return this.setCamera(new m(-(e.x-r/2),-(e.y-o/2),this.getCamera().z),s),this}zoomToFit(e){const s=[...this.getCurrentPageShapeIds()];if(s.length<=0)return this;const i=H.Common(te(s.map(r=>this.getShapePageBounds(r))));return this.zoomToBounds(i,e),this}resetZoom(e=this.getViewportScreenCenter(),s){const{isLocked:i,constraints:r}=this.getCameraOptions();if(i&&!(s!=null&&s.force))return this;const o=this.getCamera(),{x:a,y:c,z:l}=o,{x:d,y:h}=e;let p=1;if(r){const f=this.getInitialZoom();l!==f&&(p=f)}return this.setCamera(new m(a+(d/p-d)-(d/l-d),c+(h/p-h)-(h/l-h),p),s),this}zoomIn(e=this.getViewportScreenCenter(),s){const{isLocked:i}=this.getCameraOptions();if(i&&!(s!=null&&s.force))return this;const{x:r,y:o,z:a}=this.getCamera(),{zoomSteps:c}=this.getCameraOptions();if(c!==null&&c.length>1){const l=this.getBaseZoom();let d=Cn(c)*l;for(let h=1;h<c.length;h++){const p=c[h-1]*l,f=c[h]*l;if(!(f-a<=(f-p)/2)){d=f;break}}this.setCamera(new m(r+(e.x/d-e.x)-(e.x/a-e.x),o+(e.y/d-e.y)-(e.y/a-e.y),d),s)}return this}zoomOut(e=this.getViewportScreenCenter(),s){const{isLocked:i}=this.getCameraOptions();if(i&&!(s!=null&&s.force))return this;const{zoomSteps:r}=this.getCameraOptions();if(r!==null&&r.length>1){const o=this.getBaseZoom(),{x:a,y:c,z:l}=this.getCamera();let d=r[0]*o;for(let h=r.length-1;h>0;h--){const p=r[h-1]*o,f=r[h]*o;if(!(f-l>=(f-p)/2)){d=p;break}}this.setCamera(new m(a+(e.x/d-e.x)-(e.x/l-e.x),c+(e.y/d-e.y)-(e.y/l-e.y),d),s)}return this}zoomToSelection(e){const{isLocked:s}=this.getCameraOptions();if(s&&!(e!=null&&e.force))return this;const i=this.getSelectionPageBounds();return i&&this.zoomToBounds(i,{targetZoom:Math.max(1,this.getZoomLevel()),...e}),this}zoomToBounds(e,s){const i=this._cameraOptions.__unsafe__getWithoutCapture();if(i.isLocked&&!(s!=null&&s.force))return this;const r=this.getViewportScreenBounds(),o=(s==null?void 0:s.inset)??Math.min(Od,r.width*.28),a=this.getBaseZoom(),c=i.zoomSteps[0],l=Cn(i.zoomSteps);let d=ve(Math.min((r.width-o)/e.w,(r.height-o)/e.h),c*a,l*a);return(s==null?void 0:s.targetZoom)!==void 0&&(d=Math.min(s.targetZoom,d)),this.setCamera(new m(-e.x+(r.width-e.w*d)/2/d,-e.y+(r.height-e.h*d)/2/d,d),s),this}stopCameraAnimation(){return this.emit("stop-camera-animation"),this}_animateViewport(e){if(!this._viewportAnimation)return;this._viewportAnimation.elapsed+=e;const{elapsed:s,easing:i,duration:r,start:o,end:a}=this._viewportAnimation;if(s>r){this.off("tick",this._animateViewport),this._viewportAnimation=null,this._setCamera(new m(-a.x,-a.y,this.getViewportScreenBounds().width/a.width));return}const c=r-s,l=i(1-c/r),d=o.minX+(a.minX-o.minX)*l,h=o.minY+(a.minY-o.minY)*l,p=o.maxX+(a.maxX-o.maxX)*l;this._setCamera(new m(-d,-h,this.getViewportScreenBounds().width/(p-d)),{force:!0})}_animateToViewport(e,s={animation:Dn}){const{animation:i,...r}=s;if(!i)return;const{duration:o=0,easing:a=ws.easeInOutCubic}=i,c=this.user.getAnimationSpeed(),l=this.getViewportPageBounds();return this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),o===0||c===0?this._setCamera(new m(-e.x,-e.y,this.getViewportScreenBounds().width/e.width),{...r}):(this._viewportAnimation={elapsed:0,duration:o/c,easing:a,start:l.clone(),end:e.clone()},this.once("stop-camera-animation",()=>{this.off("tick",this._animateViewport),this._viewportAnimation=null}),this.on("tick",this._animateViewport),this)}slideCamera(e={}){const{isLocked:s}=this.getCameraOptions();if(s&&!(e!=null&&e.force))return this;if(this.user.getAnimationSpeed()===0)return this;this.stopCameraAnimation();const{speed:r,friction:o=this.options.cameraSlideFriction,direction:a,speedThreshold:c=.01}=e;let l=Math.min(r,1);const d=()=>{this.off("tick",h),this.off("stop-camera-animation",d)};this.once("stop-camera-animation",d);const h=p=>{const{x:f,y:S,z:g}=this.getCamera(),w=m.Mul(a,l*p/g);l*=1-o,l<c?d():this._setCamera(new m(f+w.x,S+w.y,g))};return this.on("tick",h),this}zoomToUser(e,s={animation:{duration:500}}){const i=this.getCollaborators().find(r=>r.userId===e);return i?(this.run(()=>{this.getInstanceState().followingUserId!==null&&this.stopFollowingUser();const r=i.currentPageId===this.getCurrentPageId();r||this.setCurrentPage(i.currentPageId),s&&s.animation&&!r&&(s.animation=void 0),this.centerOnPoint(i.cursor,s);const{highlightedUserIds:o}=this.getInstanceState();this.updateInstanceState({highlightedUserIds:[...o,e]}),this.timers.setTimeout(()=>{const a=[...this.getInstanceState().highlightedUserIds],c=a.indexOf(e);c<0||(a.splice(c,1),this.updateInstanceState({highlightedUserIds:a}))},this.options.collaboratorIdleTimeoutMs)}),this):this}updateViewportScreenBounds(e,s=!1){e.width=Math.max(e.width,1),e.height=Math.max(e.height,1);const i=[e.minY!==0,!Hs(document.body.scrollWidth,e.maxX,1),!Hs(document.body.scrollHeight,e.maxY,1),e.minX!==0],{screenBounds:r,insets:o}=this.getInstanceState();if(e.equals(r)&&i.every((c,l)=>c===o[l]))return this;const{_willSetInitialBounds:a}=this;if(this._willSetInitialBounds=!1,a)this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this.setCamera(this.getCamera());else if(s&&!this.getInstanceState().followingUserId){const c=this.getViewportPageBounds().center;this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this.centerOnPoint(c)}else this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this._setCamera(m.From({...this.getCamera()}));return this._tickCameraState(),this}getViewportScreenBounds(){const{x:e,y:s,w:i,h:r}=this.getInstanceState().screenBounds;return new H(e,s,i,r)}getViewportScreenCenter(){const e=this.getViewportScreenBounds();return new m(e.midX-e.minX,e.midY-e.minY)}getViewportPageBounds(){const{w:e,h:s}=this.getViewportScreenBounds(),{x:i,y:r,z:o}=this.getCamera();return new H(-i,-r,e/o,s/o)}screenToPage(e){const{screenBounds:s}=this.store.unsafeGetWithoutCapture(we),{x:i,y:r,z:o=1}=this.getCamera();return new m((e.x-s.x)/o-i,(e.y-s.y)/o-r,e.z??.5)}pageToScreen(e){const{screenBounds:s}=this.store.unsafeGetWithoutCapture(we),{x:i,y:r,z:o=1}=this.getCamera();return new m((e.x+i)*o+s.x,(e.y+r)*o+s.y,e.z??.5)}pageToViewport(e){const{x:s,y:i,z:r=1}=this.getCamera();return new m((e.x+s)*r,(e.y+i)*r,e.z??.5)}_getCollaboratorsQuery(){return this.store.query.records("instance_presence",()=>({userId:{neq:this.user.getId()}}))}getCollaborators(){const e=this._getCollaboratorsQuery().get();return e.length?[...new Set(e.map(i=>i.userId))].sort().map(i=>e.filter(o=>o.userId===i).sort((o,a)=>a.lastActivityTimestamp-o.lastActivityTimestamp)[0]):ht}getCollaboratorsOnCurrentPage(){const e=this.getCurrentPageId();return this.getCollaborators().filter(s=>s.currentPageId===e)}startFollowingUser(e){this.stopFollowingUser();const s=this._getCollaboratorsQuery().get().filter(o=>o.userId===e);if(!s.length)return console.warn("User not found"),this;const i=this.user.getId();if(i||console.warn("You should set the userId for the current instance before following a user"),s.some(o=>o.followingUserId===i))return this;const r=C("latestLeaderPresence",()=>this.getCollaborators().find(o=>o.userId===e));return ut(()=>{this.updateInstanceState({followingUserId:e},{history:"ignore"});const o=xs("update current page",()=>{const l=r.get();if(!l){this.stopFollowingUser();return}l.currentPageId!==this.getCurrentPageId()&&this.getPage(l.currentPageId)&&this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:l.currentPageId}]),this._isLockedOnFollowingUser.set(!0)},{history:"ignore"})}),a=()=>{o(),this._isLockedOnFollowingUser.set(!1),this.off("frame",c),this.off("stop-following",a)},c=()=>{if(!r.get()){this.stopFollowingUser();return}if(this._isLockedOnFollowingUser.get())return;const d=this.user.getAnimationSpeed();if(d===0){this._isLockedOnFollowingUser.set(!0);return}const h=this.getViewportPageBoundsForFollowing();if(!h){this.stopFollowingUser();return}const p=this.getViewportPageBounds(),f=Math.abs(h.minX-p.minX)+Math.abs(h.maxX-p.maxX),S=Math.abs(h.minY-p.minY)+Math.abs(h.maxY-p.maxY);if(f<this.options.followChaseViewportSnap&&S<this.options.followChaseViewportSnap){this._isLockedOnFollowingUser.set(!0);return}const g=ve(d*.5,.1,.8),w=new H(zt(p.minX,h.minX,g),zt(p.minY,h.minY,g),zt(p.width,h.width,g),zt(p.height,h.height,g)),b=new m(-w.x,-w.y,this.getViewportScreenBounds().width/w.width);this.stopCameraAnimation(),this._setCamera(b)};this.once("stop-following",a),this.addListener("frame",c),c()}),this}stopFollowingUser(){return this.run(()=>{this.store.put([this.getCamera()]),this._isLockedOnFollowingUser.set(!1),this.updateInstanceState({followingUserId:null}),this.emit("stop-following")},{history:"ignore"}),this}getUnorderedRenderingShapes(e){const s=[];let i=this.options.maxShapesPerPage*2,r=this.options.maxShapesPerPage;const o=this.getErasingShapeIds(),a=(l,d,h)=>{const p=this.getShape(l);if(!p)return;d*=p.opacity;let f=!1;const S=this.getShapeUtil(p);e&&(f=!h&&o.includes(l),f&&(d*=.32)),s.push({id:l,shape:p,util:S,index:i,backgroundIndex:r,opacity:d}),i+=1,r+=1;const g=this.getSortedChildIdsForParent(l);if(!g.length)return;let w=null;S.providesBackgroundForChildren(p)&&(w=r,r=i,i+=this.options.maxShapesPerPage);for(const b of g)a(b,d,h||f);w!==null&&(r=w)},c=e?[this.getCurrentPage()]:this.getPages();for(const l of c)for(const d of this.getSortedChildIdsForParent(l.id))a(d,1,!1);return s}getCameraState(){return this._cameraState.get()}getRenderingShapes(){return this.getUnorderedRenderingShapes(!0).sort(pc)}_getAllPagesQuery(){return this.store.query.records("page")}getPages(){return this._getAllPagesQuery().get().sort(Ue)}getCurrentPage(){return this.getPage(this.getCurrentPageId())}getCurrentPageId(){return this.getInstanceState().currentPageId}getPage(e){return this.store.get(typeof e=="string"?e:e.id)}getCurrentPageShapeIds(){return this._currentPageShapeIds.get()}getCurrentPageShapeIdsSorted(){return Array.from(this.getCurrentPageShapeIds()).sort()}getPageShapeIds(e){const s=typeof e=="string"?e:e.id,i=this.store.query.exec("shape",{parentId:{eq:s}});return this.getShapeAndDescendantIds(i.map(r=>r.id))}setCurrentPage(e){const s=typeof e=="string"?e:e.id;return this.store.has(s)?(this.stopFollowingUser(),this.complete(),this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:s}])},{history:"record-preserveRedoStack"})):(console.error("Tried to set the current page id to a page that doesn't exist."),this)}updatePage(e){return this.getInstanceState().isReadonly?this:this.getPage(e.id)?this.run(()=>this.store.update(e.id,i=>({...i,...e}))):this}createPage(e){return this.run(()=>{if(this.getInstanceState().isReadonly||this.getPages().length>=this.options.maxPages)return;const s=this.getPages(),i=Iu(e.name??"Page 1",s.map(a=>a.name));let r=e.index;(!r||s.some(a=>a.index===r))&&(r=qt(s[s.length-1].index));const o=ys.create({meta:{},...e,name:i,index:r});this.store.put([o])}),this}deletePage(e){const s=typeof e=="string"?e:e.id;return this.run(()=>{if(this.getInstanceState().isReadonly)return;const i=this.getPages();if(i.length===1)return;const r=this.getPage(s);if(r){if(s===this.getCurrentPageId()){const o=i.findIndex(c=>c.id===s),a=i[o-1]??i[o+1];this.setCurrentPage(a.id)}this.store.remove([r.id])}}),this}duplicatePage(e,s=ys.createId()){if(this.getPages().length>=this.options.maxPages)return this;const i=typeof e=="string"?e:e.id,r=this.getPage(i);if(!r)return this;const o={...this.getCamera()},a=this.getContentFromCurrentPage(this.getSortedChildIdsForParent(r.id));return this.run(()=>{var d;const c=this.getPages(),l=Gi(r.index,(d=c[c.indexOf(r)+1])==null?void 0:d.index);if(this.createPage({name:r.name+" Copy",id:s,index:l}),this.setCurrentPage(s),this.setCamera(o),a)return this.putContentOntoCurrentPage(a)}),this}renamePage(e,s){const i=typeof e=="string"?e:e.id;return this.getInstanceState().isReadonly?this:(this.updatePage({id:i,name:s}),this)}_getAllAssetsQuery(){return this.store.query.records("asset")}getAssets(){return this._getAllAssetsQuery().get()}createAssets(e){return this.getInstanceState().isReadonly?this:e.length<=0?this:(this.run(()=>this.store.put(e),{history:"ignore"}),this)}updateAssets(e){return this.getInstanceState().isReadonly?this:e.length<=0?this:(this.run(()=>{this.store.put(e.map(s=>({...this.store.get(s.id),...s})))},{history:"ignore"}),this)}deleteAssets(e){if(this.getInstanceState().isReadonly)return this;const s=typeof e[0]=="string"?e:e.map(i=>i.id);return s.length<=0?this:(this.run(()=>this.store.remove(s),{history:"ignore"}),this)}getAsset(e){return this.store.get(typeof e=="string"?e:e.id)}async resolveAssetUrl(e,s){if(!e)return null;const i=this.getAsset(e);if(!i)return null;const{screenScale:r=1,shouldResolveToOriginal:o=!1}=s,c=Math.max(.125,(h=>Math.pow(2,Math.ceil(Math.log2(h))))(r)),l="connection"in navigator?navigator.connection.effectiveType:null,d=this.getInstanceState().devicePixelRatio;return await this.store.props.assets.resolve(i,{screenScale:r||1,steppedScreenScale:c,dpr:d,networkEffectiveType:l,shouldResolveToOriginal:o})}async uploadAsset(e,s){return await this.store.props.assets.upload(e,s)}_getShapeGeometryCache(){return this.store.createComputedCache("bounds",e=>this.getShapeUtil(e).getGeometry(e),(e,s)=>e.props===s.props)}getShapeGeometry(e){return this._getShapeGeometryCache().get(typeof e=="string"?e:e.id)}_getShapeHandlesCache(){return this.store.createComputedCache("handles",e=>{var s,i;return(i=(s=this.getShapeUtil(e)).getHandles)==null?void 0:i.call(s,e)})}getShapeHandles(e){return this._getShapeHandlesCache().get(typeof e=="string"?e:e.id)}getShapeLocalTransform(e){const s=typeof e=="string"?e:e.id,i=this.getShape(s);if(!i)throw Error("Editor.getTransform: shape not found");return ie.Identity().translate(i.x,i.y).rotate(i.rotation)}_getShapePageTransformCache(){return this.store.createComputedCache("pageTransformCache",e=>{if(Me(e.parentId))return this.getShapeLocalTransform(e);const s=this._getShapePageTransformCache().get(e.parentId)??ie.Identity();return ie.Compose(s,this.getShapeLocalTransform(e))})}getShapeParentTransform(e){const s=typeof e=="string"?e:e.id,i=this.getShape(s);return!i||Me(i.parentId)?ie.Identity():this._getShapePageTransformCache().get(i.parentId)??ie.Identity()}getShapePageTransform(e){const s=typeof e=="string"?e:e.id;return this._getShapePageTransformCache().get(s)??ie.Identity()}_getShapePageBoundsCache(){return this.store.createComputedCache("pageBoundsCache",e=>{const s=this._getShapePageTransformCache().get(e.id);return s?H.FromPoints(ie.applyToPoints(s,this.getShapeGeometry(e).vertices)):new H})}getShapePageBounds(e){return this._getShapePageBoundsCache().get(typeof e=="string"?e:e.id)}_getShapeClipPathCache(){return this.store.createComputedCache("clipPathCache",e=>{const s=this._getShapeMaskCache().get(e.id);if(!s)return;if(s.length===0)return"polygon(0px 0px, 0px 0px, 0px 0px)";const i=this._getShapePageTransformCache().get(e.id);return i?`polygon(${ie.applyToPoints(ie.Inverse(i),s).map(o=>`${o.x}px ${o.y}px`).join(",")})`:void 0})}getShapeClipPath(e){return this._getShapeClipPathCache().get(typeof e=="string"?e:e.id)}_getShapeMaskCache(){return this.store.createComputedCache("pageMaskCache",e=>{if(Me(e.parentId))return;const s=this.getShapeAncestors(e.id).filter(r=>this.isShapeOfType(r,"frame"));return s.length===0?void 0:s.map(r=>this._getShapePageTransformCache().get(r.id).applyToPoints(this.getShapeGeometry(r).vertices)).reduce((r,o)=>{if(!(o&&r))return;const a=Cr(r,o);return a?a.map(m.Cast):[]})})}getShapeMask(e){return this._getShapeMaskCache().get(typeof e=="string"?e:e.id)}getShapeMaskedPageBounds(e){return typeof e!="string"&&(e=e.id),this._getShapeMaskedPageBoundsCache().get(e)}_getShapeMaskedPageBoundsCache(){return this.store.createComputedCache("shapeMaskedPageBoundsCache",e=>{const s=this._getShapePageBoundsCache().get(e.id);if(!s)return;const i=this._getShapeMaskCache().get(e.id);if(i){if(i.length===0)return;const{corners:r}=s;if(r.every((a,c)=>a&&m.Equals(a,i[c])))return s.clone();const o=Cr(i,r);return o?H.FromPoints(o):void 0}return s})}getShapeAncestors(e,s=[]){const i=typeof e=="string"?e:e.id,r=this.getShape(i);if(!r)return s;const o=r.parentId;if(Me(o))return s.reverse(),s;const a=this.store.get(o);return a?(s.push(a),this.getShapeAncestors(a,s)):s}findShapeAncestor(e,s){const i=typeof e=="string"?e:e.id,r=this.getShape(i);if(!r)return;const o=r.parentId;if(Me(o))return;const a=this.getShape(o);if(a)return s(a)?a:this.findShapeAncestor(a,s)}hasAncestor(e,s){const i=typeof e=="string"?e:e==null?void 0:e.id,r=i&&this.getShape(i);return r?r.parentId===s?!0:this.hasAncestor(this.getShapeParent(r),s):!1}findCommonAncestor(e,s){var l;if(e.length===0)return;const i=typeof e[0]=="string"?e:e.map(d=>d.id),r=te(i.map(d=>this.getShape(d)));if(r.length===1){const d=r[0].parentId;return Me(d)?void 0:s?(l=this.findShapeAncestor(r[0],s))==null?void 0:l.id:d}const[o,...a]=r;let c=this.getShapeParent(o);for(;c;){if(s&&!s(c)){c=this.getShapeParent(c);continue}if(a.every(d=>this.hasAncestor(d,c.id)))return c.id;c=this.getShapeParent(c)}}isShapeOrAncestorLocked(e){const s=typeof e=="string"?this.getShape(e):e;return s===void 0?!1:s.isLocked?!0:this.isShapeOrAncestorLocked(this.getShapeParent(s))}_notVisibleShapes(){return Au(this)}getCulledShapes(){const e=this._notVisibleShapes().get(),s=this.getSelectedShapeIds(),i=this.getEditingShapeId(),r=new Set(e);return i&&r.delete(i),s.forEach(o=>{r.delete(o)}),r}getCurrentPageBounds(){let e;return this.getCurrentPageShapeIdsSorted().forEach(s=>{const i=this.getShapeMaskedPageBounds(s);i&&(e?e=e.expand(i):e=i.clone())}),e}getSelectedShapeAtPoint(e){const s=this.getSelectedShapeIds();return this.getCurrentPageShapesSorted().filter(i=>i.type!=="group"&&s.includes(i.id)).reverse().find(i=>this.isPointInShape(i,e,{hitInside:!0,margin:0}))}getShapeAtPoint(e,s={}){const i=this.getZoomLevel(),r=this.getViewportPageBounds(),{filter:o,margin:a=0,hitLocked:c=!1,hitLabels:l=!1,hitInside:d=!1,hitFrameInside:h=!1}=s;let p=1/0,f=null,S=1/0,g=null;const w=(s.renderingOnly?this.getCurrentPageRenderingShapesSorted():this.getCurrentPageShapesSorted()).filter(b=>{if(b.isLocked&&!c||this.isShapeOfType(b,"group"))return!1;const x=this.getShapeMask(b);return x&&!_t(e,x)?!1:o?o(b):!0});for(let b=w.length-1;b>=0;b--){const x=w[b],I=this.getShapeGeometry(x),_=I instanceof Ci,T=this.getPointInShapeSpace(x,e);if((this.isShapeOfType(x,"arrow")||this.isShapeOfType(x,"geo")&&x.props.fill==="none")&&x.props.text.trim()){for(const M of I.children)if(M.isLabel&&M.isPointInBounds(T))return x}if(this.isShapeOfType(x,"frame")){const M=I.distanceToPoint(T,d);if(Math.abs(M)<=a)return g||x;if(I.hitTestPoint(T,0,!0))return g||f||(h?x:void 0);continue}let A;if(_){let M=1/0;for(const F of I.children){if(F.isLabel&&!l)continue;const v=F.distanceToPoint(T,d);v<M&&(M=v)}A=M}else a===0&&(I.bounds.w<1||I.bounds.h<1)||I.bounds.containsPoint(T,a)?A=I.distanceToPoint(T,d):A=1/0;if(I.isClosed){if(A<=a){if(I.isFilled||_&&I.children[0].isFilled)return g||x;if(this.getShapePageBounds(x).contains(r))continue;if(Math.abs(A)<a)Math.abs(A)<S&&(S=Math.abs(A),g=x);else if(!g){const{area:M}=I;M<p&&(p=M,f=x)}}}else if(A<this.options.hitTestMargin/i)return x}return g||f||void 0}getShapesAtPoint(e,s={}){return this.getCurrentPageShapes().filter(i=>this.isPointInShape(i,e,s))}isPointInShape(e,s,i={}){const{hitInside:r=!1,margin:o=0}=i,a=typeof e=="string"?e:e.id,c=this.getShapeMask(a);return c&&!_t(s,c)?!1:this.getShapeGeometry(a).hitTestPoint(this.getPointInShapeSpace(e,s),o,r)}getPointInShapeSpace(e,s){const i=typeof e=="string"?e:e.id;return this._getShapePageTransformCache().get(i).clone().invert().applyToPoint(s)}getPointInParentSpace(e,s){const i=typeof e=="string"?e:e.id,r=this.getShape(i);if(!r)return new m(0,0);if(Me(r.parentId))return m.From(s);const o=this.getShapePageTransform(r.parentId);return o?o.clone().invert().applyToPoint(s):m.From(s)}getCurrentPageShapes(){return Array.from(this.getCurrentPageShapeIds(),e=>this.store.get(e))}getCurrentPageShapesSorted(){const e=[],s=this.getSortedChildIdsForParent(this.getCurrentPageId());for(let i=0,r=s.length;i<r;i++)ga(this,s[i],e);return e}getCurrentPageRenderingShapesSorted(){const e=this.getCulledShapes();return this.getCurrentPageShapesSorted().filter(({id:s})=>!e.has(s))}isShapeOfType(e,s){const i=typeof e=="string"?this.getShape(e):e;return i?i.type===s:!1}getShape(e){const s=typeof e=="string"?e:e.id;if(We(s))return this.store.get(s)}getShapeParent(e){const s=typeof e=="string"?e:e==null?void 0:e.id;if(!s)return;const i=this.getShape(s);if(!(i===void 0||!We(i.parentId)))return this.store.get(i.parentId)}getShapeNearestSibling(e,s){return s?s.parentId===e.parentId?s:this.findShapeAncestor(s,r=>r.parentId===e.parentId):void 0}isShapeInPage(e,s=this.getCurrentPageId()){const i=typeof e=="string"?e:e.id,r=this.getShape(i);if(!r)return!1;let o=!1;if(r.parentId===s)o=!0;else{let a=this.getShape(r.parentId);e:for(;a;){if(a.parentId===s){o=!0;break e}a=this.getShape(a.parentId)}}return o}getAncestorPageId(e){const s=typeof e=="string"?e:e==null?void 0:e.id,i=s&&this.getShape(s);if(i)return Me(i.parentId)?i.parentId:this.getAncestorPageId(this.getShape(i.parentId))}reparentShapes(e,s,i){const r=typeof e[0]=="string"?e:e.map(f=>f.id);if(r.length===0)return this;const o=[],a=Me(s)?ie.Identity():this.getShapePageTransform(s),c=a.rotation();let l=[];const d=te(this.getSortedChildIdsForParent(s).map(f=>this.getShape(f)));if(i){const f=d.find(S=>S.index===i);if(f){const S=d[d.indexOf(f)+1];S?l=Gt(i,S.index,r.length):l=En(i,r.length)}else{const S=d.sort(Ue).find(g=>g.index>i);S?l=Gt(i,S.index,r.length):l=En(i,r.length)}}else{const f=d.length&&d[d.length-1];l=f?En(f.index,r.length):Yn(r.length)}const h=a.clone().invert(),p=te(r.map(f=>this.getShape(f)));return this.run(()=>{for(let f=0;f<p.length;f++){const S=p[f],g=this.getShapePageTransform(S);if(!g)continue;const w=g.point();if(!w)continue;const b=h.applyToPoint(w),x=g.rotation()-c;o.push({id:S.id,type:S.type,parentId:s,x:b.x,y:b.y,rotation:x,index:l[f]})}this.updateShapes(o)},{ignoreShapeLock:!0}),this}getHighestIndexForParent(e){const s=typeof e=="string"?e:e.id,i=this._parentIdsToChildIds.get()[s];if(!i||i.length===0)return"a1";const r=this.getShape(i[i.length-1]);return qt(r.index)}getSortedChildIdsForParent(e){const s=typeof e=="string"?e:e.id,i=this._parentIdsToChildIds.get()[s];return i||ht}visitDescendants(e,s){const i=typeof e=="string"?e:e.id,r=this.getSortedChildIdsForParent(i);for(const o of r)s(o)!==!1&&this.visitDescendants(o,s);return this}getShapeAndDescendantIds(e){const s=new Set;for(const i of e.map(r=>this.getShape(r)).sort(Ue))s.add(i.id),this.visitDescendants(i,r=>{s.add(r)});return s}getDroppingOverShape(e,s=[]){const i=this.getCurrentPageShapesSorted();for(let r=i.length-1;r>=0;r--){const o=i[r];if(this.getSelectedShapeIds().includes(o.id)||!this.getShapeUtil(o).canDropShapes(o,s)||s.find(c=>c.id===o.id||this.hasAncestor(o,c.id)))continue;const a=this.getShapeMaskedPageBounds(o.id);if(a&&a.containsPoint(e)&&this.getShapeGeometry(o).hitTestPoint(this.getPointInShapeSpace(o,e),0,!0))return o}}getOutermostSelectableShape(e,s){const i=typeof e=="string"?e:e.id,r=this.getShape(i);let o=r,a=r;const c=this.getFocusedGroup();for(;a;){if(this.isShapeOfType(a,"group")&&(c==null?void 0:c.id)!==a.id&&!this.hasAncestor(c,a.id)&&((s==null?void 0:s(a))??!0))o=a;else if((c==null?void 0:c.id)===a.id)break;a=this.getShapeParent(a)}return o}_getBindingsIndexCache(){const e=Tu(this);return this.store.createComputedCache("bindingsIndex",s=>e.get().get(s.id))}getBinding(e){return this.store.get(e)}getBindingsFromShape(e,s){const i=typeof e=="string"?e:e.id;return this.getBindingsInvolvingShape(i).filter(r=>r.fromId===i&&r.type===s)}getBindingsToShape(e,s){const i=typeof e=="string"?e:e.id;return this.getBindingsInvolvingShape(i).filter(r=>r.toId===i&&r.type===s)}getBindingsInvolvingShape(e,s){const i=typeof e=="string"?e:e.id,r=this._getBindingsIndexCache().get(i)??ht;return s?r.filter(o=>o.type===s):r}createBindings(e){const s=[];for(const i of e){const r=this.getShape(i.fromId),o=this.getShape(i.toId);if(!r||!o||!this.canBindShapes({fromShape:r,toShape:o,binding:i}))continue;const c=this.getBindingUtil(i.type).getDefaultProps(),l=this.store.schema.types.binding.create({...i,id:i.id??us(),props:{...c,...i.props}});s.push(l)}return this.store.put(s),this}createBinding(e){return this.createBindings([e])}updateBindings(e){const s=[];for(const i of e){if(!i)continue;const r=this.getBinding(i.id);if(!r)continue;const o=qe(r,i);if(o===r)continue;const a=this.getShape(o.fromId),c=this.getShape(o.toId);!a||!c||this.canBindShapes({fromShape:a,toShape:c,binding:o})&&s.push(o)}return this.store.put(s),this}updateBinding(e){return this.updateBindings([e])}deleteBindings(e,{isolateShapes:s=!1}={}){const i=e.map(r=>typeof r=="string"?r:r.id);return s?this.store.atomic(()=>{var r,o;for(const a of i){const c=this.getBinding(a);if(!c)continue;const l=this.getBindingUtil(c);(r=l.onBeforeIsolateFromShape)==null||r.call(l,{binding:c,removedShape:this.getShape(c.toId)}),(o=l.onBeforeIsolateToShape)==null||o.call(l,{binding:c,removedShape:this.getShape(c.fromId)}),this.store.remove([a])}}):this.store.remove(i),this}deleteBinding(e,s){return this.deleteBindings([e],s)}canBindShapes({fromShape:e,toShape:s,binding:i}){const r=typeof e=="string"?e:e.type,o=typeof s=="string"?s:s.type,a=typeof i=="string"?i:i.type,c={fromShapeType:r,toShapeType:o,bindingType:a};return r===o?this.getShapeUtil(r).canBind(c):this.getShapeUtil(r).canBind(c)&&this.getShapeUtil(o).canBind(c)}rotateShapesBy(e,s){if((typeof e[0]=="string"?e:e.map(o=>o.id)).length<=0)return this;const r=_u({editor:this});return r?(ku({delta:s,snapshot:r,editor:this,stage:"one-off"}),this):this}getChangesToTranslateShape(e,s){var o,a,c;let i=e;const r=this.getShapeUtil(e);return i=qe(i,((o=r.onTranslateStart)==null?void 0:o.call(r,i))??void 0),i=qe(i,{id:e.id,type:e.type,x:s.x,y:s.y}),i=qe(i,((a=r.onTranslate)==null?void 0:a.call(r,e,i))??void 0),i=qe(i,((c=r.onTranslateEnd)==null?void 0:c.call(r,e,i))??void 0),i}nudgeShapes(e,s){const i=typeof e[0]=="string"?e:e.map(o=>o.id);if(i.length<=0)return this;const r=[];for(const o of i){const a=this.getShape(o),c=m.From(s),l=this.getShapeParentTransform(a);l&&c.rot(-l.rotation()),r.push(this.getChangesToTranslateShape(a,c.add(a)))}return this.updateShapes(r),this}duplicateShapes(e,s){return this.run(()=>{const i=typeof e[0]=="string"?e:e.map(p=>p.id);if(i.length<=0)return this;const r=new Set(i),o=this.getShapeAndDescendantIds(i),a=[...o].reverse(),c=new Map;for(const p of o)c.set(p,$t());const{shapesToCreate:l,bindingsToCreate:d}=Dr(this,o,p=>{const f=[];for(const g of p){const w=this.getBinding(g);if(!w)continue;const b=us();f.push({...w,id:b,fromId:Be(c.get(w.fromId)),toId:Be(c.get(w.toId))})}const S=[];for(const g of a){const w=Be(c.get(g)),b=this.getShape(g);if(!b)continue;let x=0,I=0;if(s&&r.has(g)){const E=this.getShapeParentTransform(b),D=new m(s.x,s.y).rot(-E.rotation());x=D.x,I=D.y}const _=b.parentId,T=this.getSortedChildIdsForParent(_),A=T.indexOf(b.id),M=T[A+1],F=M?this.getShape(M):null,v=F?Gi(b.index,F.index):qt(b.index);S.push({...b,id:w,x:b.x+x,y:b.y+I,index:v,parentId:c.get(b.parentId)??b.parentId})}return{shapesToCreate:S,bindingsToCreate:f}});if(l.length+this.getCurrentPageShapeIds().size>this.options.maxShapesPerPage){js(this);return}if(this.createShapes(l),this.createBindings(d),this.setSelectedShapes(te(i.map(p=>c.get(p)))),s!==void 0){const p=this.getSelectionPageBounds(),f=this.getViewportPageBounds();p&&!f.contains(p)&&this.centerOnPoint(p.center,{animation:{duration:this.options.animationMediumMs}})}}),this}moveShapesToPage(e,s){const i=typeof e[0]=="string"?e:e.map(c=>c.id);if(i.length===0)return this;if(this.getInstanceState().isReadonly)return this;const r=this.getCurrentPageId();if(s===r)return this;if(!this.store.has(s))return this;const o=this.getContentFromCurrentPage(i);if(!o)return this;if(this.getPageShapeIds(s).size+o.shapes.length>this.options.maxShapesPerPage)return js(this,s),this;const a=this.getCamera().z;return this.run(()=>{this.deleteShapes(i),this.setCurrentPage(s),this.setFocusedGroup(null),this.selectNone(),this.putContentOntoCurrentPage(o,{select:!0,preserveIds:!0,preservePosition:!0}),this.setCamera({...this.getCamera(),z:a}),this.centerOnPoint(this.getSelectionRotatedPageBounds().center)}),this}toggleLock(e){const s=typeof e[0]=="string"?e:e.map(a=>a.id);if(this.getInstanceState().isReadonly||s.length===0)return this;let i=!0,r=!0;const o=[];for(const a of s){const c=this.getShape(a);c&&(o.push(c),c.isLocked?r=!1:i=!1)}return this.run(()=>{r?(this.updateShapes(o.map(a=>({id:a.id,type:a.type,isLocked:!0}))),this.setSelectedShapes([])):i?this.updateShapes(o.map(a=>({id:a.id,type:a.type,isLocked:!1}))):this.updateShapes(o.map(a=>({id:a.id,type:a.type,isLocked:!0})))}),this}sendToBack(e){const s=typeof e[0]=="string"?e:e.map(r=>r.id),i=Fs(this,"toBack",s);return i&&this.updateShapes(i),this}sendBackward(e){const s=typeof e[0]=="string"?e:e.map(r=>r.id),i=Fs(this,"backward",s);return i&&this.updateShapes(i),this}bringForward(e){const s=typeof e[0]=="string"?e:e.map(r=>r.id),i=Fs(this,"forward",s);return i&&this.updateShapes(i),this}bringToFront(e){const s=typeof e[0]=="string"?e:e.map(r=>r.id),i=Fs(this,"toFront",s);return i&&this.updateShapes(i),this}flipShapes(e,s){const i=typeof e[0]=="string"?e:e.map(a=>a.id);if(this.getInstanceState().isReadonly)return this;let r=te(i.map(a=>this.getShape(a)));if(!r.length)return this;r=te(r.map(a=>this.isShapeOfType(a,"group")?this.getSortedChildIdsForParent(a.id).map(c=>this.getShape(c)):a).flat());const o=H.Common(te(r.map(a=>this.getShapePageBounds(a)))).center;return this.run(()=>{for(const a of r){const c=this.getShapeGeometry(a).bounds,l=this.getShapePageTransform(a.id);l&&this.resizeShape(a.id,{x:s==="horizontal"?-1:1,y:s==="vertical"?-1:1},{initialBounds:c,initialPageTransform:l,initialShape:a,mode:"scale_shape",isAspectRatioLocked:this.getShapeUtil(a).isAspectRatioLocked(a),scaleOrigin:o,scaleAxisRotation:0})}}),this}stackShapes(e,s,i){const r=typeof e[0]=="string"?e:e.map(w=>w.id);if(this.getInstanceState().isReadonly)return this;const o=r.map(w=>this.getShape(w)).filter(w=>w?this.getShapeUtil(w).canBeLaidOut(w):!1),a=o.length;if(i===0&&a<3||a<2)return this;const c=Object.fromEntries(o.map(w=>[w.id,this.getShapePageBounds(w)]));let l,d,h,p;s==="horizontal"?(l="x",d="minX",h="maxX",p="width"):(l="y",d="minY",h="maxY",p="height");let f;if(i===0){const w=[];o.sort((x,I)=>c[x.id][d]-c[I.id][d]);for(let x=0;x<a-1;x++){const I=o[x],_=o[x+1],T=c[I.id],M=c[_.id][d]-T[h],F=w.find(v=>v.gap===M);F?F.count++:w.push({gap:M,count:1})}let b=0;w.forEach(x=>{x.count>b&&(b=x.count,f=x.gap)}),b===1&&(f=Math.max(0,w.reduce((x,I)=>x+I.gap*I.count,0)/(a-1)))}else f=i;const S=[];let g=c[o[0].id][h];return o.forEach((w,b)=>{var A,M;if(b===0)return;const x={x:0,y:0};x[l]=g+f-c[w.id][l];const I=this.getShapeParent(w),_=I?m.Rot(x,-this.getShapePageTransform(I).decompose().rotation):x,T=(M=(A=this.getShapeUtil(w)).onTranslateStart)==null?void 0:M.call(A,w);S.push(T?{...T,[l]:w[l]+_[l]}:{id:w.id,type:w.type,[l]:w[l]+_[l]}),g+=c[w.id][p]+f}),this.updateShapes(S),this}packShapes(e,s){var M,F;const i=typeof e[0]=="string"?e:e.map(v=>v.id);if(this.getInstanceState().isReadonly)return this;if(i.length<2)return this;const r=i.map(v=>this.getShape(v)).filter(v=>v?this.getShapeUtil(v).canBeLaidOut(v):!1),o={},a={};let c,l,d=0;for(let v=0;v<r.length;v++)c=r[v],l=this.getShapePageBounds(c),o[c.id]=l,a[c.id]=l.clone(),d+=l.width*l.height;const h=H.Common(te(Object.values(o))),p=h.width;r.sort((v,E)=>o[E.id].height-o[v.id].height);const f=Math.max(Math.ceil(Math.sqrt(d/.95)),p),S=[new H(h.x,h.y,f,1/0)];let g=0,w=0,b,x;for(let v=0;v<r.length;v++){c=r[v],l=a[c.id];for(let E=S.length-1;E>=0;E--)if(b=S[E],!(l.width>b.width||l.height>b.height)){l.x=b.x,l.y=b.y,w=Math.max(w,l.maxY),g=Math.max(g,l.maxX),l.width===b.width&&l.height===b.height?(x=S.pop(),E<S.length&&(S[E]=x)):l.height===b.height?(b.x+=l.width+s,b.width-=l.width+s):l.width===b.width?(b.y+=l.height+s,b.height-=l.height+s):(S.push(new H(b.x+(l.width+s),b.y,b.width-(l.width+s),l.height)),b.y+=l.height+s,b.height-=l.height+s);break}}const I=H.Common(Object.values(a)),_=m.Sub(h.center,I.center);let T;const A=[];for(let v=0;v<r.length;v++){c=r[v],l=o[c.id],T=a[c.id];const E=m.Sub(T.point,l.point).add(_),D=this.getShapeParentTransform(c);D&&E.rot(-D.rotation());const B={id:c.id,type:c.type,x:c.x+E.x,y:c.y+E.y},P=(F=(M=this.getShapeUtil(c)).onTranslateStart)==null?void 0:F.call(M,{...c,...B});P?A.push({...B,...P}):A.push(B)}return A.length&&this.updateShapes(A),this}alignShapes(e,s){const i=typeof e[0]=="string"?e:e.map(l=>l.id);if(this.getInstanceState().isReadonly)return this;if(i.length<2)return this;const r=te(i.map(l=>this.getShape(l))),o=Object.fromEntries(r.map(l=>[l.id,this.getShapePageBounds(l)])),a=H.Common(te(Object.values(o))),c=[];return r.forEach(l=>{const d=o[l.id];if(!d)return;const h={x:0,y:0};switch(s){case"top":{h.y=a.minY-d.minY;break}case"center-vertical":{h.y=a.midY-d.minY-d.height/2;break}case"bottom":{h.y=a.maxY-d.minY-d.height;break}case"left":{h.x=a.minX-d.minX;break}case"center-horizontal":{h.x=a.midX-d.minX-d.width/2;break}case"right":{h.x=a.maxX-d.minX-d.width;break}}const p=this.getShapeParent(l),f=p?m.Rot(h,-this.getShapePageTransform(p).decompose().rotation):h;c.push(this.getChangesToTranslateShape(l,m.Add(l,f)))}),this.updateShapes(c),this}distributeShapes(e,s){const i=typeof e[0]=="string"?e:e.map(I=>I.id);if(this.getInstanceState().isReadonly)return this;if(i.length<3)return this;const r=i.length,o=te(i.map(I=>this.getShape(I))),a=Object.fromEntries(o.map(I=>[I.id,this.getShapePageBounds(I)]));let c,l,d,h,p;s==="horizontal"?(c="x",l="minX",d="maxX",h="midX",p="width"):(c="y",l="minY",d="maxY",h="midY",p="height");const f=[],S=o.sort((I,_)=>a[I.id][l]-a[_.id][l])[0],g=o.sort((I,_)=>a[_.id][d]-a[I.id][d])[0],w=a[S.id][h],b=(a[g.id][h]-w)/(r-1),x=w+b;return o.filter(I=>I!==S&&I!==g).sort((I,_)=>a[I.id][h]-a[_.id][h]).forEach((I,_)=>{const T={x:0,y:0};T[c]=x+b*_-a[I.id][p]/2-a[I.id][c];const A=this.getShapeParent(I),M=A?m.Rot(T,-this.getShapePageTransform(A).rotation()):T;f.push(this.getChangesToTranslateShape(I,m.Add(I,M)))}),this.updateShapes(f),this}stretchShapes(e,s){const i=typeof e[0]=="string"?e:e.map(l=>l.id);if(this.getInstanceState().isReadonly)return this;if(i.length<2)return this;const r=te(i.map(l=>this.getShape(l))),o=Object.fromEntries(i.map(l=>[l,this.getShapeGeometry(l).bounds])),a=Object.fromEntries(i.map(l=>[l,this.getShapePageBounds(l)])),c=H.Common(te(Object.values(a)));switch(s){case"vertical":{this.run(()=>{for(const l of r){if(this.getShapePageTransform(l).rotation()%ae)continue;const h=o[l.id],p=a[l.id],f=new m(0,c.minY-p.minY),S=this.getShapeParentTransform(l);S&&f.rot(-S.rotation());const{x:g,y:w}=m.Add(f,l);this.updateShapes([{id:l.id,type:l.type,x:g,y:w}]);const b=new m(1,c.height/p.height);this.resizeShape(l.id,b,{initialBounds:h,scaleOrigin:new m(p.center.x,c.minY),isAspectRatioLocked:this.getShapeUtil(l).isAspectRatioLocked(l),scaleAxisRotation:0})}});break}case"horizontal":{this.run(()=>{for(const l of r){const d=o[l.id],h=a[l.id];if(this.getShapePageTransform(l).rotation()%ae)continue;const f=new m(c.minX-h.minX,0),S=this.getShapeParentTransform(l);S&&f.rot(-S.rotation());const{x:g,y:w}=m.Add(f,l);this.updateShapes([{id:l.id,type:l.type,x:g,y:w}]);const b=new m(c.width/h.width,1);this.resizeShape(l.id,b,{initialBounds:d,scaleOrigin:new m(c.minX,h.center.y),isAspectRatioLocked:this.getShapeUtil(l).isAspectRatioLocked(l),scaleAxisRotation:0})}});break}}return this}resizeShape(e,s,i={}){var S,g,w;const r=typeof e=="string"?e:e.id;if(this.getInstanceState().isReadonly)return this;Number.isFinite(s.x)||(s=new m(1,s.y)),Number.isFinite(s.y)||(s=new m(s.x,1));const o=i.initialShape??this.getShape(r);if(!o)return this;const a=i.scaleOrigin??((S=this.getShapePageBounds(r))==null?void 0:S.center);if(!a)return this;const c=i.initialPageTransform?ie.Cast(i.initialPageTransform):this.getShapePageTransform(r);if(!c)return this;const l=c.rotation();if(l==null)return this;const d=i.scaleAxisRotation??l,h=i.initialBounds??this.getShapeGeometry(r).bounds;if(!h)return this;const p=i.isAspectRatioLocked??this.getShapeUtil(o).isAspectRatioLocked(o);if(!Ad(l,d))return this._resizeUnalignedShape(r,s,{...i,initialBounds:h,scaleOrigin:a,scaleAxisRotation:d,initialPageTransform:c,isAspectRatioLocked:p,initialShape:o});const f=this.getShapeUtil(o);if(p&&(Math.abs(s.x)>Math.abs(s.y)?s=new m(s.x,Math.sign(s.y)*Math.abs(s.x)):s=new m(Math.sign(s.x)*Math.abs(s.y),s.y)),f.onResize&&f.canResize(o)){const b=this._scalePagePoint(ie.applyToPoint(c,new m(0,0)),a,s,d),x=this.getPointInParentSpace(o.id,b),I=new m(s.x,s.y),_=Hs((l-d)%Math.PI,0);I.x=_?s.x:s.y,I.y=_?s.y:s.x;const T=ie.applyToPoint(c,new m),{x:A,y:M}=this.getPointInParentSpace(o.id,T);let F=o;i.skipStartAndEndCallbacks||(F=qe(o,((g=f.onResizeStart)==null?void 0:g.call(f,o))??void 0)),F=qe(F,{id:r,type:o.type,x:x.x,y:x.y,...f.onResize({...o,x:A,y:M},{newPoint:x,handle:i.dragHandle??"bottom_right",mode:i.mode??"scale_shape",scaleX:I.x,scaleY:I.y,initialBounds:h,initialShape:o})}),i.skipStartAndEndCallbacks||(F=qe(F,((w=f.onResizeEnd)==null?void 0:w.call(f,o,F))??void 0)),this.updateShapes([F])}else{const b=ie.applyToPoint(c,h.center),x=this._scalePagePoint(b,a,s,d),I=this.getPointInParentSpace(o.id,b),_=this.getPointInParentSpace(o.id,x),T=m.Sub(_,I);this.updateShapes([{id:r,type:o.type,x:o.x+T.x,y:o.y+T.y}])}return this}_scalePagePoint(e,s,i,r){const o=m.RotWith(e,s,-r).sub(s),a=m.MulV(o,i);return m.Add(a,s).rotWith(s,r)}_resizeUnalignedShape(e,s,i){const{type:r}=i.initialShape,o=new m(s.x,s.y);if(Math.abs(s.x)>Math.abs(s.y)?o.x=Math.sign(s.x)*Math.abs(s.y):o.y=Math.sign(s.y)*Math.abs(s.x),this.resizeShape(e,o,{initialShape:i.initialShape,initialBounds:i.initialBounds,isAspectRatioLocked:i.isAspectRatioLocked}),Math.sign(s.x)*Math.sign(s.y)<0){let{rotation:b}=ie.Decompose(i.initialPageTransform);b-=2*b,this.updateShapes([{id:e,type:r,rotation:b}])}const a=ie.applyToPoint(i.initialPageTransform,i.initialBounds.center),c=this._scalePagePoint(a,i.scaleOrigin,s,i.scaleAxisRotation),l=this.getShapePageBounds(e),d=this.getShapePageTransform(e),h=l.center,p=d.point();if(!h||!p)return this;const f=m.Sub(c,h),S=m.Add(p,f),{x:g,y:w}=this.getPointInParentSpace(e,S);return this.updateShapes([{id:e,type:r,x:g,y:w}]),this}getInitialMetaForShape(e){return{}}createShape(e){return this.createShapes([e]),this}createShapes(e){if(!Array.isArray(e))throw Error("Editor.createShapes: must provide an array of shapes or shape partials");if(this.getInstanceState().isReadonly)return this;if(e.length<=0)return this;const s=this.getCurrentPageShapeIds();if(e.length+s.size>this.options.maxShapesPerPage)return js(this),this;const r=this.getFocusedGroupId();return this.run(()=>{var h,p;const o=this.getCurrentPageShapesSorted(),a=e.map(f=>{if(f.id||(f={id:$t(),...f}),!f.parentId||!(this.store.has(f.parentId)||e.some(S=>S.id===f.parentId))){let S=this.getFocusedGroupId();for(let w=o.length-1;w>=0;w--){const b=o[w];if(this.getShapeUtil(b).canReceiveNewChildrenOfType(b,f.type)&&this.isPointInShape(b,{x:f.x??0,y:f.y??0},{margin:0,hitInside:!0})){S=b.id;break}}const g=f.parentId;if(S===f.id&&(S=r),S!==g&&(f={...f},f.parentId=S,We(S))){const w=this.getPointInShapeSpace(this.getShape(S),{x:f.x??0,y:f.y??0});f.x=w.x,f.y=w.y,f.rotation=-this.getShapePageTransform(S).rotation()+(f.rotation??0)}}return f}),c=new Map,l=[],{opacityForNextShape:d}=this.getInstanceState();for(const f of a){const S=this.getShapeUtil(f);let g=f.index;if(!g){const I=f.parentId??r;c.has(I)||c.set(I,this.getHighestIndexForParent(I)),g=c.get(I),c.set(I,qt(g))}const w=S.getDefaultProps();for(const[I,_]of this.styleProps[f.type])w[_]=this.getStyleForNextShape(I);let b=this.store.schema.types.shape.create({...f,index:g,opacity:f.opacity??d,parentId:f.parentId??r,props:"props"in f?{...w,...f.props}:w});if(b.index===void 0)throw Error("no index!");const x=(p=(h=this.getShapeUtil(b)).onBeforeCreate)==null?void 0:p.call(h,b);x&&(b=x),l.push(b)}l.forEach(f=>{f.meta={...this.getInitialMetaForShape(f),...f.meta}}),this.store.put(l)}),this}animateShape(e,s={animation:Dn}){return this.animateShapes([e],s)}animateShapes(e,s={animation:Dn}){if(!s.animation)return this;const{duration:i=500,easing:r=ws.linear}=s.animation,o=De();let a=i,c;const l=[];let d,h;for(let f=0,S=e.length;f<S;f++){if(d=e[f],!d)continue;const g=this.getShape(d.id);g&&(h={start:ue(g),end:qe(ue(g),d)},l.push(h),this.animatingShapes.set(g.id,o))}const p=f=>{var b,x;if(a-=f,a<0){const{animatingShapes:I}=this,_=e.filter(T=>T&&I.get(T.id)===o);_.length&&this.updateShapes(_),this.off("tick",p);return}c=r(1-a/i);const{animatingShapes:S}=this,g=[];let w;for(let I=0,_=l.length;I<_;I++){const{start:T,end:A}=l[I];w=S.get(T.id),w===o&&g.push({...A,x:T.x+(A.x-T.x)*c,y:T.y+(A.y-T.y)*c,opacity:T.opacity+(A.opacity-T.opacity)*c,rotation:T.rotation+(A.rotation-T.rotation)*c,props:((x=(b=this.getShapeUtil(A)).getInterpolatedProps)==null?void 0:x.call(b,T,A,c))??A.props})}this._updateShapes(g)};return this.on("tick",p),this}groupShapes(e,s={}){var g;const{groupId:i=$t(),select:r=!0}=s;if(!Array.isArray(e))throw Error("Editor.groupShapes: must provide an array of shapes or shape ids");if(this.getInstanceState().isReadonly)return this;const o=typeof e[0]=="string"?e:e.map(w=>w.id);if(o.length<=1)return this;const a=te((this._shouldIgnoreShapeLock?o:this._getUnlockedShapeIds(o)).map(w=>this.getShape(w))),c=a.sort(Ue).map(w=>w.id),l=H.Common(te(a.map(w=>this.getShapePageBounds(w)))),{x:d,y:h}=l.point,p=this.findCommonAncestor(a)??this.getCurrentPageId();if(this.getCurrentToolId()!=="select")return this;this.isIn("select.idle")||this.cancel();const f=a.filter(w=>w.parentId===p).sort(Ue),S=(g=f[f.length-1])==null?void 0:g.index;return this.run(()=>{this.createShapes([{id:i,type:"group",parentId:p,index:S,x:d,y:h,opacity:1,props:{}}]),this.reparentShapes(c,i),r&&this.select(i)}),this}ungroupShapes(e,s={}){if(this.getInstanceState().isReadonly)return this;const{select:i=!0}=s,r=typeof e[0]=="string"?e:e.map(l=>l.id),o=te((this._shouldIgnoreShapeLock?r:this._getUnlockedShapeIds(r)).map(l=>this.getShape(l)));if(o.length===0)return this;if(this.getCurrentToolId()!=="select")return this;this.isIn("select.idle")||this.cancel();const a=new Set,c=[];return o.forEach(l=>{this.isShapeOfType(l,"group")?c.push(l):a.add(l.id)}),c.length===0?this:(this.run(()=>{let l;for(let d=0,h=c.length;d<h;d++){l=c[d];const p=this.getSortedChildIdsForParent(l.id);for(let f=0,S=p.length;f<S;f++)a.add(p[f]);this.reparentShapes(p,l.parentId,l.index)}this.deleteShapes(c.map(d=>d.id)),i&&this.select(...a)}),this)}updateShape(e){return this.updateShapes([e]),this}updateShapes(e){const s=Array(e.length);for(let i=0,r=e.length;i<r;i++){const o=e[i];if(!o)continue;const a=this.getShape(o.id);if(a){if(!this._shouldIgnoreShapeLock){if(a.isLocked){if(!(Object.hasOwn(o,"isLocked")&&!o.isLocked))continue}else if(this.isShapeOrAncestorLocked(a))continue}this.animatingShapes.delete(o.id),s.push(o)}}return this._updateShapes(s),this}_getUnlockedShapeIds(e){return e.filter(s=>{var i;return!((i=this.getShape(s))!=null&&i.isLocked)})}deleteShapes(e){if(this.getInstanceState().isReadonly)return this;if(!Array.isArray(e))throw Error("Editor.deleteShapes: must provide an array of shapes or shapeIds");const s=typeof e[0]=="string"?e:e.map(o=>o.id),i=this._shouldIgnoreShapeLock?s:this._getUnlockedShapeIds(s);if(i.length===0)return this;const r=new Set(i);for(const o of i)this.visitDescendants(o,a=>{r.add(a)});return this.run(()=>this.store.remove([...r]))}deleteShape(e){return this.deleteShapes([typeof e=="string"?e:e.id]),this}_extractSharedStyles(e,s){if(this.isShapeOfType(e,"group")){const i=this._parentIdsToChildIds.get()[e.id];if(!i)return;for(let r=0,o=i.length;r<o;r++)this._extractSharedStyles(this.getShape(i[r]),s)}else for(const[i,r]of this.styleProps[e.type])s.applyValue(i,Ee(e.props,r))}_getSelectionSharedStyles(){const e=this.getSelectedShapes(),s=new kr;for(const i of e)this._extractSharedStyles(i,s);return s}getStyleForNextShape(e){const s=this.getInstanceState().stylesForNextShape[e.id];return s===void 0?e.defaultValue:s}getShapeStyleIfExists(e,s){const i=this.styleProps[e.type].get(s);if(i!==void 0)return Ee(e.props,i)}getSharedStyles(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0)return this._getSelectionSharedStyles();const e=this.root.getCurrent(),s=new kr;if(!e)return s;if(e.shapeType)for(const i of this.styleProps[e.shapeType].keys())s.applyValue(i,this.getStyleForNextShape(i));return s}getSharedOpacity(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0){const e=[],s=r=>{const o=this.getShape(r);if(o)if(this.isShapeOfType(o,"group"))for(const a of this.getSortedChildIdsForParent(o.id))s(a);else e.push(o)};for(const r of this.getSelectedShapeIds())s(r);let i=null;for(const r of e)if(i===null)i=r.opacity;else if(i!==r.opacity)return{type:"mixed"};if(i!==null)return{type:"shared",value:i}}return{type:"shared",value:this.getInstanceState().opacityForNextShape}}setOpacityForNextShapes(e,s){return this.updateInstanceState({opacityForNextShape:e},s),this}setOpacityForSelectedShapes(e){const s=this.getSelectedShapes();if(s.length>0){const i=[],r=o=>{if(this.isShapeOfType(o,"group")){const a=this.getSortedChildIdsForParent(o);for(const c of a)r(this.getShape(c))}else i.push(o)};for(const o of s)r(o);this.updateShapes(i.map(o=>({id:o.id,type:o.type,opacity:e})))}return this}setStyleForNextShapes(e,s,i){const r=this.getInstanceState().stylesForNextShape;return this.updateInstanceState({stylesForNextShape:{...r,[e.id]:s}},i),this}setStyleForSelectedShapes(e,s){const i=this.getSelectedShapes();if(i.length>0){const r=[],o=a=>{if(this.isShapeOfType(a,"group")){const c=this.getSortedChildIdsForParent(a.id);for(const l of c)o(this.getShape(l))}else{const c=this.getShapeUtil(a),l=this.styleProps[a.type].get(e);if(l){const d={id:a.id,type:a.type,props:{[l]:s}};r.push({util:c,originalShape:a,updatePartial:d})}}};for(const a of i)o(a);this.updateShapes(r.map(({updatePartial:a})=>a))}return this}registerExternalAssetHandler(e,s){return this.externalAssetContentHandlers[e]=s,this}async getAssetForExternalContent(e){var s,i;return await((i=(s=this.externalAssetContentHandlers)[e.type])==null?void 0:i.call(s,e))}hasExternalAssetHandler(e){return!!this.externalAssetContentHandlers[e]}registerExternalContentHandler(e,s){return this.externalContentHandlers[e]=s,this}async putExternalContent(e){var s,i;return(i=(s=this.externalContentHandlers)[e.type])==null?void 0:i.call(s,e)}getContentFromCurrentPage(e){const s=typeof e[0]=="string"?e:e.map(r=>r.id);if(!s||s.length===0)return;const i=this.getShapeAndDescendantIds(s);return Dr(this,i,r=>{const o=[];for(const h of r){const p=this.getBinding(h);p&&o.push(p)}const a=[],c=[];for(const h of i){const p=this.getShape(h);if(!p)continue;if(!i.has(p.parentId)){const S=this.getShapePageTransform(p.id),g=S.point();c.push({...p,x:g.x,y:g.y,rotation:S.rotation(),parentId:this.getCurrentPageId()}),a.push(p.id)}else c.push(p)}const l=[],d=new Set;for(const h of c){if(!("assetId"in h.props))continue;const p=h.props.assetId;if(!p||d.has(p))continue;d.add(p);const f=this.getAsset(p);f&&l.push(f)}return{schema:this.store.schema.serialize(),shapes:c,rootShapeIds:a,bindings:o,assets:l}})}async resolveAssetsInContent(e){if(!e)return;const s=[];return await Promise.allSettled(e.assets.map(async i=>{var r,o;if((i.type==="image"||i.type==="video")&&!((r=i.props.src)!=null&&r.startsWith("data:image"))&&!((o=i.props.src)!=null&&o.startsWith("http"))){const a=ue(i),c=await this.store.props.assets.resolve(i,{screenScale:1,steppedScreenScale:1,dpr:1,networkEffectiveType:null,shouldResolveToOriginal:!0});a.props.src=await Vr.blobToDataUrl(await ln(c).then(l=>l.blob())),s.push(a)}else s.push(i)})),e.assets=s,e}putContentOntoCurrentPage(e,s={}){var D,B;if(this.getInstanceState().isReadonly)return this;if(!e.schema)throw Error(`Could not put content:
content is missing a schema.`);const{select:i=!1,preserveIds:r=!1,preservePosition:o=!1}=s;let{point:a=void 0}=s;const c=this.getCurrentPageId(),{rootShapeIds:l}=e,d=[],h=[],p=[],f={store:{...Object.fromEntries(e.assets.map(P=>[P.id,P])),...Object.fromEntries(e.shapes.map(P=>[P.id,P])),...Object.fromEntries(((D=e.bindings)==null?void 0:D.map(P=>[P.id,P]))??[])},schema:e.schema},S=this.store.schema.migrateStoreSnapshot(f);if(S.type==="error")throw Error("Could not put content: could not migrate content");for(const P of Object.values(S.value))switch(P.typeName){case"asset":{d.push(P);break}case"shape":{h.push(P);break}case"binding":{p.push(P);break}}const g=new Map(r?h.map(P=>[P.id,P.id]):h.map(P=>[P.id,$t()])),w=new Map(r?p.map(P=>[P.id,P.id]):p.map(P=>[P.id,us()]));let b=this.getCurrentPageId(),x=1/0,I=[];for(const P of this.getSelectedShapes()){if(x===0)break;const j=this.isShapeOfType(P,"frame"),R=this.getShapeAncestors(P);j&&R.push(P);const V=j?R.length+1:R.length;if(V<x)x=V,I=R,b=j?P.id:P.parentId;else if(V===x){if(I.length!==R.length)throw Error(`Ancestors: ${I.length} !== ${R.length}`);if(I.length===0){b=c;break}else{b=c;for(let z=0;z<I.length&&R[z]===I[z];z++)b=R[z].id}}}let _=!1;if(!Me(b)){const P=this.getShape(b);if(P){if(!this.getViewportPageBounds().includes(this.getShapePageBounds(P)))b=c;else if(l.length===1){const j=h.find(R=>R.id===l[0]);this.isShapeOfType(P,"frame")&&this.isShapeOfType(j,"frame")&&j.props.w===(P==null?void 0:P.props.w)&&j.props.h===(P==null?void 0:P.props.h)&&(_=!0)}}else b=c}_||(_=g.has(b)),_&&(b=this.getShape(b).parentId);let T=this.getHighestIndexForParent(b);const A=[],M=h.map(P=>{const j=g.get(P.id),R={...P,id:j};return l.includes(P.id)&&(R.parentId=c,A.push(R)),g.has(R.parentId)?R.parentId=g.get(P.parentId):(l.push(R.id),R.index=T,T=qt(T)),R});if(M.length+this.getCurrentPageShapeIds().size>this.options.maxShapesPerPage)return js(this),this;const F=p.map(P=>({...P,id:Be(w.get(P.id)),fromId:Be(g.get(P.fromId)),toId:Be(g.get(P.toId))})),v=[],E=[];for(const P of d)this.store.has(P.id)||((P.type==="image"||P.type==="video")&&((B=P.props.src)!=null&&B.startsWith("data:image"))&&(E.push(ue(P)),P.props.src=null),v.push(P));return Promise.allSettled(E.map(async P=>{const j=await wu(P.props.src,P.props.name,P.props.mimeType??"image/png"),R=await this.getAssetForExternalContent({type:"file",file:j});if(!R){this.deleteAssets([P.id]);return}this.updateAssets([{...R,id:P.id}])})),this.run(()=>{v.length>0&&this.createAssets(v),this.createShapes(M),this.createBindings(F),i&&this.select(...A.map(z=>z.id)),b!==c&&this.reparentShapes(A.map(z=>z.id),b);const P=M.map(z=>this.getShape(z.id)),j=H.Common(P.map(z=>this.getShapePageBounds(z)));if(a===void 0)if(Me(b)){const z=this.getViewportPageBounds();o||z.includes(H.From(j))?a=j.center:a=z.center}else{const z=this.getShape(b);a=ie.applyToPoint(this.getShapePageTransform(z),this.getShapeGeometry(z).bounds.center)}if(A.length===1){const z=A[0];if(this.isShapeOfType(z,"frame"))for(;this.getShapesAtPoint(a).some(J=>this.isShapeOfType(J,"frame")&&J.props.w===z.props.w&&J.props.h===z.props.h);)a.x+=j.w+16}const R=H.Common(te(A.map(({id:z})=>this.getShapePageBounds(z)))).center,V=m.Sub(a,R);this.updateShapes(A.map(({id:z})=>{const J=this.getShape(z),nt=this.getShapeParentTransform(z).decompose().rotation,je=m.Rot(V,-nt);return{id:J.id,type:J.type,x:J.x+je.x,y:J.y+je.y}}))}),this}async getSvgElement(e,s={}){const i=await Fu(this,e,s);if(!i)return;const r=document.createDocumentFragment(),o=La.createRoot(r);Oa.flushSync(()=>{o.render(i.jsx)});const a=r.firstElementChild;return de(a instanceof SVGSVGElement,"Expected an SVG element"),o.unmount(),{svg:a,width:i.width,height:i.height}}async getSvgString(e,s={}){const i=await this.getSvgElement(e,s);return i?{svg:new XMLSerializer().serializeToString(i.svg),width:i.width,height:i.height}:void 0}async getSvg(e,s={}){const i=await this.getSvgElement(e,s);if(i)return i.svg}_updateInputsFromEvent(e){const{pointerVelocity:s,previousScreenPoint:i,previousPagePoint:r,currentScreenPoint:o,currentPagePoint:a}=this.inputs,{screenBounds:c}=this.store.unsafeGetWithoutCapture(we),{x:l,y:d,z:h}=Es(()=>this.getCamera()),p=e.point.x-c.x,f=e.point.y-c.y,S=e.point.z??.5;i.setTo(o),r.setTo(a),o.set(p,f);const g=p/h-l,w=f/h-d;isFinite(g)&&isFinite(w)&&a.set(g,w,S),this.inputs.isPen=e.type==="pointer"&&e.isPen,(e.name==="pointer_down"||this.inputs.isPinching)&&(s.set(0,0),this.inputs.originScreenPoint.setTo(o),this.inputs.originPagePoint.setTo(a)),this.run(()=>{var b;this.store.put([{id:sn,typeName:"pointer",x:a.x,y:a.y,lastActivityTimestamp:e.type==="pointer"&&e.pointerId===mr.CAMERA_MOVE?((b=this.store.unsafeGetWithoutCapture(sn))==null?void 0:b.lastActivityTimestamp)??this._tickManager.now:this._tickManager.now,meta:{}}])},{history:"ignore"})}cancel(){return this.dispatch({type:"misc",name:"cancel"}),this}interrupt(){return this.dispatch({type:"misc",name:"interrupt"}),this}complete(){return this.dispatch({type:"misc",name:"complete"}),this}focus({focusContainer:e=!0}={}){return this.getIsFocused()?this:(e&&this.focusManager.focus(),this.updateInstanceState({isFocused:!0}),this)}blur({blurContainer:e=!0}={}){return this.getIsFocused()?(e?this.focusManager.blur():this.complete(),this.updateInstanceState({isFocused:!1}),this):this}getIsFocused(){return this.getInstanceState().isFocused}getSnapshot(){return uu(this.store)}loadSnapshot(e){return aa(this.store,e),this}cancelDoubleClick(){this._clickManager.cancelDoubleClickTimeout()}_flushEventsForTick(e){this.run(()=>{if(this._pendingEventsForNextTick.length>0){const s=[...this._pendingEventsForNextTick];this._pendingEventsForNextTick.length=0;for(const i of s)this._flushEventForTick(i)}e>0&&this.root.handleEvent({type:"misc",name:"tick",elapsed:e}),this.scribbles.tick(e)})}maybeTrackPerformance(e){Ce.measurePerformance.get()&&(this.performanceTracker.isStarted()?clearTimeout(this.performanceTrackerTimeout):this.performanceTracker.start(e),this.performanceTrackerTimeout=this.timers.setTimeout(()=>{this.performanceTracker.stop()},50))}}O([C],L.prototype,"getCanUndo");O([C],L.prototype,"getCanRedo");O([C],L.prototype,"getPath");O([C],L.prototype,"getCurrentTool");O([C],L.prototype,"getCurrentToolId");O([C],L.prototype,"getDocumentSettings");O([C],L.prototype,"getInstanceState");O([C],L.prototype,"getOpenMenus");O([C],L.prototype,"getIsMenuOpen");O([C],L.prototype,"getPageStates");O([C],L.prototype,"_getPageStatesQuery");O([C],L.prototype,"getCurrentPageState");O([C],L.prototype,"_getCurrentPageStateId");O([C],L.prototype,"getSelectedShapeIds");O([C],L.prototype,"getSelectedShapes");O([C],L.prototype,"getOnlySelectedShapeId");O([C],L.prototype,"getOnlySelectedShape");O([C],L.prototype,"getSelectionPageBounds");O([C],L.prototype,"getSelectionRotation");O([C],L.prototype,"getSelectionRotatedPageBounds");O([C],L.prototype,"getSelectionRotatedScreenBounds");O([C],L.prototype,"getFocusedGroupId");O([C],L.prototype,"getFocusedGroup");O([C],L.prototype,"getEditingShapeId");O([C],L.prototype,"getEditingShape");O([C],L.prototype,"getHoveredShapeId");O([C],L.prototype,"getHoveredShape");O([C],L.prototype,"getHintingShapeIds");O([C],L.prototype,"getHintingShape");O([C],L.prototype,"getErasingShapeIds");O([C],L.prototype,"getErasingShapes");O([C],L.prototype,"_unsafe_getCameraId");O([C],L.prototype,"getCamera");O([C],L.prototype,"getViewportPageBoundsForFollowing");O([C],L.prototype,"getCameraForFollowing");O([C],L.prototype,"getZoomLevel");O([C],L.prototype,"getViewportScreenBounds");O([C],L.prototype,"getViewportScreenCenter");O([C],L.prototype,"getViewportPageBounds");O([C],L.prototype,"_getCollaboratorsQuery");O([C],L.prototype,"getCollaborators");O([C],L.prototype,"getCollaboratorsOnCurrentPage");O([C],L.prototype,"getRenderingShapes");O([C],L.prototype,"_getAllPagesQuery");O([C],L.prototype,"getPages");O([C],L.prototype,"getCurrentPageId");O([C],L.prototype,"getCurrentPageShapeIdsSorted");O([C],L.prototype,"_getAllAssetsQuery");O([C],L.prototype,"_getShapeGeometryCache");O([C],L.prototype,"_getShapeHandlesCache");O([C],L.prototype,"_getShapePageTransformCache");O([C],L.prototype,"_getShapePageBoundsCache");O([C],L.prototype,"_getShapeClipPathCache");O([C],L.prototype,"_getShapeMaskCache");O([C],L.prototype,"_getShapeMaskedPageBoundsCache");O([C],L.prototype,"_notVisibleShapes");O([C],L.prototype,"getCulledShapes");O([C],L.prototype,"getCurrentPageBounds");O([C],L.prototype,"getCurrentPageShapes");O([C],L.prototype,"getCurrentPageShapesSorted");O([C],L.prototype,"getCurrentPageRenderingShapesSorted");O([C],L.prototype,"_getBindingsIndexCache");O([C],L.prototype,"_getSelectionSharedStyles");O([C({isEqual:(n,t)=>n.equals(t)})],L.prototype,"getSharedStyles");O([C],L.prototype,"getSharedOpacity");O([C],L.prototype,"getIsFocused");function js(n,t=n.getCurrentPageId()){const e=n.getPage(t).name;n.emit("max-shapes",{name:e,pageId:t,count:n.options.maxShapesPerPage})}function qe(n,t){if(!t)return n;let e=null;const s=Object.entries(t);for(let i=0,r=s.length;i<r;i++){const[o,a]=s[i];if(a!==void 0&&!(o==="id"||o==="type"||o==="typeName")&&a!==n[o]){if(e||(e={...n}),o==="props"||o==="meta"){e[o]={...n[o]};for(const[c,l]of Object.entries(a))l!==void 0&&(e[o][c]=l);continue}e[o]=a}}return e||n}function ga(n,t,e){const s=n.getShape(t);if(!s)return;e.push(s);const i=n.getSortedChildIdsForParent(t);for(let r=0,o=i.length;r<o;r++)ga(n,i[r],e)}function Dr(n,t,e){let s;if(n.run(()=>{const i=n.store.extractingChanges(()=>{const r=new Set,o=new Set;for(const a of t)if(n.getShape(a))for(const l of n.getBindingsInvolvingShape(a)){const d=t.has(l.fromId),h=t.has(l.toId);if(d&&h){r.add(l.id);continue}(!d||!h)&&o.add(l.id)}n.deleteBindings([...o],{isolateShapes:!0});try{s=yt.ok(e(r))}catch(a){s=yt.err(a)}});n.store.applyDiff(Xn(i))},{history:"ignore"}),s.ok)return s.value;throw s.error}function Rr(n,t){if(!t.constraints)throw Error("Should have constraints here");const{padding:{x:e,y:s}}=t.constraints,i=n.getViewportScreenBounds(),r=H.From(t.constraints.bounds),o=(i.w-e*2)/r.w,a=(i.h-s*2)/r.h;return{zx:o,zy:a}}function ma(){const n=K(),t=Ou();return $("isDarkMode",()=>(t==null?void 0:t.isDarkMode)??n.user.getIsDarkMode(),[t,n])}const Lr="<path d='m19.7432 17.0869-4.072 4.068 2.829 2.828-8.473-.013-.013-8.47 2.841 2.842 4.075-4.068 1.414-1.415-2.844-2.842h8.486v8.484l-2.83-2.827z' fill='%23fff'/><path d='m18.6826 16.7334-4.427 4.424 1.828 1.828-5.056-.016-.014-5.054 1.842 1.841 4.428-4.422 2.474-2.475-1.844-1.843h5.073v5.071l-1.83-1.828z' fill='%23000'/>",Or="<path d='m9 17.9907v.005l5.997 5.996.001-3.999h1.999 2.02v4l5.98-6.001-5.98-5.999.001 4.019-2.021.002h-2l.001-4.022zm1.411.003 3.587-3.588-.001 2.587h3.5 2.521v-2.585l3.565 3.586-3.564 3.585-.001-2.585h-2.521l-3.499-.001-.001 2.586z' fill='%23fff'/><path d='m17.4971 18.9932h2.521v2.586l3.565-3.586-3.565-3.585v2.605h-2.521-3.5v-2.607l-3.586 3.587 3.586 3.586v-2.587z' fill='%23000'/>",zs='<path d="M22.4789 9.45728L25.9935 12.9942L22.4789 16.5283V14.1032C18.126 14.1502 14.6071 17.6737 14.5675 22.0283H17.05L13.513 25.543L9.97889 22.0283H12.5674C12.6071 16.5691 17.0214 12.1503 22.4789 12.1031L22.4789 9.45728Z" fill="black"/><path fill-rule="evenodd" clip-rule="evenodd" d="M21.4789 7.03223L27.4035 12.9945L21.4789 18.9521V15.1868C18.4798 15.6549 16.1113 18.0273 15.649 21.0284H19.475L13.5128 26.953L7.55519 21.0284H11.6189C12.1243 15.8155 16.2679 11.6677 21.4789 11.1559L21.4789 7.03223ZM22.4789 12.1031C17.0214 12.1503 12.6071 16.5691 12.5674 22.0284H9.97889L13.513 25.543L17.05 22.0284H14.5675C14.5705 21.6896 14.5947 21.3558 14.6386 21.0284C15.1157 17.4741 17.9266 14.6592 21.4789 14.1761C21.8063 14.1316 22.1401 14.1069 22.4789 14.1032V16.5284L25.9935 12.9942L22.4789 9.45729L22.4789 12.1031Z" fill="white"/>';function pt(n,t,e,s,i,r=16,o=16){const a=(-e-t)*($e/180),c=Math.sin(a),l=Math.cos(a),d=1*l-1*c,h=1*c+1*l;return`url("data:image/svg+xml,<svg height='32' width='32' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg' style='color: ${i};'><defs><filter id='shadow' y='-40%' x='-40%' width='180px' height='180%' color-interpolation-filters='sRGB'><feDropShadow dx='${d}' dy='${h}' stdDeviation='1.2' flood-opacity='.5'/></filter></defs><g fill='none' transform='rotate(${t+e} 16 16)${s?" scale(-1,-1) translate(0, -32)":""}' filter='url(%23shadow)'>`+n.replaceAll('"',"'")+`</g></svg>") ${r} ${o}, pointer`}const gp=["default","pointer","cross","move","grab","grabbing","text","zoom-in","zoom-out"],mp={none:()=>"none","ew-resize":(n,t,e)=>pt(Or,n,0,t,e),"ns-resize":(n,t,e)=>pt(Or,n,90,t,e),"nesw-resize":(n,t,e)=>pt(Lr,n,0,t,e),"nwse-resize":(n,t,e)=>pt(Lr,n,90,t,e),"nwse-rotate":(n,t,e)=>pt(zs,n,0,t,e),"nesw-rotate":(n,t,e)=>pt(zs,n,90,t,e),"senw-rotate":(n,t,e)=>pt(zs,n,180,t,e),"swne-rotate":(n,t,e)=>pt(zs,n,270,t,e)};function yp(n,t=0,e="black"){return mp[n](Dd(t),!1,e)}function Sp(){const n=K(),t=Dt(),e=ma();Et("useCursor",()=>{const{type:s,rotation:i}=n.getInstanceState().cursor;if(gp.includes(s)){t.style.setProperty("--tl-cursor",`var(--tl-cursor-${s})`);return}t.style.setProperty("--tl-cursor",yp(s,i,e?"white":"black"))},[n,t,e])}function wp(){const n=K(),t=Dt(),e=ma(),s=$(Ce.forceSrgb);dt.useEffect(()=>{e?(t.setAttribute("data-color-mode","dark"),t.classList.remove("tl-theme__light"),t.classList.add("tl-theme__dark")):(t.setAttribute("data-color-mode","light"),t.classList.remove("tl-theme__dark"),t.classList.add("tl-theme__light")),s?t.classList.add("tl-theme__force-sRGB"):t.classList.remove("tl-theme__force-sRGB")},[n,t,s,e])}function bp(n){const t=k.useRef();return k.useLayoutEffect(()=>{t.current=n}),k.useDebugValue(n),k.useCallback((...e)=>{const s=t.current;return de(s,"fn does not exist"),s(...e)},[])}function xp(){const[n,t]=k.useState(0);k.useEffect(()=>t(e=>e+1),[])}const Ip=n=>n.props.src,vp={upload:(n,t)=>Vr.blobToDataUrl(t)};function Pp(n){return"schema"in n&&n.schema?n.schema:wd({shapes:"shapeUtils"in n&&n.shapeUtils?Fr(ua(n.shapeUtils)):void 0,bindings:"bindingUtils"in n&&n.bindingUtils?Fr(ca(n.bindingUtils)):void 0,migrations:"migrations"in n?n.migrations:void 0})}function on({initialData:n,defaultName:t="",id:e,assets:s=vp,onMount:i,collaboration:r,...o}={}){const a=Pp(o),c=new di({id:e,schema:a,initialData:n,props:{defaultName:t,assets:{upload:s.upload,resolve:s.resolve??Ip},onMount:l=>{de(l instanceof L),i==null||i(l)},collaboration:r}});if(o.snapshot){if(n)throw new Error("Cannot provide both initialData and snapshot");aa(c,o.snapshot)}return c}function Fr(n){return Object.fromEntries(n.map(t=>[t.type,{props:t.props,migrations:t.migrations}]))}const Cp="TLDRAW_DOCUMENT_v2",Ep="TLDRAW_ASSET_STORE_v1",ya="TLDRAW_DB_NAME_INDEX_v2",X={Records:"records",Schema:"schema",SessionState:"session_state",Assets:"assets"};async function Sa(n){const t=Cp+n;return kp(t),await zr(t,4,{upgrade(e){e.objectStoreNames.contains(X.Records)||e.createObjectStore(X.Records),e.objectStoreNames.contains(X.Schema)||e.createObjectStore(X.Schema),e.objectStoreNames.contains(X.SessionState)||e.createObjectStore(X.SessionState),e.objectStoreNames.contains(X.Assets)||e.createObjectStore(X.Assets)}})}async function _p(n){const t=window.indexedDB.databases?(await window.indexedDB.databases()).map(p=>p.name):Ri(),e=Ep+n;if(!t.find(p=>p===e))return;const i=await zr(e,1,{upgrade(p){p.objectStoreNames.contains("assets")||p.createObjectStore("assets")}}),r=i.transaction(["assets"],"readonly"),o=r.objectStore("assets"),a=await o.getAllKeys(),c=await Promise.all(a.map(async p=>[p,await o.get(p)]));await r.done;const l=await Sa(n),d=l.transaction([X.Assets],"readwrite"),h=d.objectStore(X.Assets);for(const[p,f]of c)h.put(f,p);await d.done,i.close(),l.close(),await Br(e)}const fs=class fs{constructor(t){u(this,"getDbPromise");u(this,"isClosed",!1);u(this,"pendingTransactionSet",new Set);fs.connectedInstances.add(this),this.getDbPromise=(async()=>(await _p(t),await Sa(t)))()}getDb(){return this.getDbPromise}pending(){return Promise.allSettled([this.getDbPromise,...this.pendingTransactionSet]).then(ri)}async close(){this.isClosed||(this.isClosed=!0,await this.pending(),(await this.getDb()).close(),fs.connectedInstances.delete(this))}tx(t,e,s){const i=(async()=>{de(!this.isClosed,"db is closed");const o=(await this.getDb()).transaction(e,t),a=o.done.catch(c=>{if(!this.isClosed)throw c});try{return await s(o)}finally{this.isClosed?o.abort():await a}})();return this.pendingTransactionSet.add(i),i.finally(()=>this.pendingTransactionSet.delete(i)),i}async load({sessionId:t}={}){return await this.tx("readonly",[X.Records,X.Schema,X.SessionState],async e=>{var c,l;const s=e.objectStore(X.Records),i=e.objectStore(X.Schema),r=e.objectStore(X.SessionState);let o=t?(c=await r.get(t))==null?void 0:c.snapshot:null;return o||(o=(l=(await r.getAll()).sort((h,p)=>h.updatedAt-p.updatedAt).pop())==null?void 0:l.snapshot),{records:await s.getAll(),schema:await i.get(X.Schema),sessionStateSnapshot:o}})}async storeChanges({schema:t,changes:e,sessionId:s,sessionStateSnapshot:i}){await this.tx("readwrite",[X.Records,X.Schema,X.SessionState],async r=>{const o=r.objectStore(X.Records),a=r.objectStore(X.Schema),c=r.objectStore(X.SessionState);for(const[l,d]of Object.entries(e.added))await o.put(d,l);for(const[l,d]of Object.values(e.updated))await o.put(d,d.id);for(const l of Object.keys(e.removed))await o.delete(l);a.put(t.serialize(),X.Schema),i&&s?c.put({snapshot:i,updatedAt:Date.now(),id:s},s):(i||s)&&console.error("sessionStateSnapshot and instanceId must be provided together")})}async storeSnapshot({schema:t,snapshot:e,sessionId:s,sessionStateSnapshot:i}){await this.tx("readwrite",[X.Records,X.Schema,X.SessionState],async r=>{const o=r.objectStore(X.Records),a=r.objectStore(X.Schema),c=r.objectStore(X.SessionState);await o.clear();for(const[l,d]of Object.entries(e))await o.put(d,l);a.put(t.serialize(),X.Schema),i&&s?c.put({snapshot:i,updatedAt:Date.now(),id:s},s):(i||s)&&console.error("sessionStateSnapshot and instanceId must be provided together")})}async pruneSessions(){await this.tx("readwrite",[X.SessionState],async t=>{const e=t.objectStore(X.SessionState),s=(await e.getAll()).sort((r,o)=>r.updatedAt-o.updatedAt);if(s.length<10){await t.done;return}const i=s.slice(0,s.length-10);for(const{id:r}of i)await e.delete(r)})}async getAsset(t){return await this.tx("readonly",[X.Assets],async e=>await e.objectStore(X.Assets).get(t))}async storeAsset(t,e){await this.tx("readwrite",[X.Assets],async s=>{await s.objectStore(X.Assets).put(e,t)})}};u(fs,"connectedInstances",new Set);let an=fs;function Ri(){const n=JSON.parse(ao(ya)||"[]")??[];return Array.isArray(n)?n:[]}function kp(n){const t=new Set(Ri());t.add(n),co(ya,JSON.stringify([...t]))}function Tp(){window.alert(`Oops! We could not save changes to your browser's storage. We now need to reload the page and try again.

Keep seeing this message?
• If you're using tldraw in a private or "incognito" window, try loading tldraw in a regular window or in a different browser.
• If your hard disk is full, try clearing up some space and then reload the page.`)}function Mp(){window.alert(`Oops! We could not access your browser's storage—and the app won't work correctly without that. We now need to reload the page and try again.

Keep seeing this message?
• If you're using tldraw in a private or "incognito" window, try loading tldraw in a regular window or in a different browser.`)}const Ap=350,Dp=1e4,jr=Symbol("UPDATE_INSTANCE_STATE"),Rp=n=>n;class Lp{constructor(t){u(this,"onmessage")}postMessage(t){}close(){}}const Op=typeof BroadcastChannel>"u"?Lp:BroadcastChannel;class Fp{constructor(t,{persistenceKey:e,sessionId:s=rn,onLoad:i,onLoadError:r},o=new Op(`tldraw-tab-sync-${e}`)){u(this,"disposables",new Set);u(this,"diffQueue",[]);u(this,"didDispose",!1);u(this,"shouldDoFullDBWrite",!0);u(this,"isReloading",!1);u(this,"persistenceKey");u(this,"sessionId");u(this,"serializedSchema");u(this,"isDebugging",!1);u(this,"documentTypes");u(this,"$sessionStateSnapshot");u(this,"db");u(this,"initTime",Date.now());u(this,"isPersisting",!1);u(this,"didLastWriteError",!1);u(this,"scheduledPersistTimeout",null);this.store=t,this.channel=o,typeof window<"u"&&(window.tlsync=this),this.persistenceKey=e,this.sessionId=s,this.db=new an(e),this.disposables.add(()=>this.db.close()),this.serializedSchema=this.store.schema.serialize(),this.$sessionStateSnapshot=ra(this.store),this.disposables.add(t.listen(({changes:a})=>{this.diffQueue.push(a),this.channel.postMessage(Rp({type:"diff",storeId:this.store.id,changes:a,schema:this.serializedSchema})),this.schedulePersist()},{source:"user",scope:"document"})),this.disposables.add(t.listen(()=>{this.diffQueue.push(jr),this.schedulePersist()},{scope:"session"})),this.connect(i,r),this.documentTypes=new Set(Object.values(this.store.schema.types).filter(a=>a.scope==="document").map(a=>a.typeName))}debug(...t){this.isDebugging&&console.debug(...t)}async connect(t,e){this.debug("connecting");let s;try{s=await this.db.load({sessionId:this.sessionId})}catch(i){e(i),Mp();return}if(this.debug("loaded data from store",s,"didDispose",this.didDispose),!this.didDispose)try{if(s){const i=Object.fromEntries(s.records.map(a=>[a.id,a])),r=s.sessionStateSnapshot??du(i),o=this.store.schema.migrateStoreSnapshot({store:i,schema:s.schema??this.store.schema.serializeEarliestVersion()});if(o.type==="error"){console.error("failed to migrate store",o),e(new Error(`Failed to migrate store: ${o.reason}`));return}this.store.mergeRemoteChanges(()=>{this.store.put(Object.values(o.value).filter(a=>this.documentTypes.has(a.typeName)),"initialize")}),r&&oa(this.store,r)}this.channel.onmessage=({data:i})=>{var a,c;this.debug("got message",i);const r=i,o=this.store.schema.getMigrationsSince(r.schema);if(o.ok){if(o.value.length>0){this.debug("telling them to reload"),this.channel.postMessage({type:"announce",schema:this.serializedSchema}),this.shouldDoFullDBWrite=!0,this.persistIfNeeded();return}}else{if(Date.now()-this.initTime<5e3){e(new Error("Schema mismatch, please close other tabs and reload the page"));return}this.debug("reloading"),this.isReloading=!0,(c=(a=window==null?void 0:window.location)==null?void 0:a.reload)==null||c.call(a);return}r.type==="diff"&&(this.debug("applying diff"),ut(()=>{this.store.mergeRemoteChanges(()=>{this.store.applyDiff(r.changes),this.store.ensureStoreIsUsable()})}))},this.channel.postMessage({type:"announce",schema:this.serializedSchema}),this.disposables.add(()=>{this.channel.close()}),t(this)}catch(i){if(this.debug("error loading data from store",i),this.didDispose)return;e(i);return}}close(){this.debug("closing"),this.didDispose=!0,this.disposables.forEach(t=>t())}schedulePersist(){this.debug("schedulePersist",this.scheduledPersistTimeout),!this.scheduledPersistTimeout&&(this.scheduledPersistTimeout=setTimeout(()=>{this.scheduledPersistTimeout=null,this.persistIfNeeded()},this.didLastWriteError?Dp:Ap))}persistIfNeeded(){this.debug("persistIfNeeded",{isPersisting:this.isPersisting,isReloading:this.isReloading,shouldDoFullDBWrite:this.shouldDoFullDBWrite,diffQueueLength:this.diffQueue.length,storeIsPossiblyCorrupt:this.store.isPossiblyCorrupted()}),this.scheduledPersistTimeout&&(clearTimeout(this.scheduledPersistTimeout),this.scheduledPersistTimeout=null),!this.isPersisting&&(this.isReloading||this.store.isPossiblyCorrupted()||(this.shouldDoFullDBWrite||this.diffQueue.length>0)&&this.doPersist())}async doPersist(){if(de(!this.isPersisting,"persist already in progress"),this.didDispose)return;this.isPersisting=!0,this.debug("doPersist start");const t=this.diffQueue;this.diffQueue=[];try{if(this.shouldDoFullDBWrite)this.shouldDoFullDBWrite=!1,await this.db.storeSnapshot({schema:this.store.schema,snapshot:this.store.serialize(),sessionId:this.sessionId,sessionStateSnapshot:this.$sessionStateSnapshot.get()});else{const e=li(t.filter(s=>s!==jr));await this.db.storeChanges({changes:e,schema:this.store.schema,sessionId:this.sessionId,sessionStateSnapshot:this.$sessionStateSnapshot.get()})}this.didLastWriteError=!1}catch(e){this.shouldDoFullDBWrite=!0,this.didLastWriteError=!0,console.error("failed to store changes in indexed db",e),Tp(),typeof window<"u"&&window.location.reload()}this.isPersisting=!1,this.debug("doPersist end"),this.schedulePersist()}}function wa(n){const t=k.useRef(n),[e,s]=k.useState(n);e!==t.current&&s(t.current);const i=k.useCallback(r=>{typeof r=="function"?t.current=r(t.current):t.current=r,s(t.current)},[]);return[e,i]}function jp(n){const[t,e]=wa({status:"loading"});return n=Yo(n),k.useEffect(()=>{const{persistenceKey:s,sessionId:i,...r}=n;if(!s){e({status:"not-synced",store:on(r)});return}e({status:"loading"});const o=new gs,a={upload:async(h,p)=>(await d.db.storeAsset(h.id,p),h.id),resolve:async h=>h.props.src?h.props.src.startsWith("asset:")?await o.get(h,async()=>{const p=await d.db.getAsset(h.id);return p?URL.createObjectURL(p):null}):h.props.src:null,...r.assets},c=on({...r,assets:a});let l=!1;const d=new Fp(c,{sessionId:i,persistenceKey:s,onLoad(){l||e({store:c,status:"synced-local"})},onLoadError(h){l||e({status:"error",error:h})}});return()=>{l=!0,d.close()}},[n,e]),t}function zp(){const n=K(),t=Dt();k.useEffect(()=>{const e=r=>t.style.setProperty("--tl-zoom",r.toString()),s=tc(e,100),i=new Xt("useZoomCss",()=>{n.getCurrentPageShapeIds().size<300?e(n.getZoomLevel()):s(n.getZoomLevel())});return i.attach(),i.execute(),()=>{i.detach(),s.cancel()}},[n,t])}function ei(n){const t=new ArrayBuffer(n.length),e=new Uint8Array(t);for(let s=0,i=n.length;s<i;s++)e[s]=n.charCodeAt(s);return t}function Bp(n){const t=atob(n),e=ei(t);return crypto.subtle.importKey("spki",new Uint8Array(e),{name:"ECDSA",namedCurve:"P-256"},!0,["verify"])}const Up=5,Xs={ANNUAL_LICENSE:1,PERPETUAL_LICENSE:2,INTERNAL_LICENSE:4},Np=Math.max(...Object.values(Xs)),cs={ID:0,HOSTS:1,FLAGS:2,EXPIRY_DATE:3},$p=Object.keys(cs).length,Bs="sales@tldraw.com";class Li{constructor(t,e,s){u(this,"publicKey","MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEHJh0uUfxHtCGyerXmmatE368Hd9rI6LH9oPDQihnaCryRFWEVeOvf9U/SPbyxX74LFyJs5tYeAHq5Nc0Ax25LQ");u(this,"isDevelopment");u(this,"isTest");u(this,"isCryptoAvailable");u(this,"state",fe("license state","pending"));this.isTest=!1,this.isDevelopment=this.getIsDevelopment(s),this.publicKey=e||this.publicKey,this.isCryptoAvailable=!!crypto.subtle,go.enableLicensing.get()?this.getLicenseFromKey(t).then(i=>{const r=Kp(i);this.state.set(r?"unlicensed":"licensed")}):this.state.set("licensed")}getIsDevelopment(t){return t==="development"?!0:t==="production"?!1:window.location.protocol!=="https:"}async extractLicenseKey(t){const[e,s]=t.split("."),[i,r]=e.split("/");if(!i.startsWith("tldraw-"))throw new Error(`Unsupported prefix '${i}'`);const o=await Bp(this.publicKey);let a;try{a=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,new Uint8Array(ei(atob(s))),new Uint8Array(ei(atob(r))))}catch(l){throw console.error(l),new Error("Could not perform signature validation")}if(!a)throw new Error("Invalid signature");let c;try{c=JSON.parse(atob(r))}catch{throw new Error("Could not parse object")}return c.length>$p&&this.outputMessages(["License key contains some unknown properties.","You may want to update tldraw packages to a newer version to get access to new functionality."]),{id:c[cs.ID],hosts:c[cs.HOSTS],flags:c[cs.FLAGS],expiryDate:c[cs.EXPIRY_DATE]}}async getLicenseFromKey(t){if(!t)return this.isDevelopment||this.outputNoLicenseKeyProvided(),{isLicenseParseable:!1,reason:"no-key-provided"};if(this.isDevelopment&&!this.isCryptoAvailable)return console.log("tldraw: you seem to be in a development environment that does not support crypto. License not verified."),console.log("You should check that this works in production separately."),{isLicenseParseable:!1,reason:"has-key-development-mode"};let e=t.replace(/[\u200B-\u200D\uFEFF]/g,"");e=e.replace(/\r?\n|\r/g,"");try{const s=await this.extractLicenseKey(e),i=new Date(s.expiryDate),r=this.isFlagEnabled(s.flags,Xs.ANNUAL_LICENSE),o=this.isFlagEnabled(s.flags,Xs.PERPETUAL_LICENSE),a={license:s,isLicenseParseable:!0,isDevelopment:this.isDevelopment,isDomainValid:this.isDomainValid(s),expiryDate:i,isAnnualLicense:r,isAnnualLicenseExpired:r&&this.isAnnualLicenseExpired(i),isPerpetualLicense:o,isPerpetualLicenseExpired:o&&this.isPerpetualLicenseExpired(i),isInternalLicense:this.isFlagEnabled(s.flags,Xs.INTERNAL_LICENSE)};return this.outputLicenseInfoIfNeeded(a),a}catch(s){return this.outputInvalidLicenseKey(s.message),{isLicenseParseable:!1,reason:"invalid-license-key"}}}isDomainValid(t){const e=window.location.hostname.toLowerCase();return t.hosts.some(s=>{const i=s.toLowerCase().trim();return i===e||`www.${i}`===e||i===`www.${e}`||s==="*"?!0:s.includes("*")?new RegExp(s.replace(/\*/g,".*?")).test(e):!1})}getExpirationDateWithoutGracePeriod(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate())}getExpirationDateWithGracePeriod(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate()+Up+1)}isAnnualLicenseExpired(t){const e=this.getExpirationDateWithGracePeriod(t),s=new Date>=e;return!s&&new Date>=this.getExpirationDateWithoutGracePeriod(t)&&this.outputMessages(["tldraw license is about to expire, you are in a grace period.",`Please reach out to ${Bs} if you would like to renew your license.`]),s}isPerpetualLicenseExpired(t){const e=this.getExpirationDateWithGracePeriod(t),s={major:new Date(hr.major),minor:new Date(hr.minor)};return s.major>=e||s.minor>=e}isFlagEnabled(t,e){return(t&e)===e}outputNoLicenseKeyProvided(){this.outputMessages(["No tldraw license key provided!",`Please reach out to ${Bs} if you would like to license tldraw or if you'd like a trial.`])}outputInvalidLicenseKey(t){this.outputMessages(["Invalid tldraw license key",`Reason: ${t}`])}outputLicenseInfoIfNeeded(t){t.isAnnualLicenseExpired&&this.outputMessages(["Your tldraw license has expired!",`Please reach out to ${Bs} to renew.`]),!t.isDomainValid&&!t.isDevelopment&&this.outputMessages(["This tldraw license key is not valid for this domain!",`Please reach out to ${Bs} if you would like to use tldraw on other domains.`]),t.license.flags>=Np*2&&this.outputMessages(["This tldraw license contains some unknown flags.","You may want to update tldraw packages to a newer version to get access to new functionality."])}outputMessages(t){if(!this.isTest){this.outputDelimiter();for(const e of t)console.log(`%c${e}`,"color: white; background: crimson; padding: 2px; border-radius: 3px;");this.outputDelimiter()}}outputDelimiter(){console.log("%c-------------------------------------------------------------------","color: white; background: crimson; padding: 2px; border-radius: 3px;")}}u(Li,"className","tl-watermark_SEE-LICENSE");function Kp(n){if(!n.isLicenseParseable||!n.isDomainValid&&!n.isDevelopment)return!0;if(n.isPerpetualLicenseExpired||n.isAnnualLicenseExpired){if(n.isInternalLicense)throw new Error("License: Internal license expired.");return!0}return!1}const ba=k.createContext({}),Hp=()=>k.useContext(ba);function Yp({licenseKey:n,children:t}){const[e]=k.useState(()=>new Li(n));return y.jsx(ba.Provider,{value:e,children:t})}const Gp='<svg xmlns="http://www.w3.org/2000/svg" width="3001" height="1000" fill="none"><path fill="#000" d="M590.656 300.449c0 49.706-40.294 90-90 90-49.705 0-90-40.294-90-90 0-49.705 40.295-90 90-90 49.706 0 90 40.295 90 90M569.431 719.011c-15.247 32.821-56.006 91.589-98.338 91.438-32.004-.115-38.642-30.904-17.414-50.856 17.381-16.337 28.246-48.075 31.995-72.719.415-2.728-1.556-5.197-4.272-5.679-39.666-7.04-70.746-40.877-70.746-83.417 0-48.23 38.983-87.329 87.07-87.329 39.936 0 70.172 22.237 83.369 52.397 18.839 43.055 7.117 115.733-11.664 156.165M2613.29 385.681V239.319c0-11.363 9.22-20.569 20.59-20.569h8.26c11.37 0 20.59 9.206 20.59 20.569v36.911c0 8.629 7 15.625 15.63 15.625h35.25c8.63 0 15.63-6.996 15.63-15.625v-36.911c0-11.363 9.22-20.569 20.59-20.569h8.17c11.37 0 20.59 9.206 20.59 20.569v146.362c0 11.363-9.22 20.569-20.59 20.569h-8.17c-11.37 0-20.59-9.206-20.59-20.569v-36.999c0-8.63-7-15.625-15.63-15.625h-35.25c-8.63 0-15.63 6.995-15.63 15.625v36.999c0 11.363-9.22 20.569-20.59 20.569h-8.26c-11.37 0-20.59-9.206-20.59-20.569M2391.97 239.319v146.362c0 11.348-9.16 20.569-20.49 20.569h-8.2c-11.33 0-20.49-9.221-20.49-20.569V239.319c0-11.348 9.16-20.569 20.49-20.569h8.2c11.33 0 20.49 9.221 20.49 20.569M2098.23 391.43l-42.69-146.361c-3.85-13.171 6.06-26.319 19.79-26.319h10.6c9.59 0 17.93 6.611 20.08 15.952l17.01 73.045c1.48 6.348 10.47 6.478 12.14.176l19.47-73.838c2.38-9.04 10.57-15.335 19.93-15.335h12.1c9.37 0 17.56 6.3 19.94 15.346l19.49 74.067c1.66 6.305 10.65 6.178 12.13-.171l17.09-73.294c2.15-9.339 10.49-15.948 20.08-15.948h10.53c13.72 0 23.63 13.141 19.79 26.31l-42.63 146.361c-2.56 8.789-10.63 14.829-19.79 14.829h-15.68c-9.12 0-17.16-5.98-19.76-14.709l-21.17-71.059c-1.77-5.948-10.19-5.957-11.97-.012l-21.33 71.071c-2.6 8.729-10.64 14.709-19.76 14.709h-15.59c-9.17 0-17.23-6.035-19.8-14.82M2443.23 218.75h118.59c11.38 0 20.62 9.195 20.62 20.557s-9.24 20.556-20.62 20.556h-24.79c-5.53 0-10 4.477-10 10v115.818c0 11.368-9.25 20.569-20.63 20.569h-7.65c-11.39 0-20.63-9.201-20.63-20.569V269.863c0-5.523-4.48-10-10-10h-24.89c-11.37 0-20.61-9.195-20.61-20.556s9.24-20.557 20.61-20.557M1174.15 218.75h24.64c8.35 0 15.88 5.042 19.04 12.764l34.61 83.942c2.13 5.161 9.44 5.155 11.56-.01l34.43-83.932a20.58 20.58 0 0 1 19.04-12.764h24.64c11.37 0 20.58 9.208 20.58 20.569v146.362c0 11.361-9.21 20.569-20.58 20.569h-7.09c-11.36 0-20.58-9.208-20.58-20.569l-.12-50.645c-.01-6.888-9.53-8.688-12.06-2.283l-23.46 59.332a20.57 20.57 0 0 1-19.14 13.009h-3.03a20.57 20.57 0 0 1-19.15-13.046l-23.47-59.68c-2.52-6.416-12.05-4.623-12.06 2.271l-.13 51.042c0 11.361-9.21 20.569-20.57 20.569h-7.1c-11.36 0-20.57-9.208-20.57-20.569V239.319c0-11.361 9.21-20.569 20.57-20.569"/><path fill="#000" fill-rule="evenodd" d="m1449.94 391.836 6.12-19.392a6.255 6.255 0 0 1 5.96-4.369l50.22-.061a6.24 6.24 0 0 1 5.96 4.348l6.23 19.486c2.71 8.581 10.71 14.402 19.74 14.402h9.34c14.13 0 24.15-13.791 19.61-27.151l-49.74-146.361c-2.85-8.37-10.74-13.988-19.61-13.988h-33.16c-8.87 0-16.77 5.618-19.61 13.988l-49.74 146.361c-4.54 13.36 5.48 27.151 19.61 27.151h9.32c9.04 0 17.04-5.827 19.75-14.414m31.1-98.858c1.85-5.807 10.08-5.796 11.91.016l8.83 27.916c1.28 4.028-1.73 8.134-5.96 8.134h-17.74c-4.23 0-7.24-4.119-5.95-8.151zM1681.81 406.25c18.91 0 35.39-3.686 49.36-11.168 13.97-7.544 24.73-18.394 32.24-32.489 7.56-14.105 11.29-30.866 11.29-50.182 0-19.256-3.73-35.957-11.29-50.004-7.57-14.094-18.35-24.912-32.32-32.397-13.91-7.545-30.4-11.26-49.37-11.26h-49.5c-11.38 0-20.63 9.201-20.63 20.569v146.362c0 11.368 9.25 20.569 20.63 20.569zm23.13-47.701c-6.62 3.215-14.85 4.886-24.79 4.886-10.49 0-19-8.507-19-19v-64.34c0-10.149 8.23-18.376 18.38-18.376 10.18 0 18.56 1.703 25.23 4.974 6.59 3.149 11.63 8.315 15.08 15.633 3.45 7.269 5.28 17.268 5.28 30.162 0 12.891-1.82 22.951-5.28 30.347-3.39 7.319-8.36 12.509-14.9 15.714" clip-rule="evenodd"/><path fill="#000" d="M1804.21 385.681V239.319c0-11.361 9.21-20.569 20.58-20.569h91.28c11.36 0 20.57 9.202 20.57 20.557s-9.21 20.556-20.57 20.556h-54.64a7.807 7.807 0 0 0-7.81 7.813v16.366a7.806 7.806 0 0 0 7.81 7.812h48.13c11.37 0 20.58 9.246 20.58 20.602s-9.21 20.601-20.58 20.601h-48.13a7.806 7.806 0 0 0-7.81 7.812v16.455a7.807 7.807 0 0 0 7.81 7.813h54.64c11.36 0 20.57 9.202 20.57 20.556s-9.21 20.557-20.57 20.557h-91.28c-11.37 0-20.58-9.208-20.58-20.569"/><path fill="#000" fill-rule="evenodd" d="M2875.5 68.75h-2750c-31.066 0-56.25 25.184-56.25 56.25v750c0 31.066 25.184 56.25 56.25 56.25h2750c31.07 0 56.25-25.184 56.25-56.25V125c0-31.066-25.18-56.25-56.25-56.25M125.5 0C56.464 0 .5 55.964.5 125v750c0 69.036 55.965 125 125 125h2750c69.04 0 125-55.964 125-125V125c0-69.036-55.96-125-125-125z" clip-rule="evenodd"/><path fill="#000" d="M2476.06 804.813c-10.54 0-19.82-6.947-22.81-17.068L2390.79 575.7c-4.49-15.248 6.92-30.534 22.8-30.534h27.75c11.1 0 20.72 7.686 23.18 18.52L2489 671.402c2.07 9.093 14.93 9.321 17.32.308l28.83-108.844c2.76-10.435 12.19-17.7 22.98-17.7h25.17c10.8 0 20.25 7.293 22.99 17.755l28.27 107.739c2.36 9.001 15.18 8.829 17.3-.232l25.01-106.888c2.51-10.763 12.1-18.374 23.14-18.374h27.87c15.88 0 27.29 15.286 22.8 30.534l-62.46 212.045a23.78 23.78 0 0 1-22.81 17.068h-32.12c-10.39 0-19.58-6.763-22.69-16.696l-32.08-102.694c-2.62-8.397-14.51-8.331-17.04.095l-30.74 102.346c-3.02 10.061-12.27 16.949-22.76 16.949zM1742.44 804.813h-75.81c-13.09 0-23.71-10.656-23.71-23.801V568.967c0-13.145 10.62-23.801 23.71-23.801h74.8c26.6 0 49.59 5.198 68.95 15.594 19.45 10.312 34.44 25.187 44.96 44.627 10.61 19.355 15.91 42.556 15.91 69.602q0 40.57-15.78 69.73c-10.53 19.355-25.43 34.231-44.71 44.627-19.28 10.311-42.05 15.467-68.32 15.467m-29.3-83.642c0 13.145 10.61 23.801 23.71 23.801h3.06c12.8 0 23.7-2.07 32.71-6.212 9.09-4.141 16-11.283 20.71-21.426q7.2-15.213 7.2-42.345 0-27.13-7.32-42.344c-4.8-10.143-11.87-17.285-21.22-21.426-9.26-4.142-20.63-6.212-34.1-6.212h-1.04c-13.1 0-23.71 10.656-23.71 23.801zM1460.86 804.813c-13.12 0-23.76-10.656-23.76-23.801V568.967c0-13.145 10.64-23.801 23.76-23.801h22.84c13.13 0 23.76 10.656 23.76 23.801v155.247c0 13.145 10.64 23.801 23.76 23.801h57.27c13.12 0 23.76 10.656 23.76 23.801v9.196c0 13.145-10.64 23.801-23.76 23.801zM1204.45 601.964c-13.13 0-23.77-10.656-23.77-23.801v-9.196c0-13.145 10.64-23.801 23.77-23.801h177.89c13.13 0 23.78 10.656 23.78 23.801v9.196c0 13.145-10.65 23.801-23.78 23.801h-39.38c-8.21 0-14.86 6.66-14.86 14.875v164.173c0 13.145-10.64 23.801-23.78 23.801h-21.85c-13.13 0-23.78-10.656-23.78-23.801V616.839c0-8.215-6.65-14.875-14.86-14.875z"/><path fill="#000" fill-rule="evenodd" d="M2223.05 787.891c-3.02 10.047-12.27 16.922-22.74 16.922h-25.43c-16.19 0-27.64-15.862-22.57-31.261l69.88-212.045c3.21-9.753 12.31-16.341 22.56-16.341h61.84c10.25 0 19.35 6.588 22.56 16.341l69.87 212.045c5.08 15.399-6.37 31.261-22.56 31.261h-25.43c-10.48 0-19.72-6.875-22.74-16.922l-6.7-22.2a14.84 14.84 0 0 0-14.21-10.576h-63.42c-6.55 0-12.32 4.296-14.22 10.576zm76.13-96.945-14.13-48.436c-2.46-8.451-14.36-8.602-17.04-.217l-15.46 48.436c-1.84 5.759 2.45 11.645 8.48 11.645h29.6c5.94 0 10.22-5.715 8.55-11.428" clip-rule="evenodd"/><path fill="#000" d="M1939.6 804.813c-13.13 0-23.77-10.656-23.77-23.801V568.967c0-13.145 10.64-23.801 23.77-23.801h88.13c19.24 0 36.08 3.508 50.51 10.523s25.65 17.115 33.67 30.3q12.03 19.779 12.03 47.416c0 18.595-4.14 34.273-12.41 47.036-7.64 11.913-18.18 21.101-31.63 27.564-16.98 8.159-36 11.104-54.7 11.104h-43.07c-76.56 0 4.08-135.84 4.08-84.706v7.996c0 12.117 9.81 21.941 21.91 21.941 8.12 0 16.3-.345 24.04-3.043 5.91-2.113 10.43-5.451 13.55-10.015 3.2-4.565 4.81-10.523 4.81-17.877 0-7.437-1.61-13.481-4.81-18.129-3.12-4.733-7.64-8.199-13.55-10.396-7.05-2.766-14.67-3.423-22.18-3.423-13.13 0-23.77 10.656-23.77 23.801v47.71c0 11.825 11.14 16.003 19.91 20.752 12.31 6.671 7.58 25.389-6.42 25.389-7.45 0-13.49 6.048-13.49 13.508v48.395c0 13.145-10.63 23.801-23.76 23.801zm134.89-106.758 5.41 9.95 33.51 61.622c8.62 15.86-2.84 35.186-20.87 35.186h-22.27c-8.74 0-16.77-4.798-20.92-12.496l-35.05-65.04a15.52 15.52 0 0 0-13.66-8.168c-42.24 0 40.62-82.154 73.85-21.054M931.652 0h68.748v1000h-68.748z"/></svg>',Xp=`${xu()}/watermarks/watermark-desktop.svg`,Us=`data:image/svg+xml;utf8,${encodeURIComponent(Gp)}`;let zn=null;async function qp(n){return n?Us:(zn||(zn=Promise.race([(async()=>{try{const t=await ln(Xp);if(!t.ok)return Us;const e=await t.blob();return URL.createObjectURL(e)}catch{return Us}})(),new Promise(t=>{setTimeout(()=>{t(Us)},3e3)})])),zn)}const Wp=dt.memo(function({forceLocal:t=!1}){const e=zo(),s=K(),i=Hp(),r=$("show watermark",()=>go.enableLicensing.get()&&s.getViewportScreenBounds().width>760&&i.state.get()==="unlicensed",[s,i]),o=$("debug mode",()=>s.getInstanceState().isDebugMode,[s]),a=$("is menu open",()=>s.getIsMenuOpen(),[s]),[c,l]=k.useState(null),d=t||i.isDevelopment;if(k.useEffect(()=>{if(!r)return;let f=!1;return(async()=>{const S=await qp(d);f||l(S)})(),()=>{f=!0}},[d,r]),!r||!c)return null;const h=Li.className,p=`url('${c}') center 100% / 100% no-repeat`;return y.jsxs(y.Fragment,{children:[y.jsx("style",{children:`
/* ------------------- SEE LICENSE -------------------
The tldraw watermark is part of tldraw's license. It is shown for unlicensed
users. By using this library, you agree to keep the watermark's behavior, 
keeping it visible, unobscured, and available to user-interaction.

To remove the watermark, please purchase a license at tldraw.dev.
*/

.${h} {
	position: absolute;
	bottom: var(--space-2);
	right: var(--space-2);
	width: 96px;
	height: 32px;
	z-index: 2147483647 !important;
	pointer-events: ${a?"none":"all"};
	background-color: color-mix(in srgb, var(--color-background) 62%, transparent);
	border-radius: 5px;
	padding: 2px;
	box-sizing: content-box;
}

.${h}[data-debug='true'] {
	bottom: 46px;
}

.${h} > a {
	position: absolute;
	width: 96px;
	height: 32px;
	pointer-events: none;
	cursor: inherit;
	color: var(--color-text);
	background-color: currentColor;
	opacity: .28;
}

@media (hover: hover) {
	.${h}:hover {
		background-color: var(--color-background);
		transition: background-color 0.2s ease-in-out;
		transition-delay: 0.32s;
	}
	.${h}:hover > a {
		animation: delayed_link 0.2s forwards ease-in-out;
		animation-delay: 0.32s;
	}
}

@keyframes delayed_link {
	0% {
		cursor: inherit;
		opacity: .38;
		pointer-events: none;
	}
	100% {
		cursor: pointer;
		opacity: 1;
		pointer-events: all;
	}
}
`}),y.jsx("div",{className:h,"data-debug":o,draggable:!1,...e,children:y.jsx("a",{href:"https://tldraw.dev",target:"_blank",rel:"noreferrer",draggable:!1,onPointerDown:vs,style:{mask:p,WebkitMask:p}})})]})}),Vp=[],Zp=[],Qp=[],Jp="tl-container",Jf=k.memo(function({store:t,components:e,className:s,user:i,...r}){const[o,a]=dt.useState(null),c=k.useMemo(()=>i??sa(),[i]),l=(e==null?void 0:e.ErrorFallback)===void 0?Xo:e==null?void 0:e.ErrorFallback,d={...r,shapeUtils:r.shapeUtils??Vp,bindingUtils:r.bindingUtils??Zp,tools:r.tools??Qp,components:e};return y.jsx("div",{ref:a,"data-tldraw":Fo,draggable:!1,className:be(`${Jp} tl-theme__light`,s),onPointerDown:vs,tabIndex:-1,children:y.jsx(Ss,{fallback:l,onError:h=>oi(h,{tags:{origin:"react.tldraw-before-app"}}),children:o&&y.jsx(Yp,{licenseKey:r.licenseKey,children:y.jsx(jd,{container:o,children:y.jsx(Zh,{overrides:e,children:t?t instanceof di?y.jsx(Ia,{...d,store:t,user:c}):y.jsx(xa,{...d,store:t,user:c}):y.jsx(ef,{...d,store:t,user:c})})})})})})});function ef(n){const{defaultName:t,snapshot:e,initialData:s,shapeUtils:i,bindingUtils:r,persistenceKey:o,sessionId:a,user:c,assets:l}=n,d=jp({shapeUtils:i,bindingUtils:r,initialData:s,persistenceKey:o,sessionId:a,defaultName:t,snapshot:e,assets:l});return y.jsx(xa,{...n,store:d,user:c})}const xa=k.memo(function({store:t,user:e,...s}){const i=Dt();k.useLayoutEffect(()=>{e.userPreferences.get().colorScheme==="dark"&&(i.classList.remove("tl-theme__light"),i.classList.add("tl-theme__dark"))},[i,e]);const{LoadingScreen:r}=ce();switch(t.status){case"error":throw t.error;case"loading":return r?y.jsx(r,{}):null}return y.jsx(Ia,{...s,store:t.store,user:e})}),Bn=()=>document.location.search.includes("tldraw_preserve_focus");function Ia({onMount:n,children:t,store:e,tools:s,shapeUtils:i,bindingUtils:r,user:o,initialState:a,autoFocus:c=!0,inferDarkMode:l,cameraOptions:d,options:h,licenseKey:p}){const{ErrorFallback:f}=ce(),S=Dt(),[g,w]=wa(null),b=k.useRef({autoFocus:c&&!Bn(),inferDarkMode:l,initialState:a,cameraOptions:d});k.useLayoutEffect(()=>{b.current={autoFocus:c&&!Bn(),inferDarkMode:l,initialState:a,cameraOptions:d}},[c,l,a,d]),k.useLayoutEffect(()=>{const{autoFocus:_,inferDarkMode:T,initialState:A,cameraOptions:M}=b.current,F=new L({store:e,shapeUtils:i,bindingUtils:r,tools:s,getContainer:()=>S,user:o,initialState:A,autoFocus:_,inferDarkMode:T,cameraOptions:M,options:h,licenseKey:p});return w(F),()=>{F.dispose()}},[r,S,h,i,e,s,o,w,p]),k.useLayoutEffect(()=>{g&&d&&g.setCameraOptions(d)},[g,d]);const x=k.useSyncExternalStore(k.useCallback(_=>g?(g.on("crash",_),()=>g.off("crash",_)):()=>{},[g]),()=>(g==null?void 0:g.getCrashingError())??null);k.useEffect(function(){if(!g)return;function T(){g&&g.focus()}function A(){g&&g.blur()}if(c&&Bn())return g.getContainer().addEventListener("pointerdown",T),document.body.addEventListener("pointerdown",A),()=>{var M;(M=g.getContainer())==null||M.removeEventListener("pointerdown",T),document.body.removeEventListener("pointerdown",A)}},[g,c]);const{Canvas:I}=ce();return g?y.jsx(Ss,{fallback:f,onError:_=>g.annotateError(_,{origin:"react.tldraw",willCrashApp:!0}),children:x?y.jsx(sf,{crashingError:x}):y.jsx(wn.Provider,{value:g,children:y.jsxs(tf,{onMount:n,children:[t??(I?y.jsx(I,{}):null),y.jsx(Wp,{})]})})}):null}function tf({children:n,onMount:t}){return zp(),Sp(),wp(),xp(),rf(e=>{const s=e.store.props.onMount(e),i=t==null?void 0:t(e);return()=>{s==null||s(),i==null||i()}}),n}function sf({crashingError:n}){throw n}function nf({children:n}){return y.jsx("div",{className:"tl-loading",children:n})}function eg({children:n}){return y.jsx("div",{className:"tl-loading",children:n})}function rf(n){const t=K(),e=bp(s=>{let i;return s.run(()=>{i=n==null?void 0:n(s),s.emit("mount")},{history:"ignore"}),window.tldrawReady=!0,i});dt.useLayoutEffect(()=>{if(t)return e==null?void 0:e(t)},[t,e])}function tg({children:n,className:t="",...e}){return y.jsx("div",{...e,className:be("tl-html-container",t),children:n})}class Un{constructor(t){this.editor=t}}u(Un,"props"),u(Un,"migrations"),u(Un,"type");function of(n,t,e={}){const{newPoint:s,handle:i,scaleX:r,scaleY:o}=t,{minWidth:a=1,maxWidth:c=1/0,minHeight:l=1,maxHeight:d=1/0}=e;let h=n.props.w*r,p=n.props.h*o;const f=new m(0,0);if(h>0){if(h<a){switch(i){case"top_left":case"left":case"bottom_left":{f.x=h-a;break}case"top":case"bottom":{f.x=(h-a)/2;break}default:f.x=0}h=a}}else if(f.x=h,h=-h,h<a){switch(i){case"top_left":case"left":case"bottom_left":{f.x=-h;break}default:f.x=-a}h=a}if(p>0){if(p<l){switch(i){case"top_left":case"top":case"top_right":{f.y=p-l;break}case"right":case"left":{f.y=(p-l)/2;break}default:f.y=0}p=l}}else if(f.y=p,p=-p,p<l){switch(i){case"top_left":case"top":case"top_right":{f.y=-p;break}default:f.y=-l}p=l}const{x:S,y:g}=f.rot(n.rotation).add(s);return{...n,x:S,y:g,props:{w:Math.min(c,h),h:Math.min(d,p)}}}class sg extends ps{constructor(){super(...arguments);u(this,"onResize",(e,s)=>of(e,s))}getGeometry(e){return new da({width:e.props.w,height:e.props.h,isFilled:!0})}getHandleSnapGeometry(e){return{points:this.getGeometry(e).bounds.cornersAndCenter}}getInterpolatedProps(e,s,i){return{...s.props,w:zt(e.props.w,s.props.w,i),h:zt(e.props.h,s.props.h,i)}}}class va extends mt{constructor(){super(...arguments);u(this,"onPointerDown",e=>{this.parent.transition("pointing",e)});u(this,"onEnter",()=>{this.editor.setCursor({type:"cross",rotation:0})});u(this,"onCancel",()=>{this.editor.setCurrentTool("select")})}}u(va,"id","idle");class Pa extends mt{constructor(){super(...arguments);u(this,"markId","");u(this,"wasFocusedOnEnter",!1);u(this,"onEnter",()=>{this.wasFocusedOnEnter=!this.editor.getIsMenuOpen()});u(this,"onPointerMove",e=>{if(this.editor.inputs.isDragging){const{originPagePoint:s}=this.editor.inputs,i=this.parent.shapeType,r=$t();this.markId=`creating:${r}`,this.editor.mark(this.markId),this.editor.createShapes([{id:r,type:i,x:s.x,y:s.y,props:{w:1,h:1}}]).select(r),this.editor.setCurrentTool("select.resizing",{...e,target:"selection",handle:"bottom_right",isCreating:!0,creationCursorOffset:{x:1,y:1},onInteractionEnd:this.parent.id,onCreate:this.parent.onCreate})}});u(this,"onPointerUp",()=>{this.complete()});u(this,"onCancel",()=>{this.cancel()});u(this,"onComplete",()=>{this.complete()});u(this,"onInterrupt",()=>{this.cancel()})}complete(){const{originPagePoint:e}=this.editor.inputs;if(!this.wasFocusedOnEnter)return;this.editor.mark(this.markId);const s=this.parent.shapeType,i=$t();this.editor.mark(this.markId),this.editor.createShapes([{id:i,type:s,x:e.x,y:e.y}]);const r=this.editor.getShape(i);if(!r){this.cancel();return}let{w:o,h:a}=r.props;const c=new m(o/2,a/2),l=this.editor.getShapeParentTransform(r);l&&c.rot(-l.rotation());let d=1;this.editor.user.getIsDynamicResizeMode()&&(d=1/this.editor.getZoomLevel(),o*=d,a*=d,c.mul(d));const h=ue(r);h.x=r.x-c.x,h.y=r.y-c.y,h.props.w=o,h.props.h=a,"scale"in r.props&&(h.props.scale=d),this.editor.updateShape(h),this.editor.setSelectedShapes([i]),this.editor.getInstanceState().isToolLocked?this.parent.transition("idle"):this.editor.setCurrentTool("select.idle")}cancel(){this.parent.transition("idle")}}u(Pa,"id","pointing");class Nn extends mt{constructor(){super(...arguments);u(this,"onCreate")}}u(Nn,"id","box"),u(Nn,"initial","idle"),u(Nn,"children",()=>[va,Pa]);function ng(n){const t=K();return $("isEditing",()=>t.getEditingShapeId()===n,[t,n])}function ig(n){const t=K();return k.useMemo(function(){const i=l=>{if(l.isKilled)return;if(l.button===Ii){t.dispatch({type:"pointer",target:"selection",handle:n,name:"right_click",...Ge(l)});return}if(l.button!==0)return;const d=nn(l.currentTarget);function h(){d.removeEventListener("pointerup",h),Pi(d,l)}vi(d,l),d.addEventListener("pointerup",h),t.dispatch({name:"pointer_down",type:"pointer",target:"selection",handle:n,...Ge(l)}),vs(l)};let r,o;function a(l){l.isKilled||l.button===0&&(l.clientX===r&&l.clientY===o||(r=l.clientX,o=l.clientY,t.dispatch({name:"pointer_move",type:"pointer",target:"selection",handle:n,...Ge(l)})))}return{onPointerDown:i,onPointerMove:a,onPointerUp:l=>{l.isKilled||l.button===0&&t.dispatch({name:"pointer_up",type:"pointer",target:"selection",handle:n,...Ge(l)})}}},[t,n])}function rg(n){const[t,e]=k.useState(()=>({store:on(n),opts:n}));if(!so(t.opts,n)){const s={store:on(n),opts:n};return e(s),s.store}return t.store}const af=20,cf=8;function Oi(n,t=af){return Math.max(cf,Math.ceil(n/t))}class Ns extends xt{constructor(e){super({...e,isFilled:!1,isClosed:!1});u(this,"_center");u(this,"radius");u(this,"start");u(this,"end");u(this,"largeArcFlag");u(this,"sweepFlag");u(this,"measure");u(this,"angleStart");u(this,"angleEnd");const{center:s,sweepFlag:i,largeArcFlag:r,start:o,end:a}=e;if(o.equals(a))throw Error("Arc must have different start and end points.");this.angleStart=m.Angle(s,o),this.angleEnd=m.Angle(s,a),this.radius=m.Dist(s,o),this.measure=Rd(this.angleStart,this.angleEnd,i,r),this.start=o,this.end=a,this.sweepFlag=i,this.largeArcFlag=r,this._center=s}nearestPoint(e){const{_center:s,measure:i,radius:r,angleEnd:o,angleStart:a,start:c,end:l}=this,d=fr(i,a,o,s.angle(e));if(d<=0)return c;if(d>=1)return l;const h=s.clone().add(e.clone().sub(s).uni().mul(r));let p,f=1/0,S;for(const g of[c,l,h])S=m.Dist2(e,g),S<f&&(p=g,f=S);if(!p)throw Error("nearest point not found");return p}hitTestLineSegment(e,s){const{_center:i,radius:r,measure:o,angleStart:a,angleEnd:c}=this,l=In(e,s,i,r);return l===null?!1:l.some(d=>{const h=fr(o,a,c,i.angle(d));return h>=0&&h<=1})}getVertices(){const{_center:e,measure:s,length:i,radius:r,angleStart:o}=this,a=[];for(let c=0,l=Oi(Math.abs(i));c<l+1;c++){const d=c/l*s,h=o+d;a.push(xi(e,r,h))}return a}getSvgPathData(e=!0){const{start:s,end:i,radius:r,largeArcFlag:o,sweepFlag:a}=this;return`${e?`M${s.toFixed()}`:""} A${r} ${r} 0 ${o} ${a} ${i.toFixed()}`}getLength(){return this.measure*this.radius}}class og extends xt{constructor(e){super({isClosed:!0,...e});u(this,"_center");u(this,"radius");u(this,"x");u(this,"y");this.config=e;const{x:s=0,y:i=0,radius:r}=e;this.x=s,this.y=i,this._center=new m(r+s,r+i),this.radius=r}getBounds(){return new H(this.x,this.y,this.radius*2,this.radius*2)}getVertices(){const{_center:e,radius:s}=this,i=ae*s,r=[];for(let o=0,a=Oi(i);o<a;o++){const c=o/a*ae;r.push(xi(e,s,c))}return r}nearestPoint(e){const{_center:s,radius:i}=this;return s.equals(e)?m.AddXY(s,i,0):s.clone().add(e.clone().sub(s).uni().mul(i))}hitTestLineSegment(e,s,i=0){const{_center:r,radius:o}=this;return In(e,s,r,o+i)!==null}getSvgPathData(){const{_center:e,radius:s}=this;return`M${e.x+s},${e.y} a${s},${s} 0 1,0 ${s*2},0a${s},${s} 0 1,0 -${s*2},0`}}class cn extends Mi{constructor(e){const{start:s,cp1:i,cp2:r,end:o}=e;super({...e,points:[s,o]});u(this,"a");u(this,"b");u(this,"c");u(this,"d");this.a=s,this.b=i,this.c=r,this.d=o}getVertices(){const e=[],{a:s,b:i,c:r,d:o}=this;for(let a=0,c=10;a<=c;a++){const l=a/c;e.push(new m((1-l)*(1-l)*(1-l)*s.x+3*((1-l)*(1-l))*l*i.x+3*(1-l)*(l*l)*r.x+l*l*l*o.x,(1-l)*(1-l)*(1-l)*s.y+3*((1-l)*(1-l))*l*i.y+3*(1-l)*(l*l)*r.y+l*l*l*o.y))}return e}midPoint(){return cn.GetAtT(this,.5)}nearestPoint(e){let s,i=1/0,r,o;for(const a of this.segments)o=a.nearestPoint(e),r=m.Dist2(o,e),r<i&&(s=o,i=r);if(!s)throw Error("nearest point not found");return s}getSvgPathData(e=!0){const{a:s,b:i,c:r,d:o}=this;return`${e?`M ${s.toFixed()} `:""} C${i.toFixed()} ${r.toFixed()} ${o.toFixed()}`}static GetAtT(e,s){const{a:i,b:r,c:o,d:a}=e;return new m((1-s)*(1-s)*(1-s)*i.x+3*((1-s)*(1-s))*s*r.x+3*(1-s)*(s*s)*o.x+s*s*s*a.x,(1-s)*(1-s)*(1-s)*i.y+3*((1-s)*(1-s))*s*r.y+3*(1-s)*(s*s)*o.y+s*s*s*a.y)}getLength(e=32){let s,i=this.a,r=0;for(let o=1;o<=e;o++)s=cn.GetAtT(this,o/e),r+=m.Dist(i,s),i=s;return r}}class ag extends xt{constructor(e){super({...e,isClosed:!1,isFilled:!1});u(this,"points");u(this,"_segments");const{points:s}=e;this.points=s}get segments(){if(!this._segments){this._segments=[];const{points:e}=this,s=e.length,i=s-2,r=1.25;for(let o=0;o<s-1;o++){const a=o===0?e[0]:e[o-1],c=e[o],l=e[o+1],d=o===i?l:e[o+2],h=c,p=o===0?a:new m(c.x+(l.x-a.x)/6*r,c.y+(l.y-a.y)/6*r),f=o===i?l:new m(l.x-(d.x-c.x)/6*r,l.y-(d.y-c.y)/6*r),S=l;this._segments.push(new cn({start:h,cp1:p,cp2:f,end:S}))}}return this._segments}getLength(){return this.segments.reduce((e,s)=>e+s.length,0)}getVertices(){const e=this.segments.reduce((s,i)=>s.concat(i.vertices),[]);return e.push(this.points[this.points.length-1]),e}nearestPoint(e){let s,i=1/0,r,o;for(const a of this.segments)o=a.nearestPoint(e),r=m.Dist2(o,e),r<i&&(s=o,i=r);if(!s)throw Error("nearest point not found");return s}hitTestLineSegment(e,s){return this.segments.some(i=>i.hitTestLineSegment(e,s))}getSvgPathData(){let e=this.segments.reduce((s,i,r)=>s+i.getSvgPathData(r===0),"");return this.isClosed&&(e+="Z"),e}}class cg extends xt{constructor(e){super({...e,isClosed:!0});u(this,"w");u(this,"h");u(this,"_edges");this.config=e;const{width:s,height:i}=e;this.w=s,this.h=i}get edges(){if(!this._edges){const{vertices:e}=this;this._edges=[];for(let s=0,i=e.length;s<i;s++){const r=e[s],o=e[(s+1)%i];this._edges.push(new Pt({start:r,end:o}))}}return this._edges}getVertices(){const e=Math.max(1,this.w),s=Math.max(1,this.h),i=e/2,r=s/2,o=Math.pow(i-r,2)/Math.pow(i+r,2),a=$e*(i+r)*(1+3*o/(10+Math.sqrt(4-3*o))),c=Oi(a),l=ae/c,d=Math.cos(l),h=Math.sin(l);let p=0,f=1,S=0,g=1;const w=Array(c);for(let b=0;b<c;b++)w[b]=new m(i+i*f,r+r*p),S=h*f+d*p,g=d*f-h*p,p=S,f=g;return w}nearestPoint(e){let s,i=1/0,r,o;for(const a of this.edges)o=a.nearestPoint(e),r=m.Dist2(o,e),r<i&&(s=o,i=r);if(!s)throw Error("nearest point not found");return s}hitTestLineSegment(e,s){return this.edges.some(i=>i.hitTestLineSegment(e,s))}getBounds(){return new H(0,0,this.w,this.h)}getLength(){const{w:e,h:s}=this,i=e/2,r=s/2,o=Math.max(0,i),a=Math.max(0,r);return Td(o,a)}getSvgPathData(e=!1){const{w:s,h:i}=this,r=s/2,o=i/2,a=Math.max(0,r),c=Math.max(0,o);return`${e?`M${r-a},${o}`:""} a${a},${c},0,1,1,${a*2},0a${a},${c},0,1,1,-${a*2},0`}}class lg extends xt{constructor(e){super({...e,isClosed:!0});u(this,"w");u(this,"h");u(this,"a");u(this,"b");u(this,"c");u(this,"d");this.config=e;const{width:s,height:i}=e;if(this.w=s,this.h=i,i>s){const r=s/2;this.a=new Ns({start:new m(0,r),end:new m(s,r),center:new m(s/2,r),sweepFlag:1,largeArcFlag:1}),this.b=new Pt({start:new m(s,r),end:new m(s,i-r)}),this.c=new Ns({start:new m(s,i-r),end:new m(0,i-r),center:new m(s/2,i-r),sweepFlag:1,largeArcFlag:1}),this.d=new Pt({start:new m(0,i-r),end:new m(0,r)})}else{const r=i/2;this.a=new Ns({start:new m(r,i),end:new m(r,0),center:new m(r,r),sweepFlag:1,largeArcFlag:1}),this.b=new Pt({start:new m(r,0),end:new m(s-r,0)}),this.c=new Ns({start:new m(s-r,0),end:new m(s-r,i),center:new m(s-r,r),sweepFlag:1,largeArcFlag:1}),this.d=new Pt({start:new m(s-r,i),end:new m(r,i)})}}nearestPoint(e){let s,i=1/0,r,o;const{a,b:c,c:l,d}=this;for(const h of[a,c,l,d])o=h.nearestPoint(e),r=m.Dist2(o,e),r<i&&(s=o,i=r);if(!s)throw Error("nearest point not found");return s}hitTestLineSegment(e,s){const{a:i,b:r,c:o,d:a}=this;return[i,r,o,a].some(c=>c.hitTestLineSegment(e,s))}getVertices(){const{a:e,b:s,c:i,d:r}=this;return[e,s,i,r].reduce((o,a)=>(o.push(...a.vertices),o),[])}getBounds(){return new H(0,0,this.w,this.h)}getLength(){const{h:e,w:s}=this;return e>s?($e*(s/2)+(e-s))*2:($e*(e/2)+(s-e))*2}getSvgPathData(){const{a:e,b:s,c:i,d:r}=this;return[e,s,i,r].map((o,a)=>o.getSvgPathData(a===0)).join(" ")+" Z"}}async function lf({shouldReload:n=!0}={}){gc();for(const t of an.connectedInstances)await t.close();await Promise.all(Ri().map(t=>Br(t))),fc(),n&&window.location.reload()}typeof window<"u"&&(window.__tldraw__hardReset=lf);function dg(n,t="_blank"){Ei.openWindow(n,t)}export{We as $,Yl as A,Un as B,os as C,zh as D,ws as E,Cf as F,Ci as G,Bl as H,ln as I,Pf as J,$t as K,te as L,ie as M,De as N,Cn as O,$e as P,pr as Q,ue as R,mt as S,zf as T,Nn as U,m as V,Vl as W,Ue as X,_t as Y,Zf as Z,Qf as _,$ as a,nd as a$,Wc as a0,ma as a1,mn as a2,Vr as a3,Of as a4,Ji as a5,Ce as a6,Ou as a7,H as a8,ye as a9,st as aA,Lt as aB,Ot as aC,Zs as aD,jf as aE,$l as aF,Kl as aG,Mi as aH,_f as aI,Gl as aJ,Xl as aK,Ff as aL,Qn as aM,ql as aN,Wl as aO,of as aP,cn as aQ,Hf as aR,Td as aS,Zl as aT,Ql as aU,Ve as aV,lg as aW,cg as aX,Uf as aY,Jl as aZ,td as a_,vs as aa,Ge as ab,ri as ac,ve as ad,xi as ae,la as af,og as ag,$f as ah,Pt as ai,Ns as aj,qf as ak,Zn as al,ps as am,Qc as an,Jc as ao,da as ap,ai as aq,gs as ar,pu as as,ng as at,zt as au,tc as av,sg as aw,Ul as ax,Nl as ay,tg as az,Sn as b,Yf as b$,id as b0,sc as b1,ad as b2,cd as b3,Yn as b4,kf as b5,ag as b6,cr as b7,ld as b8,dd as b9,ce as bA,Qh as bB,go as bC,Et as bD,fe as bE,C as bF,vi as bG,Kd as bH,Pi as bI,ao as bJ,co as bK,Tf as bL,Pr as bM,sh as bN,kr as bO,gn as bP,At as bQ,Zc as bR,Vc as bS,rd as bT,hd as bU,Do as bV,Ro as bW,vf as bX,Dh as bY,bp as bZ,Yo as b_,ud as ba,pd as bb,fd as bc,gd as bd,fr as be,Ad as bf,_u as bg,ku as bh,Mn as bi,Bf as bj,Me as bk,ys as bl,xs as bm,Dt as bn,nh as bo,xu as bp,Ef as bq,Ne as br,us as bs,Mf as bt,th as bu,lt as bv,ut as bw,dg as bx,Mt as by,yi as bz,ig as c,eg as c0,nf as c1,qh as c2,Jf as c3,rf as c4,eo as c5,dc as c6,rg as c7,L as c8,W as c9,jc as ca,Df as cb,ke as cc,G as cd,Se as ce,Lf as cf,Rf as cg,Is as d,yp as e,Hh as f,jh as g,Gf as h,Xf as i,bi as j,Md as k,Nf as l,Wf as m,Vf as n,Kf as o,ae as p,Af as q,el as r,tl as s,he as t,K as u,In as v,de as w,Gi as x,qt as y,Hs as z};
